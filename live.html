<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"/>
  <title>BattleBillions — Unified App (Mobile-First)</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --gold:#ffd700;
      --gold-1:#ffe88a;
      --gold-2:#ffcc3b;
      --ink:#eaeaea;
      --muted:#b8b8b8;
      --top-safe: max(12px, env(safe-area-inset-top));
      --side-safe: max(12px, env(safe-area-inset-left));
      --side-safe-r: max(12px, env(safe-area-inset-right));
      --bottom-safe: max(18px, env(safe-area-inset-bottom));
      --glass: rgba(12,12,16,.55);
      --glass-2: rgba(20,20,26,.6);
    }

    /* RESET */
    *{margin:0;padding:0;box-sizing:border-box}
    html, body{
      height:100%;
      width:100%;
      background:#000;
      color:var(--ink);
      font-family:'Orbitron',sans-serif;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
      overscroll-behavior: none;
    }

    /* HIDE SCROLLBARS GLOBALLY (feed still scrolls, but bars are hidden) */
    *::-webkit-scrollbar{ width:0; height:0; display:none }
    *{ scrollbar-width: none }

    /* Ambient */
    .depth-stage{ position:fixed; inset:0; z-index:0; pointer-events:none; }
    .layer-nebula{
      position:absolute; inset:-15%;
      background: conic-gradient(from 0deg at 50% 50%,
        rgba(255,215,0,.10), rgba(0,255,255,.08), rgba(148,0,255,.12), rgba(255,215,0,.10));
      filter: blur(90px) saturate(130%); opacity:.24; animation: nebula 40s linear infinite;
    }
    @keyframes nebula{ to{ transform: rotate(360deg) } }
    .layer-stars{
      position:absolute; inset:0;
      background:
        radial-gradient(1px 1px at 20% 30%, rgba(255,255,255,.09), transparent 60%),
        radial-gradient(1px 1px at 70% 60%, rgba(255,255,255,.07), transparent 60%),
        radial-gradient(1px 1px at 40% 80%, rgba(255,255,255,.06), transparent 60%);
      animation: stars 14s ease-in-out infinite alternate;
    }
    @keyframes stars{ from{filter:brightness(.9)} to{filter:brightness(1.1)} }

    /* Root App Grid */
    .app{
      position:relative; z-index:1;
      height:100dvh; /* modern viewport: prevents iOS toolbars shift */
      width:100vw;
      display:grid; grid-template-rows: auto 1fr auto;
      padding-left: var(--side-safe);
      padding-right: var(--side-safe-r);
    }

    /* Top HUD */
    .top{
      display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap:10px;
      padding: calc(var(--top-safe)) clamp(12px,3vw,22px) 8px;
    }
    .hud-left, .hud-right{ display:flex; gap:10px; align-items:center; }
    .pill{
      background:linear-gradient(180deg,var(--gold-1),var(--gold-2));
      color:#000; font-weight:800; border:none; border-radius:999px;
      padding:6px 14px; box-shadow:0 0 18px rgba(255,215,0,.45);
      cursor:pointer;
    }
    .chip{
      background:var(--glass); color:#fff; border-radius:999px;
      backdrop-filter: blur(10px); padding:6px 12px; font-weight:800;
    }
    .btn-ghost{
      background:transparent; color:#fff; border:none; cursor:pointer; font-weight:800;
      text-shadow:0 1px 0 rgba(255,255,255,.2);
      padding:6px 8px;
    }

    /* Search (center top) */
    .search{
      pointer-events:auto; display:flex; align-items:center; gap:8px; justify-content:center;
      background: rgba(255,255,255,.08);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      padding:8px 10px; border-radius:14px; box-shadow:0 0 20px rgba(255,215,0,.15);
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .search:focus-within{ transform:translateY(-1px); box-shadow:0 0 28px rgba(255,215,0,.28) }
    .search input{
      width:min(64vw, 520px);
      border:none; outline:none; background:transparent; color:#fff;
      font-family:inherit; font-size:14px;
    }
    .search button{
      background:linear-gradient(180deg,var(--gold-1),var(--gold-2));
      color:#000; border:none; border-radius:10px; padding:8px 10px; cursor:pointer; font-weight:800;
    }

    /* Results drawer */
    .results{
      position:fixed; left:50%; top: calc(var(--top-safe) + 60px);
      transform: translateX(-50%);
      width:min(92vw, 760px); max-height: 52dvh; overflow:auto;
      background: rgba(10,10,14,.9);
      border-radius:14px; padding:8px; display:none; z-index:6;
      box-shadow: 0 18px 60px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.08);
    }
    .res-item{
      display:flex; align-items:center; gap:12px; padding:10px; border-radius:10px;
      background: rgba(255,255,255,.03);
      margin:6px 0;
    }
    .res-item:hover{ background: rgba(255,255,255,.06) }
    .res-flag{ width:22px; height:14px; object-fit:cover; border-radius:3px; }
    .res-meta{ display:grid; gap:4px; }
    .res-handle{ font-weight:800; font-size:13px }
    .res-sub{ color:var(--muted); font-size:12px }
    .res-cta{
      margin-left:auto;
      background:linear-gradient(180deg,var(--gold-1),var(--gold-2));
      color:#000; border:none; border-radius:10px; padding:8px 10px; cursor:pointer; font-weight:800;
    }

    /* Views */
    .views{ position:relative; overflow:hidden; }
    .view{ position:absolute; inset:0; display:none; }
    .view.active{ display:grid; grid-template-rows: 1fr; }

    /* FEED (scrollable list of live battles) */
    .feed{
      height:100%;
      overflow-y:auto;
      -webkit-overflow-scrolling: touch;
      padding: 6px clamp(12px,3vw,22px);
      display:grid; gap:12px;
    }
    .card{
      background: var(--glass-2);
      border-radius:16px; padding:10px;
      -webkit-backdrop-filter: blur(12px);
      backdrop-filter: blur(12px);
      box-shadow: 0 14px 40px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06);
    }
    .card-head{
      display:flex; align-items:center; gap:10px; margin-bottom:8px;
    }
    .flag{ width:20px; height:14px; border-radius:3px; object-fit:cover }
    .title{ font-weight:800; font-size:14px }
    .sub{ color:var(--muted); font-size:12px }

    .split{
      position:relative; display:grid; grid-template-columns:1fr 1fr; gap:6px; min-height:0;
      border-radius:12px; overflow:hidden;
    }
    .pane{ position:relative; overflow:hidden; min-height: 30dvh; }
    .pane video{
      width:100%; height:100%; object-fit:cover; display:block; background:#000;
      filter: brightness(.96) contrast(1.08) saturate(1.06);
    }
    .pane::after{
      content:""; position:absolute; inset:0; pointer-events:none;
      background:
        linear-gradient(to right, rgba(255,255,255,.04), transparent 20% 80%, rgba(255,255,255,.04)),
        radial-gradient(1100px 360px at 10% 0%, rgba(255,215,0,.06), transparent 70%),
        radial-gradient(1100px 360px at 90% 0%, rgba(148,0,255,.05), transparent 70%);
      mix-blend-mode:screen;
    }

    .underbar{
      margin-top:8px; display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    }
    .btn{
      background:linear-gradient(180deg,var(--gold-1),var(--gold-2));
      color:#000; font-weight:800; border:none; border-radius:12px; padding:10px 14px; cursor:pointer;
      box-shadow:0 0 16px rgba(255,215,0,.35);
    }
    .ghost{
      background:transparent; color:#fff; border:none; font-weight:800; cursor:pointer;
      padding:8px 10px;
    }
    .timer-chip{
      background:rgba(0,0,0,.5); padding:8px 12px; border-radius:999px; font-weight:800; font-size:12px;
    }

    /* LIVE VIEW (SPA full view) */
    .live-wrap{
      position:relative; display:grid; grid-template-rows: 1fr auto; gap:8px;
      padding: 6px clamp(12px,3vw,22px);
    }
    .live-split{
      position:relative; display:grid; grid-template-columns:1fr 1fr; gap:6px; min-height:0;
      border-radius:14px; overflow:hidden;
    }
    .live-pane{ position:relative; overflow:hidden; min-height: 44dvh; }
    .live-pane video{ width:100%; height:100%; object-fit:cover; background:#000; }
    .live-pane.inactive::before{
      content:""; position:absolute; inset:0; background:rgba(0,0,0,.32); z-index:2; backdrop-filter: blur(1.5px);
    }
    .mid-timer{
      position:absolute; left:50%; top:10px; transform:translateX(-50%);
      background:var(--glass); -webkit-backdrop-filter:blur(8px); backdrop-filter:blur(8px);
      padding:8px 14px; border-radius:999px; font-weight:800; font-size:13px; z-index:5;
    }
    .vote-bar{
      display:flex; justify-content:center; gap:10px; padding:4px 0 2px;
    }

    /* Bottom shapes (match Arena) */
    .bottom{
      display:flex; align-items:center; justify-content:center; gap:22px;
      padding: 8px clamp(12px,3vw,22px) calc(var(--bottom-safe) + 8px);
    }
    .shape{
      appearance:none; background:transparent; border:none; padding:0;
      width:28px; height:28px; display:grid; place-items:center; cursor:pointer;
      filter: drop-shadow(0 0 10px rgba(255,255,255,.08));
      transition: transform .18s ease, filter .18s ease;
      touch-action: manipulation;
    }
    .shape:active{ transform: scale(.96) }
    .shape:hover{ transform:translateY(-2px) scale(1.06); filter:brightness(1.08); }
    .shape svg{ width:100%; height:100%; stroke:#cfcfcf; fill:none; stroke-width:2.2; }
    .shape.gold svg{ stroke:url(#goldStroke); }

    /* Mobile tweaks */
    @media (max-width: 900px){
      .search input{ width:min(72vw,520px) }
      .pane{ min-height: 32dvh }
      .live-pane{ min-height: 46dvh }
      .shape{ width:26px; height:26px }
    }
  </style>
</head>
<body>
  <!-- Gold stroke for icons -->
  <svg width="0" height="0" style="position:absolute">
    <defs>
      <linearGradient id="goldStroke" x1="0%" y1="0%" x2="0%" y2="100%">
        <stop offset="0%" stop-color="#fff4b0"/>
        <stop offset="60%" stop-color="#ffd700"/>
        <stop offset="100%" stop-color="#ffbf2e"/>
      </linearGradient>
    </defs>
  </svg>

  <!-- Ambient -->
  <div class="depth-stage" aria-hidden="true">
    <div class="layer-nebula"></div>
    <div class="layer-stars"></div>
  </div>

  <div class="app" role="application">
    <!-- TOP BAR -->
    <header class="top">
      <div class="hud-left">
        <button id="livePill" class="pill">LIVE</button>
        <div id="viewerChip" class="chip">👁 0</div>
      </div>

      <div class="search" id="searchBox" role="search">
        <input id="searchInput" type="text" inputmode="search" placeholder="Search battles by country, city, or region… (e.g., Japan, Paris, West Coast)" autocomplete="off"/>
        <button id="searchBtn">Search</button>
      </div>

      <div class="hud-right">
        <button id="shareBtn" class="btn-ghost">Share</button>
        <button id="muteAllBtn" class="btn-ghost" aria-pressed="false">Mute</button>
      </div>

      <!-- Global results drawer -->
      <div class="results" id="resultsDrawer" role="listbox" aria-label="Search results"></div>
    </header>

    <!-- VIEWS -->
    <main class="views">
      <!-- FEED VIEW (default, scrollable without visible bars) -->
      <section id="view-feed" class="view active" aria-label="Live Battles Feed">
        <div id="feed" class="feed" tabindex="0"><!-- cards injected by JS --></div>
      </section>

      <!-- LIVE VIEW (single battle, still SPA) -->
      <section id="view-live" class="view" aria-label="Live Battle">
        <div class="live-wrap">
          <div class="mid-timer" id="liveTimer">Loading…</div>
          <div class="live-split">
            <div class="live-pane" id="lpA">
              <video id="liveA" autoplay playsinline muted></video>
            </div>
            <div class="live-pane" id="lpB">
              <video id="liveB" autoplay playsinline muted></video>
            </div>
          </div>
          <div class="vote-bar">
            <button id="voteA" class="btn">Vote A</button>
            <button id="voteB" class="btn">Vote B</button>
            <button id="backToFeed" class="ghost">← Back</button>
          </div>
        </div>
      </section>

      <!-- LEADERBOARD -->
      <section id="view-board" class="view" aria-label="Leaderboard">
        <div class="feed" id="boardList">
          <div class="card"><div class="title">🏆 Leaderboard</div><div class="sub">Live ranks update in real-time</div></div>
          <div class="card"><div class="title">1) @Nova — 12,430 pts</div><div class="sub">United States</div></div>
          <div class="card"><div class="title">2) @Kiro — 12,420 pts</div><div class="sub">Japan</div></div>
          <div class="card"><div class="title">3) @Ari — 12,100 pts</div><div class="sub">France</div></div>
        </div>
      </section>

      <!-- DISCOVER -->
      <section id="view-discover" class="view" aria-label="Discover">
        <div class="feed" id="discoverList">
          <div class="card"><div class="title">🔎 Discover</div><div class="sub">New regions, trending tags, fresh matchups</div></div>
          <div class="card"><div class="title">Trending · Southeast Asia</div><div class="sub">#DoubleTime · #Freestyle</div></div>
          <div class="card"><div class="title">Rising · South America</div><div class="sub">@Sol vs @Vento</div></div>
        </div>
      </section>

      <!-- PROFILE -->
      <section id="view-profile" class="view" aria-label="Profile">
        <div class="feed" id="profileView">
          <div class="card"><div class="title">👤 Your Profile</div><div class="sub">Battles you’ve watched will appear here soon.</div></div>
        </div>
      </section>
    </main>

    <!-- BOTTOM NAV (shapes, same everywhere like Arena) -->
    <footer class="bottom" aria-label="Navigation">
      <!-- Circle = Home/Feed -->
      <button class="shape gold" data-nav="feed" title="Home" aria-label="Home">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"/></svg>
      </button>
      <!-- Square = Leaderboard -->
      <button class="shape" data-nav="board" title="Leaderboard" aria-label="Leaderboard">
        <svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
      </button>
      <!-- Diamond = Discover -->
      <button class="shape gold" data-nav="discover" title="Discover" aria-label="Discover">
        <svg viewBox="0 0 24 24"><polygon points="12,4 20,12 12,20 4,12"/></svg>
      </button>
      <!-- Triangle = Live -->
      <button class="shape" data-nav="live" title="Live" aria-label="Live">
        <svg viewBox="0 0 24 24"><polygon points="12,5 20,19 4,19"/></svg>
      </button>
      <!-- Profile glyph -->
      <button class="shape" data-nav="profile" title="Profile" aria-label="Profile">
        <svg viewBox="0 0 24 24"><path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-4 0-8 2-8 5 0 1 0 1 0 1h16s0 0 0-1c0-3-4-5-8-5Z"/></svg>
      </button>
    </footer>
  </div>

  <script type="module">
    /**
     * MOBILE-FIRST SPA
     *  - No visible scrollbars (feed still scrolls smoothly with momentum)
     *  - Uses 100dvh + safe-area paddings to avoid iOS browser chrome jumps
     *  - IntersectionObserver pauses offscreen feed videos (battery-friendly)
     *  - Autoplay policy safe: all videos start muted; "Mute" toggles globally
     *  - Ready for real backend:
     *      • Replace demoBattles + populateFeed() with Firestore live query.
     *      • Wire SFU (LiveKit/Agora/etc.) into openLive()/joinRoom().
     *      • Wire votes via Callable Cloud Functions.
     */

    /* =========================
       Demo data (replace later)
       ========================= */
    const demoBattles = [
      {
        id:'b1', liveRoomId:'', createdAt:Date.now()-1000*60*3,
        a:{handle:'@Nova', country:'United States', flagUrl:'flag_us.png', video:'user2.mp4'},
        b:{handle:'@Kiro', country:'Japan', flagUrl:'flag_jp.png', video:'user3.mp4'},
        region:'North America', area:'West Coast', status:'live', round:1, part:0, endsIn:33
      },
      {
        id:'b2', liveRoomId:'', createdAt:Date.now()-1000*60*6,
        a:{handle:'@Ari', country:'France', flagUrl:'flag_fr.png', video:'user4.mp4'},
        b:{handle:'@Zed', country:'Brazil', flagUrl:'flag_br.png', video:'user3.mp4'},
        region:'Europe', area:'Paris', status:'live', round:2, part:1, endsIn:28
      },
      {
        id:'b3', liveRoomId:'', createdAt:Date.now()-1000*60*9,
        a:{handle:'@Sol', country:'Japan', flagUrl:'flag_jp.png', video:'user2.mp4'},
        b:{handle:'@Vento', country:'Italy', flagUrl:'flag_it.png', video:'user4.mp4'},
        region:'Asia', area:'Tokyo', status:'live', round:3, part:0, endsIn:19
      }
    ];

    /* ========== Helpers ========== */
    const $  = (q)=>document.querySelector(q);
    const $$ = (q)=>document.querySelectorAll(q);
    const byId = (id)=>document.getElementById(id);

    // iOS viewport safety: recalc 100dvh-like height when toolbars change
    const appRoot = $('.app');
    function lockViewportHeight(){
      appRoot.style.height = window.innerHeight + 'px';
    }
    window.addEventListener('resize', lockViewportHeight, {passive:true});
    window.addEventListener('orientationchange', ()=> setTimeout(lockViewportHeight, 250), {passive:true});
    lockViewportHeight();

    // prevent iOS rubber-band bounce
    document.addEventListener('touchmove', (e)=>{
      // allow only if target is inside a scrollable container (.feed)
      const scroller = e.target.closest('.feed');
      if(!scroller) e.preventDefault();
    }, {passive:false});

    /* ========== Views & Nav ========== */
    const views = {
      feed: byId('view-feed'),
      live: byId('view-live'),
      board: byId('view-board'),
      discover: byId('view-discover'),
      profile: byId('view-profile'),
    };
    function showView(name){
      Object.values(views).forEach(v=>v.classList.remove('active'));
      views[name].classList.add('active');

      // Pause media appropriately
      if(name!=='feed'){ pauseFeedMedia(); }
      if(name!=='live'){ stopLiveMedia(); }
    }

    // Bottom nav
    $$('footer .shape').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const dest = btn.dataset.nav;
        if(dest==='live'){
          if(!currentLive){ openLive(demoBattles[0].id); } else { showView('live'); }
        }else{
          showView(dest);
        }
      });
    });
    byId('backToFeed').addEventListener('click', ()=>{
      bumpViewers(-1);
      showView('feed');
    });

    /* ========== FEED population ========== */
    const feedEl = byId('feed');

    function makeCard(b){
      const aId = `va-${b.id}`;
      const bId = `vb-${b.id}`;
      const timerId = `tm-${b.id}`;

      const el = document.createElement('div');
      el.className='card';
      el.innerHTML = `
        <div class="card-head">
          <img class="flag" src="${b.a.flagUrl||'flag_us.png'}" alt="">
          <div>
            <div class="title">${b.a.handle} vs ${b.b.handle}</div>
            <div class="sub">${b.a.country} · ${b.region}${b.area?(' · '+b.area):''}</div>
          </div>
        </div>
        <div class="split">
          <div class="pane"><video id="${aId}" playsinline muted loop preload="metadata"></video></div>
          <div class="pane"><video id="${bId}" playsinline muted loop preload="metadata"></video></div>
        </div>
        <div class="underbar">
          <span class="timer-chip" id="${timerId}">Round ${b.round}/3 · ${b.part===0?'A':'B'} · ${b.endsIn}s</span>
          <button class="btn" data-action="watch" data-battle="${b.id}">Watch</button>
          <button class="btn" data-action="voteA" data-battle="${b.id}">Vote A</button>
          <button class="btn" data-action="voteB" data-battle="${b.id}">Vote B</button>
          <button class="ghost" data-action="share" data-battle="${b.id}">Share</button>
        </div>
      `;

      // attach preview media (deferred actual play: IntersectionObserver)
          const vA = el.querySelector('#'+aId);
      const vB = el.querySelector('#'+bId);
      vA.src = b.a.video; vB.src = b.b.video;
      vA.playsInline = vB.playsInline = true;

      // timer
      startCardCountdown(timerId, b);

      // Observe for autoplay when visible
      previewObserver.observe(vA);
      previewObserver.observe(vB);

      return el;
    }

    function populateFeed(){
      feedEl.innerHTML = '';
      demoBattles
        .sort((x,y)=> y.createdAt - x.createdAt)
        .forEach(b=> feedEl.appendChild(makeCard(b)));
    }

    // IntersectionObserver to only play visible preview videos
    const previewObserver = new IntersectionObserver((entries)=>{
      entries.forEach(async (entry)=>{
        const vid = entry.target;
        if(entry.isIntersecting){
          try{ await vid.play(); }catch{}
        }else{
          try{ vid.pause(); }catch{}
        }
      });
    }, { root: feedEl, threshold: 0.35 });

    function pauseFeedMedia(){
      previewObserver.disconnect();
      feedEl.querySelectorAll('video').forEach(v=>{ try{ v.pause(); }catch{} });
      // stop timers
      cardTimers.forEach((raf,id)=> cancelAnimationFrame(raf));
      cardTimers.clear();
    }

    /* ========== Per-card accurate countdown ========== */
    const cardTimers = new Map();
    function startCardCountdown(timerId, battle){
      stopCardCountdown(timerId);
      const endAt = Date.now() + (battle.endsIn*1000);
      const tick = ()=>{
        const ms = Math.max(0, endAt - Date.now());
        const s  = Math.ceil(ms/1000);
        const el = byId(timerId);
        if(!el){ cancelAnimationFrame(cardTimers.get(timerId)); return; }
        el.textContent = `Round ${battle.round}/3 · ${battle.part===0?'A':'B'} · ${s}s`;
        if(ms<=0){ return; }
        const raf = requestAnimationFrame(tick);
        cardTimers.set(timerId, raf);
      };
      cardTimers.set(timerId, requestAnimationFrame(tick));
    }
    function stopCardCountdown(timerId){
      if(cardTimers.has(timerId)){ cancelAnimationFrame(cardTimers.get(timerId)); cardTimers.delete(timerId); }
    }

    /* ========== LIVE view (SPA) ========== */
    let currentLive = null;
    const liveA = byId('liveA');
    const liveB = byId('liveB');
    const lpA  = byId('lpA');
    const lpB  = byId('lpB');
    const liveTimer = byId('liveTimer');
    let liveRAF = 0;

    function openLive(battleId){
      const b = demoBattles.find(x=>x.id===battleId);
      if(!b) return;
      currentLive = { ...b, endAt: Date.now() + (b.endsIn*1000) };

      // Attach media (replace with SFU attach in prod)
      liveA.src = b.a.video; liveB.src = b.b.video;
      liveA.playsInline = liveB.playsInline = true;
      Promise.allSettled([liveA.play(), liveB.play()]);

      updateLiveTurnUI();
      startLiveCountdown();
      bumpViewers(+1);
      showView('live');
    }
    function updateLiveTurnUI(){
      if(!currentLive) return;
      if(currentLive.part===0){ lpA.classList.remove('inactive'); lpB.classList.add('inactive'); }
      else{ lpA.classList.add('inactive'); lpB.classList.remove('inactive'); }
    }
    function startLiveCountdown(){
      cancelAnimationFrame(liveRAF);
      const tick = ()=>{
        if(!currentLive){ return; }
        const ms = Math.max(0, currentLive.endAt - Date.now());
        const s  = Math.ceil(ms/1000);
        liveTimer.textContent = `Round ${currentLive.round}/3 · ${currentLive.part===0?'A':'B'} · ${s}s`;
        if(ms<=0){ return; }
        liveRAF = requestAnimationFrame(tick);
      };
      liveRAF = requestAnimationFrame(tick);
    }
    function stopLiveMedia(){
      try{ liveA.pause(); liveB.pause(); }catch{}
      cancelAnimationFrame(liveRAF); liveRAF = 0;
    }

    // Feed actions
    feedEl.addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      const action = btn.dataset.action;
      const bid = btn.dataset.battle;
      if(!action || !bid) return;

      if(action==='watch'){
        openLive(bid);
      }else if(action==='voteA'){
        // TODO: call your callable function castVote({ battleId: bid, side:'a' })
        toast('Vote for A sent');
      }else if(action==='voteB'){
        // TODO: call your callable function castVote({ battleId: bid, side:'b' })
        toast('Vote for B sent');
      }else if(action==='share'){
        shareLink(bid);
      }
    });

    /* ========== Global search (client filter demo) ========== */
    const resultsDrawer = byId('resultsDrawer');
    const searchInput = byId('searchInput');

    function normalize(s){ return (s||'').toString().toLowerCase(); }
    function renderResults(list){
      const open = list && list.length;
      resultsDrawer.style.display = open ? 'block' : 'none';
      resultsDrawer.innerHTML = (list||[]).map(b=>{
        const A = b.a || {};
        const B = b.b || {};
        const ctry = (A.country || '—');
        const flag = (A.flagUrl || 'flag_us.png');
        const loc = b.area || b.region || ctry;
        return `
          <div class="res-item" role="option">
            <img class="res-flag" src="${flag}" alt="">
            <div class="res-meta">
              <div class="res-handle">${A.handle || '@A'} vs ${(B.handle || '@B')}</div>
              <div class="res-sub">${ctry}${loc && loc!==ctry ? ' · '+loc : ''}</div>
            </div>
            <button class="res-cta" data-watch="${b.id}">Watch</button>
          </div>
        `;
      }).join('');
      resultsDrawer.querySelectorAll('[data-watch]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.dataset.watch;
          resultsDrawer.style.display='none';
          openLive(id);
        });
      });
    }
    function applySearch(term){
      const t = normalize(term);
      if(!t){ resultsDrawer.style.display='none'; resultsDrawer.innerHTML=''; return; }
      const res = demoBattles.filter(b=>{
        const A = b.a||{}, B=b.b||{};
        const hay = [A.handle,A.country,b.region,b.area,B.handle,B.country].map(normalize).join(' ');
        return hay.includes(t) || hay.split(/\s+/).some(w=>w && t.includes(w));
      });
      renderResults(res);
    }
    byId('searchBtn').addEventListener('click', ()=> applySearch(searchInput.value) );
    searchInput.addEventListener('input', (e)=>{
      const v = e.currentTarget.value;
      if(v.length>=2) applySearch(v); else { resultsDrawer.style.display='none'; resultsDrawer.innerHTML=''; }
    });
    document.addEventListener('click', (e)=>{
      const box = byId('searchBox');
      if(!box.contains(e.target) && !resultsDrawer.contains(e.target)){
        resultsDrawer.style.display='none';
      }
    });

    /* ========== Share / Mute All / Visibility ========== */
    async function shareLink(battleId){
      const url = `${location.origin}${location.pathname}#watch=${encodeURIComponent(battleId)}`;
      try{
        if(navigator.share){ await navigator.share({title:'Watch this Battle', text:'Pull up to the BattleBillions live', url}); }
        else{ await navigator.clipboard.writeText(url); toast('🔗 Link copied'); }
      }catch{}
    }
    function toast(msg){
      const el = document.createElement('div');
      el.textContent = msg;
      el.style.position='fixed';
      el.style.left='50%'; el.style.bottom='calc(var(--bottom-safe) + 20px)';
      el.style.transform='translateX(-50%)';
      el.style.background='linear-gradient(180deg,var(--gold-1),var(--gold-2))';
      el.style.color='#000'; el.style.fontWeight='800';
      el.style.padding='8px 14px'; el.style.borderRadius='999px';
      el.style.zIndex='999';
      document.body.appendChild(el);
      setTimeout(()=> el.remove(), 1400);
    }
    const muteAllBtn = byId('muteAllBtn'); let mutedAll = true; // start muted for autoplay
    function applyMuteAll(){
      document.querySelectorAll('video').forEach(v=> v.muted = mutedAll);
      muteAllBtn.setAttribute('aria-pressed', String(mutedAll));
      muteAllBtn.textContent = mutedAll ? 'Unmute' : 'Mute';
    }
    muteAllBtn.addEventListener('click', ()=>{
      mutedAll = !mutedAll; applyMuteAll();
      if(!mutedAll){
        document.querySelectorAll('video').forEach(v=> v.play().catch(()=>{}));
      }
    });
    applyMuteAll();

    document.addEventListener('visibilitychange', ()=>{
      if(document.hidden){
        pauseFeedMedia();
        stopLiveMedia();
      }else{
        // resume visible stuff
        if(views.feed.classList.contains('active')){
          populateFeed();
          // reconnect observer on new nodes
          feedEl.querySelectorAll('video').forEach(v=> previewObserver.observe(v));
        }else if(views.live.classList.contains('active') && currentLive){
          Promise.allSettled([liveA.play(), liveB.play()]);
          startLiveCountdown();
        }
      }
    });

    // Live viewer count demo
    const viewerChip = byId('viewerChip');
    function bumpViewers(delta){
      const txt = viewerChip.textContent.replace(/[^\d]/g,'');
      const n = Math.max(0, (parseInt(txt||'0',10) + delta));
      viewerChip.textContent = `👁 ${n}`;
    }

    /* ========== FEED actions (watch/vote/share) already wired above ========== */

    /* ========== Boot ========== */
    (function boot(){
      populateFeed();

      // Deep link to live
      if(location.hash.startsWith('#watch=')){
        const id = decodeURIComponent(location.hash.split('=')[1]||'');
        if(id) openLive(id);
      }
    })();

    /* ===========================================================
       BACKEND PREP (replace demo with real services)
       - Replace demoBattles with Firestore query on "battles" where status == 'live'.
       - In populateFeed(), build cards from snapshot docs.
       - In openLive(), join your SFU room, attach remote MediaStreamTracks to liveA/liveB.
       - Voting: add callable function (castVote) and call it on buttons.
       - Presence: update "viewers" count in backend (or function).
       =========================================================== */
  </script>
</body>
</html>
