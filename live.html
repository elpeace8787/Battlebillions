<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no"/>
  <title>BattleBillions ‚Äî Live Arena</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --gold:#ffd700;
      --gold-1:#ffe88a;
      --gold-2:#ffcc3b;
      --ink:#eaeaea;
      --muted:#b8b8b8;
      --top-safe: max(14px, env(safe-area-inset-top));
      --side-safe: max(14px, env(safe-area-inset-left));
      --side-safe-r: max(14px, env(safe-area-inset-right));
      --bottom-safe: max(16px, env(safe-area-inset-bottom));
      --glass: rgba(0,0,0,.55);
    }

    *{margin:0;padding:0;box-sizing:border-box}
    html, body{
      height:100%; width:100%;
      overflow:hidden; overscroll-behavior:none;
      background:#000; color:var(--ink);
      font-family:'Orbitron',sans-serif;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    *::-webkit-scrollbar{ display:none; width:0; height:0 }

    /* Ambient */
    .depth-stage{ position:fixed; inset:0; z-index:0; pointer-events:none; }
    .layer-nebula{
      position:absolute; inset:-15%;
      background: conic-gradient(from 0deg at 50% 50%,
        rgba(255,215,0,.10), rgba(0,255,255,.08), rgba(148,0,255,.12), rgba(255,215,0,.10));
      filter: blur(90px) saturate(130%); opacity:.34; animation: nebula 40s linear infinite;
    }
    @keyframes nebula{ to{ transform: rotate(360deg) } }
    .layer-stars{
      position:absolute; inset:0;
      background:
        radial-gradient(1px 1px at 20% 30%, rgba(255,255,255,.09), transparent 60%),
        radial-gradient(1px 1px at 70% 60%, rgba(255,255,255,.07), transparent 60%),
        radial-gradient(1px 1px at 40% 80%, rgba(255,255,255,.06), transparent 60%);
      animation: stars 14s ease-in-out infinite alternate;
    }
    @keyframes stars{ from{filter:brightness(.9)} to{filter:brightness(1.1)} }

    /* Root layout */
    .wrap{
      position:relative; z-index:1; height:100svh; width:100svw; overflow:hidden;
      display:grid; grid-template-rows: auto 1fr auto;
    }

    /* Top HUD */
    .top{
      display:grid; grid-template-columns: 1fr auto 1fr; align-items:center;
      gap:10px;
      padding: calc(var(--top-safe)) clamp(12px,2.5vw,20px) 10px;
      pointer-events:none;
    }
    .hud-left, .hud-right{ display:flex; gap:10px; align-items:center; pointer-events:auto; }
    .pill{
      background:linear-gradient(180deg,var(--gold-1),var(--gold-2));
      color:#000; font-weight:800; border:none; border-radius:999px;
      padding:6px 14px; box-shadow:0 0 18px rgba(255,215,0,.45);
      cursor:pointer;
    }
    .chip{
      background:var(--glass); color:#fff; border-radius:999px;
      backdrop-filter: blur(8px); padding:6px 12px; font-weight:800;
    }
    .btn-ghost{
      background:transparent; color:#fff; border:none; cursor:pointer; font-weight:800;
      text-shadow:0 1px 0 rgba(255,255,255,.2);
    }

    /* Search (centered) */
    .search{
      pointer-events:auto; display:flex; align-items:center; gap:8px; justify-content:center;
      background: rgba(255,255,255,.08);
      backdrop-filter: blur(10px);
      padding:8px 10px; border-radius:14px; box-shadow:0 0 20px rgba(255,215,0,.15);
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .search:focus-within{ transform:translateY(-1px); box-shadow:0 0 28px rgba(255,215,0,.28) }
    .search input{
      width:min(56vw, 520px);
      border:none; outline:none; background:transparent; color:#fff;
      font-family:inherit; font-size:14px;
    }
    .search button{
      background:linear-gradient(180deg,var(--gold-1),var(--gold-2));
      color:#000; border:none; border-radius:10px; padding:8px 10px; cursor:pointer; font-weight:800;
    }

    /* Search results drawer */
    .results{
      position:absolute; left:50%; top: calc(var(--top-safe) + 62px);
      transform: translateX(-50%);
      width:min(92vw, 760px); max-height: 50svh; overflow:auto;
      background: rgba(10,10,14,.86);
      border-radius:14px; padding:8px; display:none; z-index:6;
      box-shadow: 0 18px 60px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.08);
    }
    .res-item{
      display:flex; align-items:center; gap:12px; padding:10px; border-radius:10px;
      background: rgba(255,255,255,.03);
      margin:6px 0;
    }
    .res-item:hover{ background: rgba(255,255,255,.06) }
    .res-flag{ width:22px; height:14px; object-fit:cover; border-radius:3px; }
    .res-meta{ display:grid; gap:4px; }
    .res-handle{ font-weight:800; font-size:13px }
    .res-sub{ color:var(--muted); font-size:12px }
    .res-cta{
      margin-left:auto;
      background:linear-gradient(180deg,var(--gold-1),var(--gold-2));
      color:#000; border:none; border-radius:10px; padding:8px 10px; cursor:pointer; font-weight:800;
    }

    /* Streams */
    .arena{
      position:relative; display:grid; grid-template-columns: 1fr 1fr; gap:0; min-height:0;
    }
    .pane{ position:relative; overflow:hidden; min-width:0; }
    video.stream{
      width:100%; height:100%; object-fit:cover; display:block; background:#000;
      filter: brightness(.96) contrast(1.08) saturate(1.06);
    }
    .pane.inactive::before{
      content:""; position:absolute; inset:0; background:rgba(0,0,0,.32); z-index:2;
      backdrop-filter: blur(1.5px);
    }
    .pane::after{
      content:""; position:absolute; inset:0; pointer-events:none;
      background:
        linear-gradient(to right, rgba(255,255,255,.05), transparent 20% 80%, rgba(255,255,255,.05)),
        radial-gradient(1100px 360px at 10% 0%, rgba(255,215,0,.08), transparent 70%),
        radial-gradient(1100px 360px at 90% 0%, rgba(148,0,255,.07), transparent 70%);
      mix-blend-mode:screen; animation: paneSheen 6s ease-in-out infinite alternate;
      z-index:1;
    }
    @keyframes paneSheen{ from{opacity:.3} to{opacity:.58} }

    /* Pane labels */
    .meta{
      position:absolute; left:12px; bottom:12px; z-index:3;
      display:flex; align-items:center; gap:8px;
      background:var(--glass); backdrop-filter:blur(10px);
      padding:8px 12px; border-radius:12px; font-size:12px;
    }
    .meta img.flag{ width:18px; height:12px; border-radius:2px; object-fit:cover; }

    /* Center timer */
    .mid{
      pointer-events:none; position:absolute; inset:0; display:grid; place-items:center; z-index:4;
    }
    .timer{
      background:var(--glass); backdrop-filter:blur(8px);
      padding:10px 18px; border-radius:999px; font-weight:800; font-size:15px;
      text-shadow:0 0 12px rgba(255,215,0,.18);
    }
    .timer.animate{ animation:pulse 1.8s infinite; }
    @keyframes pulse{ 0%,100%{transform:scale(1)} 50%{transform:scale(1.06)} }

    /* Bottom shapes (same family as Arena) */
    .bottom{
      display:flex; align-items:center; justify-content:center; gap:22px;
      padding: 8px clamp(12px,2.5vw,20px) calc(var(--bottom-safe) + 8px);
    }
    .shape{
      appearance:none; background:transparent; border:none; padding:0;
      width:26px; height:26px; display:grid; place-items:center; cursor:pointer;
      filter: drop-shadow(0 0 10px rgba(255,255,255,.08));
      transition: transform .18s ease, filter .18s ease;
    }
    .shape:hover{ transform:translateY(-2px) scale(1.08); filter:brightness(1.08); }
    .shape svg{ width:100%; height:100%; stroke:#cfcfcf; fill:none; stroke-width:2.2; }
    .shape.gold svg{ stroke:url(#goldStroke); }

    /* Share toast */
    .share-cta{
      position:fixed; left:50%; bottom: calc(var(--bottom-safe) + 20px);
      transform:translateX(-50%); z-index:6; display:none;
    }
    .share-cta .pill{ padding:8px 14px }

    /* Mobile tweaks */
    @media (max-width: 900px){
      .shape{ width:24px; height:24px }
      .search input{ width: min(70vw, 520px); }
    }
  </style>
</head>
<body>
  <!-- Gold stroke gradient for vector shapes -->
  <svg width="0" height="0" style="position:absolute">
    <defs>
      <linearGradient id="goldStroke" x1="0%" y1="0%" x2="0%" y2="100%">
        <stop offset="0%" stop-color="#fff4b0"/>
        <stop offset="60%" stop-color="#ffd700"/>
        <stop offset="100%" stop-color="#ffbf2e"/>
      </linearGradient>
    </defs>
  </svg>

  <!-- Ambient layers -->
  <div class="depth-stage" aria-hidden="true">
    <div class="layer-nebula"></div>
    <div class="layer-stars"></div>
  </div>

  <div class="wrap" role="application" aria-label="Live Arena Viewer">
    <!-- TOP -->
    <header class="top">
      <div class="hud-left">
        <button id="liveBtn" class="pill">LIVE</button>
        <div id="viewerChip" class="chip">üëÅ 0</div>
      </div>

      <!-- SEARCH CENTER -->
      <div class="search" id="searchBox" role="search">
        <input id="searchInput" type="text" placeholder="Search battles by country, city, or region‚Ä¶ (e.g., Japan, Paris, West Coast)"/>
        <button id="searchBtn">Search</button>
      </div>

      <div class="hud-right">
        <button id="shareBtn" class="btn-ghost">Share</button>
        <button id="muteBtn" class="btn-ghost" aria-pressed="false">Mute</button>
      </div>

      <!-- Results drawer -->
      <div class="results" id="resultsDrawer" role="listbox" aria-label="Search results"></div>
    </header>

    <!-- ARENA -->
    <main class="arena">
      <!-- Competitor A -->
      <section class="pane" id="paneA">
        <video id="videoA" class="stream" autoplay playsinline muted></video>
        <div class="meta"><span id="nameA">@CompetitorA</span> ¬∑ <img class="flag" id="flagA" src="flag_us.png" alt="flag"/><span id="countryA">United States</span></div>
      </section>

      <!-- Competitor B -->
      <section class="pane" id="paneB">
        <video id="videoB" class="stream" autoplay playsinline muted></video>
        <div class="meta"><span id="nameB">@CompetitorB</span> ¬∑ <img class="flag" id="flagB" src="flag_jp.png" alt="flag"/><span id="countryB">Japan</span></div>
      </section>

      <!-- Center overlays -->
      <div class="mid">
        <div id="timer" class="timer">Loading battle‚Ä¶</div>
      </div>
    </main>

    <!-- BOTTOM shapes (keep like Arena) -->
    <footer class="bottom" aria-label="Navigation">
      <button class="shape gold" id="homeBtn" title="Home">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"/></svg>
      </button>
      <button class="shape" id="boardBtn" title="Leaderboard">
        <svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
      </button>
      <button class="shape gold" id="discoverBtn" title="Discover">
        <svg viewBox="0 0 24 24"><polygon points="12,4 20,12 12,20 4,12"/></svg>
      </button>
      <button class="shape" id="profileBtn" title="Profile">
        <svg viewBox="0 0 24 24"><path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-4 0-8 2-8 5 0 1 0 1 0 1h16s0 0 0-1c0-3-4-5-8-5Z"/></svg>
      </button>
    </footer>

    <!-- Share toast -->
    <div class="share-cta" id="shareCta"><button class="pill">üîó Link copied</button></div>
  </div>

  <!-- Scripts -->
  <script type="module">
    /**
     * VIEWER-ONLY page. New features vs previous version:
     *  - Removed vote counts
     *  - Added global search for live battles by country/area; results drawer with "Watch" CTA
     *  - Kept Arena-like shape nav icons; overall visual polish
     */

    // ---------- Helpers ----------
    const $ = (q)=>document.querySelector(q);
    const byId = (id)=>document.getElementById(id);
    const params = new URLSearchParams(location.search);
    let battleId = params.get('battle') || '';  // can change if user clicks a search result
    let roomId   = params.get('room')   || '';

    const videoA = byId('videoA');
    const videoB = byId('videoB');
    const paneA = byId('paneA');
    const paneB = byId('paneB');

    const nameA = byId('nameA'); const nameB = byId('nameB');
    const flagA = byId('flagA'); const flagB = byId('flagB');
    const countryA = byId('countryA'); const countryB = byId('countryB');

    const timerEl = byId('timer');
    const viewerChip = byId('viewerChip');
    const resultsDrawer = byId('resultsDrawer');
    const searchInput = byId('searchInput');

    // Nav links
    byId('homeBtn').onclick = ()=> location.href='home.html';
    byId('boardBtn').onclick = ()=> location.href='leaderboard.html';
    byId('discoverBtn').onclick = ()=> location.href='discover.html';
    byId('profileBtn').onclick = ()=> location.href='profile.html';

    // ---------- Firebase ----------
    import {
      db, functions,
      collection, query, where, orderBy, limit, onSnapshot,
      doc, getDoc, httpsCallable
    } from './js/firebase.js';

    // Callable presence fns (optional if you wired them)
    const viewerJoin  = httpsCallable(functions, 'viewerJoin');   // { battleId, roomId }
    const viewerLeave = httpsCallable(functions, 'viewerLeave');  // { battleId, roomId }

    // ---------- Presence ----------
    async function joinPresence(){ try{ if(battleId) await viewerJoin({ battleId, roomId }); }catch{} }
    async function leavePresence(){ try{ if(battleId) await viewerLeave({ battleId, roomId }); }catch{} }
    window.addEventListener('pagehide', leavePresence);
    window.addEventListener('beforeunload', leavePresence);

    // ---------- Battle subscription ----------
    let countdownRAF = 0;
    const current = { status:'loading', round:1, part:0, turnEndsAt:null };

    function showTimer(t){ timerEl.textContent = t; }
    function updateTurnUI(){
      if(current.part === 0){ paneA.classList.remove('inactive'); paneB.classList.add('inactive'); }
      else{ paneA.classList.add('inactive'); paneB.classList.remove('inactive'); }
    }
    function startAccurateCountdown(turnEndsAtMillis){
      cancelAnimationFrame(countdownRAF);
      timerEl.classList.add('animate');
      const tick = ()=>{
        const now = Date.now();
        const ms = Math.max(0, turnEndsAtMillis - now);
        const s  = Math.ceil(ms/1000);
        const label = (current.part===0?'@A':'@B');
        timerEl.textContent = `Round ${current.round}/3 | ${label} | ${s}s`;
        if(ms<=0){ timerEl.classList.remove('animate'); return; }
        countdownRAF = requestAnimationFrame(tick);
      };
      countdownRAF = requestAnimationFrame(tick);
    }

    async function hydrateCompetitors(b){
      const A = b.competitorA || b.a || {};
      const B = b.competitorB || b.b || {};
      nameA.textContent = A.handle || '@CompetitorA';
      nameB.textContent = B.handle || '@CompetitorB';
      countryA.textContent = A.country || '‚Äî';
      countryB.textContent = B.country || '‚Äî';
      if(A.flagUrl){ flagA.src = A.flagUrl; flagA.style.visibility='visible'; }
      if(B.flagUrl){ flagB.src = B.flagUrl; flagB.style.visibility='visible'; }
    }

    let unsubBattle = null;
    async function subscribeBattle(id){
      if(unsubBattle){ unsubBattle(); unsubBattle = null; }
      if(!id){ showTimer('Select a battle to watch'); return; }

      const ref = doc(db,'battles', id);
      const first = await getDoc(ref);
      if(!first.exists()){ showTimer('Battle not found'); return; }

      unsubBattle = onSnapshot(ref, (snap)=>{
        const b = snap.data(); if(!b) return;

        current.status = b.status || current.status;
        current.round  = b.round  ?? current.round;
        current.part   = b.part   ?? current.part;
        updateTurnUI();

        hydrateCompetitors(b);

        if(b.turnEndsAt?.toMillis){ startAccurateCountdown(b.turnEndsAt.toMillis()); }
        else{
          timerEl.classList.remove('animate');
          if(current.status==='live') showTimer(`Round ${current.round}/3`);
          else if(current.status==='finished') showTimer('üî• Battle Over üî•');
          else showTimer('Waiting‚Ä¶');
        }

        if(typeof b.viewers === 'number'){ viewerChip.textContent = `üëÅ ${b.viewers}`; }
      });
    }

    // ---------- Search (countries/areas) ----------
    // Strategy: listen to a limited window of live battles and client-filter by term.
    // For larger scale, move filtering into a Cloud Function / Algolia index.
    const LIVE_LIMIT = 30;
    let liveUnsub = null;
    let liveCache = []; // cached list of live battles

    function normalize(str){ return (str||'').toString().toLowerCase(); }

    function renderResults(list){
      const open = list && list.length;
      resultsDrawer.style.display = open ? 'block' : 'none';
      resultsDrawer.innerHTML = (list||[]).map(b=>{
        const a = b.competitorA || b.a || {};
        const ctry = (a.country || b.country || '‚Äî');
        const flag = (a.flagUrl || 'flag_us.png');
        const loc = b.area || b.region || ctry;
        return `
          <div class="res-item" role="option">
            <img class="res-flag" src="${flag}" alt="">
            <div class="res-meta">
              <div class="res-handle">${a.handle || '@CompetitorA'} vs ${(b.competitorB?.handle || b.b?.handle || '@CompetitorB')}</div>
              <div class="res-sub">${ctry}${loc && loc!==ctry ? ' ¬∑ '+loc : ''}</div>
            </div>
            <button class="res-cta" data-battle="${b.id}" data-room="${b.liveRoomId||''}">Watch</button>
          </div>
        `;
      }).join('');
      resultsDrawer.querySelectorAll('.res-cta').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const id = e.currentTarget.dataset.battle;
          const room = e.currentTarget.dataset.room || '';
          // navigate to this battle in-place
          battleId = id; roomId = room;
          resultsDrawer.style.display = 'none';
          history.replaceState({}, '', `?battle=${encodeURIComponent(battleId)}${roomId?`&room=${encodeURIComponent(roomId)}`:''}`);
          // restart presence + subscription + media
          (async()=>{
            await leavePresence();
            await joinPresence();
            await subscribeBattle(battleId);
            await joinRoom(roomId); // reattach media
          })();
        });
      });
    }

    async function subscribeLiveList(){
      if(liveUnsub) liveUnsub();
      const qLive = query(
        collection(db,'battles'),
        where('status','==','live'),
        orderBy('createdAt','desc'),
        limit(LIVE_LIMIT)
      );
      liveUnsub = onSnapshot(qLive, snap=>{
        liveCache = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        // if user hasn't typed, keep drawer hidden
        const term = normalize(searchInput.value.trim());
        if(term){
          applySearch(term);
        }
      });
    }

    function applySearch(term){
      const t = normalize(term);
      if(!t){ resultsDrawer.style.display='none'; resultsDrawer.innerHTML=''; return; }
      const res = liveCache.filter(b=>{
        const A = b.competitorA || b.a || {};
        const B = b.competitorB || b.b || {};
        const hay = [
          A.handle, A.country, b.country, b.region, b.area,
          B.handle, B.country,
          b.title, b.tags && b.tags.join(' ')
        ].map(normalize).join(' ');
        return hay.includes(t) || hay.split(/\s+/).some(w=> w && t.includes(w));
      }).slice(0, 20);
      renderResults(res);
    }

    byId('searchBtn').addEventListener('click', ()=>{
      applySearch(searchInput.value);
    });
    searchInput.addEventListener('input', (e)=>{
      const val = e.currentTarget.value;
      if(val.length>=2) applySearch(val);
      else { resultsDrawer.style.display='none'; resultsDrawer.innerHTML=''; }
    });
    // close results when clicking outside
    document.addEventListener('click', (e)=>{
      const box = byId('searchBox');
      if(!box.contains(e.target) && !resultsDrawer.contains(e.target)){
        resultsDrawer.style.display='none';
      }
    });

    // ---------- Share / Mute ----------
    const shareBtn = byId('shareBtn'); const shareCta = byId('shareCta');
    shareBtn.addEventListener('click', async ()=>{
      const url = location.href;
      const data = { title:'Watch this Battle', text:'Pull up to the BattleBillions live', url };
      try{
        if(navigator.share){ await navigator.share(data); }
        else{
          await navigator.clipboard.writeText(url);
          shareCta.style.display='block';
          setTimeout(()=> shareCta.style.display='none', 1400);
        }
      }catch{}
    });

    const muteBtn = byId('muteBtn'); let muted = false;
    function applyMute(){
      videoA.muted = muted; videoB.muted = muted;
      muteBtn.setAttribute('aria-pressed', String(muted));
      muteBtn.textContent = muted ? 'Unmute' : 'Mute';
    }
    muteBtn.addEventListener('click', ()=>{
      muted = !muted; applyMute();
      if(!muted){ videoA.play().catch(()=>{}); videoB.play().catch(()=>{}); }
    });

    // ---------- SFU / playback stub ----------
    async function joinRoom(roomId){
      // If no room is supplied, demo fallback media.
      if(!roomId){
        videoA.src = 'user2.mp4'; videoB.src = 'user3.mp4';
        videoA.loop = videoB.loop = true;
        await Promise.allSettled([videoA.play(), videoB.play()]);
        return;
      }
      // Plug-in your SFU client here to attach remote tracks to videoA/videoB.
      // Example:
      // const rtc = new YourSfuClient({ url, token });
      // await rtc.join(roomId);
      // const trackA = await rtc.subscribe('A'); videoA.srcObject = trackA.stream;
      // const trackB = await rtc.subscribe('B'); videoB.srcObject = trackB.stream;
      // await videoA.play().catch(()=>{}); await videoB.play().catch(()=>{});
    }

    // ---------- Boot ----------
    (async function boot(){
      // height fix for mobile 100vh
      const root = $('.wrap');
      const setH = ()=>{ root.style.height = window.innerHeight+'px'; };
      setH(); addEventListener('resize', setH, {passive:true});

      applyMute();
      await subscribeLiveList();
      await subscribeBattle(battleId);
      await joinPresence();
      await joinRoom(roomId);
    })();
  </script>
</body>
</html>
