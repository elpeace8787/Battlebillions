<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"/>
  <title>BattleBillions â€” Live Feed</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#eaeaea;
      --muted:#b8b8b8;
      --glass: rgba(12,12,16,.55);
      --glass-2: rgba(20,20,26,.6);
      --cyan:#47f5ff;         /* search accent */
      --magenta:#ff53e1;      /* vote accent */
      --purple:#9f7bff;       /* comments accent */
      --red:#ff4c6a;          /* flag accent */
      --grey:#c7c7c7;         /* mute accent */
      --gold:#ffd700;         /* nav icons */
      --safe-top: max(10px, env(safe-area-inset-top));
      --safe-bottom: max(14px, env(safe-area-inset-bottom));
      --side-pad: 56px;       /* room for side navs */
    }

    /* RESET */
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{
      height:100%;
      width:100%;
      background:#000;
      color:var(--ink);
      font-family:'Orbitron',sans-serif;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
      overscroll-behavior: none;
    }
    /* hide scrollbars (feed still scrolls) */
    *::-webkit-scrollbar{ width:0; height:0; display:none }
    *{ scrollbar-width: none }

    /* BACKGROUND 3D */
    #bg3d{
      position:fixed; inset:0; z-index:0; display:block; pointer-events:none;
      background:radial-gradient(1200px 800px at 30% 20%, #0a0a0d 0%, #000 70%);
    }

    /* APP LAYOUT */
    .live-container{
      position:relative; z-index:1;
      min-height:100dvh;
      padding: var(--safe-top) var(--side-pad) calc(var(--safe-bottom) + 84px);
    }

    /* TOP SEARCH */
    .top-bar{
      position:sticky; top:0; z-index:5;
      display:flex; justify-content:center; padding:8px 0 10px;
      background: linear-gradient(180deg, rgba(0,0,0,.65), rgba(0,0,0,.25));
      backdrop-filter: blur(12px);
    }
    .search-wrap{
      position:relative; width:min(92vw, 420px);
      display:flex; align-items:center; gap:8px;
      background:rgba(255,255,255,.06);
      border-radius:18px; padding:6px 10px;
      box-shadow:0 0 22px rgba(71,245,255,.18), inset 0 0 0 1px rgba(71,245,255,.22);
    }
    .search-wrap input{
      flex:1; border:none; outline:none; background:transparent; color:#fff; font-size:13px;
      font-family:inherit;
    }
    .clear-btn{
      appearance:none; border:none; background:transparent; color:#bfefff; font-weight:800; cursor:pointer;
      padding:4px 6px; border-radius:8px; display:none;
    }
    .clear-btn.show{ display:inline-block; }
    .auto-list{
      position:absolute; left:0; right:0; top:calc(100% + 8px);
      background:rgba(10,12,16,.95); border-radius:12px; padding:6px; display:none; z-index:10;
      box-shadow: 0 16px 42px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.06);
      max-height:40dvh; overflow:auto;
    }
    .auto-item{
      padding:8px 10px; border-radius:10px; font-size:13px; color:#defbff; cursor:pointer;
    }
    .auto-item:hover{ background:rgba(255,255,255,.06); }

    /* FEED */
    .feed{ display:grid; gap:14px; margin-top:10px; }
    .card{
      background: var(--glass-2);
      border-radius:16px; padding:12px;
      -webkit-backdrop-filter: blur(12px); backdrop-filter: blur(12px);
      box-shadow: 0 14px 40px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06);
    }
    .split{
      display:grid; grid-template-columns:1fr 1fr; gap:8px; border-radius:12px; overflow:hidden;
    }
    /* BIGGER BATTLE SCREENS */
    .pane{ position:relative; min-height: 52dvh; background:#000; border-radius:12px; overflow:hidden; }
    @media (max-width:700px){ .pane{ min-height: 58dvh } }
    .pane video{ width:100%; height:100%; object-fit:cover; display:block; background:#000; }

    /* OVERLAYS: avatar + flag badge + rank badge */
    .overlay{
      position:absolute; left:10px; top:10px; display:flex; align-items:center; gap:8px; z-index:2;
    }
    .avatar{
      position:relative; width:54px; height:54px; border-radius:50%; overflow:hidden;
      box-shadow:0 0 14px rgba(0,0,0,.45), 0 0 10px rgba(255,255,255,.08);
      background:#111;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .flag-badge{
      position:absolute; right:-2px; bottom:-2px; width:18px; height:12px; border-radius:3px; object-fit:cover;
      box-shadow:0 0 8px rgba(0,0,0,.5);
      border:1px solid rgba(255,255,255,.6);
      background:#000;
    }
    .name{
      font-weight:800; font-size:13px; letter-spacing:.2px; text-shadow:0 2px 6px rgba(0,0,0,.5);
    }
    .rank-row{
      position:absolute; left:10px; top:72px; display:flex; gap:6px; z-index:2;
    }
    .rank-badge{
      min-width:22px; height:22px; border-radius:999px; display:grid; place-items:center;
      font-size:11px; font-weight:800; color:#000;
      background:linear-gradient(180deg,#fff1a8,#ffd700);
      box-shadow:0 0 10px rgba(255,215,0,.35), inset 0 0 0 1px rgba(0,0,0,.15);
    }
    .rank-badge.silver{ background:linear-gradient(180deg,#fafafa,#cfcfcf) }
    .rank-badge.bronze{ background:linear-gradient(180deg,#ffd7b0,#c8903c) }

    /* VOTE BUTTONS under each panel */
    .panel-actions{
      margin-top:8px; display:flex; gap:8px; justify-content:space-between;
    }
    .pill{
      flex:1; border:none; cursor:pointer; border-radius:12px; padding:10px 12px; font-weight:800;
      background: linear-gradient(180deg, rgba(255,83,225,.18), rgba(159,123,255,.18));
      color:#fff; box-shadow: inset 0 0 0 1px rgba(255,83,225,.45), 0 0 14px rgba(159,123,255,.18);
    }
    .pill:hover{ filter:brightness(1.08) }

    /* CARD ACTIONS (visible) */
    .actions{
      margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .a-btn{
      border:none; border-radius:999px; padding:8px 12px; cursor:pointer; font-weight:800; font-size:12px; color:#000;
      display:inline-flex; align-items:center; gap:8px;
    }
    .a-share{ background: linear-gradient(180deg,#c8f6ff,#47f5ff) }
    .a-comment{ background: linear-gradient(180deg,#ffd4ff,#ff53e1) }
    .a-mute{ background: linear-gradient(180deg,#f2f2f2,#c7c7c7) }
    .a-flag{ background: linear-gradient(180deg,#ffc2cf,#ff4c6a) }
    .a-btn span{ color:#111 }

    /* TITLE/INFO ROW (flags only) */
    .info{
      display:flex; align-items:center; justify-content:space-between; margin-top:10px;
    }
    .meta{
      display:flex; align-items:center; gap:8px; color:var(--muted); font-size:12px;
    }
    .meta .flag{ width:18px; height:12px; border-radius:3px; object-fit:cover; border:1px solid rgba(255,255,255,.6) }

    /* SIDEBARS: Arena-style icons */
    nav.side{
      position:fixed; top:50%; transform:translateY(-50%); display:flex; flex-direction:column; gap:20px; z-index:6;
    }
    nav.side.left{ left:16px }
    nav.side.right{ right:16px }
    .shape{
      background:none; border:none; cursor:pointer; width:36px; height:36px; display:flex; align-items:center; justify-content:center;
      filter: drop-shadow(0 0 10px rgba(255,255,255,.08));
      transition: transform .18s ease, filter .18s ease;
    }
    .shape:active{ transform: scale(.96) }
    .shape:hover{ transform:translateY(-2px) scale(1.06); filter:brightness(1.08); }
    .shape svg{ width:100%; height:100%; fill:none; }
    .strokeline{ stroke: var(--gold); stroke-width:2.2; }
    .shape.logout .strokeline{ stroke:#ff4c4c }

    /* Bottom-center triangle */
    .center-triangle{ position:fixed; left:50%; bottom:14px; transform:translateX(-50%); z-index:6 }

    @media (max-width: 600px){
      .live-container{ padding-left:50px; padding-right:50px }
      .shape{ width:30px; height:30px }
    }

    /* EMPTY STATE */
    .empty{ text-align:center; color:#e8e8e8; opacity:.85; padding:18px 0 6px; font-size:13px }
  </style>
</head>
<body>
  <!-- Background explosions -->
  <canvas id="bg3d" aria-hidden="true"></canvas>

  <div class="live-container">
    <!-- Top: Search -->
    <div class="top-bar">
      <div class="search-wrap" role="search">
        <input id="searchInput" type="text" inputmode="search" placeholder="Search by country, city, or usernameâ€¦" autocomplete="off"/>
        <button id="clearBtn" class="clear-btn" aria-label="Clear search">âœ–</button>
        <div id="autoList" class="auto-list" role="listbox" aria-label="Suggestions"></div>
      </div>
    </div>

    <!-- FEED -->
    <section id="feed" class="feed" aria-label="Live Battles Feed"><!-- cards injected --></section>
    <div id="emptyMsg" class="empty" style="display:none">No battles found</div>
  </div>

  <!-- LEFT side (circle over square) -->
  <nav class="side left" aria-label="Left sidebar">
    <button class="shape" data-link="home.html" title="Home" aria-label="Home">
      <svg viewBox="0 0 24 24" aria-hidden="true"><circle class="strokeline" cx="12" cy="12" r="9"/></svg>
    </button>
    <button class="shape" data-link="leaderboard.html" title="Leaderboard" aria-label="Leaderboard">
      <svg viewBox="0 0 24 24" aria-hidden="true"><rect class="strokeline" x="6" y="6" width="12" height="12" rx="2"/></svg>
    </button>
  </nav>

  <!-- RIGHT side (diamond over X) -->
  <nav class="side right" aria-label="Right sidebar">
    <button class="shape" data-link="discover.html" title="Discover" aria-label="Discover">
      <svg viewBox="0 0 24 24" aria-hidden="true"><polygon class="strokeline" points="12,4 20,12 12,20 4,12"/></svg>
    </button>
    <button class="shape logout" id="logoutBtn" title="Logout" aria-label="Logout">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <line class="strokeline" x1="6" y1="6" x2="18" y2="18"/>
        <line class="strokeline" x1="18" y1="6" x2="6" y2="18"/>
      </svg>
    </button>
  </nav>

  <!-- Bottom-center triangle -->
  <div class="center-triangle">
    <button class="shape" id="uploadBeatOpen" title="Upload Beat" aria-label="Upload Beat">
      <svg viewBox="0 0 24 24" aria-hidden="true"><polygon class="strokeline" points="12,5 20,19 4,19"/></svg>
    </button>
  </div>

  <!-- Three.js -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script>
    /***********************
     * REGION COLOR MAPPING
     ***********************/
    const REGION_COLORS = {
      ASIA:   { c1: 0xff3b3b, c2: 0xff7a7a },      // reds
      AFRICA: { c1: 0x1ad67b, c2: 0x6df0a9 },      // greens
      NA:     { c1: 0x4cb6ff, c2: 0x9dd7ff },      // blues
      EUROPE: { c1: 0x9f7bff, c2: 0xd0c2ff },      // purples
      SA:     { c1: 0xff8c3a, c2: 0xffc28f },      // oranges
      OCE:    { c1: 0x42f9ff, c2: 0xaefbff },      // cyans
    };
    // quick country->region map (extend as needed)
    const COUNTRY_REGION = {
      US:'NA', CA:'NA', MX:'NA',
      JP:'ASIA', CN:'ASIA', KR:'ASIA', IN:'ASIA',
      NG:'AFRICA', ZA:'AFRICA', EG:'AFRICA',
      FR:'EUROPE', DE:'EUROPE', IT:'EUROPE', GB:'EUROPE', ES:'EUROPE',
      BR:'SA', AR:'SA', CL:'SA', CO:'SA', PE:'SA',
      AU:'OCE', NZ:'OCE'
    };

    /***********************
     * DEMO BATTLES
     ***********************/
    const demoBattles = [
      {
        id:'b1',
        a:{handle:'@Nova',  avatar:'user2.jpg', flag:'flag_jp.png', country:'JP', video:'user2.mp4', rank:1},
        b:{handle:'@Kiro',  avatar:'user3.jpg', flag:'flag_us.png', country:'US', video:'user3.mp4', rank:4},
        location:'Tokyo, Japan'
      },
      {
        id:'b2',
        a:{handle:'@Ari',   avatar:'user4.jpg', flag:'flag_fr.png', country:'FR', video:'user4.mp4', rank:2},
        b:{handle:'@Zed',   avatar:'user3.jpg', flag:'flag_br.png', country:'BR', video:'user3.mp4', rank:12},
        location:'Paris, France'
      },
      {
        id:'b3',
        a:{handle:'@Sol',   avatar:'user2.jpg', flag:'flag_jp.png', country:'JP', video:'user2.mp4', rank:7},
        b:{handle:'@Vento', avatar:'user4.jpg', flag:'flag_it.png', country:'IT', video:'user4.mp4', rank:9},
        location:'Rome, Italy'
      },
      {
        id:'b4',
        a:{handle:'@Rico',  avatar:'user4.jpg', flag:'flag_br.png', country:'BR', video:'user4.mp4', rank:3},
        b:{handle:'@Lyra',  avatar:'user3.jpg', flag:'flag_ca.png', country:'CA', video:'user3.mp4', rank:5},
        location:'Toronto, Canada'
      }
    ];

    /***********************
     * BUILD FEED CARDS
     ***********************/
    const feedEl = document.getElementById('feed');
    const emptyMsg = document.getElementById('emptyMsg');

    function rankBadge(rank){
      if(rank == null || rank > 9) return '';
      const cls = rank===1 ? '' : (rank<=3 ? 'silver' : 'bronze');
      return `<div class="rank-badge ${cls}">${rank}</div>`;
    }

    function makeCard(b){
      // Determine regions for explosion colors (used by background engine too)
      const regionA = COUNTRY_REGION[b.a.country] || 'NA';
      const regionB = COUNTRY_REGION[b.b.country] || regionA;

      const card = document.createElement('article');
      card.className = 'card';
      card.dataset.location = (b.location||'').toLowerCase();
      card.dataset.handles = (`${b.a.handle} ${b.b.handle}`).toLowerCase();
      card.dataset.regionA = regionA;
      card.dataset.regionB = regionB;

      card.innerHTML = `
        <div class="split">
          <!-- LEFT PANE (A) -->
          <div class="pane">
            <video playsinline muted loop preload="metadata" src="${b.a.video}"></video>

            <div class="overlay">
              <div class="avatar">
                <img src="${b.a.avatar}" alt="${b.a.handle}">
                <img class="flag-badge" src="${b.a.flag}" alt="">
              </div>
              <div class="name">${b.a.handle}</div>
            </div>
            <div class="rank-row">
              ${rankBadge(b.a.rank)}
            </div>

            <div class="panel-actions">
              <button class="pill" data-vid="A" data-act="voteA">Vote A</button>
            </div>
          </div>

          <!-- RIGHT PANE (B) -->
          <div class="pane">
            <video playsinline muted loop preload="metadata" src="${b.b.video}"></video>

            <div class="overlay">
              <div class="avatar">
                <img src="${b.b.avatar}" alt="${b.b.handle}">
                <img class="flag-badge" src="${b.b.flag}" alt="">
              </div>
              <div class="name">${b.b.handle}</div>
            </div>
            <div class="rank-row">
              ${rankBadge(b.b.rank)}
            </div>

            <div class="panel-actions">
              <button class="pill" data-vid="B" data-act="voteB">Vote B</button>
            </div>
          </div>
        </div>

        <div class="info">
          <div class="meta">
            <!-- show flags only (no country text) -->
            <img class="flag" src="${b.a.flag}" alt="">
            <span>vs</span>
            <img class="flag" src="${b.b.flag}" alt="">
          </div>
          <div class="meta">
            <span>Live now</span>
          </div>
        </div>

        <div class="actions">
          <button class="a-btn a-share"  data-act="share"  data-id="${b.id}">ðŸ”— <span>Share</span></button>
          <button class="a-btn a-comment" data-act="comment" data-id="${b.id}">ðŸ’¬ <span>Comment</span></button>
          <button class="a-btn a-mute"   data-act="mute"   data-id="${b.id}">ðŸ”‡ <span>Mute</span></button>
          <button class="a-btn a-flag"   data-act="flag"   data-id="${b.id}">ðŸš© <span>Flag</span></button>
        </div>
      `;

      // auto play previews when visible
      observeVideo(card.querySelectorAll('video'));
      // attach action handlers
      card.querySelectorAll('[data-act]').forEach(btn=>{
        btn.addEventListener('click', ()=> onCardAction(btn, card));
      });
      return card;
    }

    function populateFeed(list){
      feedEl.innerHTML = '';
      list.forEach(b=> feedEl.appendChild(makeCard(b)));
      emptyMsg.style.display = list.length ? 'none' : 'block';
    }

    /***********************
     * SEARCH + AUTOCOMPLETE
     * - Now matches location (country/city) AND usernames (handles)
     ***********************/
    const searchInput = document.getElementById('searchInput');
    const clearBtn = document.getElementById('clearBtn');
    const autoList = document.getElementById('autoList');

    // Build suggestions from locations + usernames
    const suggestSet = new Set();
    demoBattles.forEach(b=>{
      suggestSet.add(b.location);
      suggestSet.add(b.a.handle);
      suggestSet.add(b.b.handle);
    });
    const SUGGESTIONS = Array.from(suggestSet);

    function applyFilter(term){
      const t = (term||'').toLowerCase().trim();
      const cards = Array.from(feedEl.children);
      let shown = 0;
      if(!t){
        cards.forEach(c=> c.style.display='');
        shown = cards.length;
      }else{
        cards.forEach(c=>{
          const loc = c.dataset.location || '';
          const handles = c.dataset.handles || '';
          // partial + exact supported (location OR username)
          const match = (loc.includes(t) || t.includes(loc) || handles.includes(t) || t.includes(handles));
          c.style.display = match ? '' : 'none';
          if(match) shown++;
        });
      }
      emptyMsg.style.display = shown ? 'none' : 'block';
    }

    function updateAutocomplete(term){
      const t = (term||'').toLowerCase().trim();
      autoList.innerHTML = '';
      if(!t){ autoList.style.display='none'; return; }
      const matches = SUGGESTIONS
        .filter(s=> s.toLowerCase().includes(t))
        .slice(0,10);
      if(!matches.length){ autoList.style.display='none'; return; }
      matches.forEach(m=>{
        const div = document.createElement('div');
        div.className='auto-item';
        div.textContent = m;
        div.addEventListener('click', ()=>{
          searchInput.value = m;
          clearBtn.classList.add('show');
          autoList.style.display='none';
          applyFilter(m);
        });
        autoList.appendChild(div);
      });
      autoList.style.display='block';
    }

    searchInput.addEventListener('input', ()=>{
      const v = searchInput.value;
      clearBtn.classList.toggle('show', !!v.length);
      updateAutocomplete(v);
      applyFilter(v);
    });
    clearBtn.addEventListener('click', ()=>{
      searchInput.value=''; clearBtn.classList.remove('show'); autoList.style.display='none';
      applyFilter('');
    });
    document.addEventListener('click', (e)=>{
      if(!autoList.contains(e.target) && !e.target.isSameNode(searchInput)){
        autoList.style.display='none';
      }
    });

    /***********************
     * VIDEO OBSERVER
     ***********************/
    const previewObserver = new IntersectionObserver((entries)=>{
      entries.forEach(async (entry)=>{
        const vid = entry.target;
        if(entry.isIntersecting){
          try{ await vid.play(); }catch{}
        }else{
          try{ vid.pause(); }catch{}
        }
      });
    }, { root: null, threshold: 0.4 });

    function observeVideo(nodeList){
      nodeList.forEach(v=> previewObserver.observe(v));
    }

    /***********************
     * CARD ACTIONS
     ***********************/
    async function onCardAction(btn, card){
      const act = btn.dataset.act;
      if(act==='share'){
        const id = btn.dataset.id;
        const url = `${location.origin}${location.pathname}#watch=${encodeURIComponent(id)}`;
        try{
          if(navigator.share){ await navigator.share({title:'BattleBillions', text:'Pull up to this battle', url}); }
          else{ await navigator.clipboard.writeText(url); toast('Link copied'); }
        }catch{}
      }else if(act==='comment'){
        toast('Comments coming soon');
      }else if(act==='mute'){
        const vids = card.querySelectorAll('video');
        const newState = !(vids[0]?.muted === false && vids[1]?.muted === false);
        vids.forEach(v=> v.muted = newState);
        toast(newState ? 'Muted' : 'Unmuted');
      }else if(act==='flag'){
        toast('Flag submitted');
      }else if(act==='voteA'){
        toast('Voted A');
      }else if(act==='voteB'){
        toast('Voted B');
      }
    }

    function toast(msg){
      const el = document.createElement('div');
      el.textContent = msg;
      el.style.position='fixed';
      el.style.left='50%'; el.style.bottom='calc(var(--safe-bottom) + 24px)';
      el.style.transform='translateX(-50%)';
      el.style.background='rgba(255,255,255,.92)';
      el.style.color='#111'; el.style.fontWeight='800'; el.style.fontSize='12px';
      el.style.padding='8px 12px'; el.style.borderRadius='999px';
      el.style.zIndex='9999'; el.style.boxShadow='0 10px 30px rgba(0,0,0,.35)';
      document.body.appendChild(el);
      setTimeout(()=> el.remove(), 1200);
    }

    /***********************
     * NAV LINKS
     ***********************/
    document.querySelectorAll(".shape[data-link]").forEach(btn=>{
      btn.addEventListener("click", ()=>{ window.location.href = btn.dataset.link; });
    });

    /***********************
     * INIT FEED
     ***********************/
    populateFeed(demoBattles);

    /***********************
     * BACKGROUND EXPLOSIONS
     * - Continuous, color-coded by regions (randomized mix)
     * - Dual-colored bursts to emulate cross-country clashes
     ***********************/
    (function explosions(){
      const reduced = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
      const canvas = document.getElementById('bg3d');

      let glok=true;
      try{
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        if(!gl) throw 0;
      }catch(e){
        glok=false;
      }
      if(!glok) return;

      const renderer = new THREE.WebGLRenderer({ canvas, antialias:false, alpha:true, powerPreference:'high-performance' });
      renderer.setClearColor(0x000000, 0);
      const scene = new THREE.Scene();
      scene.fog = new THREE.FogExp2(0x000000, reduced ? 0.0006 : 0.0009);

      let W=window.innerWidth, H=window.innerHeight;
      const DPR = Math.min(window.devicePixelRatio||1, 1.75);
      renderer.setPixelRatio(DPR); renderer.setSize(W,H,false);

      const camera = new THREE.PerspectiveCamera(55, W/H, 0.1, 3000);
      camera.position.set(0,0,140);

      const hemi = new THREE.HemisphereLight(0xaaaaaa, 0x0a0a0a, 0.6);
      const dir  = new THREE.DirectionalLight(0xffe7a4, 0.5);
      dir.position.set(60,80,120);
      scene.add(hemi,dir);

      // particle sprite
      const particleTex = (()=> {
        const size = 128;
        const c = document.createElement('canvas'); c.width=c.height=size;
        const g = c.getContext('2d');
        const grad = g.createRadialGradient(size/2,size/2,0, size/2,size/2,size/2);
        grad.addColorStop(0,'rgba(255,255,255,0.95)');
        grad.addColorStop(0.35,'rgba(255,255,255,0.35)');
        grad.addColorStop(1,'rgba(255,255,255,0.0)');
        g.fillStyle = grad; g.fillRect(0,0,size,size);
        const tex = new THREE.CanvasTexture(c);
        tex.minFilter = THREE.LinearFilter; tex.magFilter = THREE.LinearFilter; tex.anisotropy = 1;
        return tex;
      })();

      const baseMat = new THREE.PointsMaterial({
        size: (reduced? 16 : 20),
        map: particleTex, transparent:true, depthWrite:false,
        blending:THREE.AdditiveBlending, vertexColors:true, sizeAttenuation:true
      });

      const pool=[]; function getPoints(n){
        for(let i=pool.length-1;i>=0;i--){
          const p=pool[i], existing=p.geometry.getAttribute('position').count;
          if(existing>=n){ pool.splice(i,1); p.visible=true; return p; }
        }
        const g = new THREE.BufferGeometry();
        const pos = new Float32Array(n*3);
        const col = new Float32Array(n*3);
        const siz = new Float32Array(n);
        g.setAttribute('position', new THREE.BufferAttribute(pos,3));
        g.setAttribute('color',    new THREE.BufferAttribute(col,3));
        g.setAttribute('size',     new THREE.BufferAttribute(siz,1));
        const m = baseMat.clone();
        const points = new THREE.Points(g,m); points.frustumCulled=false;
        return points;
      }
      function releasePoints(p){ p.visible=false; pool.push(p); }

      // ring mats created per explosion with chosen colors
      function ringMaterial(hex, op){ return new THREE.MeshBasicMaterial({ color:hex, transparent:true, opacity:op, blending:THREE.AdditiveBlending, side:THREE.DoubleSide }); }

      const explosions=[];
      class Explosion{
        constructor(colorA, colorB){
          const x = (Math.random()*W - W/2)/6;
          const y = (Math.random()*H - H/2)/6;
          const z = Math.random()*(-40) - 10;
          this.center = new THREE.Vector3(x,y,z);

          const dual = colorB && colorB!==colorA;
          this.cA = new THREE.Color(colorA);
          this.cB = new THREE.Color(dual ? colorB : colorA);

          this.life = reduced ? 1.4 : 1.8;
          this.t=0;

          this.count = (Math.random()*50 + (reduced?80:120))|0;
          this.points = getPoints(this.count);
          this.points.position.copy(this.center);

          const g = this.points.geometry;
          const pos = g.getAttribute('position').array;
          const col = g.getAttribute('color').array;
          const siz = g.getAttribute('size').array;

          this.vel = new Float32Array(this.count*3);

          for(let i=0;i<this.count;i++){
            const dirv = new THREE.Vector3().randomDirection();
            const speed = (Math.random()*22 + 12);
            this.vel[i*3+0] = dirv.x*speed;
            this.vel[i*3+1] = dirv.y*speed;
            this.vel[i*3+2] = dirv.z*speed;

            pos[i*3+0] = dirv.x*1.6;
            pos[i*3+1] = dirv.y*1.6;
            pos[i*3+2] = dirv.z*1.6;

            // color blend across particles for dual color clash
            const t = Math.random();
            const c = this.cA.clone().lerp(this.cB, t);
            col[i*3+0] = c.r; col[i*3+1] = c.g; col[i*3+2] = c.b;

            siz[i] = Math.random()*6 + 10;
          }
          g.getAttribute('position').needsUpdate = true;
          g.getAttribute('color').needsUpdate    = true;
          g.getAttribute('size').needsUpdate     = true;
          scene.add(this.points);

          const r1c = this.cA.getHex();
          const r2c = this.cB.getHex();
          const ringGeo = new THREE.RingGeometry(6, 7.6, 64);
          this.ring1 = new THREE.Mesh(ringGeo, ringMaterial(r1c, .85));
          this.ring2 = new THREE.Mesh(ringGeo, ringMaterial(r2c, .6));
          this.ring1.position.copy(this.center);
          this.ring2.position.copy(this.center);
          this.r1=6; this.r2=6;
          scene.add(this.ring1,this.ring2);
        }
        update(dt){
          this.t += dt; const f = this.t/this.life;
          const g = this.points.geometry;
          const pos = g.getAttribute('position').array;
          const siz = g.getAttribute('size').array;

          const drag = 1.0 - Math.min(0.05*dt*60, 0.05);
          for(let i=0;i<this.count;i++){
            const ix=i*3;
            pos[ix+0]+=this.vel[ix+0]*dt;
            pos[ix+1]+=this.vel[ix+1]*dt;
            pos[ix+2]+=this.vel[ix+2]*dt;
            this.vel[ix+0]*=drag; this.vel[ix+1]*=drag; this.vel[ix+2]*=drag;
            siz[i]*=(1-dt*0.12); if(siz[i]<6) siz[i]=6;
          }
          g.getAttribute('position').needsUpdate = true;
          g.getAttribute('size').needsUpdate     = true;

          this.r1 += 110*dt; this.r2 += 135*dt;
          this.ring1.scale.setScalar(this.r1/6);
          this.ring2.scale.setScalar(this.r2/6);
          this.ring1.material.opacity = Math.max(0, 0.9 - f*1.3);
          this.ring2.material.opacity = Math.max(0, 0.7 - f*1.4);
          this.ring1.lookAt(camera.position);
          this.ring2.lookAt(camera.position);

          return this.t < this.life;
        }
        dispose(){
          scene.remove(this.points); releasePoints(this.points);
          scene.remove(this.ring1); scene.remove(this.ring2);
        }
      }

      // schedule
      const MAX = reduced ? 6 : 12;
      let prev = performance.now(), lastBlast = prev;
      const INTERVAL = reduced ? 1500 : 1100;

      function randRegionColor(){
        const keys = Object.keys(REGION_COLORS);
        const r = REGION_COLORS[keys[(Math.random()*keys.length)|0]];
        return [r.c1, r.c2];
      }

      function loop(now){
        const dt = Math.min(0.05,(now-prev)/1000); prev=now;

        if(now - lastBlast > INTERVAL){
          // choose single or dual color
          let [c1a,c1b] = randRegionColor();
          if(Math.random() > .5){
            // dual region clash
            const [c2a, c2b] = randRegionColor();
            c1b = (Math.random()>.5 ? c2a : c2b);
          }
          if(explosions.length > MAX){
            const old = explosions.shift(); old.dispose();
          }
          explosions.push(new Explosion(c1a, c1b));
          lastBlast = now;
        }

        for(let i=explosions.length-1;i>=0;i--){
          if(!explosions[i].update(dt)){
            explosions[i].dispose();
            explosions.splice(i,1);
          }
        }

        camera.lookAt(0,0,0);
        renderer.render(scene,camera);
        requestAnimationFrame(loop);
      }
      function resize(){
        W=window.innerWidth; H=window.innerHeight;
        renderer.setPixelRatio(Math.min(window.devicePixelRatio||1,1.75));
        renderer.setSize(W,H,false);
        camera.aspect=W/H; camera.updateProjectionMatrix();
      }
      window.addEventListener('resize', resize, {passive:true});
      requestAnimationFrame(loop);
    })();
  </script>
</body>
</html>
