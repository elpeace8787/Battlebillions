<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no"/>
  <title>BattleBillions — Dual Live Battle (Mobile-Stable)</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --gold:#ffd700;
      --gold-1:#ffe88a;
      --gold-2:#ffcc3b;
      --ink:#eaeaea;
      --muted:#b8b8b8;
      --beatGlow: 0;
      --top-safe: max(16px, env(safe-area-inset-top));
      --side-safe: max(16px, env(safe-area-inset-left));
      --side-safe-r: max(16px, env(safe-area-inset-right));
      --bottom-safe: max(18px, env(safe-area-inset-bottom));
    }

    *{margin:0;padding:0;box-sizing:border-box}
    html, body{
      height:100%;
      width:100%;
      overflow:hidden;                /* kill page scrollbars */
      -webkit-overflow-scrolling:auto;
      overscroll-behavior:none;
      background:#000;
    }
    /* Hide any platform scrollbars just in case */
    *::-webkit-scrollbar{ display:none; width:0; height:0 }

    body{
      font-family:'Orbitron',sans-serif;
      color:var(--ink);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    /* Depth hint (very light, no scroll impact) */
    .depth-stage{ position:fixed; inset:0; z-index:0; pointer-events:none; }
    .layer-nebula{
      position:absolute; inset:-15%;
      background: conic-gradient(from 0deg at 50% 50%,
        rgba(255,215,0,.10), rgba(0,255,255,.08), rgba(148,0,255,.12), rgba(255,215,0,.10));
      filter: blur(90px) saturate(130%); opacity:.42; animation: nebula 40s linear infinite;
    }
    @keyframes nebula{ to{ transform: rotate(360deg) } }
    .layer-stars{
      position:absolute; inset:0;
      background:
        radial-gradient(1px 1px at 20% 30%, rgba(255,255,255,.09), transparent 60%),
        radial-gradient(1px 1px at 70% 60%, rgba(255,255,255,.07), transparent 60%),
        radial-gradient(1px 1px at 40% 80%, rgba(255,255,255,.06), transparent 60%);
      animation: stars 14s ease-in-out infinite alternate;
    }
    @keyframes stars{ from{filter:brightness(.9)} to{filter:brightness(1.1)} }

    /* Even split; lock to small viewport height to avoid iOS chrome shifts */
    .stream-container{
      position:relative; z-index:1; display:flex;
      height:100svh; width:100svw;      /* <- mobile-stable */
      overflow:hidden;                   /* <- no inner scroll */
      contain:layout paint size;         /* perf & containment */
    }
    .pane{ flex:1; position:relative; overflow:hidden; min-width:0; }
    video.video-stream{
      display:block;
      width:100%; height:100%;
      object-fit:cover; background:#000;
      filter: brightness(.94) contrast(1.12) saturate(1.06);
    }
    #localVideo{ transform:scaleX(-1); }

    /* Subtle sheen (no outlines/boxes) */
    .pane::after{
      content:""; position:absolute; inset:0; pointer-events:none;
      background:
        linear-gradient(to right, rgba(255,255,255,.05), transparent 20% 80%, rgba(255,255,255,.05)),
        radial-gradient(1100px 360px at 10% 0%, rgba(255,215,0,.08), transparent 70%),
        radial-gradient(1100px 360px at 90% 0%, rgba(148,0,255,.07), transparent 70%);
      mix-blend-mode:screen; animation: paneSheen 6s ease-in-out infinite alternate;
    }
    @keyframes paneSheen{ from{opacity:.32} to{opacity:.6} }

    /* Fallback when camera blocked */
    .fallback{
      position:absolute; inset:0; display:none; align-items:center; justify-content:center;
      flex-direction:column; gap:12px; text-align:center; padding:18px;
      background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35));
      font-weight:800; letter-spacing:.3px;
    }
    .pane.error .fallback{ display:flex; }
    .cam-actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
    .btn-mini{
      background:linear-gradient(180deg,var(--gold-1),var(--gold-2)); color:#000; font-weight:800;
      padding:10px 14px; border-radius:10px; cursor:pointer; border:none; box-shadow:0 0 16px rgba(255,215,0,.35);
    }

    /* HUD */
    .top-bar{
      position:absolute; left:0; right:0;
      top: calc(var(--top-safe) + 18px);
      z-index:10; display:flex; justify-content:space-between; padding:0 clamp(12px, 2vw, 20px);
      font-size:14px; pointer-events:none;
    }
    .hud-left{ pointer-events:auto; }
    .hud-live{
      appearance:none; border:none; cursor:pointer;
      background:linear-gradient(180deg,var(--gold-1),var(--gold-2));
      color:#000; padding:6px 14px; border-radius:999px; font-weight:800;
      box-shadow:0 0 18px rgba(255,215,0,.45); text-shadow:0 1px 0 rgba(255,255,255,.4);
    }

    /* Viewer chip centered in opponent pane */
    .viewer-center{
      position:absolute; left:50%;
      top: calc(var(--top-safe) + 14px);
      transform: translateX(-50%);
      z-index:12;
      padding:8px 16px; border-radius:999px;
      background:rgba(0,0,0,.55); backdrop-filter: blur(8px);
      font-weight:800; white-space:nowrap;
    }

    /* Timer + CTA */
    .round-timer{
      position:absolute; left:50%;
      bottom: calc(var(--bottom-safe) + 90px);
      transform:translateX(-50%); z-index:12;
      font-weight:800; font-size:15px; padding:10px 18px; border-radius:999px;
      background:rgba(0,0,0,.55); backdrop-filter:blur(8px);
      white-space:nowrap; text-shadow:0 0 12px rgba(255,215,0,.18);
    }
    .round-timer.animate{ animation:pulse 1.8s infinite; }
    @keyframes pulse{ 0%,100%{transform:translateX(-50%) scale(1)} 50%{transform:translateX(-50%) scale(1.06)} }

    .cta{
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:12; display:none;
    }
    .btn{
      background:linear-gradient(180deg,var(--gold-1),var(--gold-2));
      color:#000; font-weight:800; padding:14px 28px; border-radius:12px;
      box-shadow:0 0 26px rgba(255,215,0,.45); cursor:pointer; border:none;
    }

    /* Side shapes (smaller, no boxes) */
    .side{
      position:absolute;
      bottom: calc(var(--bottom-safe) + 12vh);
      display:flex; flex-direction:column; gap:12px; z-index:14; pointer-events:auto;
    }
    .side.left{ left: calc(var(--side-safe)); }
    .side.right{ right: calc(var(--side-safe-r)); }

    .shape{
      appearance:none; background:transparent; border:none; padding:0;
      width:24px; height:24px; display:grid; place-items:center; cursor:pointer;
      transition: transform .18s ease, filter .18s ease;
      filter: drop-shadow(0 0 10px rgba(255,255,255,.08));
      animation: floatY 3.6s ease-in-out infinite;
    }
    @keyframes floatY{ 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
    .side.left .shape:nth-child(1){ animation-delay:.15s }
    .side.left .shape:nth-child(2){ animation-delay:1.05s }
    .side.right .shape:nth-child(1){ animation-delay:.55s }
    .side.right .shape:nth-child(2){ animation-delay:1.45s }

    .shape:focus-visible{ filter: drop-shadow(0 0 16px rgba(255,215,0,.6)); transform:scale(1.12); }
    .shape:hover{ transform:translateY(-2px) scale(1.08); filter:brightness(1.08); }
    .shape svg{ width:100%; height:100%; stroke:#cfcfcf; fill:none; stroke-width:2.2; }
    .shape svg .strokeline{
      stroke-dasharray:90; stroke-dashoffset:90;
      animation: dash1 2.6s ease-out infinite, hue 6s linear infinite;
    }
    @keyframes dash1{ 0%{stroke-dashoffset:90;opacity:.85} 60%{stroke-dashoffset:0;opacity:1} 100%{stroke-dashoffset:0;opacity:.85} }
    @keyframes hue{ to{ filter:hue-rotate(20deg) } }
    .shape.gold svg{ stroke:url(#goldStroke); }
    .shape.logout svg{ stroke:#ff5a5a; }

    .center-triangle{
      position:absolute; left:50%;
      bottom: calc(var(--bottom-safe) + 54px);
      transform:translateX(-50%); z-index:14;
    }
    .center-triangle .shape{
      width:30px; height:30px; animation:floatY 3.8s ease-in-out infinite; animation-delay:.9s;
      filter: drop-shadow(0 0 calc(10px + 16px * var(--beatGlow)) rgba(255,215,0,.5));
    }

    /* Next Opponent overlay */
    .opponent-offer{
      position:absolute; inset:0; display:none; place-items:center; z-index:20;
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.55));
      padding:20px;
    }
    .offer-card{
      display:grid; grid-template-columns: 100px 1fr; gap:16px; align-items:center;
      padding:16px 18px; border-radius:16px;
      background: rgba(0,0,0,.4); backdrop-filter: blur(10px);
      box-shadow: 0 16px 48px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.10);
      max-width:min(560px, 92vw);
    }
    .offer-avatar{
      width:100px; height:100px; border-radius:14px; object-fit:cover;
      box-shadow: 0 0 18px rgba(255,215,0,.35);
    }
    .offer-meta{ display:grid; gap:8px; }
    .offer-title{ font-weight:800; font-size:18px; letter-spacing:.3px }
    .offer-sub{ color:var(--muted); font-size:13px; display:flex; align-items:center; gap:8px }
    .offer-sub img{ width:20px; height:14px; object-fit:cover; border-radius:2px; box-shadow:0 0 6px rgba(255,255,255,.15) }
    .offer-actions{ display:flex; gap:10px; margin-top:8px }
    .btn-ghost{
      background:transparent; color:var(--ink); border:none; cursor:pointer; padding:10px 14px; border-radius:12px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.18);
    }

    /* Instrumental modal */
    .modal{ position:fixed; inset:0; display:none; place-items:center; z-index:30;
      background: rgba(0,0,0,.55); backdrop-filter: blur(4px); }
    .dialog{
      width:min(92vw, 420px);
      background: rgba(10,10,14,.86);
      border-radius:16px; padding:18px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.08);
    }
    .dialog h3{ margin:0 0 10px 0; font-size:18px; letter-spacing:.3px }
    #instrumentalSelect{
      width:100%; padding:10px 12px; border-radius:12px; border:none; outline: none;
      background:#0a0a0e; color:#eaeaea; margin:8px 0 12px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.12);
      font-family:'Orbitron',sans-serif;
    }

    /* One-shot FX (no lingering) */
    .fx-slash, .fx-shockwave{
      position:fixed; inset:0; pointer-events:none; display:none; z-index:50; overflow:hidden;
    }
    .fx-slash.active, .fx-shockwave.active{ display:block; }
    .fx-slash::before{
      content:""; position:absolute; left:-40%; top:-40%; width:180%; height:180%;
      background: linear-gradient(90deg, rgba(255,255,255,0) 30%, rgba(255,255,255,.85) 50%, rgba(255,215,0,.65) 60%, rgba(255,255,255,0) 70%);
      transform: skewY(-12deg) translateX(-120%); filter: blur(2px);
      animation: slash 650ms cubic-bezier(.15,.6,.2,1) forwards;
    }
    @keyframes slash{ to{ transform: skewY(-12deg) translateX(120%); opacity:0 } }

    .fx-shockwave::before{
      content:""; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      width:140px; height:140px; border-radius:50%;
      background:
        radial-gradient(closest-side, rgba(255,255,255,.9), rgba(255,255,255,.35) 55%, rgba(255,255,255,0) 60%),
        radial-gradient(closest-side, rgba(255,215,0,.5), rgba(255,215,0,.00) 70%);
      box-shadow: 0 0 28px rgba(255,215,0,.45), 0 0 70px rgba(255,215,0,.25);
      animation: shock 900ms cubic-bezier(.2,.6,.1,1) forwards;
    }
    @keyframes shock{
      0%   { transform:translate(-50%,-50%) scale(.6); opacity:1 }
      70%  { transform:translate(-50%,-50%) scale(1.15); opacity:.95 }
      100% { transform:translate(-50%,-50%) scale(1.35); opacity:0 }
    }

    /* Mobile tweaks */
    @media (max-width: 880px){
      .viewer-center{ top: calc(var(--top-safe) + 12px); }
      .top-bar{ top: calc(var(--top-safe) + 12px); }
      .side{ bottom: calc(var(--bottom-safe) + 10vh); }
      .center-triangle{ bottom: calc(var(--bottom-safe) + 50px); }
      .round-timer{ bottom: calc(var(--bottom-safe) + 86px); font-size:14px; }
      .shape{ width:22px; height:22px; }
      .center-triangle .shape{ width:28px; height:28px; }
      .offer-card{ grid-template-columns: 86px 1fr; }
      .offer-avatar{ width:86px; height:86px; }
    }
    @media (max-height:700px){
      .side{ bottom: calc(var(--bottom-safe) + 9vh); }
      .center-triangle{ bottom: calc(var(--bottom-safe) + 46px); }
      .round-timer{ bottom: calc(var(--bottom-safe) + 80px); }
    }
  </style>
</head>
<body>
  <!-- Gold stroke gradient -->
  <svg width="0" height="0" style="position:absolute">
    <defs>
      <linearGradient id="goldStroke" x1="0%" y1="0%" x2="0%" y2="100%">
        <stop offset="0%" stop-color="#fff4b0"/>
        <stop offset="60%" stop-color="#ffd700"/>
        <stop offset="100%" stop-color="#ffbf2e"/>
      </linearGradient>
    </defs>
  </svg>

  <!-- Depth layers -->
  <div class="depth-stage" aria-hidden="true">
    <div class="layer-nebula"></div>
    <div class="layer-stars"></div>
  </div>

  <!-- FX layers (one-shot) -->
  <div id="fxSlash" class="fx-slash" aria-hidden="true"></div>
  <div id="fxShock" class="fx-shockwave" aria-hidden="true"></div>

  <div class="stream-container" role="application" aria-label="Live Battle Split">
    <!-- LEFT PANE (You) -->
    <div class="pane" id="leftPane">
      <video class="video-stream" id="localVideo" autoplay muted playsinline></video>

      <!-- Camera fallback -->
      <div class="fallback" id="camFallback">
        <div>Enable camera & mic to see yourself</div>
        <div class="cam-actions">
          <button id="enableCamBtn" class="btn-mini">Enable Camera</button>
          <button id="retryCamBtn" class="btn-mini">Retry</button>
          <button id="switchCamBtn" class="btn-mini">Switch Camera</button>
        </div>
        <small style="opacity:.85">Tip: use HTTPS and allow permissions.</small>
      </div>
    </div>

    <!-- RIGHT PANE (Opponent) -->
    <div class="pane" id="rightPane">
      <video class="video-stream" id="opponentVideo" autoplay muted loop playsinline src="user2.mp4"></video>

      <!-- Viewer count centered in opponent screen -->
      <div class="viewer-center" id="viewerChip">👁 1.3k viewers</div>

      <!-- Next Opponent Offer -->
      <div class="opponent-offer" id="opponentOffer" aria-live="polite">
        <div class="offer-card">
          <img id="offerAvatar" class="offer-avatar" src="user3.jpg" alt="Next opponent photo"/>
          <div class="offer-meta">
            <div class="offer-title" id="offerName">@NextOpponent</div>
            <div class="offer-sub">
              <img id="offerFlag" src="flag_us.png" alt="Country flag"/>
              <span id="offerCountry">United States</span>
            </div>
            <div class="offer-actions">
              <button id="acceptOpponent" class="btn">Accept</button>
              <button id="nextOpponent" class="btn-ghost">Next</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- HUD -->
    <div class="top-bar">
      <div class="hud-left">
        <button class="hud-live" id="liveBtn" title="Live">LIVE</button>
      </div>
      <div style="pointer-events:none;"></div>
    </div>

    <!-- Timer + CTA -->
    <div class="round-timer" id="roundTimer">Select your instrumental…</div>
    <div class="cta"><button id="startBattleBtn" class="btn">🔥 Start Battle</button></div>

    <!-- LEFT side (circle over square) -->
    <nav class="side left" aria-label="Left sidebar">
      <button class="shape" data-link="home.html" title="Home" aria-label="Home">
        <svg viewBox="0 0 24 24" aria-hidden="true"><circle class="strokeline" cx="12" cy="12" r="9"/></svg>
      </button>
      <button class="shape" data-link="leaderboard.html" title="Leaderboard" aria-label="Leaderboard">
        <svg viewBox="0 0 24 24" aria-hidden="true"><rect class="strokeline" x="6" y="6" width="12" height="12" rx="2"/></svg>
      </button>
    </nav>

    <!-- RIGHT side (diamond over X) -->
    <nav class="side right" aria-label="Right sidebar">
      <button class="shape" data-link="discover.html" title="Discover" aria-label="Discover">
        <svg viewBox="0 0 24 24" aria-hidden="true"><polygon class="strokeline" points="12,4 20,12 12,20 4,12"/></svg>
      </button>
      <button class="shape logout" id="logoutBtn" title="Logout" aria-label="Logout">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <line class="strokeline" x1="6" y1="6" x2="18" y2="18"/>
          <line class="strokeline" x1="18" y1="6" x2="6" y2="18"/>
        </svg>
      </button>
    </nav>

    <!-- Bottom-center triangle -->
    <div class="center-triangle">
      <button class="shape gold" data-link="battle.html" title="Battle" aria-label="Battle">
        <svg viewBox="0 0 24 24" aria-hidden="true"><polygon class="strokeline" points="12,5 20,19 4,19"/></svg>
      </button>
    </div>

    <!-- Instrumental modal (opens on load) -->
    <div class="modal" id="instModal" aria-modal="true" role="dialog" aria-labelledby="instTitle" style="display:grid;">
      <div class="dialog">
        <h3 id="instTitle">Select Instrumental</h3>
        <select id="instrumentalSelect">
          <option disabled selected value="">Choose a beat</option>
          <option value="beat1.mp3">🔥 Classic Trap</option>
          <option value="beat2.mp3">💥 Boom Bap</option>
          <option value="beat3.mp3">🌊 Chill Vibes</option>
          <option value="beat4.mp3">⚡ Fast Flow</option>
        </select>
        <button class="btn" id="confirmInst">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Audio -->
  <audio id="battleTrack" hidden></audio>
  <audio id="roundEndSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_38ca955dae.mp3?filename=click-124467.mp3"></audio>

  <script>
    /* Elements */
    const localVideo = document.getElementById('localVideo');
    const camFallback = document.getElementById('camFallback');
    const leftPane = document.getElementById('leftPane');
    const opponentVideo = document.getElementById('opponentVideo');

    const instModal = document.getElementById('instModal');
    const selectInst = document.getElementById('instrumentalSelect');
    const confirmInst = document.getElementById('confirmInst');

    const startBtn = document.getElementById('startBattleBtn');
    const startBtnWrap = document.querySelector('.cta');
    const timerEl = document.getElementById('roundTimer');

    const battleTrack = document.getElementById('battleTrack');
    const endSound = document.getElementById('roundEndSound');

    const fxSlash = document.getElementById('fxSlash');
    const fxShock = document.getElementById('fxShock');

    const enableCamBtn = document.getElementById('enableCamBtn');
    const retryCamBtn = document.getElementById('retryCamBtn');
    const switchCamBtn = document.getElementById('switchCamBtn');

    const liveBtn = document.getElementById('liveBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    /* Navigation */
    document.querySelectorAll('.shape[data-link]').forEach(btn=>{
      btn.addEventListener('click', ()=>{ const link = btn.dataset.link; if(link) location.href = link; });
    });
    logoutBtn.addEventListener('click', ()=>{ location.href='login.html'; });
    liveBtn.addEventListener('click', ()=>{ location.href='live.html'; });

    /* Opponents */
    const opponents = [
      { video: "user2.mp4", image: "user2.jpg", handle: "@OpponentA", country: "United States", flag: "flag_us.png" },
      { video: "user3.mp4", image: "user3.jpg", handle: "@ChallengerX", country: "Japan", flag: "flag_jp.png" },
      { video: "user4.mp4", image: "user4.jpg", handle: "@MCNeo", country: "Brazil", flag: "flag_br.png" }
    ];
    let nextIndex = 0;
    function pickNext(){ nextIndex = (nextIndex + 1) % opponents.length; return opponents[nextIndex]; }
    function getCurrentNext(){ return opponents[nextIndex]; }

    /* Camera */
    let facing = 'user';
     let currentStream = null;

    async function stopStream(stream){
      if(!stream) return;
      stream.getTracks().forEach(t=>t.stop());
    }
    async function startCamera(preferFacing = facing){
      try{
        await stopStream(currentStream);
        const primary = { video: { facingMode:{ ideal: preferFacing }, width:{ ideal:1280 }, height:{ ideal:720 } }, audio:true };
        try{
          currentStream = await navigator.mediaDevices.getUserMedia(primary);
        }catch(_){
          currentStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
        }
        localVideo.srcObject = currentStream;
        leftPane.classList.remove('error');
        camFallback.style.display = 'none';
        localVideo.style.transform = (preferFacing === 'user') ? 'scaleX(-1)' : 'none';
      }catch(e){
        leftPane.classList.add('error');
        camFallback.style.display = 'flex';
      }
    }
    enableCamBtn?.addEventListener('click', ()=> startCamera('user'));
    retryCamBtn?.addEventListener('click', ()=> startCamera(facing));
    switchCamBtn?.addEventListener('click', async ()=>{
      facing = (facing === 'user') ? 'environment' : 'user';
      await startCamera(facing);
    });

    /* Modal flow */
    confirmInst.onclick = ()=>{
      const src = selectInst.value;
      if(!src){ alert("Pick a beat."); return; }
      battleTrack.src = src;
      battleTrack.load();
      instModal.style.display = 'none';
      startBtnWrap.style.display = 'block';
      timerEl.textContent = "Press Start Battle to begin";
    };

    /* Battle Timer */
    let state = { round:1, part:0, time:33, tick:null };
    function setTimer(){ timerEl.textContent = `Round ${state.round}/3 | ${state.part===0?'@You':'@Opponent'} | ${state.time}s`; }
    function startRound(){
      clearInterval(state.tick);
      state.tick = setInterval(()=>{
        setTimer(); state.time--;
        if(state.time < 0){
          clearInterval(state.tick); endSound.play();
          if(state.part === 0){
            state.part = 1; state.time = 33;
            timerEl.textContent = "Switching…";
            setTimeout(startRound, 900);
          }else if(state.round < 3){
            state.round++; state.part = 0; state.time = 33;
            timerEl.textContent = "Next Round…";
            setTimeout(startRound, 900);
          }else{
            timerEl.textContent = "🔥 Battle Over 🔥";
            setTimeout(showOpponentOffer, 1200);
          }
        }
      }, 1000);
    }

    /* Offer Overlay */
    const offer = document.getElementById('opponentOffer');
    const offerAvatar = document.getElementById('offerAvatar');
    const offerName = document.getElementById('offerName');
    const offerCountry = document.getElementById('offerCountry');
    const offerFlag = document.getElementById('offerFlag');
    const acceptOpponent = document.getElementById('acceptOpponent');
    const nextOpponent = document.getElementById('nextOpponent');

    function showOpponentOffer(){
      const cand = pickNext();
      offerAvatar.src = cand.image; offerName.textContent = cand.handle;
      offerCountry.textContent = cand.country; offerFlag.src = cand.flag;
      offer.style.display = 'grid';
      startBtnWrap.style.display = 'none';
    }
    acceptOpponent.onclick = ()=>{
      const cand = getCurrentNext();
      opponentVideo.src = cand.video;
      offer.style.display = 'none';
      state = { round:1, part:0, time:33, tick:null };
      startBtnWrap.style.display = 'block';
      timerEl.textContent = "🔥 Opponent Ready — Press Start 🔥";
    };
    nextOpponent.onclick = ()=>{
      const cand = pickNext();
      offerAvatar.src = cand.image; offerName.textContent = cand.handle;
      offerCountry.textContent = cand.country; offerFlag.src = cand.flag;
    };

    /* One-shot FX helpers (timeout-based so they never “stick”) */
    function playSlash(){
      fxSlash.classList.add('active');
      setTimeout(()=> fxSlash.classList.remove('active'), 700);
    }
    function playShock(){
      fxShock.classList.add('active');
      setTimeout(()=> fxShock.classList.remove('active'), 950); /* remove even if animationend doesn't fire */
    }

    /* Start Battle */
    startBtn.onclick = ()=>{
      startBtnWrap.style.display='none';
      battleTrack.play().catch(()=>{});
      timerEl.classList.add('animate');
      playSlash();
      playShock();      /* <- single explosion, fades out, then removed */
      offer.style.display = 'none';
      startRound();
      beginAudioGlow();
    };

    /* Init */
    document.addEventListener('DOMContentLoaded', ()=>{
      // Lock container explicitly (some Android browsers ignore CSS until a layout pass)
      const sc = document.querySelector('.stream-container');
      sc.style.height = window.innerHeight + 'px';
      window.addEventListener('resize', ()=>{
        sc.style.height = window.innerHeight + 'px';
      });

      startCamera('user');           // try to start immediately
      instModal.style.display='grid';// open beat picker on load
    });

    /* Audio reactive (optional) */
    let audioCtx, analyser, dataArr, rafGlow;
    function beginAudioGlow(){
      try{
        if(!audioCtx){
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          const src = audioCtx.createMediaElementSource(battleTrack);
          analyser = audioCtx.createAnalyser();
          analyser.fftSize = 256;
          src.connect(analyser);
          analyser.connect(audioCtx.destination);
          dataArr = new Uint8Array(analyser.frequencyBinCount);
        }
        const loop = ()=>{
          analyser.getByteFrequencyData(dataArr);
          let sum=0, count=0;
          for(let i=2;i<18 && i<dataArr.length;i++){ sum+=dataArr[i]; count++; }
          const avg = count? sum/(count*255) : 0;
          const eased = Math.min(1, avg*2.2);
          document.documentElement.style.setProperty('--beatGlow', eased.toFixed(3));
          rafGlow = requestAnimationFrame(loop);
        };
        cancelAnimationFrame(rafGlow);
        rafGlow = requestAnimationFrame(loop);
      }catch(e){/* ignore if blocked */}
    }
  </script>
</body>
</html>
