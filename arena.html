<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no"/>
  <title>BattleBillions â€” Arena (Competitors Only)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&family=Orbitron:wght@600;800&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --ink:#f5f7fb; --ink-2:#d0d6de; --muted:#9aa3ad;
      --gold:#ffd700; --gold-2:#ffe466;
      --cyan:#47f5ff; --rose:#ff4c6a; --vio:#b491ff; --emerald:#4cff9a;
      --glass:rgba(255,255,255,.06); --glass-2:rgba(255,255,255,.08);
      --bg:#000; --panel:#0f1014; --ring:0 0 0 3px rgba(255,255,255,.14);
      --ok:#36d399; --warn:#ffb020; --danger:#ff6363;
      --safe-top:max(8px, env(safe-area-inset-top)); --safe-bottom:max(12px, env(safe-area-inset-bottom));
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;overscroll-behavior:none}
    *::-webkit-scrollbar{width:0;height:0;display:none} *{scrollbar-width:none}

    /* Ambient */
    body::before{
      content:""; position:fixed; inset:-10%; z-index:0; pointer-events:none;
      background:
        radial-gradient(900px 700px at 20% 10%, rgba(255,215,0,.06), transparent 60%),
        radial-gradient(900px 700px at 80% 20%, rgba(71,245,255,.05), transparent 60%),
        radial-gradient(1200px 1000px at 50% 80%, rgba(159,123,255,.05), transparent 70%);
      filter:blur(2px);
    }

    /* Canvas sparkles (optional, very light) */
    #bg3d{position:fixed; inset:0; z-index:0; width:100%; height:100%; display:block; pointer-events:none; background:radial-gradient(1200px 900px at 25% 10%, #0b0b0d 0%, #000 70%)}

    /* Page shell */
    .page{position:relative; z-index:1; min-height:100dvh; display:grid; grid-template-rows:auto 1fr auto; gap:12px; padding:var(--safe-top) 12px calc(var(--safe-bottom) + 10px)}

    /* Top bar (no solid background per your request, just subtle) */
    .topbar{
      display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:10px;
      backdrop-filter: blur(8px);
    }
    .brand{
      display:flex; align-items:center; gap:10px; justify-self:start;
      text-transform:uppercase; letter-spacing:.6px; font-weight:800; font-family:'Orbitron',sans-serif;
      background:
        linear-gradient(120deg, rgba(255,255,255,.18), rgba(255,255,255,0) 22% 78%, rgba(255,255,255,.18)),
        linear-gradient(180deg, #f2f2f2 0%, #c7c7c7 38%, #9d9d9d 56%, #f0f0f0 86%);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow: 0 4px 24px rgba(255,215,0,.12);
    }

    /* Battle header (center) */
    .battle-head{
      justify-self:center; display:flex; align-items:center; gap:10px; flex-wrap:wrap; text-align:center;
    }
    .tag{font-size:11px; color:#cfefff; padding:6px 10px; border-radius:999px; background:var(--glass)}
    .title{font-weight:800; letter-spacing:.3px}
    .pill{
      display:inline-flex; align-items:center; gap:8px; border:0; border-radius:999px; padding:8px 12px; font-weight:800; cursor:pointer;
      color:#111; background:linear-gradient(180deg,#fff3bd,#ffd700); box-shadow:0 8px 22px rgba(255,215,0,.2);
    }
    .pill.secondary{ color:#bfefff; background:rgba(255,255,255,.08); box-shadow:none }
    .pill:active{ transform:translateY(1px) }

    /* Right controls */
    .rightbar{
      justify-self:end; display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    }

    /* Stage: two panels */
    .stage{
      display:grid; grid-template-columns:1fr 1fr; gap:12px; align-items:stretch; min-height:62dvh;
    }
    @media (max-width:900px){ .stage{ grid-template-columns:1fr; min-height:64dvh } }

    .player{
      position:relative; border-radius:18px; overflow:hidden;
      background:rgba(20,20,24,.35); backdrop-filter: blur(10px) saturate(130%);
      box-shadow:0 12px 40px rgba(0,0,0,.35);
      display:grid; grid-template-rows:auto 1fr auto; 
    }
    .p-head{
      display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px;
    }
    .p-id{
      display:flex; align-items:center; gap:10px;
    }
    .avatar{
      width:44px; height:44px; border-radius:50%; background:#111; overflow:hidden; flex:0 0 auto;
      box-shadow:0 0 10px rgba(255,255,255,.08);
    }
    .avatar img{ width:100%; height:100%; object-fit:cover }
    .p-name{ font-weight:800; letter-spacing:.2px }
    .p-sub{ font-size:11px; color:#cfefff }

    .p-ctrls{ display:flex; align-items:center; gap:8px; }
    .ctrl{
      border:0; border-radius:10px; padding:8px 10px; font-weight:700; cursor:pointer; color:#111;
      background:linear-gradient(180deg,#dff9ff,#7ff3ff);
    }
    .ctrl.ghost{ color:#bfefff; background:rgba(255,255,255,.08) }
    .ctrl.danger{ color:#fff; background:#ff4c4c }
    .ctrl:active{ transform:translateY(1px) }

    .p-video{
      position:relative; background:#000; aspect-ratio:16/9; width:100%;
    }
    @media (min-height:780px){
      .p-video{ aspect-ratio:auto; min-height:42vh; }
    }
    video{ width:100%; height:100%; object-fit:cover; background:#000 }
    .turn-glow{
      position:absolute; inset:0; pointer-events:none; box-shadow:inset 0 0 0 2px rgba(255,215,0,.6), 0 0 60px rgba(255,215,0,.25);
      opacity:0; transition:opacity .15s ease;
    }
    .player.active .turn-glow{ opacity:1 }

    .p-foot{
      display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px;
    }
    .mini{ font-size:11px; color:#cfefff }

    /* Bottom bar: timer + round + mic + ready */
    .bottombar{
      display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap:10px; margin-top:8px;
      backdrop-filter: blur(8px);
    }
    .left-tools, .right-tools{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
    .center-tools{ display:flex; align-items:center; gap:10px }
    .timer{
      font-family:'Orbitron',sans-serif; font-weight:800; font-size:18px; letter-spacing:.5px;
      padding:10px 14px; border-radius:12px; background:rgba(255,255,255,.08);
    }
    .round{ font-family:'Orbitron',sans-serif; font-weight:800; padding:8px 12px; border-radius:12px; background:rgba(255,255,255,.08) }

    /* Modal (category picker) */
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:10; background:rgba(0,0,0,.55) }
    .modal.active{ display:flex }
    .sheet{
      width:min(96vw,940px); max-height:86vh; overflow:auto; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.12); border-radius:18px; padding:16px;
      box-shadow:0 40px 120px rgba(0,0,0,.5), inset 0 0 60px rgba(255,215,0,.06);
    }
    .sheet h3{ margin:0 0 8px; font-family:'Orbitron',sans-serif; letter-spacing:.4px }
    .grid{ display:grid; gap:10px }
    @media (min-width:780px){
      .grid.cols-2{ grid-template-columns:1fr 1fr }
      .grid.cols-3{ grid-template-columns:repeat(3,1fr) }
    }
    .cat{
      background:rgba(255,255,255,.06); border-radius:12px; padding:12px; display:flex; align-items:center; justify-content:space-between; gap:10px;
      cursor:pointer; border:1px solid rgba(255,255,255,.08);
    }
    .cat:hover{ border-color:rgba(255,255,255,.22) }
    .subchips{ display:flex; flex-wrap:wrap; gap:8px }
    .chip{ font-size:12px; padding:6px 10px; border-radius:999px; background:#101217; color:#dfe7ee }
    .chip.sel{ background:linear-gradient(180deg,#fff3bd,#ffd700); color:#111; font-weight:800 }
    .modal-actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:12px }
    .btn{ border:0; border-radius:12px; padding:10px 14px; font-weight:800; cursor:pointer }
    .btn.primary{ color:#111; background:linear-gradient(180deg,#fff3bd,#ffd700); box-shadow:0 8px 22px rgba(255,215,0,.2) }
    .btn.ghost{ color:#bfefff; background:rgba(255,255,255,.08) }
    .btn:active{ transform:translateY(1px) }

    /* Tiny helpers */
    .note{ font-size:12px; color:var(--muted) }
    .hidden{ display:none !important }
    .ok{ color:var(--ok) } .warn{ color:var(--warn) } .danger{ color:var(--danger) }

    /* Mobile camera hint */
    .hintbar{
      text-align:center; font-size:12px; color:#cfefff; margin-top:6px;
    }
  </style>
</head>
<body>
  <canvas id="bg3d"></canvas>

  <div class="page">
    <!-- Top row -->
    <div class="topbar">
      <div class="brand">3ATTLE33ILLIONS</div>

      <div class="battle-head" id="battleHead">
        <span class="tag" id="roomTag">Private Room</span>
        <span class="title" id="battleTitle">Select Category</span>
        <button id="pickCategoryBtn" class="pill">Choose Category</button>
      </div>

      <div class="rightbar">
        <button id="helpBtn" class="pill secondary">Help</button>
        <button id="leaveBtn" class="pill" title="Leave arena">Leave</button>
      </div>
    </div>

    <!-- Stage -->
    <section class="stage" id="stage">
      <!-- YOU -->
      <article class="player" id="mePanel">
        <div class="p-head">
          <div class="p-id">
            <div class="avatar"><img id="meAvatar" alt=""/></div>
            <div>
              <div class="p-name" id="meName">You</div>
              <div class="p-sub" id="meSub">Ready: <span id="meReadyState" class="warn">No</span></div>
            </div>
          </div>
          <div class="p-ctrls">
            <button class="ctrl" id="meCamBtn">Start Camera</button>
            <button class="ctrl ghost" id="meMicBtn" aria-pressed="false">Mic On</button>
            <button class="ctrl ghost" id="meFlipBtn">Flip</button>
          </div>
        </div>

        <div class="p-video">
          <video id="meVideo" playsinline muted></video>
          <div class="turn-glow"></div>
        </div>

        <div class="p-foot">
          <div class="mini" id="meInfo">Camera: off â€¢ Mic: on</div>
          <button class="ctrl" id="meReadyBtn">Iâ€™m Ready</button>
        </div>
      </article>

      <!-- OPPONENT -->
      <article class="player" id="opPanel">
        <div class="p-head">
          <div class="p-id">
            <div class="avatar"><img id="opAvatar" alt=""/></div>
            <div>
              <div class="p-name" id="opName">Opponent</div>
              <div class="p-sub">Ready: <span id="opReadyState" class="warn">No</span></div>
            </div>
          </div>
          <div class="p-ctrls">
            <!-- For real-time use with WebRTC; here just placeholders -->
            <button class="ctrl ghost" disabled>Cam</button>
            <button class="ctrl ghost" disabled>Mic</button>
            <button class="ctrl ghost" disabled>Flip</button>
          </div>
        </div>

        <div class="p-video">
          <video id="opVideo" playsinline muted></video>
          <div class="turn-glow"></div>
        </div>

        <div class="p-foot">
          <div class="mini" id="opInfo">Waiting for opponentâ€¦</div>
          <span class="mini note">Only competitors see Arena</span>
        </div>
      </article>
    </section>

    <!-- Bottom controls -->
    <div class="bottombar">
      <div class="left-tools">
        <button class="btn ghost" id="swapSidesBtn">Swap Sides</button>
        <span class="note" id="catNote">Category: â€”</span>
      </div>

      <div class="center-tools">
        <span class="round" id="roundBadge">Round 1 / 3</span>
        <span class="timer" id="timer">01:00</span>
        <button class="btn primary" id="startRoundBtn">Start Round</button>
        <button class="btn ghost" id="endTurnBtn" disabled>End Turn</button>
        <button class="btn ghost" id="nextRoundBtn" disabled>Next Round</button>
      </div>

      <div class="right-tools">
        <button class="btn ghost" id="muteAllBtn">Mute All</button>
        <button class="btn ghost" id="resetBtn">Reset</button>
      </div>
    </div>

    <div class="hintbar">No audience controls in Arena. Live/Discover/Profile carry voting & reactions.</div>
  </div>

  <!-- Category Picker -->
  <div id="categoryModal" class="modal" aria-hidden="true">
    <div class="sheet">
      <h3>Select Category & Subcategory</h3>
      <p class="note" style="margin-bottom:8px">Launch set: Rap, Art, Instruments, Comedy, Dance, Fashion</p>

      <div class="grid cols-2" id="categoryGrid">
        <!-- Filled by JS -->
      </div>

      <div class="modal-actions">
        <button class="btn ghost" id="closeModalBtn">Cancel</button>
        <button class="btn primary" id="applyCategoryBtn" disabled>Apply</button>
      </div>
    </div>
  </div>

  <!-- Three.js (light ambient) -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>

  <script>
    /***********************
     * CATEGORY DATA (V1)
     ***********************/
    const CATEGORIES = [
      {
        key:'rap', name:'Rap',
        subs:['Freestyle','Written','Acapella','On Beat','Roast / Diss'],
        rounds:3, seconds:60,
        notes:'Mic priority, timed rounds. No audience here.'
      },
      {
        key:'art', name:'Art',
        subs:['Drawing','Painting','Digital','Graffiti','Sculpture'],
        rounds:1, seconds:180,
        notes:'Time-lapse or live. Split reveal at end.'
      },
      {
        key:'instruments', name:'Instruments',
        subs:['Guitar','Piano / Keys','Drums / Percussion','Strings','Wind / Brass'],
        rounds:2, seconds:90,
        notes:'Dual audio focus. Visualizer optional.'
      },
      {
        key:'comedy', name:'Comedy',
        subs:['Roast','Stand-Up','Skits','Impressions','Freestyle Comedy'],
        rounds:2, seconds:60,
        notes:'Mic + turn indicator.'
      },
      {
        key:'dance', name:'Dance',
        subs:['Freestyle','Choreography','Hip-Hop / Street','Breakdance / Popping','Cultural'],
        rounds:2, seconds:60,
        notes:'Full-body frame. Same track optional.'
      },
      {
        key:'fashion', name:'Fashion',
        subs:['Streetwear Fits','Runway Walks','Custom Designs','Cosplay / Costume','Thrift / Budget'],
        rounds:1, seconds:60,
        notes:'Split runway & detail zoom.'
      }
    ];

    const state = {
      cat: null,
      sub: null,
      rounds: 3,
      seconds: 60,
      curRound: 1,
      turn: 'me',            // 'me' | 'op'
      timerRunning: false,
      timeLeft: 60,
      streams: { me: null },
      me: { name:'You', avatar:'' },
      op: { name:'Opponent', avatar:'' },
      meReady:false, opReady:false
    };

    /***********************
     * BASIC HELPERS
     ***********************/
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function qsParam(key){
      const u = new URL(location.href); return u.searchParams.get(key);
    }
    function formatMMSS(s){
      s = Math.max(0, Math.floor(s));
      const m = Math.floor(s/60), ss = s%60;
      return String(m).padStart(2,'0') + ':' + String(ss).padStart(2,'0');
    }

    /***********************
     * LOAD USER (OPTIONAL FIREBASE)
     ***********************/
    (async function loadUser(){
      // URL fallbacks
      const qName = qsParam('meName'); const qAvatar = qsParam('meAvatar');
      if(qName) state.me.name = qName;
      if(qAvatar) state.me.avatar = qAvatar;

      const qOppName = qsParam('opName'); const qOppAvatar = qsParam('opAvatar');
      if(qOppName) state.op.name = qOppName;
      if(qOppAvatar) state.op.avatar = qOppAvatar;

      // Try firebase.js
      try{
        const mod = await import('./firebase.js');
        const { auth, db, onAuthStateChanged, doc, getDoc } = mod;
        onAuthStateChanged(auth, async (user)=>{
          if(!user) return;
          // fetch profile
          try{
            const ref = doc(db, 'users', user.uid);
            const snap = await getDoc(ref);
            if (snap.exists()){
              const d = snap.data();
              state.me.name = d.username || d.displayName || state.me.name;
              state.me.avatar = d.avatarURL || state.me.avatar;
            }
          }catch{}
          renderIdentities();
        });
      }catch{
        // no firebase, just render with URL or defaults
        renderIdentities();
      }
    })();

    function renderIdentities(){
      $('#meName').textContent = state.me.name || 'You';
      $('#meAvatar').src = state.me.avatar || 'assets/default-avatar.png';
      $('#opName').textContent = state.op.name || 'Opponent';
      $('#opAvatar').src = state.op.avatar || 'assets/opponent-avatar.png';
    }

    /***********************
     * CATEGORY PICKER
     ***********************/
    const categoryModal = $('#categoryModal');
    const categoryGrid = $('#categoryGrid');
    const applyCategoryBtn = $('#applyCategoryBtn');

    function openCategoryModal(){
      categoryGrid.innerHTML = '';
      CATEGORIES.forEach(cat=>{
        const el = document.createElement('div');
        el.className = 'cat';
        el.dataset.key = cat.key;
        el.innerHTML = `
          <div>
            <div style="font-weight:800">${cat.name}</div>
            <div class="subchips" data-subwrap="${cat.key}">
              ${cat.subs.map(s=>`<span class="chip" data-chip="${cat.key}:${s}">${s}</span>`).join('')}
            </div>
            <div class="note" style="margin-top:6px">${cat.notes}</div>
          </div>
          <span class="chip" style="background:linear-gradient(180deg,#dff9ff,#7ff3ff); color:#111; font-weight:800">Select</span>
        `;
        categoryGrid.appendChild(el);
      });

      categoryGrid.addEventListener('click', onCategoryClick, { once:true });
      categoryModal.classList.add('active');
      categoryModal.setAttribute('aria-hidden','false');
      applyCategoryBtn.disabled = !(state.cat && state.sub);
    }

    function onCategoryClick(e){
      const chip = e.target.closest('.chip[data-chip]');
      if(chip){
        // clear previous .sel in this cat
        const [key, sub] = chip.dataset.chip.split(':');
        const wrap = document.querySelector(`[data-subwrap="${key}"]`);
        wrap.querySelectorAll('.chip').forEach(c=>c.classList.remove('sel'));
        chip.classList.add('sel');

        state.cat = key;
        state.sub = sub;
        const cfg = CATEGORIES.find(c=>c.key===key);
        state.rounds = cfg.rounds; state.seconds = cfg.seconds; state.timeLeft = cfg.seconds; state.curRound = 1; state.turn = 'me';
        applyCategoryBtn.disabled = false;
        // keep listening for other clicks
        categoryGrid.addEventListener('click', onCategoryClick, { once:true });
        return;
      }
      // if they clicked a card "Select" pill, do nothing special; apply uses Apply button
      categoryGrid.addEventListener('click', onCategoryClick, { once:true });
    }

    function applySelectedCategory(){
      categoryModal.classList.remove('active');
      categoryModal.setAttribute('aria-hidden','true');
      updateBattleHeader();
      updateRoundUI(true);
      stopTimer();
    }

    function updateBattleHeader(){
      if(!state.cat || !state.sub){
        $('#battleTitle').textContent = 'Select Category';
        $('#catNote').textContent = 'Category: â€”';
        return;
      }
      const catName = CATEGORIES.find(c=>c.key===state.cat)?.name || state.cat;
      $('#battleTitle').textContent = `${catName} â€¢ ${state.sub}`;
      $('#catNote').textContent = `Category: ${catName} / ${state.sub}`;
    }

    /***********************
     * TIMER / ROUNDS / TURNS
     ***********************/
    let raf = null, lastTick = 0;
    function startTimer(){
      if(state.timerRunning) return;
      state.timerRunning = true;
      lastTick = performance.now();
      loop();
      $('#startRoundBtn').disabled = true;
      $('#endTurnBtn').disabled = false;
      $('#nextRoundBtn').disabled = true;
      markActiveTurn();
    }
    function loop(){
      raf = requestAnimationFrame(loop);
      const now = performance.now();
      const dt = (now - lastTick)/1000; lastTick = now;
      state.timeLeft -= dt;
      if (state.timeLeft <= 0){
        state.timeLeft = 0;
        updateTimerUI();
        endTurn(); // auto end
        return;
      }
      updateTimerUI();
    }
    function stopTimer(){
      if(raf) cancelAnimationFrame(raf);
      raf = null; state.timerRunning = false;
      $('#startRoundBtn').disabled = false;
      $('#endTurnBtn').disabled = true;
      $('#nextRoundBtn').disabled = false;
      clearActiveTurn();
    }
    function updateTimerUI(){
      $('#timer').textContent = formatMMSS(state.timeLeft);
    }
    function updateRoundUI(resetTime=false){
      $('#roundBadge').textContent = `Round ${state.curRound} / ${state.rounds}`;
      if(resetTime){ state.timeLeft = state.seconds; updateTimerUI(); }
    }
    function markActiveTurn(){
      $('#mePanel').classList.toggle('active', state.turn==='me');
      $('#opPanel').classList.toggle('active', state.turn==='op');
      $('#roomTag').textContent = state.turn==='me' ? 'Your Turn' : `${state.op.name || 'Opponent'} Turn`;
    }
    function clearActiveTurn(){
      $('#mePanel').classList.remove('active');
      $('#opPanel').classList.remove('active');
      $('#roomTag').textContent = 'Paused';
    }

    function endTurn(){
      stopTimer();
      // swap turn
      state.turn = (state.turn === 'me') ? 'op' : 'me';
      // allow Next Round if both turns used (optional simple model)
      $('#nextRoundBtn').disabled = false;
      markActiveTurn();
    }
    function nextRound(){
      if(state.curRound >= state.rounds){ // battle finished
        $('#roomTag').textContent = 'Battle Complete';
        $('#startRoundBtn').disabled = true;
        $('#endTurnBtn').disabled = true;
        $('#nextRoundBtn').disabled = true;
        clearActiveTurn();
        return;
      }
      state.curRound += 1;
      state.turn = 'me'; // always start with me (simple default)
      updateRoundUI(true);
      $('#startRoundBtn').disabled = false;
      $('#endTurnBtn').disabled = true;
      $('#nextRoundBtn').disabled = true;
      markActiveTurn();
    }

    /***********************
     * READY STATES (local demo)
     ***********************/
    $('#meReadyBtn').addEventListener('click', ()=>{
      state.meReady = !state.meReady;
      $('#meReadyState').textContent = state.meReady ? 'Yes' : 'No';
      $('#meReadyState').className = state.meReady ? 'ok' : 'warn';
      $('#meReadyBtn').textContent = state.meReady ? 'Not Ready' : 'Iâ€™m Ready';
      if(state.meReady) $('#meSub').textContent = 'Ready: Yes'; else $('#meSub').innerHTML = 'Ready: <span id="meReadyState" class="warn">No</span>';
    });

    /***********************
     * CAMERA / MIC (local preview)
     ***********************/
    let useRear = false;
    async function startMyCamera(){
      try{
        const constraints = {
          audio: true,
          video: { facingMode: useRear ? { exact: 'environment' } : 'user' }
        };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        state.streams.me = stream;
        const vid = $('#meVideo');
        vid.srcObject = stream;
        await vid.play().catch(()=>{});
        $('#meInfo').textContent = 'Camera: on â€¢ Mic: on';
        $('#meCamBtn').textContent = 'Stop Camera';
      }catch(e){
        alert('Unable to access camera/microphone: ' + (e?.message||e));
      }
    }
    function stopMyCamera(){
      if(state.streams.me){
        state.streams.me.getTracks().forEach(t=>t.stop());
        state.streams.me = null;
        $('#meVideo').srcObject = null;
      }
      $('#meInfo').textContent = 'Camera: off â€¢ Mic: on';
      $('#meCamBtn').textContent = 'Start Camera';
    }
    $('#meCamBtn').addEventListener('click', ()=>{
      if(state.streams.me) stopMyCamera(); else startMyCamera();
    });
    $('#meMicBtn').addEventListener('click', (e)=>{
      const pressed = e.currentTarget.getAttribute('aria-pressed') === 'true';
      e.currentTarget.setAttribute('aria-pressed', String(!pressed));
      e.currentTarget.textContent = pressed ? 'Mic On' : 'Mic Off';
      if(state.streams.me){
        state.streams.me.getAudioTracks().forEach(t=> t.enabled = pressed);
        $('#meInfo').textContent = `Camera: ${state.streams.me ? 'on' : 'off'} â€¢ Mic: ${pressed ? 'on' : 'off'}`;
      }
    });
    $('#meFlipBtn').addEventListener('click', async ()=>{
      useRear = !useRear;
      if(state.streams.me){ stopMyCamera(); await startMyCamera(); }
    });

    /***********************
     * WIRES
     ***********************/
    $('#pickCategoryBtn').addEventListener('click', openCategoryModal);
    $('#closeModalBtn').addEventListener('click', ()=>{
      categoryModal.classList.remove('active');
      categoryModal.setAttribute('aria-hidden','true');
    });
    $('#applyCategoryBtn').addEventListener('click', applySelectedCategory);

    $('#swapSidesBtn').addEventListener('click', ()=>{
      // swap labels & avatars only visually (demo)
      const me = { name: $('#meName').textContent, avatar: $('#meAvatar').src };
      const op = { name: $('#opName').textContent, avatar: $('#opAvatar').src };
      $('#meName').textContent = op.name; $('#meAvatar').src = op.avatar;
      $('#opName').textContent = me.name; $('#opAvatar').src = me.avatar;
      // and swap in state
      [state.me, state.op] = [state.op, state.me];
      markActiveTurn();
    });

    $('#startRoundBtn').addEventListener('click', ()=>{
      if(!state.cat){ openCategoryModal(); return; }
      startTimer();
    });
    $('#endTurnBtn').addEventListener('click', endTurn);
    $('#nextRoundBtn').addEventListener('click', nextRound);

    $('#muteAllBtn').addEventListener('click', ()=>{
      if(state.streams.me) state.streams.me.getAudioTracks().forEach(t=> t.enabled = false);
      $('#meMicBtn').setAttribute('aria-pressed','true'); $('#meMicBtn').textContent='Mic Off';
      $('#meInfo').textContent = `Camera: ${state.streams.me ? 'on' : 'off'} â€¢ Mic: off`;
    });

    $('#resetBtn').addEventListener('click', ()=>{
      stopTimer();
      state.curRound = 1; state.turn='me'; state.timeLeft = state.seconds;
      updateRoundUI(true); markActiveTurn();
    });

    $('#helpBtn').addEventListener('click', ()=>{
      alert('Arena is for competitors only.\nPick a category, ready up, start round.\nNo audience controls here â€” those exist on Live / Discover / Profile.');
    });

    $('#leaveBtn').addEventListener('click', ()=>{
      // If using SPA router, change hash; else, navigate back/home
      const back = qsParam('back') || 'home.html';
      window.location.href = back;
    });

    // Start: if query has category/sub, preselect
    (function initFromQuery(){
      const catQ = qsParam('cat'); const subQ = qsParam('sub');
      if(catQ && subQ){
        const cfg = CATEGORIES.find(c=>c.key===catQ);
        if(cfg){
          state.cat = cfg.key; state.sub = subQ;
          state.rounds = cfg.rounds; state.seconds = cfg.seconds; state.timeLeft = cfg.seconds;
          updateBattleHeader(); updateRoundUI(true);
        }
      }
      markActiveTurn();
      renderIdentities();
    })();

    /***********************
     * LIGHT AMBIENT SPARKS
     ***********************/
    (function(){
      const canvas = document.getElementById('bg3d');
      let glOK=false;
      try{
        const gl = canvas.getContext('webgl',{antialias:false}) || canvas.getContext('experimental-webgl');
        glOK=!!gl;
      }catch(e){ glOK=false; }
      if(!glOK) return;

      const DPR_LIMIT=1.75;
      const renderer = new THREE.WebGLRenderer({ canvas, antialias:false, alpha:true, powerPreference:'high-performance' });
      renderer.setClearColor(0x000000,0);
      let width=innerWidth, height=innerHeight;
      renderer.setPixelRatio(Math.min(devicePixelRatio||1, DPR_LIMIT));
      renderer.setSize(width,height,false);

      const scene = new THREE.Scene();
      const camera= new THREE.PerspectiveCamera(55, width/height, 0.1, 3000); camera.position.set(0,0,140);
      const hemi = new THREE.HemisphereLight(0x888888,0x080808,0.9);
      const dir  = new THREE.DirectionalLight(0xffe7a4,0.7); dir.position.set(60,80,120);
      scene.add(hemi,dir);

      function sprite(){
        const s=128,c=document.createElement('canvas'); c.width=c.height=s;
        const g=c.getContext('2d'), grd=g.createRadialGradient(s/2,s/2,0, s/2,s/2,s/2);
        grd.addColorStop(0,'rgba(255,255,255,0.95)'); grd.addColorStop(0.35,'rgba(255,255,255,0.35)'); grd.addColorStop(1,'rgba(255,255,255,0)');
        g.fillStyle=grd; g.fillRect(0,0,s,s); const tex=new THREE.CanvasTexture(c); tex.minFilter=THREE.LinearFilter; tex.magFilter=THREE.LinearFilter; return tex;
      }
      const particleTex = sprite();

      // Ambient embers
      (function(){
        const COUNT = 400;
        const g=new THREE.BufferGeometry();
        const pos=new Float32Array(COUNT*3), col=new Float32Array(COUNT*3);
        for(let i=0;i<COUNT;i++){
          pos[i*3+0]=(Math.random()-0.5)*460;
          pos[i*3+1]=(Math.random()-0.5)*280;
          pos[i*3+2]=-60 - Math.random()*180;
          const t=Math.random()*0.5+0.35;
          col[i*3+0]=t; col[i*3+1]=t*0.9; col[i*3+2]=t*0.85;
        }
        g.setAttribute('position', new THREE.BufferAttribute(pos,3));
        g.setAttribute('color', new THREE.BufferAttribute(col,3));
        const m=new THREE.PointsMaterial({ size:2.2, map:particleTex, transparent:true, depthWrite:false, vertexColors:true, blending:THREE.AdditiveBlending });
        const p=new THREE.Points(g,m); p.frustumCulled=false; p.userData={t:0};
        scene.add(p);
        const tick = ()=>{
          p.userData.t += 0.0015;
          p.position.y = Math.sin(p.userData.t*8)*1.2;
          p.rotation.z += 0.0007;
          requestAnimationFrame(tick);
        };
        tick();
      })();

      function resize(){
        width=innerWidth; height=innerHeight;
        renderer.setPixelRatio(Math.min(devicePixelRatio||1, DPR_LIMIT));
        renderer.setSize(width,height,false);
        camera.aspect=width/height; camera.updateProjectionMatrix();
      }
      addEventListener('resize', resize, {passive:true});

      const render = ()=>{ camera.lookAt(0,0,0); renderer.render(scene,camera); requestAnimationFrame(render); };
      render();
    })();
  </script>
</body>
</html>
