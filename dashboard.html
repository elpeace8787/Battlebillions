<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BattleBillions - Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <style>
    /* ====== Minimalist Monochrome Theme ====== */
    :root{
      --bg-0:#0b0b0c;         /* page background */
      --bg-1:#111214;         /* cards / modals */
      --bg-2:#15171a;         /* bars */
      --ink:#e9edf1;          /* primary text */
      --ink-2:#cfd6dd;        /* secondary text */
      --ink-3:#9aa3ad;        /* muted text */
      --stroke:#2a2d31;       /* borders */
      --accent:#ffffff;       /* action / buttons */
      --accent-2:#1f1f22;     /* button text on light */
      --shadow:0 10px 30px rgba(0,0,0,.45);
      --ring:0 0 0 3px rgba(255,255,255,.08);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      height: 100%;
      font-family: 'Orbitron', sans-serif;
      background: var(--bg-0);
      color: var(--ink);
      overflow: hidden;
    }

    /* Soft animated backdrop */
    body::before{
      content:"";
      position:fixed; inset:-20% -10%;
      background:
        radial-gradient(60% 40% at 70% 20%, rgba(255,255,255,.06), transparent 60%),
        radial-gradient(50% 35% at 20% 70%, rgba(255,255,255,.04), transparent 60%),
        linear-gradient(135deg, #0b0b0c 0%, #101114 60%, #0c0d10 100%);
      filter: blur(30px) saturate(1);
      animation: drift 18s ease-in-out infinite alternate;
      z-index:-1;
    }
    @keyframes drift{
      0%{ transform: translateY(-2%) translateX(-1%); }
      100%{ transform: translateY(2%) translateX(1%); }
    }

    .screen { position: absolute; inset: 0; display: none; }
    .screen.active { display: block; }

    .stream-container {
      display: flex; height: 100vh; width: 100vw; position: relative;
      background: radial-gradient(1200px 600px at 50% 110%, rgba(255,255,255,.06), transparent 60%);
      transition: filter 300ms ease, opacity 300ms ease, transform .6s ease;
    }
    .stream-container.dimmed { filter: brightness(0.75) contrast(0.95) saturate(0.95); }

    video.video-stream {
      flex: 1; object-fit: cover; background-color: #000; width: 50%; height: 100%;
      filter: brightness(0.9) contrast(1.15) saturate(1.1);
      border-right: 1px solid var(--stroke);
    }
    video.video-stream:last-child{ border-right:none; border-left:1px solid var(--stroke); }

    .overlay { position: absolute; inset: 0; pointer-events: none; z-index: 10; }

    .top-bar, .bottom-bar {
      position: absolute; width: 100%;
      display: flex; justify-content: space-between; align-items:center;
      pointer-events: auto; z-index: 20;
      background: rgba(17,18,20,.75);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--stroke);
      box-shadow: var(--shadow);
    }
    .top-bar { top: 0; height: 40px; padding: 6px 14px; }
    .bottom-bar { bottom: 0; padding: 8px 14px; border-top: 1px solid var(--stroke); border-bottom:none; gap: 16px; }

    .nav-icon {
      font-size: 14px; color: var(--ink-2); cursor: pointer; padding:8px 10px; border-radius:10px;
      transition: transform 0.25s, background .2s, color .2s;
    }
    .nav-icon:hover { transform: translateY(-1px); background: rgba(255,255,255,.06); color: var(--ink); }

    .side-controls.left, .side-controls.right {
      position: absolute; bottom: 140px; display: flex; flex-direction: column; gap: 14px;
      pointer-events: auto; z-index: 30;
    }
    .side-controls.left { left: 15px; }
    .side-controls.right { right: 15px; }

    .side-button {
      width: 38px; height: 38px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--stroke);
      border-radius: 12px; display: flex; align-items: center; justify-content: center;
      font-size: 18px; color: var(--ink-2);
      cursor: pointer; transition: transform 0.25s, background .2s, color .2s;
      box-shadow: var(--shadow);
    }
    .side-button:hover { transform: translateY(-1px) scale(1.03); background: rgba(255,255,255,.1); color: var(--ink); }
    .floating { animation: floatUpDown 3s ease-in-out infinite; }

    .profile-labels { position: absolute; top: 48px; right: 20px; display: flex; justify-content: flex-end; z-index: 40; }
    .profile-entry {
      display: flex; align-items: center; gap: 10px;
      background: rgba(255,255,255,.06); padding: 6px 14px; border-radius: 12px;
      border: 1px solid var(--stroke); box-shadow: var(--shadow);
      animation: floatUpDown 4s ease-in-out infinite;
    }
    .profile-entry img { width: 34px; height: 34px; border-radius: 10px; animation: floatLeftRight 6s ease-in-out infinite; box-shadow: var(--shadow); }
    .profile-entry span { font-size: 14px; color: var(--ink-2); }

    @keyframes floatUpDown { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-4px)} }
    @keyframes floatLeftRight { 0%,100%{transform:translateX(0)} 50%{transform:translateX(5px)} }

    .round-timer {
      position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%);
      background: rgba(255,255,255,.06); padding: 12px 26px; border-radius: 14px;
      font-size: 16px; font-weight: 700; color: var(--ink); border: 1px solid var(--stroke);
      box-shadow: var(--shadow); animation: pulse 2.4s infinite; z-index: 50;
      pointer-events: none; text-align: center;
    }
    .round-timer.animate { background: rgba(255,255,255,.12); }
    @keyframes pulse { 0%{transform:translateX(-50%) scale(1)} 50%{transform:translateX(-50%) scale(1.03)} 100%{transform:translateX(-50%) scale(1)} }

    /* Modals */
    .modal {
      position: absolute; inset: 0; display: none; align-items: center; justify-content: center;
      z-index: 1000; background: rgba(0,0,0,0.45); backdrop-filter: blur(6px); pointer-events: auto;
    }
    .modal.show { display: flex; }

    .card {
      background: var(--bg-1); border: 1px solid var(--stroke); border-radius: 16px;
      width: min(92vw, 760px); padding: 20px; box-shadow: var(--shadow);
    }
    .card h2 { margin-bottom: 8px; color: var(--ink); font-size: 20px; text-align: center; }
    .slogan { margin: 8px auto 16px; padding: 10px 12px; border-radius: 10px; background: rgba(255,255,255,.04); border: 1px solid var(--stroke); font-size: 12px; line-height: 1.6; color: var(--ink-3); text-align: center; }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-top: 12px; }

    .pill {
      display: flex; align-items: center; justify-content: center;
      min-height: 56px; width: 100%; padding: 10px 8px; text-align: center;
      white-space: normal; word-break: break-word; line-height: 1.2; font-size: 15px; letter-spacing: 0.4px;
      background: rgba(255,255,255,.06); border: 1px solid var(--stroke);
      border-radius: 12px; color: var(--ink-2); cursor: pointer; user-select: none;
      transition: transform .2s, background .2s, box-shadow .2s, color .2s;
    }
    .pill:focus-visible { outline: none; box-shadow: var(--ring); }
    .pill:hover { transform: translateY(-2px); background: rgba(255,255,255,.1); color: var(--ink); }
    .pill.active { background: rgba(255,255,255,.18); color: var(--ink); }

    .actions { margin-top: 16px; display: flex; justify-content: center; gap: 10px; }
    .btn {
      background: var(--accent); color: var(--accent-2); border: 1px solid var(--stroke);
      border-radius: 12px; padding: 10px 16px; cursor: pointer; font-weight: 800;
      transition: transform .2s, filter .2s;
    }
    .btn:hover { transform: translateY(-1px); filter: brightness(.9); }
    .btn.secondary { background: transparent; color: var(--ink); }

    .modal .sub-title { text-align: center; color: var(--ink-3); margin-top: 6px; font-size: 13px; }
    .muted { opacity: .8; font-size: 12px; margin-top: 10px; text-align:center; color: var(--ink-3); }

    #startBattleBtn {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) translateY(6px);
      background: var(--accent); color: var(--accent-2);
      border: 1px solid var(--stroke); font-size: 18px;
      padding: 14px 28px; border-radius: 16px; cursor: pointer;
      z-index: 1200; pointer-events: auto; box-shadow: var(--shadow);
      transition: all 0.25s ease; display: none;
    }
    #startBattleBtn:hover { transform: translate(-50%, -50%) translateY(4px) scale(1.02); }

    .placeholder { display:flex; align-items:center; justify-content:center; height:100%; width:100%; background: rgba(255,255,255,0.02); backdrop-filter: blur(4px); text-align:center; }
    .placeholder .box { border:1px solid var(--stroke); border-radius:16px; padding:24px 28px; background:var(--bg-1); max-width: 720px; width: calc(100% - 40px); box-shadow: var(--shadow); }
    .placeholder h1 { color:var(--ink); margin-bottom:8px; }
    .placeholder p { color:var(--ink-3); }

    /* Post-battle overlay */
    .post-modal { position:absolute; inset:0; display:none; align-items:center; justify-content:center; z-index:1100; background: rgba(0,0,0,0.55); backdrop-filter: blur(6px); }
    .post-modal.show { display:flex; }
    .post-card { background:var(--bg-1); border:1px solid var(--stroke); border-radius:16px; width:min(92vw,760px); padding:18px 20px; box-shadow: var(--shadow); }
    .post-card h3 { color:var(--ink); text-align:center; margin-bottom:8px; }
    .post-actions { display:flex; gap:10px; justify-content:center; margin-top:12px; }
  </style>
</head>
<body>
  <!-- SCREEN: BATTLE -->
  <div class="screen active" id="screen-battle">
    <div class="stream-container" id="streamContainer">
      <video class="video-stream" id="localVideo" autoplay muted playsinline></video>
      <video class="video-stream" id="opponentVideo" autoplay muted loop src="user2.mp4"></video>

      <!-- CATEGORY PICKER -->
      <div class="modal show" id="categoryModal" aria-modal="true" role="dialog">
        <div class="card">
          <h2>Pick a Category</h2>
          <div class="slogan">
            <div>1ST - <b>Defeat BILLIONS.</b></div>
            <div>2ND - <b>Choose Your BATTLE.</b></div>
            <div>3RD - <b>Defeat BILLIONS.</b></div>
          </div>

          <div class="grid" id="categoryGrid">
            <!-- Core set -->
            <button type="button" class="pill" data-cat="ART">ART</button>
            <button type="button" class="pill" data-cat="AUTO">AUTO</button>
            <button type="button" class="pill" data-cat="DEBAT">DEBAT</button>
            <button type="button" class="pill" data-cat="FASHION">FASHION</button>
            <button type="button" class="pill" data-cat="INSTRUMENTS">INSTRUMENTS</button>
            <button type="button" class="pill" data-cat="RAP">RAP</button>
            <!-- Added set -->
            <button type="button" class="pill" data-cat="DANCE">DANCE</button>
            <button type="button" class="pill" data-cat="COMEDY">COMEDY</button>
            <button type="button" class="pill" data-cat="GAMING">GAMING</button>
            <button type="button" class="pill" data-cat="COOKING">COOKING</button>
            <button type="button" class="pill" data-cat="FITNESS">FITNESS</button>
            <button type="button" class="pill" data-cat="PHOTOGRAPHY">PHOTOGRAPHY</button>
          </div>
          <div class="actions">
            <button class="btn secondary" id="cancelCat" type="button">Close</button>
          </div>
        </div>
      </div>

      <!-- CATEGORY OPTIONS -->
      <div class="modal" id="optionsModal" aria-modal="true" role="dialog">
        <div class="card">
          <h2 id="optionsTitle">Category Options</h2>
          <div class="sub-title" id="optionsSubtitle">Configure this battle</div>
          <div id="optionsBody"></div>
          <div class="muted" id="optionsHint"></div>
          <div class="actions" id="optionsActions" style="margin-top:12px;">
            <button class="btn secondary" id="backBtn" type="button">Back</button>
          </div>
        </div>
      </div>

      <!-- Center button shown after option chosen -->
      <button id="startBattleBtn" onclick="startBattle()">‚öîÔ∏è BattleBillions</button>

      <div class="overlay">
        <div class="top-bar">
          <div class="nav-icon">LIVE</div>
          <div class="nav-icon" id="viewerCountTop">üëÅÔ∏è 1,300</div>
        </div>

        <div class="profile-labels" id="profileLabels">
          <div class="profile-entry">
            <img src="user2.jpg" id="opponentImage" alt="User 2">
            <span id="opponentUsername">@Opponent</span>
          </div>
        </div>

        <div class="side-controls left">
          <div class="side-button floating" data-screen="profile">üë§</div>
          <div class="side-button" data-screen="dashboard">üîé</div>
          <div class="side-button" data-screen="login">üö™</div>
        </div>

        <div class="side-controls right">
          <div class="side-button" data-screen="home">üè†</div>
          <div class="side-button" data-screen="leaderboard">üèÜ</div>
          <div class="side-button" data-screen="battle">üì∫</div>
        </div>

        <div class="bottom-bar">
          <div class="nav-icon" data-screen="profile">üë§ Profile</div>
          <div class="nav-icon" data-screen="dashboard">Dashboard</div>
          <div class="nav-icon" data-screen="leaderboard">Leaderboard</div>
          <div class="nav-icon" data-screen="home">Home</div>
          <div class="nav-icon" data-screen="battle">Battle</div>
        </div>

        <div class="round-timer" id="roundTimer">Choose a category to begin‚Ä¶</div>
      </div>

      <!-- POST-BATTLE OVERLAY: category box + next opponent -->
      <div class="post-modal" id="postBattleModal" aria-modal="true" role="dialog">
        <div class="post-card">
          <h3>Battle Over ‚Äî What‚Äôs Next?</h3>
          <p class="muted">Stay in your category or pick a new one, then hit <b>Next Opponent</b> to keep battling.</p>
          <div class="grid" id="postCategoryGrid" style="margin-top:12px"></div>
          <div class="post-actions">
            <button class="btn secondary" id="postClose">Close</button>
            <button class="btn" id="postKeepCat">Keep Current Category</button>
            <button class="btn" id="postPickSub">Pick Subcategory</button>
            <button class="btn" id="postNextOpponent">Next Opponent</button>
          </div>
        </div>
      </div>
      <!-- /POST-BATTLE OVERLAY -->
    </div>
  </div>

  <!-- Other screens -->
  <div class="screen" id="screen-home"><div class="placeholder"><div class="box"><h1>Home</h1><p>Use the nav to jump back to <b>Battle</b> ‚Äî everything loads on this page.</p></div></div></div>
  <div class="screen" id="screen-profile"><div class="placeholder"><div class="box"><h1>Your Profile</h1><p>Profile settings soon. Click <b>Battle</b> to return.</p></div></div></div>
  <div class="screen" id="screen-leaderboard"><div class="placeholder"><div class="box"><h1>Leaderboard</h1><p>Top performers will appear here. Click <b>Battle</b> to return.</p></div></div></div>
  <div class="screen" id="screen-dashboard"><div class="placeholder"><div class="box"><h1>Dashboard Explorer</h1><p>Search & discovery UI goes here. Click <b>Battle</b> to return.</p></div></div></div>
  <div class="screen" id="screen-login"><div class="placeholder"><div class="box"><h1>Login</h1><p>Auth flow placeholder. Click <b>Battle</b> to return.</p></div></div></div>

  <audio id="roundEndSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_38ca955dae.mp3?filename=click-124467.mp3"></audio>
  <audio id="battleTrack" controls hidden></audio>

  <script>
    /* ========== SPA NAV ========== */
    const screens = {
      battle: document.getElementById('screen-battle'),
      home: document.getElementById('screen-home'),
      profile: document.getElementById('screen-profile'),
      leaderboard: document.getElementById('screen-leaderboard'),
      dashboard: document.getElementById('screen-dashboard'),
      login: document.getElementById('screen-login'),
    };
    function showScreen(name) {
      Object.entries(screens).forEach(([key, el]) => {
        if (key === name) el.classList.add('active'); else el.classList.remove('active');
      });
    }
    document.querySelectorAll('[data-screen]').forEach(el => {
      el.addEventListener('click', (e) => {
        e.preventDefault();
        showScreen(el.getAttribute('data-screen'));
      });
    });

    /* ========== Battle & Category State ========== */
    let currentCategory = null;
    let chosenOptions = {};
    let chosenSub = null;

    const opponentPools = {
      ART: [{ video: "art2.mp4", image: "art2.jpg", username: "@InkMage" }, { video: "art3.mp4", image: "art3.jpg", username: "@ColorCaster" }],
      AUTO: [{ video: "auto1.mp4", image: "auto1.jpg", username: "@TorqueLord" }, { video: "auto2.mp4", image: "auto2.jpg", username: "@RimReaper" }],
      DEBAT: [{ video: "deb1.mp4", image: "deb1.jpg", username: "@LogicBlade" }, { video: "deb2.mp4", image: "deb2.jpg", username: "@VerbalVolt" }],
      FASHION: [{ video: "fashion2.mp4", image: "fashion2.jpg", username: "@RunwayRuler" }, { video: "fashion3.mp4", image: "fashion3.jpg", username: "@FitArchitect" }],
      INSTRUMENTS: [{ video: "inst1.mp4", image: "inst1.jpg", username: "@ChordSmith" }, { video: "inst2.mp4", image: "inst2.jpg", username: "@DrumOracle" }],
      RAP: [{ video: "user3.mp4", image: "user3.jpg", username: "@ChallengerX" }, { video: "user4.mp4", image: "user4.jpg", username: "@MCNeo" }],
      DANCE: [{ video: "dance1.mp4", image: "dance1.jpg", username: "@Footwork" }, { video: "dance2.mp4", image: "dance2.jpg", username: "@WaveLord" }],
      COMEDY: [{ video: "comedy1.mp4", image: "comedy1.jpg", username: "@Punchliner" }, { video: "comedy2.mp4", image: "comedy2.jpg", username: "@CrowdKiller" }],
      GAMING: [{ video: "game1.mp4", image: "game1.jpg", username: "@Clutch" }, { video: "game2.mp4", image: "game2.jpg", username: "@Headshot" }],
      COOKING: [{ video: "cook1.mp4", image: "cook1.jpg", username: "@SearMaster" }, { video: "cook2.mp4", image: "cook2.jpg", username: "@MiseEnPlace" }],
      FITNESS: [{ video: "fit1.mp4", image: "fit1.jpg", username: "@RepMachine" }, { video: "fit2.mp4", image: "fit2.jpg", username: "@HIITHero" }],
      PHOTOGRAPHY: [{ video: "photo1.mp4", image: "photo1.jpg", username: "@LensCraft" }, { video: "photo2.mp4", image: "photo2.jpg", username: "@FrameChaser" }],
    };

    const subLists = {
      ART: ['Painting','Digital','Graffiti','Sculpture','Illustration'],
      AUTO: ['Drift','Drag','Build Showcase','Detailing','Audio Systems'],
      DEBAT: ['Politics','Tech','Sports','Culture','Freestyle'],
      FASHION: ['Runway','Streetwear','Vintage','Upcycle','Styling'],
      INSTRUMENTS: ['Guitar','Piano','Violin','Drums','DJ'],
      RAP: [
        {label:'Classic Trap', value:'beat1.mp3'},
        {label:'Boom Bap', value:'beat2.mp3'},
        {label:'Chill Vibes', value:'beat3.mp3'},
        {label:'Fast Flow', value:'beat4.mp3'},
      ],
      DANCE: ['Hip-Hop','Popping','Breaking','Contemporary','Freestyle'],
      COMEDY: ['Stand-up','Improv','Sketch','Roast','Storytelling'],
      GAMING: ['FPS','MOBA','Fighting','Speedrun','Battle Royale'],
      COOKING: ['Plating','Street Food','Fine Dining','BBQ','Desserts'],
      FITNESS: ['Calisthenics','Powerlifting','HIIT','Functional','Endurance'],
      PHOTOGRAPHY: ['Portrait','Street','Landscape','Macro','Product'],
    };

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 1280 }, height: { ideal: 720 } }, audio: true });
        document.getElementById('localVideo').srcObject = stream;
      } catch (err) {
        console.error('Camera error:', err);
      }
    }

    const streamContainer = document.getElementById('streamContainer');
    const timerDisplay = document.getElementById('roundTimer');
    const sound = document.getElementById('roundEndSound');
    const battleTrack = document.getElementById('battleTrack');
    const opponentVideo = document.getElementById('opponentVideo');
    theOpponentImage = document.getElementById('opponentImage');
    const opponentUsername = document.getElementById('opponentUsername');
    const viewerCountTop = document.getElementById('viewerCountTop');

    const categoryModal = document.getElementById('categoryModal');
    const optionsModal = document.getElementById('optionsModal');
    const optionsTitle = document.getElementById('optionsTitle');
    const optionsSubtitle = document.getElementById('optionsSubtitle');
    const optionsBody = document.getElementById('optionsBody');
    const optionsHint = document.getElementById('optionsHint');
    const startBattleBtn = document.getElementById('startBattleBtn');
    const categoryGrid = document.getElementById('categoryGrid');

    // Post-battle overlay elements
    const postModal = document.getElementById('postBattleModal');
    const postCategoryGrid = document.getElementById('postCategoryGrid');
    const postClose = document.getElementById('postClose');
    const postKeepCat = document.getElementById('postKeepCat');
    const postPickSub = document.getElementById('postPickSub');
    const postNextOpponent = document.getElementById('postNextOpponent');

    document.getElementById('cancelCat').onclick = () => {
      categoryModal.classList.remove('show');
      timerDisplay.innerText = "Open categories anytime to begin.";
      clearHash();
    };
    document.getElementById('backBtn').onclick = () => {
      optionsModal.classList.remove('show');
      categoryModal.classList.add('show');
      startBattleBtn.style.display = 'none';
      chosenSub = null;
      updateHash(currentCategory, null);
      categoryGrid.querySelectorAll('.pill').forEach(p=>p.classList.toggle('active', p.dataset.cat===currentCategory));
      categoryGrid.querySelector(`[data-cat="${currentCategory}"]`)?.focus();
    };

    // Category buttons
    categoryGrid.addEventListener('click', (e) => {
      const btn = e.target.closest('.pill[data-cat]');
      if (!btn) return;
      openCategory(btn.dataset.cat, true);
    });
    categoryGrid.addEventListener('keydown', (e) => {
      if ((e.key === 'Enter' || e.key === ' ') && e.target.matches('.pill[data-cat]')) {
        e.preventDefault();
        openCategory(e.target.dataset.cat, true);
      }
    });

    // Build post-battle category grid (same set)
    function buildPostCats(){
      postCategoryGrid.innerHTML = '';
      Object.keys(subLists).forEach(cat=>{
        const b=document.createElement('button');
        b.className='pill'; b.textContent=cat;
        b.addEventListener('click', ()=>{
          currentCategory = cat; chosenSub=null;
          postModal.classList.remove('show');
          categoryModal.classList.add('show');
          categoryGrid.querySelectorAll('.pill').forEach(p=>p.classList.toggle('active', p.dataset.cat===cat));
          openCategory(cat, true);
        });
        postCategoryGrid.appendChild(b);
      });
    }

    function openCategory(cat, fromUser) {
      try {
        currentCategory = cat;
        chosenSub = null;
        startBattleBtn.style.display = 'none';
        categoryGrid.querySelectorAll('.pill').forEach(p=>p.classList.toggle('active', p.dataset.cat===cat));
        buildOptionsFor(cat);
        categoryModal.classList.remove('show');
        optionsModal.classList.add('show');
        if (fromUser) updateHash(cat, null);
        optionsModal.querySelector('.pill')?.focus();
      } catch (err) {
        console.error('openCategory error:', err);
      }
    }

    function applyCategoryOpponent(cat) {
      const pool = opponentPools[cat] || [];
      if (pool.length) {
        const random = pool[Math.floor(Math.random() * pool.length)];
        opponentVideo.src = random.video;
        theOpponentImage.src = random.image;
        opponentUsername.innerText = random.username;
      }
    }

    function buildOptionsFor(cat) {
      optionsBody.innerHTML = '';
      chosenOptions = {};
      optionsHint.innerText = '';
      optionsTitle.innerText = `${cat} ‚Äì Options`;

      const wrapper = document.createElement('div');
      wrapper.className = 'grid';

      const items = subLists[cat] || [];
      if (cat === 'RAP') {
        optionsSubtitle.innerText = "Choose your instrumental.";
        items.forEach(b => {
          const btn = makePill(b.label, b.value, () => {
            chosenOptions.beat = b.value;
            chosenSub = b.label;
            battleTrack.src = b.value;
            battleTrack.load();
            optionsModal.classList.remove('show');
            startBattleBtn.style.display = 'block';
            timerDisplay.innerText = "Ready ‚Äî tap BattleBillions to start!";
            updateHash(cat, b.label);
            applyCategoryOpponent(cat);
          });
          wrapper.appendChild(btn);
        });
        optionsHint.innerText = "Only RAP uses instrumentals.";
      } else {
        const subtitleMap = {
          ART: "Choose your art style.",
          AUTO: "Choose your auto event.",
          DEBAT: "Choose your debate topic.",
          FASHION: "Choose your fashion lane.",
          INSTRUMENTS: "Choose your instrument.",
          DANCE: "Pick your dance style.",
          COMEDY: "Pick a comedy format.",
          GAMING: "Pick a gaming lane.",
          COOKING: "Choose your food focus.",
          FITNESS: "Choose your training style.",
          PHOTOGRAPHY: "Choose your shooting style.",
        };
        optionsSubtitle.innerText = subtitleMap[cat] || "Choose an option.";
        items.forEach(label => {
          const btn = makePill(label, label, () => {
            chosenSub = label;
            chosenOptions[cat.toLowerCase()] = label;
            optionsModal.classList.remove('show');
            startBattleBtn.style.display = 'block';
            timerDisplay.innerText = "Ready ‚Äî tap BattleBillions to start!";
            updateHash(cat, label);
            applyCategoryOpponent(cat);
          });
          wrapper.appendChild(btn);
        });
        optionsHint.innerText = "";
      }

      optionsBody.appendChild(wrapper);
    }

    function makePill(label, value, onChoose) {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'pill';
      btn.tabIndex = 0;
      btn.textContent = label;
      btn.dataset.value = value;
      btn.addEventListener('click', onChoose);
      btn.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); onChoose(); }
      });
      return btn;
    }

    /* Deep link: #cat/<CAT>/<SUB?>  */
    function updateHash(cat, sub) {
      const frag = `#cat/${encodeURIComponent(cat)}${sub?`/${encodeURIComponent(sub)}`:''}`;
      history.pushState({cat, sub}, '', frag);
    }
    function clearHash(){ history.pushState({}, '', location.pathname + location.search); }

    function parseHashAndOpen() {
      const m = location.hash.match(/^#cat\/([^\/]+)(?:\/([^\/]+))?/i);
      if (!m) return;
      const cat = decodeURIComponent(m[1]);
      const sub = m[2] ? decodeURIComponent(m[2]) : null;
      if (!subLists[cat]) return;
      openCategory(cat, false);
      if (sub) {
        setTimeout(() => {
          const target = Array.from(optionsBody.querySelectorAll('.pill'))
            .find(b => (b.textContent.trim() === sub) || (b.dataset.value === sub));
          target?.click();
        }, 0);
      }
    }
    window.addEventListener('popstate', parseHashAndOpen);
    window.addEventListener('hashchange', parseHashAndOpen);

    /* Round logic (3 rounds, 33s, 6s pause, dim during action) */
    let round = 1, roundPart = 0, timeLeft = 33;
    const maxRounds = 3;
    function setDim(active) { active ? streamContainer.classList.add('dimmed') : streamContainer.classList.remove('dimmed'); }
    function triggerGlow() { timerDisplay.classList.add('animate'); setTimeout(() => timerDisplay.classList.remove('animate'), 1600); }

    function runRoundPart() {
      setDim(true);
      const interval = setInterval(() => {
        timerDisplay.innerText = `Round ${round} of ${maxRounds} | ${(roundPart === 0 ? '@You' : '@Opponent')} | ${timeLeft}s`;
        timeLeft--;
        if (timeLeft < 0) {
          clearInterval(interval);
          sound.play();
          setDim(false);

          if (roundPart === 0) {
            roundPart = 1; timeLeft = 33;
            timerDisplay.innerText = `Switching to Opponent‚Ä¶`;
            setTimeout(runRoundPart, 6000);
          } else {
            if (round < maxRounds) {
              round++; roundPart = 0; timeLeft = 33;
              timerDisplay.innerText = `Switching to Next Round‚Ä¶`;
              setTimeout(runRoundPart, 6000);
            } else {
              timerDisplay.innerText = 'Battle Over ‚Äî Great Work!';
              triggerGlow(); setDim(false);
              buildPostCats();
              postModal.classList.add('show');
              loadRandomOpponent();
              startBattleBtn.style.display = 'block';
            }
          }
        }
      }, 1000);
    }

    function startBattle() {
      if (!currentCategory) { timerDisplay.innerText = "Pick a category first."; return; }
      if (currentCategory === 'RAP') {
        if (!chosenOptions.beat) { timerDisplay.innerText = "Pick an instrumental to start."; return; }
        battleTrack.play().catch(()=>{});
      } else {
        battleTrack.pause(); battleTrack.currentTime = 0;
      }
      postModal.classList.remove('show');
      startBattleBtn.style.display = 'none';
      triggerGlow();
      round = 1; roundPart = 0; timeLeft = 33;
      runRoundPart();
    }

    function loadRandomOpponent() {
      const pool = opponentPools[currentCategory] || [];
      if (pool.length) {
        const random = pool[Math.floor(Math.random() * pool.length)];
        opponentVideo.src = random.video;
        theOpponentImage.src = random.image;
        opponentUsername.innerText = random.username;
      }
      setTimeout(() => {
        timerDisplay.innerText = "New Opponent Ready ‚Äî pick options or press BattleBillions!";
      }, 900);
    }

    // Post-battle actions
    postClose.addEventListener('click', ()=> postModal.classList.remove('show'));
    postKeepCat.addEventListener('click', ()=>{
      if(!currentCategory || !chosenSub){ postModal.classList.remove('show'); categoryModal.classList.add('show'); return; }
      postModal.classList.remove('show');
      startBattleBtn.style.display='block';
      timerDisplay.innerText = "Tap BattleBillions to continue.";
    });
    postPickSub.addEventListener('click', ()=>{
      postModal.classList.remove('show');
      categoryModal.classList.add('show');
      if(currentCategory){
        categoryGrid.querySelectorAll('.pill').forEach(p=>p.classList.toggle('active', p.dataset.cat===currentCategory));
        openCategory(currentCategory, true);
      }
    });
    postNextOpponent.addEventListener('click', ()=>{
      postModal.classList.remove('show');
      loadRandomOpponent();
      startBattleBtn.style.display='block';
      timerDisplay.innerText = "Opponent switched. Tap BattleBillions to start!";
    });

    /* Viewer count tick (subtle) */
    let viewers = 1300;
    setInterval(()=>{
      const delta = Math.floor(Math.random()*13)-6; // -6..+6
      viewers = Math.max(0, viewers + delta);
      viewerCountTop.textContent = `üëÅÔ∏è ${viewers.toLocaleString()}`;
    }, 1600);

    /* Init */
    window.onload = () => {
      showScreen('battle');
      startCamera();
      timerDisplay.innerText = "Choose a category to begin‚Ä¶";
      setDim(false);
      parseHashAndOpen();
    };
  </script>
</body>
</html>
