<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>3ATTL33ILLIONS</title>

  <!-- Virgo font (local file) -->
  <style>
    @font-face{
      font-family:'Virgo';
      src:
        url('Virgo.woff2') format('woff2'),
        url('Virgo.ttf') format('truetype');
      font-display:swap;
    }
  </style>

  <style>
    :root{
      --bg-0:#000000; /* full solid black feel */
      --bg-1:#111214; --bg-2:#15171a;
      --ink:#e9edf1; --ink-2:#cfd6dd; --ink-3:#9aa3ad;
      --stroke:#2a2d31; --accent:#ffffff; --accent-2:#1f1f22;
      --ring:0 0 0 3px rgba(255,255,255,.12);
      --gold-1:#F5D76E; --gold-2:#F0B90B; --gold-3:#FFD15C;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:'Virgo', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:var(--bg-0); color:var(--ink); overflow:hidden; letter-spacing:.2px;
    }

    /* Minimal ambient backdrop; super subtle so screen reads as solid black */
    body::before{
      content:"";position:fixed;inset:-20% -10%;
      background: radial-gradient(1200px 600px at 50% 110%, rgba(255,255,255,.03), transparent 60%);
      filter: blur(24px); opacity:.35; z-index:-1;
    }

    /* ====== Top bar — transparent, no borders ====== */
    .app-topbar{
      position:fixed;inset:0 0 auto 0;height:44px;display:flex;align-items:center;justify-content:space-between;
      padding:0 14px;background:transparent;border:none;backdrop-filter:none;z-index:1000
    }
    .brand{font-weight:900;letter-spacing:.8px;color:#fff;display:flex;align-items:center;gap:10px}
    .brand .wordmark{font-size:14px;opacity:.95}
    .top-right{display:flex;gap:10px;align-items:center}
    .chip{font-size:12px;color:var(--ink-2);padding:0;border:none;background:transparent}

    /* ====== Bottom tab bar — transparent, labels above icons ====== */
    .app-tabbar{
      position:fixed;left:0;right:0;bottom:0;height:72px;
      padding-bottom:calc(var(--safe-bottom));
      background:transparent;border:none;backdrop-filter:none;z-index:1000;
      display:grid;grid-template-columns:repeat(5,1fr)
    }
    .tab-btn{
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;
      color:var(--ink-2);cursor:pointer;user-select:none;transition:transform .2s,color .2s
    }
    .tab-btn:hover{color:var(--ink)}
    .tab-btn.active{color:#fff}
    .tab-btn svg{width:22px;height:22px;stroke:#fff;fill:none;opacity:.95}
    .tab-label{font-size:10px;letter-spacing:.35px;line-height:1}

    /* BILLIONS (3ILLIONS) gold animation */
    .tab-btn[data-screen="dashboard"] .tab-label{
      background:linear-gradient(90deg,var(--gold-1),var(--gold-2),var(--gold-3),var(--gold-2),var(--gold-1));
      background-size:300% 100%;-webkit-background-clip:text;background-clip:text;color:transparent;
      animation: shimmer 3.2s linear infinite
    }
    @keyframes shimmer{0%{background-position:0% 50%}100%{background-position:100% 50%}}
    .tab-btn[data-screen="dashboard"] svg .gold-stroke{stroke:url(#goldGrad)}

    /* ====== Content area ====== */
    .app-shell{position:fixed;inset:44px 0 72px 0}
    .screen{position:absolute;inset:0;display:none}
    .screen.active{display:block}

    /* ====== Battle screen ====== */
    .stream-container{
      display:flex;height:100%;width:100%;position:relative;
      background:transparent;
      transition:filter 300ms ease,opacity 300ms ease,transform .6s ease
    }
    .stream-container.dimmed{filter:brightness(.75) contrast(.95) saturate(.95)}
    video.video-stream{flex:1;object-fit:cover;background:#000;width:50%;height:100%;filter:brightness(.9) contrast(1.15) saturate(1.1)}
    video.video-stream + video.video-stream{border-left:1px solid rgba(255,255,255,.04)}
    .overlay{position:absolute;inset:0;pointer-events:none;z-index:10}

    /* Opponent profile — no outline/background; faded 3ATTL33ILLIONS behind */
    .profile-labels{
      position:absolute;top:12px;right:16px;display:flex;justify-content:flex-end;z-index:40;
      pointer-events:auto;
    }
    .profile-entry{
      position:relative; display:flex; align-items:center; gap:10px;
      background:transparent; padding:6px 14px; border:none; box-shadow:none; cursor:pointer;
      overflow:hidden; text-decoration:none; color:inherit;
    }
    .profile-entry::before{
      content:"3ATTL33ILLIONS";
      position:absolute; inset:0; left:6px; top:50%;
      transform:translateY(-50%);
      font-weight:900; font-size:22px; letter-spacing:.15em;
      color:#fff; opacity:.06; white-space:nowrap; pointer-events:none; z-index:0;
    }
    .profile-entry img{width:34px;height:34px;border-radius:10px;position:relative;z-index:1}
    .profile-entry span{font-size:14px;color:var(--ink-2);position:relative;z-index:1}

    /* ====== Small bottom-center "3ATTLE" start button ====== */
    .battle-fab{
      position:fixed;left:50%;bottom:calc(72px + var(--safe-bottom) + 56px);transform:translateX(-50%);
      padding:8px 14px;border-radius:999px;background:rgba(255,255,255,.10);color:#fff;
      border:none;backdrop-filter:none;z-index:1200;
      display:none;align-items:center;gap:8px;cursor:pointer;transition:transform .2s,opacity .2s,background .2s
    }
    .battle-fab:hover{background:rgba(255,255,255,.16);transform:translateX(-50%) translateY(-1px)}
    .battle-fab:focus-visible{outline:none;box-shadow:var(--ring)}

    /* ====== Choose Category (disappears after tap) ====== */
    .cat-fab{
      position:fixed;left:50%;bottom:calc(72px + var(--safe-bottom) + 14px);transform:translateX(-50%);
      padding:8px 14px;border-radius:999px;background:rgba(255,255,255,.10);color:#fff;
      border:none;backdrop-filter:none;z-index:1200;
      display:flex;align-items:center;gap:8px;cursor:pointer;transition:transform .2s,opacity .2s,background .2s
    }
    .cat-fab:hover{background:rgba(255,255,255,.16);transform:translateX(-50%) translateY(-1px)}
    .cat-fab:focus-visible{outline:none;box-shadow:var(--ring)}
    .cat-fab svg{width:18px;height:18px;stroke:#fff}

    /* ====== Round timer — hidden until battle starts ====== */
    .round-timer{
      position:absolute;bottom:108px;left:50%;transform:translateX(-50%);
      background:rgba(255,255,255,.06);padding:10px 20px;border-radius:14px;font-size:14px;font-weight:800;color:var(--ink);
      border:1px solid rgba(255,255,255,.08);z-index:50;pointer-events:none;text-align:center;display:none
    }
    .round-timer.pulse{animation:pulse 2.2s infinite}
    @keyframes pulse{0%{transform:translateX(-50%) scale(1)}50%{transform:translateX(-50%) scale(1.03)}100%{transform:translateX(-50%) scale(1)}}

    /* ====== Modals / Cards ====== */
    .modal{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:1000;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);pointer-events:auto}
    .modal.show{display:flex}

    .card{background:#0e0e0f;border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:20px}

    /* --- Smaller, scrollable Categories sheet --- */
    #categoryModal .card{
      width:min(92vw,520px);
      max-height:72vh;
      display:flex;flex-direction:column;gap:12px;
      padding:16px;
    }
    .cat-header{position:sticky;top:0;z-index:2;background:#0e0e0f;display:grid;grid-template-columns:1fr;gap:10px}
    .cat-header h2{font-size:18px;text-align:center;margin:2px 0 0}
    .cat-search{display:flex;gap:8px;align-items:center}
    .cat-search input{
      flex:1;background:#0b0b0c;border:1px solid rgba(255,255,255,.08);
      border-radius:12px;padding:10px 12px;color:#fff;font-family:'Virgo',sans-serif;
    }
    .cat-search input::placeholder{color:#9aa3ad}
    .cat-count{
      font-size:12px;color:#cfd6dd;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.04)
    }
    .cat-scroller{position:relative;flex:1;min-height:220px;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:2px}
    .cat-empty{display:none;text-align:center;color:#9aa3ad;font-size:13px;padding:16px}
    .cat-empty.show{display:block}

    /* Generic grid + pills (reused) */
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
    .pill{display:flex;align-items:center;justify-content:center;min-height:56px;width:100%;padding:10px 8px;text-align:center;white-space:normal;word-break:break-word;line-height:1.2;font-size:15px;letter-spacing:.4px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:12px;color:var(--ink-2);cursor:pointer;user-select:none;transition:transform .2s,background .2s,box-shadow .2s,color .2s}
    .pill:hover{transform:translateY(-2px);background:rgba(255,255,255,.1);color:var(--ink)}
    .pill:focus-visible{outline:none;box-shadow:var(--ring)}
    .pill.active{background:rgba(255,255,255,.18);color:var(--ink)}

    .actions{margin-top:10px;display:flex;justify-content:center;gap:10px}
    .btn{background:var(--accent);color:var(--accent-2);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px 16px;cursor:pointer;font-weight:800;transition:transform .2s,filter .2s}
    .btn:hover{transform:translateY(-1px);filter:brightness(.9)}
    .btn.secondary{background:transparent;color:var(--ink)}

    .modal .sub-title{text-align:center;color:var(--ink-3);margin-top:6px;font-size:13px}
    .muted{opacity:.8;font-size:12px;margin-top:10px;text-align:center;color:var(--ink-3)}

    .placeholder{display:flex;align-items:center;justify-content:center;height:100%;width:100%;text-align:center}
    .placeholder .box{border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:24px 28px;background:#0e0e0f;max-width:720px;width:calc(100% - 40px)}
    .placeholder h1{color:var(--ink);margin-bottom:8px}
    .placeholder p{color:var(--ink-3)}

    /* Post-battle */
    .post-modal{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:1100;background:rgba(0,0,0,.55);backdrop-filter:blur(6px)}
    .post-modal.show{display:flex}
    .post-card{background:#0e0e0f;border:1px solid rgba(255,255,255,.06);border-radius:16px;width:min(92vw,820px);padding:18px 20px}
    .post-card h3{color:var(--ink);text-align:center;margin-bottom:8px}
    .post-actions{display:flex;gap:10px;justify-content:center;margin-top:12px}
  </style>
</head>
<body>
  <!-- SVG sprite & gold gradient -->
  <svg width="0" height="0" style="position:absolute;opacity:0;">
    <defs>
      <linearGradient id="goldGrad" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" stop-color="#F5D76E"><animate attributeName="offset" values="0;1;0" dur="5s" repeatCount="indefinite"/></stop>
        <stop offset="50%" stop-color="#F0B90B"><animate attributeName="offset" values=".5;1;.5" dur="5s" repeatCount="indefinite"/></stop>
        <stop offset="100%" stop-color="#FFD15C"><animate attributeName="offset" values="1;0;1" dur="5s" repeatCount="indefinite"/></stop>
      </linearGradient>
      <symbol id="ic-home" viewBox="0 0 24 24"><path d="M3 11.5L12 4l9 7.5V20a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-8.5z" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></symbol>
      <symbol id="ic-battle" viewBox="0 0 24 24"><path d="M10 4h4M4 10h16M4 14h16M10 20h4" stroke-width="1.6" stroke-linecap="round"/><path d="M8 4l-2 6 2 6M16 4l2 6-2 6" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></symbol>
      <symbol id="ic-trophy" viewBox="0 0 24 24"><path d="M7 4h10v3a4 4 0 0 1-4 4h-2a4 4 0 0 1-4-4V4z" stroke-width="1.6"/><path d="M17 7h2a2 2 0 0 0 2-2V4h-4M7 7H5a2 2 0 0 1-2-2V4h4" stroke-width="1.6"/><path d="M10 11v3H8v2h8v-2h-2v-3" stroke-width="1.6"/></symbol>
      <symbol id="ic-search" viewBox="0 0 24 24"><circle cx="11" cy="11" r="6.5" class="gold-stroke" stroke-width="1.6"/><path d="M20 20l-3.5-3.5" class="gold-stroke" stroke-width="1.6" stroke-linecap="round"/></symbol>
      <symbol id="ic-user" viewBox="0 0 24 24"><path d="M12 12a4.2 4.2 0 1 0 0-8.4 4.2 4.2 0 0 0 0 8.4Z" stroke-width="1.6"/><path d="M4 20.4a8 8 0 0 1 16 0" stroke-width="1.6" stroke-linecap="round"/></symbol>
      <symbol id="ic-eye" viewBox="0 0 24 24"><path d="M2.5 12S6.5 6.5 12 6.5 21.5 12 21.5 12 17.5 17.5 12 17.5 2.5 12 2.5 12z" stroke-width="1.6"/><circle cx="12" cy="12" r="2.8" stroke-width="1.6"/></symbol>
      <symbol id="ic-play" viewBox="0 0 24 24"><path d="M7 5v14l11-7-11-7z" stroke-width="1.6" stroke-linejoin="round"/></symbol>
      <symbol id="ic-grid" viewBox="0 0 24 24"><path d="M4 4h6v6H4zM14 4h6v6h-6zM4 14h6v6H4zM14 14h6v6h-6z" stroke-width="1.6"/></symbol>
    </defs>
  </svg>

  <!-- Top bar -->
  <header class="app-topbar">
    <div class="brand"><div class="wordmark">3ATTL33ILLIONS</div></div>
    <div class="top-right">
      <div class="chip" id="viewerCountTop"><svg style="width:14px;height:14px;vertical-align:-2px;"><use href="#ic-eye"/></svg>&nbsp;1,300</div>
      <div class="chip">LIVE</div>
    </div>
  </header>

  <!-- Small bottom-center "3ATTLE" start -->
  <button class="battle-fab" id="startBattleFab" aria-label="Start 3ATTLE">3ATTLE</button>

  <!-- Choose Category (disappears after first tap) -->
  <button class="cat-fab" id="openCats" aria-haspopup="dialog" aria-controls="categoryModal">
    <svg><use href="#ic-grid"/></svg><span>Choose Category</span>
  </button>

  <!-- Content -->
  <main class="app-shell">
    <!-- Battle -->
    <section class="screen active" id="screen-battle" data-route="battle">
      <div class="stream-container" id="streamContainer">
        <video class="video-stream" id="localVideo" autoplay muted playsinline></video>
        <video class="video-stream" id="opponentVideo" autoplay muted loop src="user2.mp4"></video>

        <!-- Category Picker (now small + scroll + search) -->
        <div class="modal" id="categoryModal" aria-modal="true" role="dialog">
          <div class="card">
            <div class="cat-header">
              <h2>Pick a Category</h2>
              <div class="cat-search">
                <input id="catSearch" type="search" placeholder="Search categories…" aria-label="Search categories">
                <div class="cat-count" id="catCount">0</div>
              </div>
            </div>

            <div class="cat-scroller">
              <div class="grid" id="categoryGrid"></div>
              <div class="cat-empty" id="catEmpty">No categories match your search.</div>
            </div>

            <div class="actions">
              <button class="btn secondary" id="cancelCat" type="button">Close</button>
            </div>
          </div>
        </div>

        <!-- Options -->
        <div class="modal" id="optionsModal" aria-modal="true" role="dialog">
          <div class="card" style="width:min(92vw,680px);max-height:76vh;display:flex;flex-direction:column;gap:12px;">
            <h2 id="optionsTitle">Category Options</h2>
            <div class="sub-title" id="optionsSubtitle">Configure this 3ATTLE</div>
            <div id="optionsBody"></div>
            <div class="muted" id="optionsHint"></div>
            <div class="actions" id="optionsActions" style="margin-top:12px;">
              <button class="btn secondary" id="backBtn" type="button">Back</button>
            </div>
          </div>
        </div>

        <div class="overlay">
          <!-- Clickable opponent profile (routes to Profile screen) -->
          <div class="profile-labels" id="profileLabels">
            <a href="#/profile" class="profile-entry" id="opponentProfile" data-screen="profile" aria-label="Open opponent profile">
              <img src="user2.jpg" id="opponentImage" alt="User 2">
              <span id="opponentUsername">@Opponent</span>
            </a>
          </div>

          <!-- Timer (hidden until battle starts) -->
          <div class="round-timer" id="roundTimer"></div>
        </div>

        <!-- Post-battle -->
        <div class="post-modal" id="postBattleModal" aria-modal="true" role="dialog">
          <div class="post-card">
            <h3>3ATTLE Over — What’s Next?</h3>
            <p class="muted">Stay in your category or pick a new one, then hit <b>Next Opponent</b>.</p>
            <div class="grid" id="postCategoryGrid" style="margin-top:12px"></div>
            <div class="post-actions">
              <button class="btn secondary" id="postClose">Close</button>
              <button class="btn" id="postKeepCat">Keep Current Category</button>
              <button class="btn" id="postPickSub">Pick Subcategory</button>
              <button class="btn" id="postNextOpponent">Next Opponent</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Other screens -->
    <section class="screen" id="screen-home" data-route="home">
      <div class="placeholder"><div class="box"><h1>Home</h1><p>Single-page flow. Use the tab bar.</p></div></div>
    </section>
    <section class="screen" id="screen-dashboard" data-route="dashboard">
      <div class="placeholder"><div class="box"><h1>3ILLIONS</h1><p>Discover the biggest 3ATTLES, trends, and challengers.</p></div></div>
    </section>
    <section class="screen" id="screen-leaderboard" data-route="leaderboard">
      <div class="placeholder"><div class="box"><h1>Leaderboard</h1><p>Top performers will appear here.</p></div></div>
    </section>
    <section class="screen" id="screen-profile" data-route="profile">
      <div class="placeholder"><div class="box"><h1>Profile</h1><p>Opponent profile opens here from the battle overlay.</p></div></div>
    </section>
  </main>

  <!-- Bottom tabs -->
  <nav class="app-tabbar" role="tablist" aria-label="Main">
    <a class="tab-btn" data-screen="home" role="tab" aria-selected="false">
      <span class="tab-label">Home</span>
      <svg><use href="#ic-home"/></svg>
    </a>
    <a class="tab-btn" data-screen="dashboard" role="tab" aria-selected="false" title="3ILLIONS">
      <span class="tab-label">3ILLIONS</span>
      <svg><use href="#ic-search"/></svg>
    </a>
    <a class="tab-btn active" data-screen="battle" role="tab" aria-selected="true">
      <span class="tab-label">3ATTLES</span>
      <svg><use href="#ic-battle"/></svg>
    </a>
    <a class="tab-btn" data-screen="leaderboard" role="tab" aria-selected="false">
      <span class="tab-label">Leaders</span>
      <svg><use href="#ic-trophy"/></svg>
    </a>
    <a class="tab-btn" data-screen="profile" role="tab" aria-selected="false">
      <span class="tab-label">Profile</span>
      <svg><use href="#ic-user"/></svg>
    </a>
  </nav>

  <!-- Audio -->
  <audio id="roundEndSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_38ca955dae.mp3?filename=click-124467.mp3"></audio>
  <audio id="battleTrack" controls hidden></audio>

  <script>
    /* ====== SPA Nav ====== */
    const screens = [...document.querySelectorAll('.screen')].reduce((acc, el) => (acc[el.dataset.route]=el, acc), {});
    const tabs = document.querySelectorAll('.tab-btn');

    function showScreen(name){
      Object.entries(screens).forEach(([k,el])=>el.classList.toggle('active',k===name));
      tabs.forEach(t=>{
        const on = t.getAttribute('data-screen')===name;
        t.classList.toggle('active',on);
        t.setAttribute('aria-selected',on?'true':'false');
      });
    }

    // Global delegated nav (tabs + opponent box)
    document.addEventListener('click',(e)=>{
      const link = e.target.closest('[data-screen]');
      if(!link) return;
      e.preventDefault();
      const target = link.getAttribute('data-screen');
      showScreen(target);
      if (target!=='battle') closeAllModals();
      if (!location.hash.startsWith('#cat/')) location.hash = '#/'+target;
    });

    function routeFromHash(){
      const h=location.hash;
      if(h.startsWith('#/')){
        const r=h.slice(2); if(screens[r]) showScreen(r);
      } else if(h.startsWith('#cat/')){
        showScreen('battle'); parseHashAndOpen();
      }
    }
    window.addEventListener('hashchange', routeFromHash);

    /* ====== Battle & Category State ====== */
    let currentCategory=null, chosenOptions={}, chosenSub=null;

    const opponentPools={ 
      ART:[{video:"art2.mp4",image:"art2.jpg",username:"@InkMage"},{video:"art3.mp4",image:"art3.jpg",username:"@ColorCaster"}],
      AUTO:[{video:"auto1.mp4",image:"auto1.jpg",username:"@TorqueLord"},{video:"auto2.mp4",image:"auto2.jpg",username:"@RimReaper"}],
      DEBAT:[{video:"deb1.mp4",image:"deb1.jpg",username:"@LogicBlade"},{video:"deb2.mp4",image:"deb2.jpg",username:"@VerbalVolt"}],
      FASHION:[{video:"fashion2.mp4",image:"fashion2.jpg",username:"@RunwayRuler"},{video:"fashion3.mp4",image:"fashion3.jpg",username:"@FitArchitect"}],
      INSTRUMENTS:[{video:"inst1.mp4",image:"inst1.jpg",username:"@ChordSmith"},{video:"inst2.mp4",image:"inst2.jpg",username:"@DrumOracle"}],
      RAP:[{video:"user3.mp4",image:"user3.jpg",username:"@ChallengerX"},{video:"user4.mp4",image:"user4.jpg",username:"@MCNeo"}],
      DANCE:[{video:"dance1.mp4",image:"dance1.jpg",username:"@Footwork"},{video:"dance2.mp4",image:"dance2.jpg",username:"@WaveLord"}],
      COMEDY:[{video:"comedy1.mp4",image:"comedy1.jpg",username:"@Punchliner"},{video:"comedy2.mp4",image:"comedy2.jpg",username:"@CrowdKiller"}],
      GAMING:[{video:"game1.mp4",image:"game1.jpg",username:"@Clutch"},{video:"game2.mp4",image:"game2.jpg",username:"@Headshot"}],
      COOKING:[{video:"cook1.mp4",image:"cook1.jpg",username:"@SearMaster"},{video:"cook2.mp4",image:"cook2.jpg",username:"@MiseEnPlace"}],
      FITNESS:[{video:"fit1.mp4",image:"fit1.jpg",username:"@RepMachine"},{video:"fit2.mp4",image:"fit2.jpg",username:"@HIITHero"}],
      PHOTOGRAPHY:[{video:"photo1.mp4",image:"photo1.jpg",username:"@LensCraft"},{video:"photo2.mp4",image:"photo2.jpg",username:"@FrameChaser"}],
      SINGING:[{video:"sing1.mp4",image:"sing1.jpg",username:"@VocalEdge"},{video:"sing2.mp4",image:"sing2.jpg",username:"@Falsetto"}],
      POETRY:[{video:"poe1.mp4",image:"poe1.jpg",username:"@VerseKing"},{video:"poe2.mp4",image:"poe2.jpg",username:"@Stanza"}],
      MAGIC:[{video:"mag1.mp4",image:"mag1.jpg",username:"@CardFlux"},{video:"mag2.mp4",image:"mag2.jpg",username:"@IllusionX"}],
      SPORTS:[{video:"spo1.mp4",image:"spo1.jpg",username:"@ClutchTime"},{video:"spo2.mp4",image:"spo2.jpg",username:"@GoatTalk"}],
      TECH:[{video:"tech1.mp4",image:"tech1.jpg",username:"@DevWizard"},{video:"tech2.mp4",image:"tech2.jpg",username:"@ByteSmith"}],
      EDU:[{video:"edu1.mp4",image:"edu1.jpg",username:"@MindCoach"},{video:"edu2.mp4",image:"edu2.jpg",username:"@LessonLab"}],
      FILM:[{video:"film1.mp4",image:"film1.jpg",username:"@CutMaster"},{video:"film2.mp4",image:"film2.jpg",username:"@SceneLord"}],
      PODCAST:[{video:"pod1.mp4",image:"pod1.jpg",username:"@HotMic"},{video:"pod2.mp4",image:"pod2.jpg",username:"@TalkFlow"}],
      BEAUTY:[{video:"bea1.mp4",image:"bea1.jpg",username:"@BlendQueen"},{video:"bea2.mp4",image:"bea2.jpg",username:"@Contour"}],
      DIY:[{video:"diy1.mp4",image:"diy1.jpg",username:"@ToolTime"},{video:"diy2.mp4",image:"diy2.jpg",username:"@Maker"}],
      ASMR:[{video:"asm1.mp4",image:"asm1.jpg",username:"@Whisper"},{video:"asm2.mp4",image:"asm2.jpg",username:"@Tingle"}],
      MEMES:[{video:"mem1.mp4",image:"mem1.jpg",username:"@TemplateKing"},{video:"mem2.mp4",image:"mem2.jpg",username:"@Dank"}],
      TATTOO:[{video:"tat1.mp4",image:"tat1.jpg",username:"@InkLord"},{video:"tat2.mp4",image:"tat2.jpg",username:"@ShadeMaster"}],
    };

    const subLists={
      ART:['Painting','Digital','Graffiti','Sculpture','Illustration'],
      AUTO:['Drift','Drag','Build Showcase','Detailing','Audio Systems'],
      DEBAT:['Politics','Tech','Sports','Culture','Freestyle'],
      FASHION:['Runway','Streetwear','Vintage','Upcycle','Styling'],
      INSTRUMENTS:['Guitar','Piano','Violin','Drums','DJ'],
      RAP:[{label:'Classic Trap',value:'beat1.mp3'},{label:'Boom Bap',value:'beat2.mp3'},{label:'Chill Vibes',value:'beat3.mp3'},{label:'Fast Flow',value:'beat4.mp3'}],
      DANCE:['Hip-Hop','Popping','Breaking','Contemporary','Freestyle'],
      COMEDY:['Stand-up','Improv','Sketch','Roast','Storytelling'],
      GAMING:['FPS','MOBA','Fighting','Speedrun','Battle Royale'],
      COOKING:['Plating','Street Food','Fine Dining','BBQ','Desserts'],
      FITNESS:['Calisthenics','Powerlifting','HIIT','Functional','Endurance'],
      PHOTOGRAPHY:['Portrait','Street','Landscape','Macro','Product'],
      SINGING:['R&B','Pop','Gospel','Opera','Freestyle'],
      POETRY:['Spoken Word','Haiku','Slam','Narrative','Freestyle'],
      MAGIC:['Cards','Coins','Mentalism','Stage','Close-up'],
      SPORTS:['Basketball','Football','Soccer','Boxing','Track'],
      TECH:['Coding','Gadgets','AI Demos','Hardware Mods','AR/VR'],
      EDU:['Math','Science','History','Language','Life Skills'],
      FILM:['Cinematography','Editing','VFX','Color','Directing'],
      PODCAST:['Interview','Debate','Solo','Roundtable','Live Call-in'],
      BEAUTY:['Makeup','Hair','Skin','Nails','FX'],
      DIY:['Woodwork','3D Print','Home Hack','Repair','Custom Build'],
      ASMR:['Tapping','Whisper','Keyboard','Crinkle','Brushing'],
      MEMES:['Trend Flip','Original Skit','Sound Remix','Green Screen','Duet'],
      TATTOO:['Linework','Black&Grey','Color','Neo-trad','Realism'],
    };

    const streamContainer=document.getElementById('streamContainer');
    const timerDisplay=document.getElementById('roundTimer');
    const sound=document.getElementById('roundEndSound');
    const battleTrack=document.getElementById('battleTrack');
    const opponentVideo=document.getElementById('opponentVideo');
    const opponentImage=document.getElementById('opponentImage');
    const opponentUsername=document.getElementById('opponentUsername');
    const viewerCountTop=document.getElementById('viewerCountTop');

    const categoryModal=document.getElementById('categoryModal');
    const optionsModal=document.getElementById('optionsModal');
    const optionsTitle=document.getElementById('optionsTitle');
    const optionsSubtitle=document.getElementById('optionsSubtitle');
    const optionsBody=document.getElementById('optionsBody');
    const optionsHint=document.getElementById('optionsHint');
    const startBattleFab=document.getElementById('startBattleFab');
    const categoryGrid=document.getElementById('categoryGrid');
    const catSearch=document.getElementById('catSearch');
    const catCount=document.getElementById('catCount');
    const catEmpty=document.getElementById('catEmpty');

    const postModal=document.getElementById('postBattleModal');
    const postCategoryGrid=document.getElementById('postCategoryGrid');
    const postClose=document.getElementById('postClose');
    const postKeepCat=document.getElementById('postKeepCat');
    const postPickSub=document.getElementById('postPickSub');
    const postNextOpponent=document.getElementById('postNextOpponent');

    const openCats=document.getElementById('openCats');
    openCats.addEventListener('click',()=>{
      openCats.style.display='none';         // disappears after first tap
      categoryModal.classList.add('show');
      catSearch.value='';
      buildCategoryButtons('');
      catSearch.focus();
      location.hash = '#/battle';
    });

    function closeAllModals(){categoryModal.classList.remove('show');optionsModal.classList.remove('show');postModal.classList.remove('show')}
    document.getElementById('cancelCat').onclick=()=>{
      categoryModal.classList.remove('show');
      clearHash();
    };
    document.getElementById('backBtn').onclick=()=>{
      optionsModal.classList.remove('show');categoryModal.classList.add('show');startBattleFab.style.display='none';chosenSub=null;updateHash(currentCategory,null);
      categoryGrid.querySelectorAll('.pill').forEach(p=>p.classList.toggle('active',p.dataset.cat===currentCategory));
      categoryGrid.querySelector(`[data-cat="${currentCategory}"]`)?.focus();
    };

    // Build ALL categories dynamically + search filter
    const allCats = Object.keys(subLists); // ensures every category in subLists appears
    function buildCategoryButtons(filter){
      categoryGrid.innerHTML='';
      const f = (filter||'').trim().toLowerCase();
      const shown = [];
      allCats.sort((a,b)=>a.localeCompare(b)).forEach(cat=>{
        if(f && !cat.toLowerCase().includes(f)) return;
        const btn=document.createElement('button');
        btn.type='button'; btn.className='pill'; btn.dataset.cat=cat; btn.textContent=cat;
        categoryGrid.appendChild(btn);
        shown.push(cat);
      });
      catCount.textContent = String(shown.length);
      catEmpty.classList.toggle('show', shown.length===0);
    }

    // Search events
    catSearch.addEventListener('input', (e)=> buildCategoryButtons(e.target.value));
    catSearch.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){
        const first = categoryGrid.querySelector('.pill');
        if(first){ first.click(); }
      }
    });

    // Category grid interactions (delegated)
    categoryGrid.addEventListener('click',e=>{
      const btn=e.target.closest('.pill[data-cat]'); if(!btn) return; openCategory(btn.dataset.cat,true);
    });
    categoryGrid.addEventListener('keydown',e=>{
      if((e.key==='Enter'||e.key===' ')&&e.target.matches('.pill[data-cat]')){e.preventDefault();openCategory(e.target.dataset.cat,true);}
    });

    function buildPostCats(){
      postCategoryGrid.innerHTML='';
      Object.keys(subLists).forEach(cat=>{
        const b=document.createElement('button');b.className='pill';b.textContent=cat;
        b.addEventListener('click',()=>{
          currentCategory=cat;chosenSub=null;postModal.classList.remove('show');categoryModal.classList.add('show');
          catSearch.value=''; buildCategoryButtons(''); // show all when reopened
          openCategory(cat,true);
        });
        postCategoryGrid.appendChild(b);
      });
    }

    function openCategory(cat,fromUser){
      try{
        currentCategory=cat;chosenSub=null;startBattleFab.style.display='none';
        // visual select
        categoryGrid.querySelectorAll('.pill').forEach(p=>p.classList.toggle('active',p.dataset.cat===cat));
        buildOptionsFor(cat);
        categoryModal.classList.remove('show');optionsModal.classList.add('show');
        if (fromUser) updateHash(cat,null);
        optionsModal.querySelector('.pill')?.focus();
      }catch(err){console.error('openCategory error:',err)}
    }

    function applyCategoryOpponent(cat){
      const pool=opponentPools[cat]||[];
      if(pool.length){
        const random=pool[Math.floor(Math.random()*pool.length)];
        opponentVideo.src=random.video;opponentImage.src=random.image;opponentUsername.innerText=random.username;
      }
    }

    function buildOptionsFor(cat){
      optionsBody.innerHTML='';chosenOptions={};optionsHint.innerText='';optionsTitle.innerText=`${cat} – Options`;
      const wrapper=document.createElement('div');wrapper.className='grid';
      const items=subLists[cat]||[];
      if(cat==='RAP'){
        optionsSubtitle.innerText="Choose your instrumental.";
        items.forEach(b=>{
          const btn=makePill(b.label,b.value,()=>{
            chosenOptions.beat=b.value;chosenSub=b.label;battleTrack.src=b.value;battleTrack.load();
            optionsModal.classList.remove('show');startBattleFab.style.display='flex';
            updateHash(cat,b.label);applyCategoryOpponent(cat);
          });wrapper.appendChild(btn);
        });optionsHint.innerText="Only RAP uses instrumentals.";
      }else{
        const subtitleMap={ART:"Choose your art style.",AUTO:"Choose your auto event.",DEBAT:"Choose your debate topic.",FASHION:"Choose your fashion lane.",INSTRUMENTS:"Choose your instrument.",DANCE:"Pick your dance style.",COMEDY:"Pick a comedy format.",GAMING:"Pick a gaming lane.",COOKING:"Choose your food focus.",FITNESS:"Choose your training style.",PHOTOGRAPHY:"Choose your shooting style.",SINGING:"Pick your vocal lane.",POETRY:"Pick your poetry style.",MAGIC:"Pick your magic discipline.",SPORTS:"Pick your sport lane.",TECH:"Pick your tech demo lane.",EDU:"Pick your teaching lane.",FILM:"Pick your film craft.",PODCAST:"Pick your podcast format.",BEAUTY:"Pick your beauty lane.",DIY:"Pick your build lane.",ASMR:"Pick your trigger lane.",MEMES:"Pick your meme lane.",TATTOO:"Pick your tattoo style."};
        optionsSubtitle.innerText=subtitleMap[cat]||"Choose an option.";
        items.forEach(label=>{
          const btn=makePill(label,label,()=>{
            chosenSub=label;chosenOptions[cat.toLowerCase()]=label;optionsModal.classList.remove('show');startBattleFab.style.display='flex';
            updateHash(cat,label);applyCategoryOpponent(cat);
          });wrapper.appendChild(btn);
        });
      }
      optionsBody.appendChild(wrapper);
    }

    function makePill(label,value,onChoose){
      const btn=document.createElement('button');btn.type='button';btn.className='pill';btn.tabIndex=0;btn.textContent=label;btn.dataset.value=value;
      btn.addEventListener('click',onChoose);btn.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();onChoose();}});
      return btn;
    }

    /* Deep link */
    function updateHash(cat,sub){const frag=`#cat/${encodeURIComponent(cat)}${sub?`/${encodeURIComponent(sub)}`:''}`;history.pushState({cat,sub},'',frag)}
    function clearHash(){history.pushState({},'','#/battle')}
    function parseHashAndOpen(){
      const m=location.hash.match(/^#cat\/([^\/]+)(?:\/([^\/]+))?/i); if(!m) return;
      const cat=decodeURIComponent(m[1]); const sub=m[2]?decodeURIComponent(m[2]):null;
      if(!subLists[cat]) return; openCategory(cat,false);
      if(sub){setTimeout(()=>{const target=[...document.querySelectorAll('#optionsBody .pill')].find(b=>b.textContent.trim()===sub||b.dataset.value===sub);target?.click();},0)}
    }
    window.addEventListener('popstate',()=>{routeFromHash();parseHashAndOpen()});

    /* Rounds */
    let round=1,roundPart=0,timeLeft=33; const maxRounds=3;
    function setDim(a){a?streamContainer.classList.add('dimmed'):streamContainer.classList.remove('dimmed')}
    function glow(){timerDisplay.classList.add('pulse');setTimeout(()=>timerDisplay.classList.remove('pulse'),1400)}
    function runRoundPart(){
      // show timer now that battle is live
      timerDisplay.style.display='block';
      setDim(true);
      const interval=setInterval(()=>{
        timerDisplay.textContent=`Round ${round} of ${maxRounds} | ${(roundPart===0?'@You':'@Opponent')} | ${timeLeft}s`;
        timeLeft--;
        if(timeLeft<0){
          clearInterval(interval); sound.play(); setDim(false);
          if(roundPart===0){roundPart=1;timeLeft=33;timerDisplay.textContent=`Switching to Opponent…`;setTimeout(runRoundPart,6000)}
          else{
            if(round<maxRounds){round++;roundPart=0;timeLeft=33;timerDisplay.textContent=`Switching to Next Round…`;setTimeout(runRoundPart,6000)}
            else{timerDisplay.textContent='3ATTLE Over — Great Work!';glow();setDim(false);buildPostCats();postModal.classList.add('show');loadRandomOpponent();startBattleFab.style.display='flex'}
          }
        }
      },1000);
    }

    function startBattle(){
      if(!currentCategory){return}
      if(currentCategory==='RAP'){
        if(!chosenOptions.beat){return}
        battleTrack.play().catch(()=>{});
      }else{
        battleTrack.pause(); battleTrack.currentTime=0;
      }
      postModal.classList.remove('show');
      startBattleFab.style.display='none';
      glow();
      round=1; roundPart=0; timeLeft=33;
      runRoundPart();
    }

    startBattleFab.addEventListener('click', startBattle);

    function loadRandomOpponent(){
      const pool=opponentPools[currentCategory]||[]; if(pool.length){const r=pool[Math.floor(Math.random()*pool.length)];
        opponentVideo.src=r.video;opponentImage.src=r.image;opponentUsername.innerText=r.username;}
    }

    // Post-battle actions
    postClose.addEventListener('click',()=>postModal.classList.remove('show'));
    postKeepCat.addEventListener('click',()=>{
      if(!currentCategory||!chosenSub){postModal.classList.remove('show');categoryModal.classList.add('show');return}
      postModal.classList.remove('show');startBattleFab.style.display='flex';
    });
    postPickSub.addEventListener('click',()=>{
      postModal.classList.remove('show');categoryModal.classList.add('show');
      if(currentCategory){
        catSearch.value=''; buildCategoryButtons('');
        openCategory(currentCategory,true)
      }
    });
    postNextOpponent.addEventListener('click',()=>{postModal.classList.remove('show');loadRandomOpponent();startBattleFab.style.display='flex'});

    // Viewer count tick
    let viewers=1300;
    setInterval(()=>{
      const delta=Math.floor(Math.random()*13)-6;
      viewers=Math.max(0,viewers+delta);
      viewerCountTop.innerHTML=`<svg style="width:14px;height:14px;vertical-align:-2px;"><use href="#ic-eye"/></svg>&nbsp;${viewers.toLocaleString()}`
    },1600);

    // Camera
    async function startCamera(){
      try{
        const stream=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:1280},height:{ideal:720}},audio:true});
        document.getElementById('localVideo').srcObject=stream;
      }catch(err){console.error('Camera error:',err)}
    }

    // Init
    window.onload=()=>{
      showScreen('battle');
      if(!location.hash) location.hash='#/battle';
      startCamera();
      // build full list upfront so count is correct if user opens later
      buildCategoryButtons('');
      routeFromHash(); parseHashAndOpen();
    };
  </script>
</body>
</html>
