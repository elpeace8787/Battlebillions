<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>3ATTL33ILLIONS â€” 3ATTLES</title>

  <!-- Virgo font -->
  <style>
    @font-face{
      font-family:'Virgo';
      src:
        url('assets/fonts/Virgo.woff2') format('woff2'),
        url('assets/fonts/Virgo.ttf') format('truetype');
      font-display:swap;
    }
  </style>

  <style>
    :root{
      --bg-0:#000000;
      --ink:#e9edf1; --ink-2:#cfd6dd; --ink-3:#9aa3ad;
      --ring:0 0 0 3px rgba(255,255,255,.12);
      --gold-1:#F5D76E; --gold-2:#F0B90B; --gold-3:#FFD15C;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:'Virgo', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:var(--bg-0); color:var(--ink); overflow:hidden; letter-spacing:.2px;
    }
    body::before{
      content:"";position:fixed;inset:-20% -10%;
      background: radial-gradient(1200px 600px at 50% 110%, rgba(255,255,255,.03), transparent 60%);
      filter: blur(24px); opacity:.35; z-index:-1;
    }

    /* Top & bottom chrome */
    .app-topbar{
      position:fixed;inset:0 0 auto 0;height:44px;display:flex;align-items:center;justify-content:space-between;
      padding:0 14px;background:transparent;border:none;backdrop-filter:none;z-index:1000
    }
    .brand{font-weight:900;letter-spacing:.8px;color:#fff;display:flex;align-items:center;gap:10px}
    .brand .wordmark{font-size:14px;opacity:.95}
    .top-right{display:flex;gap:10px;align-items:center}
    .chip{font-size:12px;color:var(--ink-2);padding:0;border:none;background:transparent}

    .app-tabbar{
      position:fixed;left:0;right:0;bottom:0;height:72px;
      padding-bottom:calc(var(--safe-bottom));
      background:transparent;border:none;backdrop-filter:none;z-index:1000;
      display:grid;grid-template-columns:repeat(5,1fr)
    }
    .tab-btn{
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;
      color:var(--ink-2);cursor:pointer;user-select:none;transition:transform .2s,color .2s
    }
    .tab-btn:hover{color:var(--ink)}
    .tab-btn.active{color:#fff}
    .tab-btn svg{width:22px;height:22px;stroke:#fff;fill:none;opacity:.95}
    .tab-label{font-size:10px;letter-spacing:.35px;line-height:1}
    .tab-btn[data-screen="dashboard"] .tab-label{
      background:linear-gradient(90deg,var(--gold-1),var(--gold-2),var(--gold-3),var(--gold-2),var(--gold-1));
      background-size:300% 100%;-webkit-background-clip:text;background-clip:text;color:transparent;
      animation: shimmer 3.2s linear infinite
    }
    @keyframes shimmer{0%{background-position:0% 50%}100%{background-position:100% 50%}}

    /* Screens */
    .app-shell{position:fixed;inset:44px 0 72px 0}
    .screen{position:absolute;inset:0;display:none}
    .screen.active{display:block}
    .screen-slot{position:absolute;inset:0;overflow:auto;-webkit-overflow-scrolling:touch}
    .slot-loading{display:flex;align-items:center;justify-content:center;height:100%;color:#9aa3ad;font-size:12px}

    /* Battle screen */
    .stream-container{display:flex;height:100%;width:100%;position:relative;transition:filter 300ms ease,opacity 300ms ease,transform .6s ease}
    .stream-container.dimmed{filter:brightness(.75) contrast(.95) saturate(.95)}
    video.video-stream{flex:1;object-fit:cover;background:#000;width:50%;height:100%;filter:brightness(.9) contrast(1.15) saturate(1.1)}
    video.video-stream + video.video-stream{border-left:1px solid rgba(255,255,255,.04)}
    .overlay{position:absolute;inset:0;pointer-events:none;z-index:10}

    .profile-labels{position:absolute;top:12px;right:16px;display:flex;justify-content:flex-end;z-index:40;pointer-events:auto}
    .profile-entry{position:relative; display:flex; align-items:center; gap:10px;background:transparent; padding:6px 14px; border:none; box-shadow:none; cursor:pointer;overflow:hidden; text-decoration:none; color:inherit;}
    .profile-entry::before{content:"3ATTL33ILLIONS";position:absolute; inset:0; left:6px; top:50%; transform:translateY(-50%); font-weight:900; font-size:22px; letter-spacing:.15em;color:#fff; opacity:.06; white-space:nowrap; pointer-events:none; z-index:0;}
    .profile-entry img{width:34px;height:34px;border-radius:10px;position:relative;z-index:1}
    .profile-entry span{font-size:14px;color:var(--ink-2);position:relative;z-index:1}

    /* Start 3ATTLE */
    .battle-fab{
      position:fixed;left:50%;bottom:calc(72px + var(--safe-bottom) + 56px);transform:translateX(-50%);
      padding:8px 14px;border-radius:999px;background:rgba(255,255,255,.10);color:#fff;
      border:1px solid rgba(255,255,255,.12);z-index:1200;
      display:none;align-items:center;gap:8px;cursor:pointer;transition:transform .2s,opacity .2s,background .2s,box-shadow .2s
    }
    .battle-fab:hover{transform:translateX(-50%) translateY(-1px)}
    .battle-fab:focus-visible{outline:none;box-shadow:var(--ring)}
    .battle-fab.blink{animation:blinkFab 1.15s ease-in-out infinite}
    @keyframes blinkFab{
      0%,55%{ background:rgba(255,255,255,.10); box-shadow:0 0 0 0 rgba(240,185,11,0); color:#ffffff; border-color:rgba(255,255,255,.12);}
      56%,100%{
        background:linear-gradient(90deg,#4f4f4f,#F0B90B,#4f4f4f);
        background-size:200% 100%;
        box-shadow:0 0 24px 4px rgba(240,185,11,.25);
        color:#101010; border-color:rgba(240,185,11,.55);
      }
    }

    /* Choose Category */
    .cat-fab{position:fixed;left:50%;bottom:calc(72px + var(--safe-bottom) + 14px);transform:translateX(-50%);
      padding:8px 14px;border-radius:999px;background:rgba(255,255,255,.10);color:#fff;border:none;z-index:1200;
      display:flex;align-items:center;gap:8px;cursor:pointer;transition:transform .2s,opacity .2s,background .2s}
    .cat-fab:hover{background:rgba(255,255,255,.16);transform:translateX(-50%) translateY(-1px)}
    .cat-fab:focus-visible{outline:none;box-shadow:var(--ring)}
    .cat-fab svg{width:18px;height:18px;stroke:#fff}

    /* Timer + pre-countdown */
    .round-timer{position:absolute;bottom:108px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,.06);padding:10px 20px;border-radius:14px;font-size:14px;font-weight:800;color:var(--ink);border:1px solid rgba(255,255,255,.08);z-index:50;pointer-events:none;text-align:center;display:none}
    .round-timer.pulse{animation:pulse 2.2s infinite}
    @keyframes pulse{0%{transform:translateX(-50%) scale(1)}50%{transform:translateX(-50%) scale(1.03)}100%{transform:translateX(-50%) scale(1)}}
    .pre-countdown{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:60;pointer-events:none;font-weight:900;font-size:clamp(48px, 20vw, 220px);letter-spacing:.08em;color:#fff;text-shadow:0 0 20px rgba(240,185,11,.35), 0 0 35px rgba(255,255,255,.15);}
    .pre-countdown.pop{ animation:pop .78s cubic-bezier(.2,.8,.2,1);}
    @keyframes pop{0%{ transform:scale(.6); opacity:.2 }50%{ transform:scale(1.05); opacity:1 }100%{ transform:scale(1); opacity:.9 }}

    /* Modals / cards (categories, options, opponent picker) */
    .modal{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:1000;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);pointer-events:auto}
    .modal.show{display:flex}
    .card{background:#0e0e0f;border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:20px}

    #categoryModal .card{width:min(92vw,520px);max-height:72vh;display:flex;flex-direction:column;gap:12px;padding:16px}
    .cat-header{position:sticky;top:0;z-index:2;background:#0e0e0f;display:grid;grid-template-columns:1fr;gap:10px}
    .cat-header h2{font-size:18px;text-align:center;margin:2px 0 0}
    .cat-search{display:flex;gap:8px;align-items:center}
    .cat-search input{flex:1;background:#0b0b0c;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px 12px;color:#fff;font-family:'Virgo',sans-serif;}
    .cat-search input::placeholder{color:#9aa3ad}
    .cat-count{font-size:12px;color:#cfd6dd;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04)}
    .cat-scroller{position:relative;flex:1;min-height:220px;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:2px}
    .cat-empty{display:none;text-align:center;color:#9aa3ad;font-size:13px;padding:16px}
    .cat-empty.show{display:block}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
    .pill{display:flex;align-items:center;justify-content:center;min-height:56px;width:100%;padding:10px 8px;text-align:center;white-space:normal;word-break:break-word;line-height:1.2;font-size:15px;letter-spacing:.4px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:12px;color:var(--ink-2);cursor:pointer;user-select:none;transition:transform .2s,background .2s,box-shadow .2s,color .2s}
    .pill:hover{transform:translateY(-2px);background:rgba(255,255,255,.1);color:var(--ink)}
    .pill:focus-visible{outline:none;box-shadow:var(--ring)}
    .pill.active{background:rgba(255,255,255,.18);color:var(--ink)}

    .actions{margin-top:10px;display:flex;justify-content:center;gap:10px}
    .btn{background:#fff;color:#111;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px 16px;cursor:pointer;font-weight:800;transition:transform .2s,filter .2s}
    .btn:hover{transform:translateY(-1px);filter:brightness(.9)}
    .btn.secondary{background:transparent;color:var(--ink)}

    /* Opponent Picker */
    #opponentPicker .card{width:min(92vw,560px);max-height:76vh;display:flex;flex-direction:column;gap:12px}
    .opp-header{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .opp-header h3{font-size:18px}
    .opp-scroller{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:6px;border-radius:12px;background:#0b0b0c;border:1px solid rgba(255,255,255,.06)}
    .opp-item{display:flex;align-items:center;gap:12px;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.03);cursor:pointer; transition:transform .2s, background .2s, border-color .2s;margin-bottom:10px;}
    .opp-item:hover{transform:translateY(-1px);background:rgba(255,255,255,.06)}
    .opp-item img{width:40px;height:40px;border-radius:10px;object-fit:cover}
    .opp-name{font-weight:800;color:#fff}
    .opp-meta{font-size:12px;color:#9aa3ad}

    .opp-actions{display:grid;grid-template-columns:1fr;gap:10px;margin-top:6px}
    .btn-gold{background:linear-gradient(90deg,#4f4f4f,#F0B90B,#4f4f4f);background-size:200% 100%;border:1px solid rgba(240,185,11,.55);color:#101010;box-shadow:0 0 24px 4px rgba(240,185,11,.25)}
  </style>
</head>
<body>
  <!-- SVG sprite -->
  <svg width="0" height="0" style="position:absolute;opacity:0;">
    <defs>
      <symbol id="ic-home" viewBox="0 0 24 24"><path d="M3 11.5L12 4l9 7.5V20a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-8.5z" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></symbol>
      <symbol id="ic-battle" viewBox="0 0 24 24"><path d="M10 4h4M4 10h16M4 14h16M10 20h4" stroke-width="1.6" stroke-linecap="round"/><path d="M8 4l-2 6 2 6M16 4l2 6-2 6" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></symbol>
      <symbol id="ic-trophy" viewBox="0 0 24 24"><path d="M7 4h10v3a4 4 0 0 1-4 4h-2a4 4 0 0 1-4-4V4z" stroke-width="1.6"/><path d="M17 7h2a2 2 0 0 0 2-2V4h-4M7 7H5a2 2 0 0 1-2-2V4h4" stroke-width="1.6"/><path d="M10 11v3H8v2h8v-2h-2v-3" stroke-width="1.6"/></symbol>
      <symbol id="ic-search" viewBox="0 0 24 24"><circle cx="11" cy="11" r="6.5" stroke-width="1.6"/><path d="M20 20l-3.5-3.5" stroke-width="1.6" stroke-linecap="round"/></symbol>
      <symbol id="ic-messages" viewBox="0 0 24 24"><path d="M4 6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H9l-5 4V6z" stroke-width="1.6" stroke-linejoin="round"/><path d="M7 9h10M7 12h7" stroke-width="1.6" stroke-linecap="round"/></symbol>
      <symbol id="ic-eye" viewBox="0 0 24 24"><path d="M2.5 12S6.5 6.5 12 6.5 21.5 12 21.5 12 17.5 17.5 12 17.5 2.5 12 2.5 12z" stroke-width="1.6"/><circle cx="12" cy="12" r="2.8" stroke-width="1.6"/></symbol>
      <symbol id="ic-grid" viewBox="0 0 24 24"><path d="M4 4h6v6H4zM14 4h6v6h-6zM4 14h6v6H4zM14 14h6v6h-6z" stroke-width="1.6"/></symbol>
    </defs>
  </svg>

  <!-- Top bar -->
  <header class="app-topbar">
    <div class="brand"><div class="wordmark">3ATTL33ILLIONS</div></div>
    <div class="top-right">
      <div class="chip" id="viewerCountTop"><svg style="width:14px;height:14px;vertical-align:-2px;"><use href="#ic-eye"/></svg>&nbsp;1,300</div>
      <div class="chip">LIVE</div>
    </div>
  </header>

  <!-- Start 3ATTLE -->
  <button class="battle-fab" id="startBattleFab" aria-label="Start 3ATTLE">3ATTLE</button>

  <!-- Choose Category -->
  <button class="cat-fab" id="openCats" aria-haspopup="dialog" aria-controls="categoryModal">
    <svg><use href="#ic-grid"/></svg><span>Choose Category</span>
  </button>

  <!-- CONTENT -->
  <main class="app-shell">
    <!-- 3ATTLES (Battle view lives here) -->
    <section class="screen active" id="screen-battle" data-route="battle">
      <div class="stream-container" id="streamContainer">
        <video class="video-stream" id="localVideo" autoplay muted playsinline></video>
        <video class="video-stream" id="opponentVideo" autoplay muted loop src="assets/video/user2.mp4"></video>

        <!-- Category Modal (search + grid) -->
        <div class="modal" id="categoryModal" aria-modal="true" role="dialog">
          <div class="card">
            <div class="cat-header">
              <h2>Pick a Category</h2>
              <div class="cat-search">
                <input id="catSearch" type="search" placeholder="Search categoriesâ€¦" aria-label="Search categories">
                <div class="cat-count" id="catCount">0</div>
              </div>
            </div>
            <div class="cat-scroller">
              <div class="grid" id="categoryGrid"></div>
              <div class="cat-empty" id="catEmpty">No categories match your search.</div>
            </div>
            <div class="actions">
              <button class="btn secondary" id="cancelCat" type="button">Close</button>
            </div>
          </div>
        </div>

        <!-- Options Modal -->
        <div class="modal" id="optionsModal" aria-modal="true" role="dialog">
          <div class="card" style="width:min(92vw,680px);max-height:76vh;display:flex;flex-direction:column;gap:12px;">
            <h2 id="optionsTitle">Category Options</h2>
            <div class="sub-title" id="optionsSubtitle">Configure this 3ATTLE</div>
            <div id="optionsBody"></div>
            <div class="muted" id="optionsHint"></div>
            <div class="actions" id="optionsActions" style="margin-top:12px;">
              <button class="btn secondary" id="backBtn" type="button">Back</button>
            </div>
          </div>
        </div>

        <!-- Opponent Picker (post-battle) -->
        <div class="modal" id="opponentPicker" aria-modal="true" role="dialog">
          <div class="card">
            <div class="opp-header">
              <h3>Choose Next Opponent</h3>
              <div class="muted">Category: <span id="oppCatLabel">â€”</span></div>
            </div>
            <div class="opp-scroller" id="oppList"></div>
            <div class="opp-actions">
              <button class="btn btn-gold" id="oppBattleNext">3ATTLE Next Opponent</button>
              <button class="btn" id="oppChooseCat">Choose Category</button>
              <button class="btn secondary" id="oppDone">Done for now</button>
            </div>
          </div>
        </div>

        <div class="overlay">
          <!-- Opponent profile opens Opponents (profile.html) page -->
          <div class="profile-labels" id="profileLabels">
            <a href="#/profile" class="profile-entry" id="opponentProfile" data-screen="opponents" aria-label="Open opponent profile">
              <img src="assets/img/user2.jpg" id="opponentImage" alt="User 2">
              <span id="opponentUsername">@Opponent</span>
            </a>
          </div>

          <!-- Pre-turn countdown + timer -->
          <div class="pre-countdown" id="preCountdown" aria-live="polite" aria-atomic="true"></div>
          <div class="round-timer" id="roundTimer"></div>
        </div>
      </div>
    </section>

    <!-- Other screens: injected from repo files -->
    <section class="screen" id="screen-home" data-route="home">
      <div class="screen-slot" data-src="/home.html"><div class="slot-loading">Loading Homeâ€¦</div></div>
    </section>

    <section class="screen" id="screen-dashboard" data-route="dashboard">
      <div class="screen-slot" data-src="/battle.html"><div class="slot-loading">Loading 3ILLIONSâ€¦</div></div>
    </section>

    <section class="screen" id="screen-leaderboard" data-route="leaderboard">
      <div class="screen-slot" data-src="/leaderboard.html"><div class="slot-loading">Loading Leaderboardâ€¦</div></div>
    </section>

    <section class="screen" id="screen-messages" data-route="messages">
      <div class="screen-slot" data-src="/messages.html"><div class="slot-loading">Loading Messagesâ€¦</div></div>
    </section>

    <section class="screen" id="screen-opponents" data-route="opponents">
      <div class="screen-slot" data-src="/profile.html"><div class="slot-loading">Loading Opponentsâ€¦</div></div>
    </section>
  </main>

  <!-- Bottom tabs -->
  <nav class="app-tabbar" role="tablist" aria-label="Main">
    <a class="tab-btn" data-screen="home" role="tab" aria-selected="false">
      <span class="tab-label">Home</span>
      <svg><use href="#ic-home"/></svg>
    </a>
    <a class="tab-btn" data-screen="dashboard" role="tab" aria-selected="false" title="3ILLIONS">
      <span class="tab-label">3ILLIONS</span>
      <svg><use href="#ic-search"/></svg>
    </a>
    <a class="tab-btn active" data-screen="battle" role="tab" aria-selected="true">
      <span class="tab-label">3ATTLES</span>
      <svg><use href="#ic-battle"/></svg>
    </a>
    <a class="tab-btn" data-screen="leaderboard" role="tab" aria-selected="false" title="Leaders">
      <span class="tab-label">Leaders</span>
      <svg><use href="#ic-trophy"/></svg>
    </a>
    <a class="tab-btn" data-screen="messages" role="tab" aria-selected="false" title="Messages">
      <span class="tab-label">Messages</span>
      <svg><use href="#ic-messages"/></svg>
    </a>
  </nav>

  <!-- Audio -->
  <audio id="roundEndSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_38ca955dae.mp3?filename=click-124467.mp3"></audio>
  <audio id="battleTrack" controls hidden></audio>

  <script>
    /* ====== SPA Nav ====== */
    const screens = [...document.querySelectorAll('.screen')].reduce((acc, el) => (acc[el.dataset.route]=el, acc), {});
    const tabs = document.querySelectorAll('.tab-btn');
    const startBattleFab = document.getElementById('startBattleFab');

    function showScreen(name){
      Object.entries(screens).forEach(([k,el])=>el.classList.toggle('active',k===name));
      tabs.forEach(t=>{
        const on = t.getAttribute('data-screen')===name;
        t.classList.toggle('active',on);
        t.setAttribute('aria-selected',on?'true':'false');
      });
      if(name !== 'battle'){
        startBattleFab.style.display='none';
        startBattleFab.classList.remove('blink');
      }
      mountExternalChunk(name); // load external HTML once (for non-battle screens)
    }

    document.addEventListener('click',(e)=>{
      const link = e.target.closest('[data-screen]');
      if(!link) return;
      e.preventDefault();
      const target = link.getAttribute('data-screen');
      showScreen(target);
      if (target!=='battle') closeAllModals();
      if (!location.hash.startsWith('#cat/')) location.hash = '#/'+target;
    });

    function routeFromHash(){
      const h=location.hash;
      if(h.startsWith('#/')){
        const r=h.slice(2); if(screens[r]) showScreen(r);
      } else if(h.startsWith('#cat/')){
        showScreen('battle'); parseHashAndOpen();
      }
    }
    window.addEventListener('hashchange', routeFromHash);

    /* ====== External HTML loader (no iframes) ====== */
    const chunkLoaded = new Set();
    async function mountExternalChunk(name){
      if(name === 'battle') return;
      const screen = screens[name];
      if(!screen) return;
      const slot = screen.querySelector('.screen-slot');
      if(!slot || chunkLoaded.has(slot)) return;

      const src = slot.dataset.src;
      if(!src) return;

      try{
        const res = await fetch(src, { cache: 'no-cache' });
        const text = await res.text();
        const doc = new DOMParser().parseFromString(text, 'text/html');

        const frag = doc.querySelector('[data-app-fragment]') || doc.querySelector('main') || doc.body;
        slot.innerHTML = frag ? frag.innerHTML : text;
        chunkLoaded.add(slot);
      }catch(err){
        slot.innerHTML = `<div class="slot-loading">Failed to load ${name}.</div>`;
        console.error('Chunk load failed:', name, err);
      }
    }

    /* ====== Battle & Category State ====== */
    let currentCategory=null, chosenOptions={}, chosenSub=null, selectedOpponent=null;

    const opponentPools={ 
      ART:[{video:"assets/video/art2.mp4",image:"assets/img/art2.jpg",username:"@InkMage"},{video:"assets/video/art3.mp4",image:"assets/img/art3.jpg",username:"@ColorCaster"}],
      AUTO:[{video:"assets/video/auto1.mp4",image:"assets/img/auto1.jpg",username:"@TorqueLord"},{video:"assets/video/auto2.mp4",image:"assets/img/auto2.jpg",username:"@RimReaper"}],
      DEBAT:[{video:"assets/video/deb1.mp4",image:"assets/img/deb1.jpg",username:"@LogicBlade"},{video:"assets/video/deb2.mp4",image:"assets/img/deb2.jpg",username:"@VerbalVolt"}],
      FASHION:[{video:"assets/video/fashion2.mp4",image:"assets/img/fashion2.jpg",username:"@RunwayRuler"},{video:"assets/video/fashion3.mp4",image:"assets/img/fashion3.jpg",username:"@FitArchitect"}],
      INSTRUMENTS:[{video:"assets/video/inst1.mp4",image:"assets/img/inst1.jpg",username:"@ChordSmith"},{video:"assets/video/inst2.mp4",image:"assets/img/inst2.jpg",username:"@DrumOracle"}],
      RAP:[{video:"assets/video/user3.mp4",image:"assets/img/user3.jpg",username:"@ChallengerX"},{video:"assets/video/user4.mp4",image:"assets/img/user4.jpg",username:"@MCNeo"}],
      DANCE:[{video:"assets/video/dance1.mp4",image:"assets/img/dance1.jpg",username:"@Footwork"},{video:"assets/video/dance2.mp4",image:"assets/img/dance2.jpg",username:"@WaveLord"}],
      COMEDY:[{video:"assets/video/comedy1.mp4",image:"assets/img/comedy1.jpg",username:"@Punchliner"},{video:"assets/video/comedy2.mp4",image:"assets/img/comedy2.jpg",username:"@CrowdKiller"}],
      GAMING:[{video:"assets/video/game1.mp4",image:"assets/img/game1.jpg",username:"@Clutch"},{video:"assets/video/game2.mp4",image:"assets/img/game2.jpg",username:"@Headshot"}],
      COOKING:[{video:"assets/video/cook1.mp4",image:"assets/img/cook1.jpg",username:"@SearMaster"},{video:"assets/video/cook2.mp4",image:"assets/img/cook2.jpg",username:"@MiseEnPlace"}],
      FITNESS:[{video:"assets/video/fit1.mp4",image:"assets/img/fit1.jpg",username:"@RepMachine"},{video:"assets/video/fit2.mp4",image:"assets/img/fit2.jpg",username:"@HIITHero"}],
      PHOTOGRAPHY:[{video:"assets/video/photo1.mp4",image:"assets/img/photo1.jpg",username:"@LensCraft"},{video:"assets/video/photo2.mp4",image:"assets/img/photo2.jpg",username:"@FrameChaser"}],
      SINGING:[{video:"assets/video/sing1.mp4",image:"assets/img/sing1.jpg",username:"@VocalEdge"},{video:"assets/video/sing2.mp4",image:"assets/img/sing2.jpg",username:"@Falsetto"}],
      POETRY:[{video:"assets/video/poe1.mp4",image:"assets/img/poe1.jpg",username:"@VerseKing"},{video:"assets/video/poe2.mp4",image:"assets/img/poe2.jpg",username:"@Stanza"}],
      MAGIC:[{video:"assets/video/mag1.mp4",image:"assets/img/mag1.jpg",username:"@CardFlux"},{video:"assets/video/mag2.mp4",image:"assets/img/mag2.jpg",username:"@IllusionX"}],
      SPORTS:[{video:"assets/video/spo1.mp4",image:"assets/img/spo1.jpg",username:"@ClutchTime"},{video:"assets/video/spo2.mp4",image:"assets/img/spo2.jpg",username:"@GoatTalk"}],
      TECH:[{video:"assets/video/tech1.mp4",image:"assets/img/tech1.jpg",username:"@DevWizard"},{video:"assets/video/tech2.mp4",image:"assets/img/tech2.jpg",username:"@ByteSmith"}],
      EDU:[{video:"assets/video/edu1.mp4",image:"assets/img/edu1.jpg",username:"@MindCoach"},{video:"assets/video/edu2.mp4",image:"assets/img/edu2.jpg",username:"@LessonLab"}],
      FILM:[{video:"assets/video/film1.mp4",image:"assets/img/film1.jpg",username:"@CutMaster"},{video:"assets/video/film2.mp4",image:"assets/img/film2.jpg",username:"@SceneLord"}],
      PODCAST:[{video:"assets/video/pod1.mp4",image:"assets/img/pod1.jpg",username:"@HotMic"},{video:"assets/video/pod2.mp4",image:"assets/img/pod2.jpg",username:"@TalkFlow"}],
      BEAUTY:[{video:"assets/video/bea1.mp4",image:"assets/img/bea1.jpg",username:"@BlendQueen"},{video:"assets/video/bea2.mp4",image:"assets/img/bea2.jpg",username:"@Contour"}],
      DIY:[{video:"assets/video/diy1.mp4",image:"assets/img/diy1.jpg",username:"@ToolTime"},{video:"assets/video/diy2.mp4",image:"assets/img/diy2.jpg",username:"@Maker"}],
      ASMR:[{video:"assets/video/asm1.mp4",image:"assets/img/asm1.jpg",username:"@Whisper"},{video:"assets/video/asm2.mp4",image:"assets/img/asm2.jpg",username:"@Tingle"}],
      MEMES:[{video:"assets/video/mem1.mp4",image:"assets/img/mem1.jpg",username:"@TemplateKing"},{video:"assets/video/mem2.mp4",image:"assets/img/mem2.jpg",username:"@Dank"}],
      TATTOO:[{video:"assets/video/tat1.mp4",image:"assets/img/tat1.jpg",username:"@InkLord"},{video:"assets/video/tat2.mp4",image:"assets/img/tat2.jpg",username:"@ShadeMaster"}],
    };

    const subLists={
      ART:['Painting','Digital','Graffiti','Sculpture','Illustration'],
      AUTO:['Drift','Drag','Build Showcase','Detailing','Audio Systems'],
      DEBAT:['Politics','Tech','Sports','Culture','Freestyle'],
      FASHION:['Runway','Streetwear','Vintage','Upcycle','Styling'],
      INSTRUMENTS:['Guitar','Piano','Violin','Drums','DJ'],
      RAP:[{label:'Classic Trap',value:'assets/audio/beat1.mp3'},{label:'Boom Bap',value:'assets/audio/beat2.mp3'},{label:'Chill Vibes',value:'assets/audio/beat3.mp3'},{label:'Fast Flow',value:'assets/audio/beat4.mp3'}],
      DANCE:['Hip-Hop','Popping','Breaking','Contemporary','Freestyle'],
      COMEDY:['Stand-up','Improv','Sketch','Roast','Storytelling'],
      GAMING:['FPS','MOBA','Fighting','Speedrun','Battle Royale'],
      COOKING:['Plating','Street Food','Fine Dining','BBQ','Desserts'],
      FITNESS:['Calisthenics','Powerlifting','HIIT','Functional','Endurance'],
      PHOTOGRAPHY:['Portrait','Street','Landscape','Macro','Product'],
      SINGING:['R&B','Pop','Gospel','Opera','Freestyle'],
      POETRY:['Spoken Word','Haiku','Slam','Narrative','Freestyle'],
      MAGIC:['Cards','Coins','Mentalism','Stage','Close-up'],
      SPORTS:['Basketball','Football','Soccer','Boxing','Track'],
      TECH:['Coding','Gadgets','AI Demos','Hardware Mods','AR/VR'],
      EDU:['Math','Science','History','Language','Life Skills'],
      FILM:['Cinematography','Editing','VFX','Color','Directing'],
      PODCAST:['Interview','Debate','Solo','Roundtable','Live Call-in'],
      BEAUTY:['Makeup','Hair','Skin','Nails','FX'],
      DIY:['Woodwork','3D Print','Home Hack','Repair','Custom Build'],
      ASMR:['Tapping','Whisper','Keyboard','Crinkle','Brushing'],
      MEMES:['Trend Flip','Original Skit','Sound Remix','Green Screen','Duet'],
      TATTOO:['Linework','Black&Grey','Color','Neo-trad','Realism'],
    };

    const streamContainer=document.getElementById('streamContainer');
    const timerDisplay=document.getElementById('roundTimer');
    const preCountdown=document.getElementById('preCountdown');
    const sound=document.getElementById('roundEndSound');
    const battleTrack=document.getElementById('battleTrack');
    const opponentVideo=document.getElementById('opponentVideo');
    const opponentImage=document.getElementById('opponentImage');
    const opponentUsername=document.getElementById('opponentUsername');
    const viewerCountTop=document.getElementById('viewerCountTop');

    const categoryModal=document.getElementById('categoryModal');
    const optionsModal=document.getElementById('optionsModal');
    const optionsTitle=document.getElementById('optionsTitle');
    const optionsSubtitle=document.getElementById('optionsSubtitle');
    const optionsBody=document.getElementById('optionsBody');
    const optionsHint=document.getElementById('optionsHint');
    const categoryGrid=document.getElementById('categoryGrid');
    const catSearch=document.getElementById('catSearch');
    const catCount=document.getElementById('catCount');
    const catEmpty=document.getElementById('catEmpty');

    // Opponent Picker
    const opponentPicker=document.getElementById('opponentPicker');
    const oppList=document.getElementById('oppList');
    const oppClose=document.getElementById('oppClose');
    const oppCatLabel=document.getElementById('oppCatLabel');
    const oppBattleNext=document.getElementById('oppBattleNext');
    const oppChooseCat=document.getElementById('oppChooseCat');
    const oppDone=document.getElementById('oppDone');

    const openCats=document.getElementById('openCats');
    openCats.addEventListener('click',()=>{
      categoryModal.classList.add('show');
      catSearch.value='';
      buildCategoryButtons('');
      catSearch.focus();
      location.hash = '#/battle';
    });

    function closeAllModals(){categoryModal.classList.remove('show');optionsModal.classList.remove('show');opponentPicker.classList.remove('show')}
    document.getElementById('cancelCat').onclick=()=>{categoryModal.classList.remove('show');clearHash();};
    document.getElementById('backBtn').onclick=()=>{
      optionsModal.classList.remove('show');categoryModal.classList.add('show');
      startBattleFab.style.display='none';startBattleFab.classList.remove('blink');
      chosenSub=null;updateHash(currentCategory,null);
    };

    /* Build categories + search */
    const allCats = Object.keys(subLists);
    function buildCategoryButtons(filter){
      categoryGrid.innerHTML='';
      const f = (filter||'').trim().toLowerCase();
      const shown = [];
      allCats.sort((a,b)=>a.localeCompare(b)).forEach(cat=>{
        if(f && !cat.toLowerCase().includes(f)) return;
        const btn=document.createElement('button');
        btn.type='button'; btn.className='pill'; btn.dataset.cat=cat; btn.textContent=cat;
        categoryGrid.appendChild(btn); shown.push(cat);
      });
      catCount.textContent = String(shown.length);
      catEmpty.classList.toggle('show', shown.length===0);
    }
    catSearch.addEventListener('input', (e)=> buildCategoryButtons(e.target.value));
    catSearch.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ categoryGrid.querySelector('.pill')?.click(); }});

    // Category interactions
    categoryGrid.addEventListener('click',e=>{
      const btn=e.target.closest('.pill[data-cat]'); if(!btn) return; openCategory(btn.dataset.cat,true);
    });
    categoryGrid.addEventListener('keydown',e=>{
      if((e.key==='Enter'||e.key===' ')&&e.target.matches('.pill[data-cat]')){e.preventDefault();openCategory(e.target.dataset.cat,true);}
    });

    function openCategory(cat,fromUser){
      try{
        currentCategory=cat;chosenSub=null;selectedOpponent=null;
        startBattleFab.style.display='none';startBattleFab.classList.remove('blink');
        buildOptionsFor(cat);
        categoryModal.classList.remove('show');optionsModal.classList.add('show');
        if (fromUser) updateHash(cat,null);
        optionsModal.querySelector('.pill')?.focus();
      }catch(err){console.error('openCategory error:',err)}
    }

    function applyCategoryOpponent(cat,obj){
      if(obj){
        opponentVideo.src=obj.video;opponentImage.src=obj.image;opponentUsername.innerText=obj.username;
        selectedOpponent = obj;
        return;
      }
      const pool=opponentPools[cat]||[];
      if(pool.length){
        const random=pool[Math.floor(Math.random()*pool.length)];
        opponentVideo.src=random.video;opponentImage.src=random.image;opponentUsername.innerText=random.username;
        selectedOpponent = random;
      }
    }

    function buildOptionsFor(cat){
      optionsBody.innerHTML='';chosenOptions={};optionsHint.innerText='';optionsTitle.innerText=`${cat} â€“ Options`;
      const wrapper=document.createElement('div');wrapper.className='grid';
      const items=subLists[cat]||[];
      if(cat==='RAP'){
        optionsSubtitle.innerText="Choose your instrumental.";
        items.forEach(b=>{
          const btn=makePill(b.label,b.value,()=>{
            chosenOptions.beat=b.value;chosenSub=b.label;battleTrack.src=b.value;battleTrack.load();
            optionsModal.classList.remove('show');
            startBattleFab.style.display='flex';startBattleFab.classList.add('blink'); startBattleFab.focus();
            updateHash(cat,b.label);applyCategoryOpponent(cat);
          });wrapper.appendChild(btn);
        });optionsHint.innerText="Only RAP uses instrumentals.";
      }else{
        const subtitleMap={ART:"Choose your art style.",AUTO:"Choose your auto event.",DEBAT:"Choose your debate topic.",FASHION:"Choose your fashion lane.",INSTRUMENTS:"Choose your instrument.",DANCE:"Pick your dance style.",COMEDY:"Pick a comedy format.",GAMING:"Pick a gaming lane.",COOKING:"Choose your food focus.",FITNESS:"Choose your training style.",PHOTOGRAPHY:"Choose your shooting style.",SINGING:"Pick your vocal lane.",POETRY:"Pick your poetry style.",MAGIC:"Pick your magic discipline.",SPORTS:"Pick your sport lane.",TECH:"Pick your tech demo lane.",EDU:"Pick your teaching lane.",FILM:"Pick your film craft.",PODCAST:"Pick your podcast format.",BEAUTY:"Pick your beauty lane.",DIY:"Pick your build lane.",ASMR:"Pick your trigger lane.",MEMES:"Pick your meme lane.",TATTOO:"Pick your tattoo style."};
        optionsSubtitle.innerText=subtitleMap[cat]||"Choose an option.";
        items.forEach(label=>{
          const btn=makePill(label,label,()=>{
            chosenSub=label;chosenOptions[cat.toLowerCase()]=label;optionsModal.classList.remove('show');
            startBattleFab.style.display='flex';startBattleFab.classList.add('blink'); startBattleFab.focus();
            updateHash(cat,label);applyCategoryOpponent(cat);
          });wrapper.appendChild(btn);
        });
      }
      optionsBody.appendChild(wrapper);
    }

    function makePill(label,value,onChoose){
      const btn=document.createElement('button');btn.type='button';btn.className='pill';btn.tabIndex=0;btn.textContent=label;btn.dataset.value=value;
      btn.addEventListener('click',onChoose);btn.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();onChoose();}});
      return btn;
    }

    /* Hash helpers */
    function updateHash(cat,sub){const frag=`#cat/${encodeURIComponent(cat)}${sub?`/${encodeURIComponent(sub)}`:''}`;history.pushState({cat,sub},'',frag)}
    function clearHash(){history.pushState({},'','#/battle')}
    function parseHashAndOpen(){
      const m=location.hash.match(/^#cat\/([^\/]+)(?:\/([^\/]+))?/i); if(!m) return;
      const cat=decodeURIComponent(m[1]); const sub=m[2]?decodeURIComponent(m[2]):null;
      if(!subLists[cat]) return; openCategory(cat,false);
      if(sub){setTimeout(()=>{const target=[...document.querySelectorAll('#optionsBody .pill')].find(b=>b.textContent.trim()===sub||b.dataset.value===sub);target?.click();},0)}
    }
    window.addEventListener('popstate',()=>{routeFromHash();parseHashAndOpen()});

    /* Rounds + countdown */
    let round=1,roundPart=0,timeLeft=33; const maxRounds=3;
    function setDim(a){a?streamContainer.classList.add('dimmed'):streamContainer.classList.remove('dimmed')}
    function glow(){timerDisplay.classList.add('pulse');setTimeout(()=>timerDisplay.classList.remove('pulse'),1400)}

    function showCountdown(cb){
      const seq=[6,5,4,3,2,1];
      preCountdown.style.display='flex';
      function step(){
        if(seq.length===0){ preCountdown.style.display='none'; cb(); return; }
        const n=seq.shift();
        preCountdown.textContent=String(n);
        preCountdown.classList.remove('pop'); void preCountdown.offsetWidth; preCountdown.classList.add('pop');
        setTimeout(step, 800);
      }
      step();
    }

    function runRoundPart(){
      const who = (roundPart===0?'@You':'@Opponent');
      showCountdown(()=>{
        setDim(true);
        timerDisplay.style.display='block';
        timeLeft = 33;
        const interval=setInterval(()=>{
          timerDisplay.textContent=`Round ${round} of ${maxRounds} | ${who} | ${timeLeft}s`;
          timeLeft--;
          if(timeLeft<0){
            clearInterval(interval); sound.play(); setDim(false);
            if(roundPart===0){
              roundPart=1; runRoundPart();
            }else{
              if(round<maxRounds){
                round++; roundPart=0; runRoundPart();
              }else{
                timerDisplay.textContent='3ATTLE Over â€” Pick Your Next Opponent';
                glow();
                buildOpponentPicker(currentCategory);
                startBattleFab.style.display='none'; startBattleFab.classList.remove('blink');
              }
            }
          }
        },1000);
      });
    }

    function startBattle(){
      if(!currentCategory){return}
      if(currentCategory==='RAP'){
        if(!chosenOptions.beat){return}
        battleTrack.play().catch(()=>{});
      }else{ battleTrack.pause(); battleTrack.currentTime=0; }
      opponentPicker.classList.remove('show');
      startBattleFab.style.display='none';
      startBattleFab.classList.remove('blink');
      glow();
      round=1; roundPart=0;
      runRoundPart();
    }
    startBattleFab.addEventListener('click', startBattle);

    /* Opponent Picker */
    function buildOpponentPicker(cat){
      oppCatLabel.textContent = cat || 'â€”';
      oppList.innerHTML='';
      const pool = opponentPools[cat] || [];
      if(pool.length===0){
        const empty = document.createElement('div');
        empty.className='muted'; empty.style.textAlign='center'; empty.style.padding='16px';
        empty.textContent='No opponents available.';
        oppList.appendChild(empty);
      } else {
        pool.forEach((o, idx)=>{
          const row = document.createElement('div');
          row.className='opp-item';
          row.innerHTML = `
            <img src="${o.image}" alt="${o.username}">
            <div style="display:flex;flex-direction:column;">
              <span class="opp-name">${o.username}</span>
              <span class="opp-meta">Ready to 3ATTLE â€¢ Slot #${idx+1}</span>
            </div>`;
          row.addEventListener('click', ()=>{
            applyCategoryOpponent(cat, o); // swap into stage
            startBattleFab.style.display='flex'; startBattleFab.classList.add('blink'); startBattleFab.focus();
            timerDisplay.textContent='Opponent ready â€” tap 3ATTLE to start!';
          });
          oppList.appendChild(row);
        });
      }
      opponentPicker.classList.add('show');
    }

    // Action buttons under the list
    oppBattleNext.addEventListener('click', ()=>{
      if(!selectedOpponent){ return; } // must have selected
      startBattle(); // uses current selectedOpponent already on stage
    });
    oppChooseCat.addEventListener('click', ()=>{
      opponentPicker.classList.remove('show');
      categoryModal.classList.add('show');
      catSearch.value='';
      buildCategoryButtons('');
      catSearch.focus();
    });
    oppDone.addEventListener('click', ()=>{
      opponentPicker.classList.remove('show');
      startBattleFab.style.display='none';
      startBattleFab.classList.remove('blink');
      timerDisplay.textContent='Paused â€” Choose Category or Open another page.';
    });

    // Opponent profile opens Opponents (profile.html)
    document.getElementById('opponentProfile').addEventListener('click', ()=>{
      showScreen('opponents');
    });

    /* Viewer count tick */
    let viewers=1300;
    setInterval(()=>{
      const delta=Math.floor(Math.random()*13)-6;
      viewers=Math.max(0,viewers+delta);
      viewerCountTop.innerHTML=`<svg style="width:14px;height:14px;vertical-align:-2px;"><use href="#ic-eye"/></svg>&nbsp;${viewers.toLocaleString()}`
    },1600);

    /* Camera */
    async function startCamera(){
      try{
        const stream=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:1280},height:{ideal:720}},audio:true});
        document.getElementById('localVideo').srcObject=stream;
      }catch(err){console.error('Camera error:',err)}
    }

    /* Init */
    window.onload=()=>{
      showScreen('battle');
      if(!location.hash) location.hash='#/battle';
      startCamera();
      buildCategoryButtons('');
      routeFromHash(); parseHashAndOpen();
    };
  </script>
</body>
</html>
