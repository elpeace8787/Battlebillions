<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"/>
  <title>BattleBillions — Leaderboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#eaeaea;
      --muted:#b8b8b8;
      --cyan:#47f5ff;
      --gold:#ffd700;
      --red:#ff4c6a;
      --safe-top:max(10px, env(safe-area-inset-top));
      --safe-bottom:max(14px, env(safe-area-inset-bottom));
      --side-pad:clamp(12px, 4vw, 44px);
      --glass:rgba(255,255,255,.06);
      --bg-grad:
        radial-gradient(900px 600px at 25% 15%, rgba(255,215,0,.06), transparent 60%),
        radial-gradient(800px 600px at 80% 20%, rgba(71,245,255,.05), transparent 60%),
        radial-gradient(1200px 1000px at 50% 80%, rgba(159,123,255,.05), transparent 70%);
    }

    *{margin:0;padding:0;box-sizing:border-box}
    html,body{
      height:100%;
      width:100%;
      background:#000;
      color:var(--ink);
      font-family:'Orbitron',sans-serif;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
      overscroll-behavior:none;
      overflow-x:hidden;
    }
    /* hide scrollbars (still scrollable) */
    *::-webkit-scrollbar{ width:0; height:0; display:none }
    *{ scrollbar-width:none }

    /* 3D explosions background canvas */
    #bg3d{
      position:fixed; inset:0; width:100%; height:100%; display:block;
      z-index:0; pointer-events:none;
      background: radial-gradient(1200px 900px at 20% 10%, #0b0b0d 0%, #000 70%);
    }

    /* Soft ambient vignette above canvas (still behind content) */
    body::before{
      content:""; position:fixed; inset:-10%; pointer-events:none; z-index:0;
      background:var(--bg-grad);
      filter: blur(2px);
    }

    .page{
      position:relative; z-index:1;
      min-height:100dvh;
      padding: var(--safe-top) var(--side-pad) calc(var(--safe-bottom) + 90px);
    }

    /* HEADER (glass, no borders) */
    .header{
      position:sticky; top:0; z-index:5;
      display:grid; gap:10px;
      background: linear-gradient(180deg, rgba(0,0,0,.85), rgba(0,0,0,.35));
      backdrop-filter: blur(12px);
      padding:10px var(--side-pad) 12px;
      margin:0 calc(var(--side-pad) * -1);
    }
    .title{
      display:flex; justify-content:center; align-items:center; gap:10px;
      font-weight:800; letter-spacing:.4px; text-transform:uppercase;
    }
    .title span{
      background:
        linear-gradient(120deg, rgba(255,255,255,.18), rgba(255,255,255,0) 20% 80%, rgba(255,255,255,.18)),
        linear-gradient(180deg, #f2f2f2 0%, #c7c7c7 38%, #9d9d9d 56%, #f0f0f0 86%);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow: 0 4px 24px rgba(255,215,0,.12);
      font-size:22px;
    }

    /* TOP CONTROLS */
    .controls{
      display:grid; grid-template-columns: 1fr auto auto; gap:10px; align-items:center;
    }
    @media (max-width:860px){
      .controls{ grid-template-columns: 1fr auto; grid-auto-rows:auto }
      .tabs-wrap{ grid-column: 1 / -1; justify-content:center }
    }
    .search{
      position:relative; display:flex; align-items:center; gap:8px;
      background:var(--glass); border-radius:18px; padding:6px 10px;
      box-shadow:0 0 22px rgba(71,245,255,.18);
      width:100%;
    }
    .search input{
      flex:1; border:none; outline:none; background:transparent; color:#fff; font-size:13px; font-family:inherit;
      text-shadow:0 0 6px rgba(0,0,0,.5);
    }
    .search .clear{ display:none; appearance:none; border:none; background:transparent; color:#bfefff; font-weight:800; cursor:pointer; }
    .search .clear.show{ display:inline-block; }

    .window-tabs{
      display:flex; gap:8px; justify-content:center; flex-wrap:wrap;
    }
    .tab{
      font-size:12px; font-weight:800; color:#111; cursor:pointer; border:none;
      padding:8px 12px; border-radius:999px;
      background:linear-gradient(180deg,#fff3bd,#ffd700);
      box-shadow:0 8px 22px rgba(255,215,0,.2);
      opacity:.6; transition:opacity .15s ease, transform .12s ease;
    }
    .tab.active{ opacity:1; transform:translateY(-1px) }

    .filterBtn{
      border:none; cursor:pointer; font-weight:800;
      padding:8px 12px; border-radius:14px; color:#111;
      background:linear-gradient(180deg,#dff9ff,#7ff3ff);
      box-shadow:0 8px 22px rgba(127,243,255,.2);
    }
    .filterBtn[data-count]:after{
      content:attr(data-count);
      margin-left:8px; font-size:11px; color:#000; background:#ffd700; padding:2px 6px; border-radius:10px;
      box-shadow: 0 0 10px rgba(255,215,0,.5);
    }

    /* FILTER SHEET (glass, no borders) */
    .sheet-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:20; display:none;
    }
    .sheet{
      position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
      width:min(94vw, 820px); max-height:80vh; overflow:auto; z-index:21; display:none;
      background:rgba(20,20,24,.7); backdrop-filter: blur(14px) saturate(130%);
      border-radius:18px; padding:14px;
      box-shadow: 0 20px 80px rgba(0,0,0,.6);
    }
    .sheet header{
      display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;
    }
    .sheet header h3{ font-size:14px; letter-spacing:.3px }
    .sheet header button{
      border:none; background:transparent; color:#fff; font-weight:800; cursor:pointer; font-size:14px;
    }
    .grid{
      display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;
    }
    @media (max-width:760px){ .grid{ grid-template-columns: 1fr } }
    .chip{
      display:flex; align-items:center; gap:8px;
      background:rgba(255,255,255,.06);
      border-radius:12px; padding:10px 12px;
      box-shadow:none;
    }
    .chip label{ font-size:11px; color:#cfefff; opacity:.9; min-width:92px }
    .chip select, .chip input{
      flex:1; background:transparent; border:none; outline:none; color:#fff; font-family:inherit; font-size:12px;
    }
    .sheet footer{
      margin-top:12px; display:flex; gap:10px; justify-content:flex-end;
    }
    .btn{ border:none; cursor:pointer; font-weight:800; padding:10px 14px; border-radius:12px; }
    .btn.primary{
      color:#111; background:linear-gradient(180deg,#fff3bd,#ffd700);
      box-shadow:0 8px 22px rgba(255,215,0,.2);
    }
    .btn.ghost{ color:#bfefff; background:rgba(255,255,255,.08) }

    /* RESULTS LIST — rows are TRANSPARENT, just text glow */
    .list{ display:grid; gap:12px; margin-top:14px; }
    .row{
      display:grid; grid-template-columns: 56px 1fr; gap:12px; align-items:center;
      background: transparent; /* <<< transparent to reveal explosions */
      border-radius:16px; padding:10px 12px;
      box-shadow:none;
    }
    .av{
      width:56px; height:56px; border-radius:50%; overflow:hidden; position:relative; background:#111;
      box-shadow:0 0 14px rgba(0,0,0,.45), 0 0 10px rgba(255,255,255,.08);
    }
    .av img{ width:100%; height:100%; object-fit:cover }
    .badge-flag{ position:absolute; right:-2px; bottom:-2px; width:18px; height:12px; border-radius:3px; }
    .who{ display:grid; gap:4px; }
    .topline{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .handle{ font-weight:800; font-size:14px; text-shadow:0 0 8px rgba(0,0,0,.6) }
    .loc{ font-size:11px; color:var(--muted); text-shadow:0 0 8px rgba(0,0,0,.6) }
    .ranks{ display:flex; gap:6px; align-items:center; }
    .rbadge{
      min-width:20px; height:20px; border-radius:999px; display:grid; place-items:center;
      font-size:11px; font-weight:800; color:#000;
      background:linear-gradient(180deg,#fff1a8,#ffd700);
      box-shadow:0 0 10px rgba(255,215,0,.35);
    }
    .rbadge.silver{ background:linear-gradient(180deg,#fafafa,#cfcfcf) }
    .rbadge.bronze{ background:linear-gradient(180deg,#ffd7b0,#c8903c) }
    .stats{ display:flex; gap:12px; font-size:11px; color:#cfefff; flex-wrap:wrap; text-shadow:0 0 8px rgba(0,0,0,.6) }

    /* SIDE ICONS (auto-hide on scroll) */
    nav.side{
      position:fixed; top:50%; transform:translateY(-50%); display:flex; flex-direction:column; gap:20px; z-index:6;
      transition: opacity .25s ease, transform .25s ease;
    }
    nav.side.left{ left:16px }
    nav.side.right{ right:16px }
    .shape{
      background:none; border:none; cursor:pointer; width:36px; height:36px; display:flex; align-items:center; justify-content:center;
      filter: drop-shadow(0 0 10px rgba(255,255,255,.08));
      transition: transform .18s ease, filter .18s ease;
    }
    .shape:active{ transform: scale(.96) }
    .shape:hover{ transform:translateY(-2px) scale(1.06); filter:brightness(1.08) }
    .shape svg{ width:100%; height:100%; fill:none }
    .strokeline{ stroke: var(--gold); stroke-width:2.2 }
    .shape.logout .strokeline{ stroke:#ff4c4c }

    /* Bottom-center triangle */
    .center-triangle{
      position:fixed; left:50%; bottom:14px; transform:translateX(-50%); z-index:6;
      transition: opacity .25s ease, transform .25s ease;
    }

    /* Auto-hide icons while scrolling */
    .nav-hidden nav.side,
    .nav-hidden .center-triangle{
      opacity:0; pointer-events:none; transform:translateY(6px);
    }
  </style>
</head>
<body>
  <!-- 3D background -->
  <canvas id="bg3d"></canvas>

  <div class="page">
    <!-- Sticky Header -->
    <header class="header">
      <div class="title"><span>Global Leaderboard</span></div>

      <div class="controls">
        <div class="search" role="search">
          <input id="q" type="text" placeholder="Search users or any rank list (city, country, school, language, zodiac…)" autocomplete="off"/>
          <button id="qClear" class="clear" aria-label="Clear search">✖</button>
        </div>

        <div class="tabs-wrap">
          <button class="tab active" data-window="all">All-time</button>
          <button class="tab" data-window="30d">30d</button>
          <button class="tab" data-window="7d">7d</button>
          <button class="tab" data-window="24h">24h</button>
        </div>

        <button id="openFilters" class="filterBtn" data-count="0" aria-haspopup="dialog" aria-controls="filterSheet">
          Filters
        </button>
      </div>
    </header>

    <!-- RESULTS -->
    <main class="list" id="list" aria-live="polite"></main>
  </div>

  <!-- LEFT side (circle over square) -->
  <nav class="side left" aria-label="Left sidebar">
    <button class="shape" data-link="home.html" title="Home" aria-label="Home">
      <svg viewBox="0 0 24 24" aria-hidden="true"><circle class="strokeline" cx="12" cy="12" r="9"/></svg>
    </button>
    <button class="shape" data-link="leaderboard.html" title="Leaderboard" aria-label="Leaderboard">
      <svg viewBox="0 0 24 24" aria-hidden="true"><rect class="strokeline" x="6" y="6" width="12" height="12" rx="2"/></svg>
    </button>
  </nav>

  <!-- RIGHT side (diamond over X) -->
  <nav class="side right" aria-label="Right sidebar">
    <button class="shape" data-link="discover.html" title="Discover" aria-label="Discover">
      <svg viewBox="0 0 24 24" aria-hidden="true"><polygon class="strokeline" points="12,4 20,12 12,20 4,12"/></svg>
    </button>
    <button class="shape logout" id="logoutBtn" title="Logout" aria-label="Logout">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <line class="strokeline" x1="6" y1="6" x2="18" y2="18"/>
        <line class="strokeline" x1="18" y1="6" x2="6" y2="18"/>
      </svg>
    </button>
  </nav>

  <!-- Bottom-center triangle -->
  <div class="center-triangle">
    <button class="shape" data-link="arena.html" title="Arena" aria-label="Arena">
      <svg viewBox="0 0 24 24" aria-hidden="true"><polygon class="strokeline" points="12,5 20,19 4,19"/></svg>
    </button>
  </div>

  <!-- FILTER SHEET -->
  <div id="backdrop" class="sheet-backdrop" aria-hidden="true"></div>
  <section id="filterSheet" class="sheet" role="dialog" aria-modal="true" aria-label="Leaderboard Filters">
    <header>
      <h3>Filters</h3>
      <button id="closeFilters" aria-label="Close">✖</button>
    </header>

    <div class="grid">
      <div class="chip">
        <label for="region">Region</label>
        <select id="region">
          <option value="">World</option>
          <option value="NA">North America</option>
          <option value="EUROPE">Europe</option>
          <option value="ASIA">Asia</option>
          <option value="AFRICA">Africa</option>
          <option value="SA">South America</option>
          <option value="OCE">Oceania</option>
        </select>
      </div>

      <div class="chip">
        <label for="country">Country</label>
        <select id="country"><option value="">All</option></select>
      </div>

      <div class="chip">
        <label for="city">City</label>
        <input id="city" type="text" placeholder="All" />
      </div>

      <div class="chip">
        <label for="gender">Gender</label>
        <select id="gender">
          <option value="">All</option>
          <option value="M">Men</option>
          <option value="F">Women</option>
        </select>
      </div>

      <div class="chip">
        <label for="age">Age</label>
        <select id="age">
          <option value="">All</option>
          <option value="13-17">13–17</option>
          <option value="18-24">18–24</option>
          <option value="25-34">25–34</option>
          <option value="35-44">35–44</option>
          <option value="45+">45+</option>
        </select>
      </div>

      <div class="chip">
        <label for="ethnicity">Ethnicity</label>
        <select id="ethnicity">
          <option value="">All</option>
          <option value="Black">Black</option>
          <option value="Latino">Latino</option>
          <option value="White">White</option>
          <option value="Asian">Asian</option>
          <option value="Middle Eastern">Middle Eastern</option>
          <option value="Indigenous">Indigenous</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div class="chip">
        <label for="language">Language</label>
        <select id="language">
          <option value="">All</option>
          <option value="English">English</option>
          <option value="Spanish">Spanish</option>
          <option value="French">French</option>
          <option value="Portuguese">Portuguese</option>
          <option value="Japanese">Japanese</option>
          <option value="Chinese">Chinese</option>
          <option value="Hindi">Hindi</option>
        </select>
      </div>

      <div class="chip">
        <label for="school">High School</label>
        <input id="school" type="text" placeholder="All"/>
      </div>

      <div class="chip">
        <label for="college">College</label>
        <input id="college" type="text" placeholder="All"/>
      </div>

      <div class="chip">
        <label for="zodiac">Zodiac</label>
        <select id="zodiac">
          <option value="">All</option>
          <option>Aries</option><option>Taurus</option><option>Gemini</option><option>Cancer</option>
          <option>Leo</option><option>Virgo</option><option>Libra</option><option>Scorpio</option>
          <option>Sagittarius</option><option>Capricorn</option><option>Aquarius</option><option>Pisces</option>
        </select>
      </div>

      <div class="chip">
        <label for="czodiac">Chinese Zodiac</label>
        <select id="czodiac">
          <option value="">All</option>
          <option>Rat</option><option>Ox</option><option>Tiger</option><option>Rabbit</option>
          <option>Dragon</option><option>Snake</option><option>Horse</option><option>Goat</option>
          <option>Monkey</option><option>Rooster</option><option>Dog</option><option>Pig</option>
        </select>
      </div>

      <div class="chip">
        <label for="sort">Sort</label>
        <select id="sort">
          <option value="votes">Vote Count</option>
          <option value="wins">Wins</option>
          <option value="winrate">Win rate</option>
          <option value="recent">Most active</option>
        </select>
      </div>
    </div>

    <footer>
      <button id="resetFilters" class="btn ghost">Reset</button>
      <button id="applyFilters" class="btn primary">Apply</button>
    </footer>
  </section>

  <script>
    /***********************
     * DEMO DATA
     ***********************/
    const USERS = [
      {handle:'@Nova',  avatar:'user2.jpg', flag:'flag_jp.png', region:'ASIA',   country:'JP', city:'Tokyo',     gender:'F', age:24, ethnicity:'Asian',        language:'Japanese',  school:'Shinjuku HS',     college:'Waseda Univ',    zodiac:'Leo',        czodiac:'Dragon', votes:981234, wins:312, losses:88,  recent:Date.now()-1e3*60*5,   badge:1},
      {handle:'@Kiro',  avatar:'user3.jpg', flag:'flag_us.png', region:'NA',     country:'US', city:'New York',  gender:'M', age:26, ethnicity:'Latino',       language:'English',    school:'Bronx HS',        college:'NYU',            zodiac:'Aries',      czodiac:'Snake',  votes:902210, wins:290, losses:110, recent:Date.now()-1e3*60*40,  badge:3},
      {handle:'@Ari',   avatar:'user4.jpg', flag:'flag_fr.png', region:'EUROPE', country:'FR', city:'Paris',     gender:'F', age:22, ethnicity:'White',        language:'French',     school:'Lycée Buffon',    college:'Sorbonne',       zodiac:'Pisces',     czodiac:'Rabbit', votes:876540, wins:270, losses:120, recent:Date.now()-1e3*60*15,  badge:2},
      {handle:'@Zed',   avatar:'user3.jpg', flag:'flag_br.png', region:'SA',     country:'BR', city:'Rio',       gender:'M', age:28, ethnicity:'Latino',       language:'Portuguese', school:'Rio Norte HS',    college:'PUC-Rio',        zodiac:'Scorpio',    czodiac:'Horse',  votes:834221, wins:250, losses:130, recent:Date.now()-1e3*60*55,  badge:4},
      {handle:'@Sol',   avatar:'user2.jpg', flag:'flag_jp.png', region:'ASIA',   country:'JP', city:'Osaka',     gender:'M', age:29, ethnicity:'Asian',        language:'Japanese',   school:'Osaka HS',        college:'Osaka Univ',     zodiac:'Virgo',      czodiac:'Goat',   votes:801120, wins:220, losses:145, recent:Date.now()-1e3*60*8,   badge:6},
      {handle:'@Vento', avatar:'user4.jpg', flag:'flag_it.png', region:'EUROPE', country:'IT', city:'Rome',      gender:'M', age:31, ethnicity:'White',        language:'Italian',    school:'Roma Liceo',      college:'Sapienza',       zodiac:'Taurus',     czodiac:'Dog',    votes:792404, wins:205, losses:152, recent:Date.now()-1e3*60*75,  badge:7},
      {handle:'@Rico',  avatar:'user4.jpg', flag:'flag_br.png', region:'SA',     country:'BR', city:'São Paulo', gender:'M', age:25, ethnicity:'Latino',       language:'Portuguese', school:'Paulista HS',     college:'USP',            zodiac:'Gemini',     czodiac:'Monkey', votes:788001, wins:201, losses:160, recent:Date.now()-1e3*60*9,   badge:5},
      {handle:'@Lyra',  avatar:'user3.jpg', flag:'flag_ca.png', region:'NA',     country:'CA', city:'Toronto',   gender:'F', age:23, ethnicity:'Middle Eastern',language:'English',    school:'North York HS',   college:'U of T',         zodiac:'Aquarius',   czodiac:'Rooster',votes:744220, wins:190, losses:170, recent:Date.now()-1e3*60*2,   badge:8},
      {handle:'@Neon',  avatar:'user4.jpg', flag:'flag_gb.png', region:'EUROPE', country:'GB', city:'London',    gender:'M', age:27, ethnicity:'White',        language:'English',    school:'Hackney HS',      college:'UCL',            zodiac:'Cancer',     czodiac:'Ox',     votes:732990, wins:180, losses:174, recent:Date.now()-1e3*60*180, badge:9},
      {handle:'@Mina',  avatar:'user3.jpg', flag:'flag_de.png', region:'EUROPE', country:'DE', city:'Berlin',    gender:'F', age:24, ethnicity:'White',        language:'German',     school:'Berlin Mitte HS', college:'TU Berlin',      zodiac:'Libra',      czodiac:'Rat',    votes:729112, wins:179, losses:175, recent:Date.now()-1e3*60*24,  badge:null},
      {handle:'@Sage',  avatar:'user2.jpg', flag:'flag_au.png', region:'OCE',    country:'AU', city:'Sydney',    gender:'M', age:30, ethnicity:'White',        language:'English',    school:'Sydney HS',       college:'UNSW',           zodiac:'Capricorn',  czodiac:'Tiger',  votes:701090, wins:175, losses:177, recent:Date.now()-1e3*60*300, badge:null},
      {handle:'@Asha',  avatar:'user2.jpg', flag:'flag_in.png', region:'ASIA',   country:'IN', city:'Mumbai',    gender:'F', age:21, ethnicity:'Asian',        language:'Hindi',      school:'Mumbai Central',  college:'IIT Bombay',     zodiac:'Sagittarius',czodiac:'Pig',    votes:698332, wins:170, losses:190, recent:Date.now()-1e3*60*35,  badge:null},
    ];

    const REGION_COUNTRIES = {
      NA: ['US','CA','MX'],
      EUROPE: ['FR','DE','IT','GB','ES'],
      ASIA: ['JP','CN','KR','IN'],
      AFRICA: ['NG','ZA','EG'],
      SA: ['BR','AR','CL','CO','PE'],
      OCE: ['AU','NZ']
    };

    const COUNTRY_LABEL = {
      US:'United States', CA:'Canada', MX:'Mexico', JP:'Japan', CN:'China', KR:'South Korea', IN:'India',
      NG:'Nigeria', ZA:'South Africa', EG:'Egypt',
      FR:'France', DE:'Germany', IT:'Italy', GB:'United Kingdom', ES:'Spain',
      BR:'Brazil', AR:'Argentina', CL:'Chile', CO:'Colombia', PE:'Peru',
      AU:'Australia', NZ:'New Zealand'
    };

    /***********************
     * ELEMENTS
     ***********************/
    const listEl = document.getElementById('list');
    const qEl = document.getElementById('q');
    const qClear = document.getElementById('qClear');
    const tabs = Array.from(document.querySelectorAll('.tab'));
    const openFilters = document.getElementById('openFilters');
    const closeFilters = document.getElementById('closeFilters');
    const backdrop = document.getElementById('backdrop');
    const filterSheet = document.getElementById('filterSheet');
    const resetFilters = document.getElementById('resetFilters');
    const applyFiltersBtn = document.getElementById('applyFilters');

    // Filter inputs
    const regionEl = document.getElementById('region');
    const countryEl = document.getElementById('country');
    const cityEl = document.getElementById('city');
    const genderEl = document.getElementById('gender');
    const ageEl = document.getElementById('age');
    const ethnicityEl = document.getElementById('ethnicity');
    const languageEl = document.getElementById('language');
    const schoolEl = document.getElementById('school');
    const collegeEl = document.getElementById('college');
    const zodiacEl = document.getElementById('zodiac');
    const czodiacEl = document.getElementById('czodiac');
    const sortEl = document.getElementById('sort');

    let activeWindow = 'all';

    /***********************
     * HELPERS
     ***********************/
    function winrate(u){
      const total = u.wins + u.losses;
      return total ? (u.wins/total) : 0;
    }
    function lastActiveScore(u){
      return -u.recent;
    }
    function rb(u){
      if(!u.badge || u.badge>9) return '';
      const cls = u.badge===1 ? '' : (u.badge<=3?'silver':'bronze');
      return `<div class="rbadge ${cls}">${u.badge}</div>`;
    }
    function row(u){
      return `
        <div class="row" data-user="${u.handle}">
          <div class="av">
            <img src="${u.avatar}" alt="${u.handle}">
            <img class="badge-flag" src="${u.flag}" alt="">
          </div>
          <div class="who">
            <div class="topline">
              <div class="handle">${u.handle}</div>
              <div class="loc">${COUNTRY_LABEL[u.country]||u.country} • ${u.city}</div>
              <div class="ranks">${rb(u)}</div>
            </div>
            <div class="stats">
              <span>Votes ${u.votes.toLocaleString()}</span>
              <span>W ${u.wins}</span>
              <span>L ${u.losses}</span>
              <span>WR ${(winrate(u)*100).toFixed(1)}%</span>
              <span>${u.gender==='M'?'Men':'Women'}</span>
              <span>Age ${u.age}</span>
              <span>${u.ethnicity}</span>
              <span>${u.language}</span>
              <span>${u.zodiac}</span>
              <span>${u.czodiac}</span>
              <span>${u.school}</span>
              <span>${u.college}</span>
            </div>
          </div>
        </div>
      `;
    }

    function getActiveCount(){
      let c = 0;
      const v = (el)=> (el.value && el.value.trim()!=='');
      if(v(regionEl)) c++;
      if(v(countryEl)) c++;
      if(v(cityEl)) c++;
      if(v(genderEl)) c++;
      if(v(ageEl)) c++;
      if(v(ethnicityEl)) c++;
      if(v(languageEl)) c++;
      if(v(schoolEl)) c++;
      if(v(collegeEl)) c++;
      if(v(zodiacEl)) c++;
      if(v(czodiacEl)) c++;
      if(v(sortEl) && sortEl.value!=='votes') c++; // count only if not default
      return c;
    }

    function applyFilters(){
      const q = (qEl.value||'').trim().toLowerCase();
      const region = regionEl.value;
      const country = countryEl.value;
      const city = (cityEl.value||'').trim().toLowerCase();
      const gender = genderEl.value;
      const ageBand = ageEl.value;
      const ethnicity = ethnicityEl.value;
      const language = languageEl.value;
      const school = (schoolEl.value||'').trim().toLowerCase();
      const college = (collegeEl.value||'').trim().toLowerCase();
      const zodiac = zodiacEl.value;
      const czodiac = czodiacEl.value;
      const sort = sortEl.value;

      let out = USERS.filter(u=>{
        if(region && u.region!==region) return false;
        if(country && u.country!==country) return false;
        if(city && !u.city.toLowerCase().includes(city)) return false;
        if(gender && u.gender!==gender) return false;
        if(ethnicity && u.ethnicity!==ethnicity) return false;
        if(language && u.language!==language) return false;
        if(school && !(u.school||'').toLowerCase().includes(school)) return false;
        if(college && !(u.college||'').toLowerCase().includes(college)) return false;
        if(zodiac && u.zodiac!==zodiac) return false;
        if(czodiac && u.czodiac!==czodiac) return false;

        if(ageBand){
          const a=u.age||0;
          const [lo,hi] = ageBand==='45+' ? [45,999] : ageBand.split('-').map(Number);
          if(!(a>=lo && a<=hi)) return false;
        }

        if(q){
          const hay = [
            u.handle, u.city, (COUNTRY_LABEL[u.country]||u.country),
            u.region, u.gender==='M'?'men':'women',
            String(u.age), u.ethnicity, u.language, u.school, u.college,
            u.zodiac, u.czodiac
          ].join(' ').toLowerCase();
          if(!hay.includes(q)) return false;
        }

        if(activeWindow==='24h' && (Date.now()-u.recent) > 86400000) return false;
        if(activeWindow==='7d'  && (Date.now()-u.recent) > 7*86400000) return false;
        if(activeWindow==='30d' && (Date.now()-u.recent) > 30*86400000) return false;

        return true;
      });

      out.sort((a,b)=>{
        if(sort==='wins') return b.wins - a.wins;
        if(sort==='winrate') {
          const aw = a.wins/(a.wins+a.losses||1);
          const bw = b.wins/(b.wins+b.losses||1);
          return bw - aw;
        }
        if(sort==='recent') return lastActiveScore(a) - lastActiveScore(b);
        return b.votes - a.votes;
      });

      listEl.innerHTML = out.map(row).join('');
      openFilters.setAttribute('data-count', getActiveCount());
    }

    function populateCountries(){
      const region = regionEl.value;
      countryEl.innerHTML = `<option value="">All</option>`;
      if(!region){ return; }
      (REGION_COUNTRIES[region]||[]).forEach(c=>{
        const opt = document.createElement('option');
        opt.value=c; opt.textContent = COUNTRY_LABEL[c]||c;
        countryEl.appendChild(opt);
      });
    }

    function openSheet(){
      backdrop.style.display='block';
      filterSheet.style.display='block';
      document.body.style.overflow='hidden';
    }
    function closeSheet(){
      backdrop.style.display='none';
      filterSheet.style.display='none';
      document.body.style.overflow='auto';
    }

    /***********************
     * EVENTS
     ***********************/
    qEl.addEventListener('input', ()=>{
      qClear.classList.toggle('show', !!qEl.value.length);
      applyFilters();
    });
    qClear.addEventListener('click', ()=>{
      qEl.value=''; qClear.classList.remove('show'); applyFilters();
    });

    tabs.forEach(t=>{
      t.addEventListener('click', ()=>{
        tabs.forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        activeWindow = t.dataset.window;
        applyFilters();
      });
    });

    openFilters.addEventListener('click', openSheet);
    closeFilters.addEventListener('click', closeSheet);
    backdrop.addEventListener('click', closeSheet);

    regionEl.addEventListener('change', populateCountries);

    applyFiltersBtn.addEventListener('click', ()=>{
      applyFilters();
      closeSheet();
    });
    resetFilters.addEventListener('click', ()=>{
      [regionEl,countryEl,cityEl,genderEl,ageEl,ethnicityEl,languageEl,schoolEl,collegeEl,zodiacEl,czodiacEl].forEach(el=>{
        if(el.tagName==='SELECT') el.selectedIndex = 0; else el.value='';
      });
      sortEl.value='votes';
      populateCountries();
      applyFilters();
      openFilters.setAttribute('data-count','0');
    });

    document.querySelectorAll(".shape[data-link]").forEach(btn=>{
      btn.addEventListener("click", ()=>{ window.location.href = btn.dataset.link; });
    });

    // Auto-hide icons on scroll
    let navHideTimer = null;
    const root = document.body;
    window.addEventListener('scroll', ()=>{
      root.classList.add('nav-hidden');
      if(navHideTimer) clearTimeout(navHideTimer);
      navHideTimer = setTimeout(()=> root.classList.remove('nav-hidden'), 350);
    }, { passive:true });

    // INIT
    populateCountries();
    applyFilters();
  </script>

  <!-- Three.js explosions (lightweight) -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script>
  (function(){
    const canvas = document.getElementById('bg3d');
    const reduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    let width = window.innerWidth, height = window.innerHeight;

    let glOK = false;
    try{
      const gl = canvas.getContext('webgl',{antialias:false}) || canvas.getContext('experimental-webgl');
      glOK = !!gl;
    }catch(e){ glOK=false; }
    if(!glOK) return;

    const DPR_LIMIT = 1.75;
    const renderer = new THREE.WebGLRenderer({ canvas, antialias:false, alpha:true, powerPreference:'high-performance' });
    renderer.setClearColor(0x000000, 0);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, DPR_LIMIT));
    renderer.setSize(width, height, false);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(55, width/height, 0.1, 3000);
    camera.position.set(0,0,140);

    const hemi = new THREE.HemisphereLight(0x888888, 0x080808, 0.9);
    const dir  = new THREE.DirectionalLight(0xffe7a4, 0.7); dir.position.set(60,80,120);
    scene.add(hemi, dir);

    // Particle sprite (soft disk)
    function makeSprite(){
      const s=128, c=document.createElement('canvas'); c.width=c.height=s;
      const g=c.getContext('2d'), grd=g.createRadialGradient(s/2,s/2,0, s/2,s/2,s/2);
      grd.addColorStop(0,'rgba(255,255,255,0.95)');
      grd.addColorStop(0.35,'rgba(255,255,255,0.35)');
      grd.addColorStop(1,'rgba(255,255,255,0)');
      g.fillStyle=grd; g.fillRect(0,0,s,s);
      const tex=new THREE.CanvasTexture(c); tex.minFilter=THREE.LinearFilter; tex.magFilter=THREE.LinearFilter;
      return tex;
    }
    const particleTex = makeSprite();
    const baseMat = new THREE.PointsMaterial({
      size:(reduced? 16:20), map:particleTex, transparent:true, depthWrite:false,
      blending:THREE.AdditiveBlending, vertexColors:true, sizeAttenuation:true
    });

    // Ambient embers (very light)
    function makeAmbient(){
      const COUNT = reduced ? 300 : 600;
      const g=new THREE.BufferGeometry();
      const pos=new Float32Array(COUNT*3), col=new Float32Array(COUNT*3);
      for(let i=0;i<COUNT;i++){
        pos[i*3+0]=(Math.random()-0.5)*440;
        pos[i*3+1]=(Math.random()-0.5)*260;
        pos[i*3+2]=-60 - Math.random()*180;
        const t = Math.random()*0.5+0.35;
        col[i*3+0]=t; col[i*3+1]=t*0.9; col[i*3+2]=t*0.85;
      }
      g.setAttribute('position', new THREE.BufferAttribute(pos,3));
      g.setAttribute('color', new THREE.BufferAttribute(col,3));
      const m=new THREE.PointsMaterial({ size:reduced?1.8:2.6, map:particleTex, transparent:true, depthWrite:false, vertexColors:true, blending:THREE.AdditiveBlending });
      const p=new THREE.Points(g,m); p.frustumCulled=false; p.userData={t:0};
      return p;
    }
    const ambient = makeAmbient(); scene.add(ambient);

    // Color palettes for explosions (multi-colored)
    const PALETTES = [
      [0xffd700,0xff9b00,0xff4d00], // gold -> orange
      [0x47f5ff,0x27d8ff,0x1597ff], // cyans
      [0xff4c6a,0xff2a9f,0xff6ec7], // neon pinks
      [0xad8cff,0x7f63ff,0x3f2cff], // purples
      [0x7cff8b,0x2cff6c,0x00d46b], // greens
    ];

    // Points pool to reuse
    const pool=[];
    function getPoints(count){
      for(let i=pool.length-1;i>=0;i--){
        const p=pool[i];
        if(p.geometry.getAttribute('position').count>=count){ pool.splice(i,1); p.visible=true; return p; }
      }
      const g=new THREE.BufferGeometry();
      g.setAttribute('position', new THREE.BufferAttribute(new Float32Array(count*3),3));
      g.setAttribute('color', new THREE.BufferAttribute(new Float32Array(count*3),3));
      g.setAttribute('size',  new THREE.BufferAttribute(new Float32Array(count),1));
      const m=baseMat.clone();
      const pts=new THREE.Points(g,m); pts.frustumCulled=false;
      return pts;
    }
    function releasePoints(p){ p.visible=false; pool.push(p); }

    class Explosion{
      constructor(){
        const x=(Math.random()-0.5)*width/6;
        const y=(Math.random()-0.5)*height/6;
        const z=-30 - Math.random()*40;
        this.center=new THREE.Vector3(x,y,z);
        this.count=(Math.random()*60+(reduced?80:140))|0;

        this.points=getPoints(this.count); this.points.position.copy(this.center);

        const g=this.points.geometry;
        const pos=g.getAttribute('position').array;
        const col=g.getAttribute('color').array;
        const siz=g.getAttribute('size').array;

        // pick palette
        const pal = PALETTES[(Math.random()*PALETTES.length)|0];
        const cA=new THREE.Color(pal[0]), cB=new THREE.Color(pal[1]), cC=new THREE.Color(pal[2]);

        this.vel=new Float32Array(this.count*3);
        this.life=reduced?1.4:1.8; this.t=0;

        for(let i=0;i<this.count;i++){
          const dirv=new THREE.Vector3().randomDirection();
          const speed=12+Math.random()*34;
          const ix=i*3;
          this.vel[ix+0]=dirv.x*speed;
          this.vel[ix+1]=dirv.y*speed;
          this.vel[ix+2]=dirv.z*speed;
          pos[ix+0]=dirv.x*1.6; pos[ix+1]=dirv.y*1.6; pos[ix+2]=dirv.z*1.6;

          // gradient across particles
          const t=i/this.count;
          const cc = (t<.5)? cA.clone().lerp(cB, t*2) : cB.clone().lerp(cC, (t-.5)*2);
          col[ix+0]=cc.r; col[ix+1]=cc.g; col[ix+2]=cc.b;
          siz[i]=8+Math.random()*14;
        }
        g.getAttribute('position').needsUpdate=true;
        g.getAttribute('color').needsUpdate=true;
        g.getAttribute('size').needsUpdate=true;

        scene.add(this.points);

        // shockwave rings
        const ringGeo=new THREE.RingGeometry(5,6.6,64);
        const m1=new THREE.MeshBasicMaterial({color:pal[0], transparent:true, opacity:0.85, blending:THREE.AdditiveBlending, side:THREE.DoubleSide});
        const m2=new THREE.MeshBasicMaterial({color:pal[1], transparent:true, opacity:0.55, blending:THREE.AdditiveBlending, side:THREE.DoubleSide});
        this.ring1=new THREE.Mesh(ringGeo,m1); this.ring2=new THREE.Mesh(ringGeo,m2);
        this.ring1.position.copy(this.center); this.ring2.position.copy(this.center);
        this.r1=5; this.r2=5; scene.add(this.ring1,this.ring2);

        this.shake=0.35;
      }
      update(dt){
        this.t+=dt; const f=this.t/this.life;

        const g=this.points.geometry;
        const pos=g.getAttribute('position').array;
        const col=g.getAttribute('color').array;
        const siz=g.getAttribute('size').array;

        const drag=1.0 - Math.min(0.05*dt*60, 0.05);
        for(let i=0;i<this.count;i++){
          const ix=i*3;
          pos[ix+0]+=this.vel[ix+0]*dt;
          pos[ix+1]+=this.vel[ix+1]*dt;
          pos[ix+2]+=this.vel[ix+2]*dt;
          this.vel[ix+0]*=drag; this.vel[ix+1]*=drag; this.vel[ix+2]*=drag;

          siz[i]*=(1-dt*0.1); if(siz[i]<7) siz[i]=7;
          // gentle fade to warm gold tint near the end
          const toGold = Math.max(0, Math.min(1, (f-0.3)/0.5 ));
          col[ix+0]=col[ix+0]*(1-toGold) + 1.0*toGold;
          col[ix+1]=col[ix+1]*(1-toGold) + 0.72*toGold;
          col[ix+2]=col[ix+2]*(1-toGold) + 0.28*toGold;
        }
        g.getAttribute('position').needsUpdate=true;
        g.getAttribute('color').needsUpdate=true;
        g.getAttribute('size').needsUpdate=true;

        // Rings
        this.r1+=100*dt; this.r2+=125*dt;
        this.ring1.scale.setScalar(this.r1/5);
        this.ring2.scale.setScalar(this.r2/5);
        const o1=Math.max(0,0.9 - f*1.25), o2=Math.max(0,0.6 - f*1.3);
        this.ring1.material.opacity=o1; this.ring2.material.opacity=o2;
        this.ring1.lookAt(camera.position); this.ring2.lookAt(camera.position);

        // mild shake
        if(this.shake>0){
          const s=this.shake*(1-f);
          camera.position.x += (Math.random()-0.5)*s;
          camera.position.y += (Math.random()-0.5)*s;
        }
        return this.t<this.life;
      }
      dispose(){
        scene.remove(this.points); releasePoints(this.points);
        scene.remove(this.ring1); scene.remove(this.ring2);
      }
    }

    const explosions=[];
    const BLAST_INTERVAL = reduced ? 1900 : 1200;
    const MAX_EXPLOSIONS = reduced ? 5 : 10;
    let prev=performance.now(), lastBlast=prev;

    // kick off with one
    explosions.push(new Explosion());

    function loop(now){
      const dt=Math.min(0.05,(now-prev)/1000); prev=now;

      ambient.userData.t += dt*0.15;
      ambient.position.y = Math.sin(ambient.userData.t)*1.6;
      ambient.rotation.z += dt*0.015;

      if(now-lastBlast>BLAST_INTERVAL){
        if(explosions.length>MAX_EXPLOSIONS){
          const old=explosions.shift(); old.dispose();
        }
        explosions.push(new Explosion());
        lastBlast=now;
      }

      for(let i=explosions.length-1;i>=0;i--){
        if(!explosions[i].update(dt)){
          explosions[i].dispose();
          explosions.splice(i,1);
        }
      }

      camera.lookAt(0,0,0);
      renderer.render(scene,camera);
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    function resize(){
      width=window.innerWidth; height=window.innerHeight;
      renderer.setPixelRatio(Math.min(window.devicePixelRatio||1, DPR_LIMIT));
      renderer.setSize(width,height,false);
      camera.aspect=width/height; camera.updateProjectionMatrix();
    }
    window.addEventListener('resize',resize,{passive:true});
  })();
  </script>
</body>
</html>
