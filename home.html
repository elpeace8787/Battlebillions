<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BattleBillions â€” Home</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&family=Orbitron:wght@600&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --ink:#f5f5f5; --ink-2:#cecece; --muted:#8a8a8a;
      --accent:#ffd700; --panel:rgba(255,255,255,.06); --edge:rgba(255,255,255,.12);
      --bg:#000;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}

    .shell{min-height:100vh; display:grid; grid-template-rows:auto 1fr; gap:16px}
    .topbar{
      position:sticky; top:0; z-index:10; display:flex; align-items:center; justify-content:space-between;
      padding:12px 16px; background:rgba(10,10,12,.5); backdrop-filter:saturate(120%) blur(8px); border-bottom:1px solid var(--edge);
    }
    .brand{display:flex; align-items:center; gap:10px; font-family:'Orbitron',sans-serif; letter-spacing:.4px; color:var(--accent); font-weight:700;}
    .brand .dot{width:8px;height:8px;border-radius:999px;background:var(--accent);box-shadow:0 0 10px rgba(255,215,0,.7)}
    .userbox{display:flex; align-items:center; gap:12px}
    .avatar{
      width:40px;height:40px;border-radius:999px; background:#111; border:1px solid var(--edge); overflow:hidden; display:grid; place-items:center;
    }
    .avatar img{width:100%;height:100%;object-fit:cover;display:none}
    .avatar .initials{font-weight:700}
    .meta{display:flex; flex-direction:column; line-height:1.1}
    .meta .name{font-size:13px}
    .meta .handle{font-size:12px;color:var(--muted)}
    .btn{appearance:none;border:1px solid var(--edge);background:#121214;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{transform:translateY(-1px)}
    .btn.warn{border-color:transparent;background:#1a1a1a}

    .main{padding:16px}
    .grid{display:grid; gap:14px; grid-template-columns: repeat(auto-fill,minmax(260px,1fr));}
    .card{background:var(--panel); border:1px solid var(--edge); border-radius:16px; padding:16px; box-shadow:0 0 24px rgba(255,215,0,.06);}
    .card h3{margin:0 0 8px}
    .muted{color:var(--muted); font-size:13px}

    .status{min-height:18px;font-size:12px;color:var(--muted);text-align:center;margin:8px 0}

    .foot{padding:12px; text-align:center; color:var(--muted); font-size:12px; border-top:1px solid var(--edge)}
    a.link{color:var(--ink-2); text-decoration:none}
  </style>
</head>
<body>
  <div class="shell">
    <header class="topbar">
      <div class="brand"><span class="dot"></span> BattleBillions</div>
      <div class="userbox">
        <div class="avatar" id="userAvatar">
          <img id="userAvatarImg" alt=""/>
          <span class="initials" id="userAvatarInit">BB</span>
        </div>
        <div class="meta">
          <span class="name"   id="userName">Loadingâ€¦</span>
          <span class="handle" id="userHandle"></span>
        </div>
        <button class="btn warn" id="logoutBtn" title="Log out">Logout</button>
      </div>
    </header>

    <main class="main">
      <div class="status" id="status"></div>

      <div class="grid">
        <section class="card">
          <h3>Welcome back ðŸ‘‹</h3>
          <p class="muted">This page reads your profile from Firestore and shows your avatar & username. Use the same pattern on your other pages.</p>
        </section>

        <section class="card">
          <h3>Your Profile Snapshot</h3>
          <pre class="muted" id="profileDump" style="white-space:pre-wrap;margin:0">â€”</pre>
        </section>

        <section class="card">
          <h3>Quick Links</h3>
          <p><a class="link" href="index.html#/discover">Go to Discover</a></p>
          <p><a class="link" href="index.html#/opponent">Find Opponent</a></p>
          <p><a class="link" href="index.html#/leaderboard">Leaderboard</a></p>
          <p><a class="link" href="index.html#/profile">Profile</a></p>
        </section>
      </div>
    </main>

    <footer class="foot">Â© <span id="year"></span> BattleBillions</footer>
  </div>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // Avatar helpers (initials fallback)
    function initialsFrom(nameOrEmail, handle){
      const src = (handle && handle.replace('@','')) || nameOrEmail || 'BB';
      const parts = src.split(/[^\w]+/).filter(Boolean);
      if(parts.length>=2) return (parts[0][0] + parts[1][0]).toUpperCase();
      return src.slice(0,2).toUpperCase();
    }
    function showAvatar(url, initials){
      const img = document.getElementById('userAvatarImg');
      const init = document.getElementById('userAvatarInit');
      if(url){
        img.src = url;
        img.onload = ()=>{ img.style.display='block'; init.style.display='none'; };
        img.onerror = ()=>{ img.style.display='none'; init.textContent = initials; init.style.display='block'; };
      }else{
        img.style.display='none';
        init.textContent = initials;
        init.style.display='block';
      }
    }
  </script>

  <!-- Firebase auth + Firestore: read user and fill UI -->
  <script type="module">
    let local={};
    try{ local = await import("./firebase.js"); }catch(e){ console.warn("firebase.js not found (home.html)."); }

    const {
      auth, db,
      onAuthStateChanged:OASC, signOut:SO,
      doc:DOC, getDoc:GDC
    } = local;

    // Backfill from CDN if your firebase.js didnâ€™t export these (still uses your initialized instances)
    let onAuthStateChanged=OASC, signOut=SO;
    let doc=DOC, getDoc=GDC;
    if(!onAuthStateChanged || !signOut){
      const a = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
      onAuthStateChanged = onAuthStateChanged || a.onAuthStateChanged;
      signOut = signOut || a.signOut;
    }
    if(!doc || !getDoc){
      const f = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
      doc = doc || f.doc;
      getDoc = getDoc || f.getDoc;
    }

    const $ = s=>document.querySelector(s);
    const statusEl = $('#status');

    $('#logoutBtn').addEventListener('click', async ()=>{
      try{ await signOut(auth); location.href = 'index.html#/auth/login'; }
      catch(e){ statusEl.textContent = e?.message || 'Logout failed.'; }
    });

    function dumpProfile(data){
      const el = document.getElementById('profileDump');
      try{ el.textContent = JSON.stringify(data || {}, null, 2); }
      catch{ el.textContent = 'â€”'; }
    }

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        // Not signed in â†’ send to login in the SPA
        location.href = 'index.html#/auth/login';
        return;
      }

      // Load Firestore user document
      let profile = {};
      if(db && user.uid){
        try{
          const snap = await getDoc(doc(db, "users", user.uid));
          profile = snap.exists() ? (snap.data()||{}) : {};
        }catch(e){
          console.warn('Firestore profile fetch failed:', e);
        }
      }

      // Derive display + handle + avatar
      const username = profile.username
        || (user.displayName ? user.displayName.replace(/\s+/g,'').toLowerCase() : null)
        || (user.email ? user.email.split('@')[0] : 'player');

      const displayName = profile.username || user.displayName || username;
      const avatarURL = profile.avatarURL || user.photoURL || null;

      $('#userName').textContent   = displayName;
      $('#userHandle').textContent = '@'+String(username||'player');

      showAvatar(avatarURL, initialsFrom(displayName || user.email || '', username));

      // Optional: dump profile for quick verification
      dumpProfile({ uid:user.uid, email:user.email, ...profile });
    });
  </script>
</body>
</html>
