<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"/>
  <title>BattleBillions — Home</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --ink:#eaeaea; --muted:#b8b8b8;
      --gold:#ffd700;
      --safe-top:max(10px, env(safe-area-inset-top));
      --safe-bottom:max(14px, env(safe-area-inset-bottom));
      --side-pad:clamp(12px,4vw,44px);
      --bg-grad:
        radial-gradient(900px 600px at 25% 15%, rgba(255,215,0,.06), transparent 60%),
        radial-gradient(800px 600px at 80% 20%, rgba(71,245,255,.05), transparent 60%),
        radial-gradient(1200px 1000px at 50% 80%, rgba(159,123,255,.05), transparent 70%);
      --bd: rgba(255,255,255,.14);
    }
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{
      height:100%; width:100%; background:#000; color:var(--ink);
      font-family:'Orbitron',sans-serif; -webkit-tap-highlight-color:transparent;
      touch-action:manipulation; overscroll-behavior:none; overflow-x:hidden;
    }
    *::-webkit-scrollbar{ width:0; height:0; display:none } *{ scrollbar-width:none }

    #bg3d{ position:fixed; inset:0; width:100%; height:100%; display:block; z-index:0; pointer-events:none; background: radial-gradient(1200px 900px at 20% 10%, #0b0b0d 0%, #000 70%); }
    body::before{ content:""; position:fixed; inset:-10%; pointer-events:none; z-index:0; background:var(--bg-grad); filter:blur(2px); }

    .page{ position:relative; z-index:1; min-height:100dvh; padding: var(--safe-top) var(--side-pad) calc(var(--safe-bottom) + 90px); }
    .header{ position:sticky; top:0; z-index:5; margin:0 calc(var(--side-pad)*-1); background: linear-gradient(180deg, rgba(0,0,0,.85), rgba(0,0,0,.35)); backdrop-filter: blur(12px); padding:12px var(--side-pad) 14px; }
    .topline{ display:flex; align-items:center; gap:12px; justify-content:space-between; }
    .title{ display:flex; align-items:center; gap:12px; }
    .avatar{ width:56px; height:56px; border-radius:50%; overflow:hidden; background:#111; box-shadow:0 0 14px rgba(0,0,0,.45), 0 0 10px rgba(255,255,255,.08); position:relative; display:grid; place-items:center; }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:none }
    .avatar .initials{ font-weight:800; letter-spacing:.5px; font-size:18px; color:#000; width:100%; height:100%; display:grid; place-items:center; background:linear-gradient(180deg,#fff1a8,#ffd700); }
    .flag-badge{ position:absolute; right:-3px; bottom:-3px; width:20px; height:14px; border-radius:3px; box-shadow:0 0 8px rgba(0,0,0,.6); }
    .nameblock{ display:flex; flex-direction:column; gap:4px; }
    .display{
      font-weight:800; letter-spacing:.3px; text-transform:uppercase; font-size:18px;
      background:
        linear-gradient(120deg, rgba(255,255,255,.18), rgba(255,255,255,0) 20% 80%, rgba(255,255,255,.18)),
        linear-gradient(180deg, #f2f2f2 0%, #c7c7c7 38%, #9d9d9d 56%, #f0f0f0 86%);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow: 0 4px 24px rgba(255,215,0,.12);
    }
    .handle{ font-size:12px; color:var(--muted) }
    .social-row{ display:flex; gap:12px; margin-top:6px; align-items:center; flex-wrap:wrap; }
    .soc-chip{ background:rgba(255,255,255,.08); border:1px solid var(--bd); border-radius:999px; padding:6px 10px; font-size:12px; color:#d6fffd; font-weight:800; }
    .actions{ display:flex; gap:10px; }
    .rank-pill{ border:none; cursor:pointer; font-weight:800; border-radius:12px; padding:10px 14px; color:#111; background:linear-gradient(180deg,#fff3bd,#ffd700); box-shadow:0 8px 22px rgba(255,215,0,.2); min-width:120px; text-align:center; }
    .btn.ghost{ color:#bfefff; background:rgba(255,255,255,.08); border:none; cursor:pointer; font-weight:800; border-radius:12px; padding:10px 14px; }

    .stats{ display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin-top:12px; }
    .stat{ background:rgba(255,255,255,.06); border-radius:14px; padding:10px 8px; display:grid; gap:2px; justify-items:center; }
    .stat .num{ font-weight:800; font-size:15px }
    .stat .lab{ font-size:10px; color:#cfefff }

    .tabs{ margin-top:14px; display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
    .tab{ font-size:12px; font-weight:800; color:#111; cursor:pointer; border:none; padding:8px 12px; border-radius:999px; background:linear-gradient(180deg,#dff9ff,#7ff3ff); box-shadow:0 8px 22px rgba(127,243,255,.2); opacity:.7; transition:opacity .15s ease, transform .12s ease; }
    .tab.active{ opacity:1; transform:translateY(-1px) }
    .panel{ display:none; margin-top:14px } .panel.active{ display:block }

    .battles{ display:grid; gap:14px; }
    .battle{ background:rgba(20,20,24,.35); backdrop-filter: blur(10px) saturate(130%); border-radius:18px; padding:12px; box-shadow:0 12px 40px rgba(0,0,0,.35); }
    .battle-top{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .bt-meta{ display:flex; align-items:center; gap:10px; }
    .bt-time{ font-size:11px; color:#cfefff } .bt-title{ font-size:13px; font-weight:800 }
    .bt-panels{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; } @media (max-width:760px){ .bt-panels{ grid-template-columns:1fr; } }
    .panelVid{ position:relative; aspect-ratio: 16/9; border-radius:14px; overflow:hidden; background:#000; box-shadow:0 10px 28px rgba(0,0,0,.35); }
    .panelVid video{ width:100%; height:100%; object-fit:cover }
    .overlay-min{ position:absolute; inset:0; pointer-events:none; display:flex; align-items:flex-start; justify-content:space-between; padding:8px; }
    .min-tag{ font-size:10px; padding:6px 10px; border-radius:999px; color:#111; background:linear-gradient(180deg,#fff3bd,#ffd700); box-shadow:0 8px 22px rgba(255,215,0,.2); }
    .voteRow{ margin-top:10px; display:grid; grid-template-columns: 1fr auto 1fr; gap:10px; align-items:center; }
    .voteBtn{ border:none; cursor:pointer; border-radius:12px; padding:10px 14px; font-weight:800; color:#111; background:linear-gradient(180deg,#fff3bd,#ffd700); box-shadow:0 8px 22px rgba(255,215,0,.2); transition: transform .12s ease; }
    .voteBtn:active{ transform: scale(.98) }
    .midTimer{ font-size:12px; color:#cfefff; text-align:center; background:rgba(255,255,255,.06); border-radius:999px; padding:6px 10px; }
    .acts{ margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; }
    .act{ border:none; cursor:pointer; font-weight:800; border-radius:12px; padding:8px 12px; font-size:12px; color:#bfefff; background:rgba(255,255,255,.08); }

    nav.side{ position:fixed; top:50%; transform:translateY(-50%); display:flex; flex-direction:column; gap:20px; z-index:6; transition: opacity .25s ease, transform .25s ease; }
    nav.side.left{ left:16px } nav.side.right{ right:16px }
    .shape{ background:none; border:none; cursor:pointer; width:36px; height:36px; display:flex; align-items:center; justify-content:center; filter: drop-shadow(0 0 10px rgba(255,255,255,.08)); transition: transform .18s ease, filter .18s ease; }
    .shape:active{ transform: scale(.96) } .shape:hover{ transform:translateY(-2px) scale(1.06); filter:brightness(1.08) }
    .shape svg{ width:100%; height:100%; fill:none } .strokeline{ stroke: var(--gold); stroke-width:2.2 } .shape.logout .strokeline{ stroke:#ff4c4c }
    .center-triangle{ position:fixed; left:50%; bottom:14px; transform:translateX(-50%); z-index:6; transition: opacity .25s ease, transform .25s ease; }
    .nav-hidden nav.side, .nav-hidden .center-triangle{ opacity:0; pointer-events:none; transform:translateY(6px); }

    /* Modal for rank list */
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:20; background:rgba(10,10,12,.6); backdrop-filter: blur(8px) saturate(120%); }
    .modal.open{ display:flex; }
    .modal-card{ width:min(92vw,520px); background:rgba(20,20,24,.55); border:1px solid var(--bd); border-radius:18px; padding:16px; box-shadow:0 18px 60px rgba(0,0,0,.45); }
    .modal-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
    .modal-title{ font-weight:800; letter-spacing:.3px }
    .modal-close{ border:none; background:rgba(255,255,255,.08); color:#fff; border-radius:10px; padding:6px 10px; cursor:pointer; }
    .rank-list{ display:grid; gap:8px; margin-top:6px; }
    .rank-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; background:rgba(255,255,255,.05); border:1px solid var(--bd); border-radius:12px; padding:10px 12px; }
    .rank-name{ font-weight:800; }
    .rank-num{ min-width:64px; text-align:center; font-weight:800; color:#111; background:linear-gradient(180deg,#fff3bd,#ffd700); border-radius:999px; padding:6px 10px; }
  </style>
</head>
<body>
  <canvas id="bg3d"></canvas>

  <div class="page">
    <header class="header">
      <div class="topline">
        <div class="title">
          <div class="avatar">
            <img id="avatar" alt="Avatar"/>
            <span id="avatarInitials" class="initials">BB</span>
            <img id="flag" class="flag-badge" src="" alt="" style="display:none"/>
          </div>
          <div class="nameblock">
            <div id="display" class="display">Player</div>
            <div class="handle" id="handle">@player</div>
            <div class="social-row">
              <span class="soc-chip" id="followersChip">Followers: 0</span>
              <span class="soc-chip" id="followingChip">Following: 0</span>
            </div>
          </div>
        </div>
        <div class="actions">
          <button class="rank-pill" id="rankPill" title="View leaderboard ranks">#—</button>
          <button class="btn ghost" id="settingsBtn" title="Settings">Settings</button>
        </div>
      </div>

      <section class="stats" id="stats">
        <div class="stat"><div class="num" id="statVotes">0</div><div class="lab">Votes</div></div>
        <div class="stat"><div class="num" id="statWins">0</div><div class="lab">Wins</div></div>
        <div class="stat"><div class="num" id="statLoss">0</div><div class="lab">Losses</div></div>
      </section>

      <nav class="tabs" role="tablist">
        <button class="tab active" data-tab="battles" role="tab" aria-selected="true">Battles</button>
        <button class="tab" data-tab="about" role="tab">About</button>
        <button class="tab" data-tab="media" role="tab">Media</button>
      </nav>
    </header>

    <section id="panel-battles" class="panel active">
      <div class="battles" id="battlesList"></div>
    </section>

    <section id="panel-about" class="panel">
      <div class="about" id="aboutBox"><p id="bio">Loading…</p></div>
    </section>

    <section id="panel-media" class="panel">
      <div class="media"><div class="grid" id="mediaGrid"></div></div>
    </section>
  </div>

  <!-- LEFT -->
  <nav class="side left" aria-label="Left sidebar">
    <button class="shape" data-link="home.html" title="Home" aria-label="Home">
      <svg viewBox="0 0 24 24" aria-hidden="true"><circle class="strokeline" cx="12" cy="12" r="9"/></svg>
    </button>
    <button class="shape" data-link="leaderboard.html" title="Leaderboard" aria-label="Leaderboard">
      <svg viewBox="0 0 24 24" aria-hidden="true"><rect class="strokeline" x="6" y="6" width="12" height="12" rx="2"/></svg>
    </button>
  </nav>

  <!-- RIGHT -->
  <nav class="side right" aria-label="Right sidebar">
    <button class="shape" data-link="discover.html" title="Discover" aria-label="Discover">
      <svg viewBox="0 0 24 24" aria-hidden="true"><polygon class="strokeline" points="12,4 20,12 12,20 4,12"/></svg>
    </button>
    <button class="shape logout" id="logoutBtn" title="Logout" aria-label="Logout">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <line class="strokeline" x1="6" y1="6" x2="18" y2="18"/>
        <line class="strokeline" x1="18" y1="6" x2="6" y2="18"/>
      </svg>
    </button>
  </nav>

  <!-- Arena -->
  <div class="center-triangle">
    <button class="shape" data-link="arena.html" title="Arena" aria-label="Arena">
      <svg viewBox="0 0 24 24" aria-hidden="true"><polygon class="strokeline" points="12,5 20,19 4,19"/></svg>
    </button>
  </div>

  <!-- Rank Modal -->
  <div id="rankModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="rankModalTitle">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title" id="rankModalTitle">Your Leaderboard Ranks</div>
        <button class="modal-close" id="rankClose">Close</button>
      </div>
      <div id="rankList" class="rank-list"></div>
    </div>
  </div>

  <!-- Profile load -->
  <script type="module">
    let fb = {};
    try { fb = await import("./firebase.js"); } catch(e){ console.error("[home] import firebase.js failed:", e); }
    const { auth, db, onAuthStateChanged, signOut, doc, getDoc } = fb;

    const $ = (s)=>document.querySelector(s);
    const avatarImg = $('#avatar');
    const avatarInitials = $('#avatarInitials');
    const displayEl = $('#display');
    const handleEl  = $('#handle');
    const flagImg   = $('#flag');

    const statVotes = $('#statVotes');
    const statWins  = $('#statWins');
    const statLoss  = $('#statLoss');
    const followersChip = $('#followersChip');
    const followingChip = $('#followingChip');

    const battlesList = $('#battlesList');
    const mediaGrid   = $('#mediaGrid');
    const bioEl       = $('#bio');

    const rankPill    = $('#rankPill');
    const rankModal   = $('#rankModal');
    const rankClose   = $('#rankClose');
    const rankList    = $('#rankList');

    const settingsBtn = document.getElementById('settingsBtn');
    const logoutBtn   = document.getElementById('logoutBtn');

    const nz = (n)=> Number.isFinite(n) ? n : 0;

    function initialsFrom(name, handle){
      const s = (name || handle || "BB").toString().replace("@","");
      const parts = s.split(/[^\w]+/).filter(Boolean);
      const a = (parts[0]?.[0] || "B").toUpperCase();
      const b = (parts[1]?.[0] || parts[0]?.[1] || "B").toUpperCase();
      return a + b;
    }
    function setAvatar(url, name, handle){
      const init = initialsFrom(name, handle);
      avatarInitials.textContent = init;
      if (url && url !== "null" && url !== "undefined"){
        avatarImg.src = url;
        avatarImg.style.display = "block";
        avatarImg.onload = ()=>{ avatarInitials.style.display="none"; };
        avatarImg.onerror = ()=>{ avatarImg.style.display="none"; avatarInitials.style.display="grid"; };
      } else {
        avatarImg.removeAttribute("src");
        avatarImg.style.display = "none";
        avatarInitials.style.display="grid";
      }
    }
    function flagFromCountry(country){
      const map = {
        "United States":"flag_us.png","USA":"flag_us.png","US":"flag_us.png",
        "Japan":"flag_jp.png","Canada":"flag_ca.png","United Kingdom":"flag_uk.png","Australia":"flag_au.png"
      };
      return map[country||""] || "";
    }

    // pick first defined property from list of paths (supports nested like "education.hs")
    function pick(obj, keys){
      for(const k of keys){
        const val = k.split('.').reduce((o,kk)=>o && o[kk], obj);
        if(val !== undefined && val !== null && val !== "") return val;
      }
      return undefined;
    }

    function quickFillFromAuth(u){
      const base = (u.displayName || (u.email?.split("@")[0]) || localStorage.getItem("bb.username") || "player");
      const username = String(base);
      const handle = "@"+username.toLowerCase();
      displayEl.textContent = username;
      handleEl.textContent  = handle;
      // prefer local avatar (if you saved it in create flow), then auth photo
      const localAvatar = localStorage.getItem("bb.avatarURL");
      setAvatar(localAvatar || u.photoURL || "", username, handle);
    }

    function fillFromProfile(u, p){
      // username from Firestore (create flow writes 'username')
      const username = pick(p, ["username","userName","displayName"]) || u.displayName || (u.email?.split("@")[0]) || localStorage.getItem("bb.username") || "player";
      const handle = "@" + String(username).toLowerCase();

      displayEl.textContent = username;
      handleEl.textContent  = handle;

      // avatar from Firestore (create flow writes 'avatarURL' if present)
      const avatarURL = pick(p, ["avatarURL","avatar","photoURL","profile.avatarURL"]) || localStorage.getItem("bb.avatarURL") || u.photoURL || "";
      setAvatar(avatarURL, username, handle);

      const flagSrc = flagFromCountry(p.country || p.region || "");
      if(flagSrc){ flagImg.src=flagSrc; flagImg.style.display=""; } else { flagImg.style.display="none"; }

      statVotes.textContent = (nz(p.votes)||0).toLocaleString();
      statWins.textContent  = nz(p.wins)||0;
      statLoss.textContent  = nz(p.losses)||0;

      followersChip.textContent = `Followers: ${(nz(p.followersCount || p.followers || 0)).toLocaleString()}`;
      followingChip.textContent = `Following: ${(nz(p.followingCount || p.following || 0)).toLocaleString()}`;

      bioEl.textContent = p.bio || "Let's battle. ⚡";

      const media = Array.isArray(p.media) ? p.media : [];
      mediaGrid.innerHTML = media.length
        ? media.map(src=>`<div class="thumb"><img src="${src}" alt="" style="width:100%;height:100%;object-fit:cover"/></div>`).join("")
        : '<div class="muted">No media yet.</div>';

      const battles = Array.isArray(p.battles) ? p.battles : [];
      battlesList.innerHTML = battles.length ? battles.map(b => `
        <article class="battle" data-id="${b.id || ''}">
          <div class="battle-top">
            <div class="bt-meta"><div class="bt-title">${b.title || 'Battle'}</div><div class="bt-time">${b.ago || ''}</div></div>
          </div>
          <div class="bt-panels">
            <div class="panelVid">
              <video src="${b.me?.video || ''}" muted playsinline loop></video>
              <div class="overlay-min"><span class="min-tag">${b.me?.tag || 'You'}</span></div>
            </div>
            <div class="panelVid">
              <video src="${b.op?.video || ''}" muted playsinline loop></video>
              <div class="overlay-min"><span class="min-tag">${b.op?.tag || 'Opponent'}</span></div>
            </div>
          </div>
          <div class="voteRow">
            <button class="voteBtn" data-side="me" aria-label="Vote left">Vote</button>
            <div class="midTimer">${b.timer || ''}</div>
            <button class="voteBtn" data-side="op" aria-label="Vote right">Vote</button>
          </div>
          <div class="acts">
            <button class="act" data-act="share">Share</button>
            <button class="act" data-act="comment">Comment</button>
            <button class="act" data-act="mute">Mute</button>
            <button class="act" data-act="flag">Flag</button>
          </div>
        </article>
      `).join("") : '<div class="muted">No recent battles yet.</div>';

      document.querySelectorAll('.panelVid video').forEach(v=>{
        v.addEventListener('canplay', ()=> v.play().catch(()=>{}));
      });

      // Ranks → pill/modal
      const ranks = p.ranks && typeof p.ranks === 'object' ? p.ranks : { Global: (p.rank ?? "—") };
      const rows = Object.entries(ranks).map(([name, val])=>{
        const num = (val ?? "—");
        return `<div class="rank-row"><div class="rank-name">${name}</div><div class="rank-num">#${num}</div></div>`;
      }).join("");
      rankList.innerHTML = rows || '<div class="muted">No ranks yet.</div>';
      const firstRank = Object.values(ranks)[0] ?? "—";
      rankPill.textContent = "#"+(firstRank === undefined ? "—" : firstRank);
    }

    // UI wires
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
        document.getElementById('panel-'+btn.dataset.tab).classList.add('active');
      });
    });

    document.querySelectorAll(".shape[data-link]").forEach(btn=>{
      btn.addEventListener("click", ()=>{ window.location.href = btn.dataset.link; });
    });

    // Settings -> settings.html
    settingsBtn?.addEventListener('click', ()=>{ window.location.href = 'settings.html'; });

    logoutBtn?.addEventListener('click', async ()=>{
      try { await signOut(auth); location.href='index.html#/auth/login'; }
      catch(e){ alert(e?.message || 'Logout failed'); }
    });

    // Rank modal
    rankPill.addEventListener('click', ()=> rankModal.classList.add('open'));
    rankClose.addEventListener('click', ()=> rankModal.classList.remove('open'));
    rankModal.addEventListener('click', (e)=>{ if(e.target === rankModal) rankModal.classList.remove('open'); });

    // Auth → Firestore profile
    if (!onAuthStateChanged || !auth) {
      console.error("[home] Firebase auth not available. Ensure firebase.js initializes and exports {auth,onAuthStateChanged}.");
    } else {
      onAuthStateChanged(auth, async (user)=>{
        if(!user){ location.href='index.html#/auth/login'; return; }
        console.log("[home] signed in:", user.uid);
        quickFillFromAuth(user);

        // Try 'users/{uid}' (your create flow) then 'Users/{uid}'
        if (!db || !doc || !getDoc) return;
        const refs = [doc(db,"users",user.uid), doc(db,"Users",user.uid)];
        for (const ref of refs){
          try{
            const snap = await getDoc(ref);
            if(snap.exists()){ fillFromProfile(user, snap.data() || {}); break; }
          }catch(e){ console.warn("[home] getDoc fail for", ref?.path, e); }
        }
      });
    }
  </script>

  <!-- Three.js (background) -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script>
    (function(){
      const canvas = document.getElementById('bg3d');
      let glOK=false; try{ glOK=!!(canvas.getContext('webgl')||canvas.getContext('experimental-webgl')); }catch{}
      if(!glOK) return;
      const DPR=1.75, reduced=matchMedia('(prefers-reduced-motion: reduce)').matches;
      const r=new THREE.WebGLRenderer({canvas,antialias:false,alpha:true,powerPreference:'high-performance'}); r.setClearColor(0,0);
      function sprite(){ const s=128,c=document.createElement('canvas'); c.width=c.height=s; const g=c.getContext('2d'), d=g.createRadialGradient(s/2,s/2,0,s/2,s/2,s/2); d.addColorStop(0,'rgba(255,255,255,.95)'); d.addColorStop(.35,'rgba(255,255,255,.35)'); d.addColorStop(1,'rgba(255,255,255,0)'); g.fillStyle=d; g.fillRect(0,0,s,s); const t=new THREE.CanvasTexture(c); t.minFilter=THREE.LinearFilter; t.magFilter=THREE.LinearFilter; return t;}
      let w=innerWidth,h=innerHeight; r.setPixelRatio(Math.min(devicePixelRatio||1,DPR)); r.setSize(w,h,false);
      const scene=new THREE.Scene(), cam=new THREE.PerspectiveCamera(55,w/h,.1,3000); cam.position.set(0,0,140);
      const hemi=new THREE.HemisphereLight(0x888888,0x080808,.9), dir=new THREE.DirectionalLight(0xffe7a4,.7); dir.position.set(60,80,120); scene.add(hemi,dir);
      const tex=sprite(); const mat=new THREE.PointsMaterial({size:(reduced?14:18),map:tex,transparent:true,depthWrite:false,blending:THREE.AdditiveBlending,vertexColors:true,sizeAttenuation:true});
      (function(){ const N=reduced?250:500,g=new THREE.BufferGeometry(),p=new Float32Array(N*3),c=new Float32Array(N*3);
        for(let i=0;i<N;i++){ p[i*3]=(Math.random()-.5)*460; p[i*3+1]=(Math.random()-.5)*280; p[i*3+2]=-60-Math.random()*180; const t=Math.random()*.5+.35; c[i*3]=t; c[i*3+1]=t*.9; c[i*3+2]=t*.85; }
        g.setAttribute('position', new THREE.BufferAttribute(p,3)); g.setAttribute('color', new THREE.BufferAttribute(c,3));
        const m=new THREE.PointsMaterial({size:(reduced?1.6:2.4),map:tex,transparent:true,depthWrite:false,vertexColors:true,blending:THREE.AdditiveBlending});
        const pts=new THREE.Points(g,m); pts.frustumCulled=false; pts.userData={t:0}; scene.add(pts);
        const tick=()=>{ pts.userData.t+=.0015; pts.position.y=Math.sin(pts.userData.t*8)*1.4; pts.rotation.z+=.0008; requestAnimationFrame(tick); }; tick();
      })();
      const pool=[]; function getPts(n){ for(let i=pool.length-1;i>=0;i--){ const p=pool[i]; if(p.geometry.getAttribute('position').count>=n){ pool.splice(i,1); p.visible=true; return p; } } const g=new THREE.BufferGeometry(); g.setAttribute('position',new THREE.BufferAttribute(new Float32Array(n*3),3)); g.setAttribute('color',new THREE.BufferAttribute(new Float32Array(n*3),3)); g.setAttribute('size',new THREE.BufferAttribute(new Float32Array(n),1)); const pts=new THREE.Points(g,mat.clone()); pts.frustumCulled=false; return pts; }
      function rel(p){ p.visible=false; pool.push(p); }
      const palettes=[[0xffd700,0xff9b00,0xff4d00],[0x47f5ff,0x27d8ff,0x1597ff],[0xff4c6a,0xff2a9f,0xff6ec7],[0xad8cff,0x7f63ff,0x3f2cff],[0x7cff8b,0x2cff6c,0x00d46b]];
      class Boom{ constructor(){ const x=(Math.random()-.5)*w/6,y=(Math.random()-.5)*h/6,z=-30-Math.random()*40; this.c=new THREE.Vector3(x,y,z); this.n=(Math.random()*60+(reduced?70:120))|0; this.p=getPts(this.n); this.p.position.copy(this.c);
          const g=this.p.geometry,pos=g.getAttribute('position').array,col=g.getAttribute('color').array,siz=g.getAttribute('size').array;
          const pal=palettes[(Math.random()*palettes.length)|0],A=new THREE.Color(pal[0]),B=new THREE.Color(pal[1]),C=new THREE.Color(pal[2]); this.v=new Float32Array(this.n*3); this.life=reduced?1.2:1.6; this.t=0;
          for(let i=0;i<this.n;i++){ const d=new THREE.Vector3().randomDirection(), sp=12+Math.random()*30, ix=i*3; this.v[ix]=d.x*sp; this.v[ix+1]=d.y*sp; this.v[ix+2]=d.z*sp; pos[ix]=d.x*1.6; pos[ix+1]=d.y*1.6; pos[ix+2]=d.z*1.6; const t=i/this.n, cc=(t<.5)?A.clone().lerp(B,t*2):B.clone().lerp(C,(t-.5)*2); col[ix]=cc.r; col[ix+1]=cc.g; col[ix+2]=cc.b; siz[i]=8+Math.random()*12; }
          g.getAttribute('position').needsUpdate=true; g.getAttribute('color').needsUpdate=true; g.getAttribute('size').needsUpdate=true; scene.add(this.p);
          const R=new THREE.RingGeometry(5,6.6,64), m1=new THREE.MeshBasicMaterial({color:0xffd700,transparent:true,opacity:.85,blending:THREE.AdditiveBlending,side:THREE.DoubleSide}), m2=new THREE.MeshBasicMaterial({color:0xffa500,transparent:true,opacity:.55,blending:THREE.AdditiveBlending,side:THREE.DoubleSide});
          this.r1=new THREE.Mesh(R,m1); this.r2=new THREE.Mesh(R,m2); this.r1.position.copy(this.c); this.r2.position.copy(this.c); this.R1=5; this.R2=5; scene.add(this.r1,this.r2);
        } upd(dt){ this.t+=dt; const f=this.t/this.life,g=this.p.geometry,pos=g.getAttribute('position').array,col=g.getAttribute('color').array,siz=g.getAttribute('size').array,drag=1-Math.min(.05*dt*60,.05);
          for(let i=0;i<this.n;i++){ const ix=i*3; pos[ix]+=this.v[ix]*dt; pos[ix+1]+=this.v[ix+1]*dt; pos[ix+2]+=this.v[ix+2]*dt; this.v[ix]*=drag; this.v[ix+1]*=drag; this.v[ix+2]*=drag; siz[i]*=(1-dt*.1); if(siz[i]<7) siz[i]=7; const to=Math.max(0,Math.min(1,(f-.3)/.5)); col[ix]=col[ix]*(1-to)+1*to; col[ix+1]=col[ix+1]*(1-to)+.72*to; col[ix+2]=col[ix+2]*(1-to)+.28*to; }
          g.getAttribute('position').needsUpdate=true; g.getAttribute('color').needsUpdate=true; g.getAttribute('size').needsUpdate=true;
          this.R1+=100*dt; this.R2+=125*dt; this.r1.scale.setScalar(this.R1/5); this.r2.scale.setScalar(this.R2/5); this.r1.material.opacity=Math.max(0,.9-f*1.25); this.r2.material.opacity=Math.max(0,.6-f*1.3); this.r1.lookAt(cam.position); this.r2.lookAt(cam.position);
          return this.t<this.life;
        } kill(){ scene.remove(this.p); rel(this.p); scene.remove(this.r1); scene.remove(this.r2); } }
      const arr=[], MAX= (matchMedia('(prefers-reduced-motion: reduce)').matches?4:8); let prev=performance.now(), last=prev, INT=(matchMedia('(prefers-reduced-motion: reduce)').matches?2000:1200);
      function loop(now){ const dt=Math.min(.05,(now-prev)/1000); prev=now; if(now-last>INT){ if(arr.length>MAX){ const o=arr.shift(); o.kill(); } arr.push(new Boom()); last=now; }
        for(let i=arr.length-1;i>=0;i--){ if(!arr[i].upd(dt)){ arr[i].kill(); arr.splice(i,1);} }
        cam.lookAt(0,0,0); r.render(scene,cam); requestAnimationFrame(loop);
      } requestAnimationFrame(loop);
      function resize(){ w=innerWidth; h=innerHeight; r.setPixelRatio(Math.min(devicePixelRatio||1,DPR)); r.setSize(w,h,false); cam.aspect=w/h; cam.updateProjectionMatrix(); }
      addEventListener('resize', resize, {passive:true});
    })();
    // Auto-hide side nav on scroll
    (function(){ let t=null; addEventListener('scroll', ()=>{ document.body.classList.add('nav-hidden'); if(t) clearTimeout(t); t=setTimeout(()=>document.body.classList.remove('nav-hidden'), 350); }, {passive:true}); })();
  </script>
</body>
</html>
