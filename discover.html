<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"/>
  <title>BattleBillions â€” Discover</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --ink:#eaeaea; --muted:#b8b8b8;
      --gold:#ffd700; --cyan:#7ff3ff; --pink:#ff4c6a; --violet:#ad8cff; --emerald:#2cff6c;
      --safe-top:max(10px, env(safe-area-inset-top));
      --safe-bottom:max(14px, env(safe-area-inset-bottom));
      --side-pad:clamp(12px,4vw,44px);
      --glass:rgba(255,255,255,.06);
      --bg-grad:
        radial-gradient(900px 600px at 25% 15%, rgba(255,215,0,.05), transparent 60%),
        radial-gradient(800px 600px at 80% 20%, rgba(127,243,255,.05), transparent 60%),
        radial-gradient(1200px 1000px at 50% 80%, rgba(159,123,255,.05), transparent 70%);
    }
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{
      height:100%; width:100%; background:#000; color:var(--ink);
      font-family:'Orbitron',sans-serif; -webkit-tap-highlight-color:transparent;
      touch-action:manipulation; overscroll-behavior:none; overflow-x:hidden;
    }
    /* hide scrollbars but keep scrolling */
    *::-webkit-scrollbar{ width:0; height:0; display:none }
    *{ scrollbar-width:none }

    /* Background canvas (subtle explosions) */
    #bg3d{
      position:fixed; inset:0; width:100%; height:100%; display:block;
      z-index:0; pointer-events:none;
      background: radial-gradient(1200px 900px at 20% 10%, #0b0b0d 0%, #000 70%);
    }
    body::before{
      content:""; position:fixed; inset:-10%; pointer-events:none; z-index:0;
      background:var(--bg-grad); filter:blur(2px);
    }

    .page{
      position:relative; z-index:1; min-height:100dvh;
      padding: calc(var(--safe-top) + 8px) var(--side-pad) calc(var(--safe-bottom) + 100px);
    }

    /* Header (glass) */
    .header{
      position:sticky; top:0; z-index:6;
      margin:0 calc(var(--side-pad)*-1);
      padding:12px var(--side-pad) 16px;
      background: linear-gradient(180deg, rgba(0,0,0,.92), rgba(0,0,0,.45));
      backdrop-filter: blur(12px);
    }
    .row{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .title{
      display:flex; align-items:center; gap:12px;
      font-weight:800; font-size:18px; text-transform:uppercase; letter-spacing:.3px;
      background:
        linear-gradient(120deg, rgba(255,255,255,.18), rgba(255,255,255,0) 20% 80%, rgba(255,255,255,.18)),
        linear-gradient(180deg, #f2f2f2 0%, #c7c7c7 38%, #9d9d9d 56%, #f0f0f0 86%);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow:0 4px 24px rgba(255,215,0,.12);
    }

    /* Tabs */
    .tabs{ margin-top:12px; display:flex; gap:10px; flex-wrap:wrap }
    .tab{
      font-size:12px; font-weight:800; color:#111; cursor:pointer; border:none;
      padding:8px 12px; border-radius:999px;
      background:linear-gradient(180deg,#dff9ff,#7ff3ff);
      box-shadow:0 8px 22px rgba(127,243,255,.2);
      opacity:.7; transition:opacity .15s ease, transform .12s ease;
    }
    .tab.active{ opacity:1; transform:translateY(-1px) }

    /* Search + filters */
    .filters{
      margin-top:12px; display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center;
    }
    @media (max-width:700px){ .filters{ grid-template-columns: 1fr } }
    .search{
      display:flex; align-items:center; gap:8px; padding:10px 12px; border-radius:12px;
      background:rgba(255,255,255,.06); backdrop-filter: blur(8px);
    }
    .search input{
      flex:1; border:none; outline:0; background:transparent; color:var(--ink); font-size:13px;
      font-family:inherit;
    }
    .drop{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
    }
    .select{
      appearance:none; border:none; outline:0; cursor:pointer; font-weight:700; font-size:12px;
      padding:10px 12px; border-radius:12px;
      background:rgba(255,255,255,.06); color:#dff9ff; font-family:inherit;
      backdrop-filter: blur(8px);
    }

    /* Panels */
    .panel{ display:none; margin-top:14px }
    .panel.active{ display:block }

    /* BATTLES GRID */
    .battleGrid{
      display:grid; gap:14px;
      grid-template-columns: repeat(2, minmax(0,1fr));
    }
    @media (max-width:980px){ .battleGrid{ grid-template-columns:1fr } }

    .card{
      background:rgba(20,20,24,.35); border-radius:16px; padding:12px;
      backdrop-filter: blur(10px) saturate(130%);
      box-shadow:0 12px 40px rgba(0,0,0,.35);
    }
    .cardTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;
    }
    .pair{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .face{
      position:relative; width:34px; height:34px; border-radius:999px; overflow:hidden; background:#0a0a0a;
      box-shadow:0 0 8px rgba(0,0,0,.45);
    }
    .face img{ width:100%; height:100%; object-fit:cover }
    .flag{
      position:absolute; right:-2px; bottom:-2px; width:16px; height:11px; border-radius:2px; box-shadow:0 0 6px rgba(0,0,0,.6);
    }
    .name{ font-weight:800; font-size:12px }
    .top9{
      margin-left:4px; min-width:18px; height:18px; border-radius:999px; display:inline-grid; place-items:center;
      font-size:10px; font-weight:800; color:#111; background:linear-gradient(180deg,#fff1a8,#ffd700);
      box-shadow:0 0 8px rgba(255,215,0,.35);
    }
    .ago{ font-size:11px; color:#cfefff }

    /* Two video panels side-by-side */
    .bt-panels{
      display:grid; grid-template-columns:1fr 1fr; gap:10px;
    }
    @media (max-width:680px){ .bt-panels{ grid-template-columns:1fr } }
    .panelVid{
      position:relative; aspect-ratio: 16/9; border-radius:14px; overflow:hidden; background:#000;
      box-shadow:0 10px 28px rgba(0,0,0,.35);
    }
    .panelVid video{ width:100%; height:100%; object-fit:cover }
    .overlay-min{
      position:absolute; inset:0; display:flex; align-items:flex-start; justify-content:space-between; padding:8px; pointer-events:none;
    }
    .min-tag{
      font-size:10px; padding:6px 10px; border-radius:999px;
      color:#111; background:linear-gradient(180deg,#fff3bd,#ffd700);
      box-shadow:0 8px 22px rgba(255,215,0,.2);
    }

    /* Vote + timer row */
    .voteRow{
      margin-top:10px; display:grid; grid-template-columns: 1fr auto 1fr; gap:10px; align-items:center;
    }
    .voteBtn{
      border:none; cursor:pointer; border-radius:12px; padding:10px 14px; font-weight:800; color:#111;
      background:linear-gradient(180deg,#fff3bd,#ffd700);
      box-shadow:0 8px 22px rgba(255,215,0,.2);
      transition: transform .12s ease;
    }
    .voteBtn:active{ transform: scale(.98) }
    .midTimer{
      font-size:12px; color:#cfefff; text-align:center;
      background:rgba(255,255,255,.06); border-radius:999px; padding:6px 10px;
      min-width:110px;
    }

    /* Actions under card */
    .acts{
      margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;
    }
    .act{
      border:none; cursor:pointer; font-weight:800; border-radius:12px; padding:8px 12px; font-size:12px;
      color:#bfefff; background:rgba(255,255,255,.08);
    }

    /* PEOPLE GRID */
    .peopleGrid{
      display:grid; gap:14px; grid-template-columns: repeat(3, minmax(0,1fr));
    }
    @media (max-width:1100px){ .peopleGrid{ grid-template-columns: repeat(2,1fr) } }
    @media (max-width:680px){ .peopleGrid{ grid-template-columns: 1fr } }

    .user{
      background:rgba(20,20,24,.35); border-radius:16px; padding:12px;
      backdrop-filter: blur(10px) saturate(130%);
      box-shadow:0 12px 40px rgba(0,0,0,.35);
      display:grid; gap:10px;
    }
    .uHead{ display:flex; align-items:center; gap:10px }
    .uFace{ position:relative; width:52px; height:52px; border-radius:50%; overflow:hidden; background:#0a0a0a }
    .uFace img{ width:100%; height:100%; object-fit:cover }
    .uFlag{ position:absolute; right:-3px; bottom:-3px; width:18px; height:12px; border-radius:2px; box-shadow:0 0 6px rgba(0,0,0,.6) }
    .uName{ font-weight:800; font-size:14px }
    .uHandle{ font-size:11px; color:#cfefff }
    .uBadges{ display:flex; align-items:center; gap:6px }
    .badge9{ min-width:20px; height:20px; border-radius:999px; display:grid; place-items:center; font-size:11px; font-weight:800; color:#111; background:linear-gradient(180deg,#fff1a8,#ffd700); box-shadow:0 0 8px rgba(255,215,0,.35) }
    .uActs{ display:flex; gap:10px }
    .btn{
      border:none; cursor:pointer; font-weight:800; border-radius:12px; padding:10px 14px;
      color:#111; background:linear-gradient(180deg,#dff9ff,#7ff3ff);
      box-shadow:0 8px 22px rgba(127,243,255,.2);
    }

    /* Shape nav (same as Arena/Profile) */
    nav.side{
      position:fixed; top:50%; transform:translateY(-50%); display:flex; flex-direction:column; gap:20px; z-index:7;
      transition: opacity .25s ease, transform .25s ease;
    }
    nav.side.left{ left:16px }
    nav.side.right{ right:16px }
    .shape{
      background:none; border:none; cursor:pointer; width:36px; height:36px; display:flex; align-items:center; justify-content:center;
      filter: drop-shadow(0 0 10px rgba(255,255,255,.08));
      transition: transform .18s ease, filter .18s ease;
    }
    .shape:active{ transform: scale(.96) }
    .shape:hover{ transform:translateY(-2px) scale(1.06); filter:brightness(1.08) }
    .shape svg{ width:100%; height:100%; fill:none }
    .strokeline{ stroke: var(--gold); stroke-width:2.2 }
    .shape.logout .strokeline{ stroke:#ff4c4c }
    .center-triangle{
      position:fixed; left:50%; bottom:14px; transform:translateX(-50%); z-index:7;
      transition: opacity .25s ease, transform .25s ease;
    }
    /* Active highlight on DIAMOND (Discover) */
    .side.right .shape:first-child .strokeline{ stroke: var(--gold); filter: drop-shadow(0 0 8px rgba(255,215,0,.6)); }

    .nav-hidden nav.side, .nav-hidden .center-triangle{ opacity:0; pointer-events:none; transform:translateY(6px) }
  </style>
</head>
<body>
  <!-- Background explosions -->
  <canvas id="bg3d"></canvas>

  <div class="page">
    <header class="header">
      <div class="row">
        <div class="title">Discover</div>
      </div>

      <nav class="tabs" role="tablist">
        <button class="tab active" data-tab="trending" role="tab" aria-selected="true">Trending Battles</button>
        <button class="tab" data-tab="people" role="tab">People</button>
      </nav>

      <section class="filters">
        <div class="search" role="search">
          <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><circle cx="11" cy="11" r="7" stroke="#dff9ff" stroke-width="2" fill="none"/><line x1="16.5" y1="16.5" x2="21" y2="21" stroke="#dff9ff" stroke-width="2"/></svg>
          <input id="q" type="text" placeholder="Search users, flags (ðŸ‡¯ðŸ‡µ), cities, stylesâ€¦"/>
        </div>
        <div class="drop">
          <select id="f-category" class="select" aria-label="Category">
            <option value="">All Categories</option>
            <option>Rap</option><option>Dance</option><option>Comedy</option><option>Freestyle</option>
          </select>
          <select id="f-country" class="select" aria-label="Country">
            <option value="">All Countries</option>
            <option value="US">ðŸ‡ºðŸ‡¸ United States</option>
            <option value="JP">ðŸ‡¯ðŸ‡µ Japan</option>
            <option value="BR">ðŸ‡§ðŸ‡· Brazil</option>
            <option value="NG">ðŸ‡³ðŸ‡¬ Nigeria</option>
          </select>
          <select id="f-lang" class="select" aria-label="Language">
            <option value="">All Languages</option>
            <option>English</option><option>Japanese</option><option>Portuguese</option><option>Yoruba</option>
          </select>
        </div>
      </section>
    </header>

    <!-- Trending Battles -->
    <section id="panel-trending" class="panel active">
      <div id="battleGrid" class="battleGrid"></div>
    </section>

    <!-- People -->
    <section id="panel-people" class="panel">
      <div id="peopleGrid" class="peopleGrid"></div>
    </section>
  </div>

  <!-- LEFT side (circle over square) -->
  <nav class="side left" aria-label="Left sidebar">
    <button class="shape" data-link="home.html" title="Home" aria-label="Home">
      <svg viewBox="0 0 24 24" aria-hidden="true"><circle class="strokeline" cx="12" cy="12" r="9"/></svg>
    </button>
    <button class="shape" data-link="leaderboard.html" title="Leaderboard" aria-label="Leaderboard">
      <svg viewBox="0 0 24 24" aria-hidden="true"><rect class="strokeline" x="6" y="6" width="12" height="12" rx="2"/></svg>
    </button>
  </nav>

  <!-- RIGHT side (diamond over X) -->
  <nav class="side right" aria-label="Right sidebar">
    <button class="shape" data-link="discover.html" title="Discover" aria-label="Discover">
      <svg viewBox="0 0 24 24" aria-hidden="true"><polygon class="strokeline" points="12,4 20,12 12,20 4,12"/></svg>
    </button>
    <button class="shape logout" id="logoutBtn" title="Logout" aria-label="Logout">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <line class="strokeline" x1="6" y1="6" x2="18" y2="18"/>
        <line class="strokeline" x1="18" y1="6" x2="6" y2="18"/>
      </svg>
    </button>
  </nav>

  <!-- Bottom-center triangle (Arena) -->
  <div class="center-triangle">
    <button class="shape" data-link="arena.html" title="Arena" aria-label="Arena">
      <svg viewBox="0 0 24 24" aria-hidden="true"><polygon class="strokeline" points="12,5 20,19 4,19"/></svg>
    </button>
  </div>

  <!-- Three.js for background -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script>
    /********************
     * MOCK DATA
     ********************/
    const BATTLES = [
      {
        id:'b1', ago:'4m', category:'Rap', countryA:'US', countryB:'JP', lang:'English',
        a:{name:'@Nova', flag:'flag_jp.png', top9:1, avatar:'user2.jpg', video:'clip_nova2.mp4'},
        b:{name:'@Kiro', flag:'flag_us.png', top9:3, avatar:'user3.jpg', video:'clip_kiro.mp4'},
        timer:'Round 2 â€¢ 00:33'
      },
      {
        id:'b2', ago:'12m', category:'Dance', countryA:'BR', countryB:'US', lang:'Portuguese',
        a:{name:'@SambaWave', flag:'flag_br.png', top9:2, avatar:'user4.jpg', video:'clip_samba.mp4'},
        b:{name:'@Flex', flag:'flag_us.png', top9:null, avatar:'user5.jpg', video:'clip_flex.mp4'},
        timer:'Round 1 â€¢ 00:28'
      },
      {
        id:'b3', ago:'18m', category:'Rap', countryA:'NG', countryB:'BR', lang:'English',
        a:{name:'@Ari', flag:'flag_ng.png', top9:5, avatar:'user6.jpg', video:'clip_ari.mp4'},
        b:{name:'@RioBars', flag:'flag_br.png', top9:null, avatar:'user7.jpg', video:'clip_riobars.mp4'},
        timer:'Round 3 â€¢ 00:12'
      }
    ];

    const PEOPLE = [
      {handle:'@Nova', display:'Nova', avatar:'user2.jpg', flag:'flag_jp.png', top9:1, country:'JP', lang:'Japanese'},
      {handle:'@Kiro', display:'Kiro', avatar:'user3.jpg', flag:'flag_us.png', top9:3, country:'US', lang:'English'},
      {handle:'@SambaWave', display:'Samba Wave', avatar:'user4.jpg', flag:'flag_br.png', top9:2, country:'BR', lang:'Portuguese'},
      {handle:'@Ari', display:'Ari', avatar:'user6.jpg', flag:'flag_ng.png', top9:5, country:'NG', lang:'English'},
      {handle:'@Flex', display:'Flex', avatar:'user5.jpg', flag:'flag_us.png', top9:null, country:'US', lang:'English'},
      {handle:'@RioBars', display:'Rio Bars', avatar:'user7.jpg', flag:'flag_br.png', top9:null, country:'BR', lang:'Portuguese'},
    ];

    /********************
     * RENDER HELPERS
     ********************/
    const battleGrid = document.getElementById('battleGrid');
    const peopleGrid = document.getElementById('peopleGrid');

    function faceHTML(p){
      return `
        <div class="face"><img src="${p.avatar}" alt=""/><img class="flag" src="${p.flag}" alt=""/></div>
        <div class="name">${p.name || p.display}</div>
        ${p.top9? `<span class="top9">${p.top9}</span>`:``}
      `;
    }

    function battleCardHTML(b){
      return `
        <article class="card" data-id="${b.id}" data-cat="${b.category}" data-country="${b.countryA},${b.countryB}" data-lang="${b.lang}">
          <div class="cardTop">
            <div class="pair">
              ${faceHTML(b.a)}
              <span style="opacity:.6">vs</span>
              ${faceHTML(b.b)}
            </div>
            <div class="ago">${b.ago} ago</div>
          </div>

          <div class="bt-panels">
            <div class="panelVid">
              <video src="${b.a.video}" muted playsinline loop></video>
              <div class="overlay-min"><span class="min-tag">You</span></div>
            </div>
            <div class="panelVid">
              <video src="${b.b.video}" muted playsinline loop></video>
              <div class="overlay-min"><span class="min-tag">Opponent</span></div>
            </div>
          </div>

          <div class="voteRow">
            <button class="voteBtn" data-side="a" aria-label="Vote left">Vote</button>
            <div class="midTimer">${b.timer}</div>
            <button class="voteBtn" data-side="b" aria-label="Vote right">Vote</button>
          </div>

          <div class="acts">
            <button class="act" data-act="share">Share</button>
            <button class="act" data-act="comment">Comment</button>
            <button class="act" data-act="mute">Mute</button>
            <button class="act" data-act="flag">Flag</button>
          </div>
        </article>
      `;
    }

    function userCardHTML(u){
      return `
        <article class="user" data-country="${u.country}" data-lang="${u.lang}">
          <div class="uHead">
            <div class="uFace">
              <img src="${u.avatar}" alt=""/>
              <img class="uFlag" src="${u.flag}" alt=""/>
            </div>
            <div>
              <div class="uName">${u.display}</div>
              <div class="uHandle">${u.handle}</div>
              <div class="uBadges">${u.top9? `<span class="badge9">${u.top9}</span>`:''}</div>
            </div>
          </div>
          <div class="uActs">
            <button class="btn" onclick="location.href='profile.html?u=${encodeURIComponent(u.handle)}'">View</button>
            <button class="btn" style="background:linear-gradient(180deg,#fff3bd,#ffd700);">Follow</button>
          </div>
        </article>
      `;
    }

    function renderBattles(list){ battleGrid.innerHTML = list.map(battleCardHTML).join(''); autoplayPreviews(); attachVoteHandlers(); }
    function renderPeople(list){ peopleGrid.innerHTML = list.map(userCardHTML).join(''); }

    /********************
     * FILTERS + SEARCH
     ********************/
    const q = document.getElementById('q');
    const fCat = document.getElementById('f-category');
    const fCountry = document.getElementById('f-country');
    const fLang = document.getElementById('f-lang');

    function normalize(str){ return (str||'').toLowerCase(); }

    function applyFilters(){
      const text = normalize(q.value);
      const cat  = fCat.value;
      const cc   = fCountry.value;
      const lang = fLang.value;

      const bFiltered = BATTLES.filter(b=>{
        const t = `${b.a.name} ${b.b.name} ${b.category} ${b.lang}`.toLowerCase();
        const countryHit = !cc || b.countryA===cc || b.countryB===cc;
        const langHit    = !lang || b.lang===lang;
        const catHit     = !cat || b.category===cat;
        const textHit    = !text || t.includes(text);
        return countryHit && langHit && catHit && textHit;
      });

      const pFiltered = PEOPLE.filter(u=>{
        const t = `${u.display} ${u.handle} ${u.lang}`.toLowerCase();
        const countryHit = !cc || u.country===cc;
        const langHit    = !lang || u.lang===lang;
        const catHit     = true; // people not categorized
        const textHit    = !text || t.includes(text);
        return countryHit && langHit && catHit && textHit;
      });

      renderBattles(bFiltered);
      renderPeople(pFiltered);
    }

    [q,fCat,fCountry,fLang].forEach(el=>{
      el.addEventListener('input', applyFilters);
      el.addEventListener('change', applyFilters);
    });

    /********************
     * Tabs
     ********************/
    const tabBtns = Array.from(document.querySelectorAll('.tab'));
    tabBtns.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        tabBtns.forEach(x=>x.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
        document.getElementById('panel-'+btn.dataset.tab).classList.add('active');
      });
    });

    /********************
     * Init content
     ********************/
    renderBattles(BATTLES);
    renderPeople(PEOPLE);

    /********************
     * Video autoplay previews
     ********************/
    function autoplayPreviews(){
      document.querySelectorAll('.panelVid video').forEach(v=>{
        v.addEventListener('canplay', ()=> v.play().catch(()=>{}), {once:true});
      });
    }

    /********************
     * Vote (one click per side, client-only demo)
     ********************/
    function attachVoteHandlers(){
      document.querySelectorAll('.card').forEach(card=>{
        const voted = {a:false, b:false};
        card.querySelectorAll('.voteBtn').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const side = btn.dataset.side;
            if(voted[side]) return;
            voted[side] = true;
            btn.textContent='Voted';
            btn.style.filter='brightness(1.1)';
            // TODO: send to backend
          });
        });
      });
    }

    /********************
     * Shape nav links
     ********************/
    document.querySelectorAll(".shape[data-link]").forEach(btn=>{
      btn.addEventListener("click", ()=>{ window.location.href = btn.dataset.link; });
    });
    document.getElementById('logoutBtn').addEventListener('click', ()=>{
      window.location.href='login.html';
    });

    // Auto-hide nav on scroll
    let navHideTimer=null;
    window.addEventListener('scroll', ()=>{
      document.body.classList.add('nav-hidden');
      if(navHideTimer) clearTimeout(navHideTimer);
      navHideTimer = setTimeout(()=> document.body.classList.remove('nav-hidden'), 350);
    }, {passive:true});

    /********************
     * Background explosions (subtle + continuous)
     ********************/
    (function(){
      const canvas = document.getElementById('bg3d');
      const reduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      let width = innerWidth, height = innerHeight;
      let glOK=false;
      try{
        const gl = canvas.getContext('webgl',{antialias:false}) || canvas.getContext('experimental-webgl');
        glOK=!!gl;
      }catch(e){ glOK=false; }
      if(!glOK) return;

      const DPR_LIMIT=1.75;
      const renderer = new THREE.WebGLRenderer({ canvas, antialias:false, alpha:true, powerPreference:'high-performance' });
      renderer.setClearColor(0x000000,0);
      renderer.setPixelRatio(Math.min(devicePixelRatio||1, DPR_LIMIT));
      renderer.setSize(width, height, false);

      const scene = new THREE.Scene();
      const camera= new THREE.PerspectiveCamera(55, width/height, 0.1, 3000);
      camera.position.set(0,0,140);

      const hemi = new THREE.HemisphereLight(0x777777,0x080808,0.9);
      const dir  = new THREE.DirectionalLight(0xffe7a4,0.6); dir.position.set(60,80,120);
      scene.add(hemi,dir);

      // Sprite
      function sprite(){
        const s=128, c=document.createElement('canvas'); c.width=c.height=s;
        const g=c.getContext('2d'), grd=g.createRadialGradient(s/2,s/2,0, s/2,s/2,s/2);
        grd.addColorStop(0,'rgba(255,255,255,0.95)');
        grd.addColorStop(0.35,'rgba(255,255,255,0.35)');
        grd.addColorStop(1,'rgba(255,255,255,0)');
        g.fillStyle=grd; g.fillRect(0,0,s,s);
        const tex=new THREE.CanvasTexture(c); tex.minFilter=THREE.LinearFilter; tex.magFilter=THREE.LinearFilter; return tex;
      }
      const particleTex = sprite();
      const baseMat = new THREE.PointsMaterial({
        size:(reduced? 13:16), map:particleTex, transparent:true, depthWrite:false,
        blending:THREE.AdditiveBlending, vertexColors:true, sizeAttenuation:true
      });

      // Points pool
      const pool=[];
      function getPoints(n){
        for(let i=pool.length-1;i>=0;i--){
          const p=pool[i];
          if(p.geometry.getAttribute('position').count>=n){ pool.splice(i,1); p.visible=true; return p; }
        }
        const g=new THREE.BufferGeometry();
        g.setAttribute('position', new THREE.BufferAttribute(new Float32Array(n*3),3));
        g.setAttribute('color', new THREE.BufferAttribute(new Float32Array(n*3),3));
        g.setAttribute('size',  new THREE.BufferAttribute(new Float32Array(n),1));
        const pts=new THREE.Points(g, baseMat.clone()); pts.frustumCulled=false; return pts;
      }
      function releasePoints(p){ p.visible=false; pool.push(p); }

      // Palettes (country-tinted feel, multi colored)
      const PALETTES = [
        [0xffd700,0xff9b00,0xff4d00], // gold/orange
        [0x7ff3ff,0x27d8ff,0x1597ff], // cyan/blue
        [0xff4c6a,0xff2a9f,0xff6ec7], // pink
        [0xad8cff,0x7f63ff,0x3f2cff], // violet
        [0x7cff8b,0x2cff6c,0x00d46b], // emerald
      ];

      class Explosion {
        constructor(){
          const x=(Math.random()-0.5)*width/5;
          const y=(Math.random()-0.5)*height/5;
          const z=-30 - Math.random()*40;
          this.center=new THREE.Vector3(x,y,z);
          this.count=(Math.random()*50+(reduced?50:100))|0;

          this.points=getPoints(this.count); this.points.position.copy(this.center);
          const g=this.points.geometry;
          const pos=g.getAttribute('position').array;
          const col=g.getAttribute('color').array;
          const siz=g.getAttribute('size').array;

          const pal=PALETTES[(Math.random()*PALETTES.length)|0];
          const cA=new THREE.Color(pal[0]), cB=new THREE.Color(pal[1]), cC=new THREE.Color(pal[2]);
          this.vel=new Float32Array(this.count*3);
          this.life=reduced?1.2:1.6; this.t=0;

          for(let i=0;i<this.count;i++){
            const dirv=new THREE.Vector3().randomDirection();
            const speed=10+Math.random()*26;
            const ix=i*3;
            this.vel[ix+0]=dirv.x*speed;
            this.vel[ix+1]=dirv.y*speed;
            this.vel[ix+2]=dirv.z*speed;
            pos[ix+0]=dirv.x*1.6; pos[ix+1]=dirv.y*1.6; pos[ix+2]=dirv.z*1.6;

            const t=i/this.count;
            const cc=(t<.5)? cA.clone().lerp(cB,t*2) : cB.clone().lerp(cC,(t-.5)*2);
            col[ix+0]=cc.r; col[ix+1]=cc.g; col[ix+2]=cc.b;
            siz[i]=7+Math.random()*10;
          }
          g.getAttribute('position').needsUpdate=true;
          g.getAttribute('color').needsUpdate=true;
          g.getAttribute('size').needsUpdate=true;
          scene.add(this.points);

          const ringGeo=new THREE.RingGeometry(4.6,6.2,64);
          const m1=new THREE.MeshBasicMaterial({color:0xffd700, transparent:true, opacity:0.8, blending:THREE.AdditiveBlending, side:THREE.DoubleSide});
          const m2=new THREE.MeshBasicMaterial({color:0xffa500, transparent:true, opacity:0.5, blending:THREE.AdditiveBlending, side:THREE.DoubleSide});
          this.ring1=new THREE.Mesh(ringGeo,m1); this.ring2=new THREE.Mesh(ringGeo,m2);
          this.ring1.position.copy(this.center); this.ring2.position.copy(this.center);
          this.r1=4.6; this.r2=4.6; scene.add(this.ring1,this.ring2);
        }
        update(dt){
          this.t+=dt; const f=this.t/this.life;
          const g=this.points.geometry;
          const pos=g.getAttribute('position').array;
          const col=g.getAttribute('color').array;
          const siz=g.getAttribute('size').array;
          const drag=1.0 - Math.min(0.05*dt*60, 0.05);
          for(let i=0;i<this.count;i++){
            const ix=i*3;
            pos[ix+0]+=this.vel[ix+0]*dt;
            pos[ix+1]+=this.vel[ix+1]*dt;
            pos[ix+2]+=this.vel[ix+2]*dt;
            this.vel[ix+0]*=drag; this.vel[ix+1]*=drag; this.vel[ix+2]*=drag;
            siz[i]*=(1-dt*0.1); if(siz[i]<6) siz[i]=6;
            const toGold = Math.max(0, Math.min(1, (f-0.35)/0.5 ));
            col[ix+0]=col[ix+0]*(1-toGold)+1.0*toGold;
            col[ix+1]=col[ix+1]*(1-toGold)+0.72*toGold;
            col[ix+2]=col[ix+2]*(1-toGold)+0.28*toGold;
          }
          g.getAttribute('position').needsUpdate=true;
          g.getAttribute('color').needsUpdate=true;
          g.getAttribute('size').needsUpdate=true;

          this.r1+=90*dt; this.r2+=115*dt;
          this.ring1.scale.setScalar(this.r1/4.6);
          this.ring2.scale.setScalar(this.r2/4.6);
          this.ring1.material.opacity=Math.max(0,0.85 - f*1.2);
          this.ring2.material.opacity=Math.max(0,0.5 - f*1.25);
          this.ring1.lookAt(camera.position); this.ring2.lookAt(camera.position);

          return this.t<this.life;
        }
        dispose(){
          scene.remove(this.points); releasePoints(this.points);
          scene.remove(this.ring1); scene.remove(this.ring2);
        }
      }

      const explosions=[];
      const MAX = reduced? 4: 7;
      const INTERVAL = reduced? 2400: 1500;
      let prev=performance.now(), last=prev;

      function loop(now){
        const dt=Math.min(0.05,(now-prev)/1000); prev=now;
        if(now-last>INTERVAL){
          if(explosions.length>MAX){ const old=explosions.shift(); old.dispose(); }
          explosions.push(new Explosion());
          last=now;
        }
        for(let i=explosions.length-1;i>=0;i--){
          if(!explosions[i].update(dt)){ explosions[i].dispose(); explosions.splice(i,1); }
        }
        camera.lookAt(0,0,0);
        renderer.render(scene,camera);
        requestAnimationFrame(loop);
      }
      requestAnimationFrame(loop);

      function resize(){
        width=innerWidth; height=innerHeight;
        renderer.setPixelRatio(Math.min(devicePixelRatio||1, DPR_LIMIT));
        renderer.setSize(width,height,false);
        camera.aspect=width/height; camera.updateProjectionMatrix();
      }
      addEventListener('resize', resize, {passive:true});
    })();

    // Re-apply filters once the page is ready
    window.addEventListener('load', applyFilters, {once:true});
  </script>
</body>
</html>
