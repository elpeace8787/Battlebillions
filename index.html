<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3ATTLE33ILLIONS — App</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --ink:#f5f5f5; --ink-2:#cecece; --muted:#8a8a8a;
      --accent:#ffd700;
      --panel:rgba(255,255,255,.05);
      --ring:0 0 0 3px rgba(255,255,255,.12);
      --err:#ff6b6b;
      --ok:#3ddc97;
      --bgGlass: rgba(15,15,17,.28);
      --bdGlass: rgba(255,255,255,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:#000;color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}

    /* Background */
    #bg3d{position:fixed; inset:0; width:100%; height:100%; display:block; pointer-events:none; background:radial-gradient(1200px 800px at 30% 20%, #101012 0%, #000 70%); z-index:0;}

    /* App Shell */
    .app-shell{position:relative; z-index:1; min-height:100vh; display:grid; place-items:center; padding:25px;}
    .stack{width:min(92vw,980px); display:grid; gap:18px}
    header{text-align:center}

    /* Title */
    .title-wrap{ perspective:1200px; display:inline-block; user-select:none; }
    .title-3d{ position:relative; display:inline-block; transform-style:preserve-3d; transition:transform .3s ease; }
    header h1{
      --shine: linear-gradient(180deg, #fafafa 0%, #dcdcdc 28%, #a9a9a9 55%, #f3f3f3 82%);
      margin:0; font-size:38px; letter-spacing:.6px; text-transform:uppercase; line-height:1;
      background:linear-gradient(120deg, rgba(255,255,255,.18) 0%, rgba(255,255,255,0) 22% 78%, rgba(255,255,255,.18) 100%),var(--shine);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      filter: drop-shadow(0 8px 22px rgba(0,0,0,.35)) drop-shadow(0 2px 8px rgba(255,215,0,.18));
      position:relative; z-index:2; animation:titleGlow 7.2s ease-in-out infinite;
    }
    header h1::before{content:"3ATTLE33ILLIONS"; position:absolute; inset:0; color:#0e0e10; opacity:.5; z-index:-1; transform: translate3d(0,0,-3px); filter: blur(.6px); text-shadow:0 1px 0 #09090a,0 2px 0 #0b0b0d,0 3px 0 #0d0d10,0 4px 0 #0f0f12;}
    header h1::after{content:"3ATTLE33ILLIONS"; position:absolute; inset:0; z-index:3; background: linear-gradient(90deg, rgba(255,215,0,.0), rgba(255,215,0,.55), rgba(255,215,0,.0)); -webkit-background-clip:text; background-clip:text; color:transparent; mix-blend-mode:screen; opacity:.55; animation: rimSweep 3.6s linear infinite;}
    .title-sheen{ position:absolute; left:-8%; top:-20%; width:120%; height:140%; background: linear-gradient(100deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.22) 50%, rgba(255,255,255,0) 100%); transform: translateZ(8px) skewX(-18deg); pointer-events:none; filter: blur(8px) opacity(.55); animation: sheenSlide 4.8s ease-in-out infinite; }
    @keyframes sheenSlide{ 0%{ transform:translate(-20%, -10%) skewX(-18deg) translateZ(8px); opacity:.25 } 50%{ transform:translate(10%, 0%) skewX(-18deg) translateZ(8px); opacity:.6 } 100%{ transform:translate(-20%, -10%) skewX(-18deg) translateZ(8px); opacity:.25 } }
    @keyframes rimSweep{ 0%{ clip-path: polygon(0 0, 12% 0, 18% 100%, 0 100%);} 50%{ clip-path: polygon(40% 0, 62% 0, 58% 100%, 36% 100%);} 100%{ clip-path: polygon(88% 0, 100% 0, 100% 100%, 82% 100%);} }
    @keyframes titleGlow{ 0%,100%{ filter: drop-shadow(0 8px 22px rgba(0,0,0,.35)) drop-shadow(0 2px 8px rgba(255,215,0,.18)); } 50%{ filter: drop-shadow(0 10px 26px rgba(0,0,0,.45)) drop-shadow(0 2px 12px rgba(255,235,140,.28)); } }

    /* Inputs/Buttons */
    .form{display:grid; gap:12px}
    .btn, input, select{ width:100%; padding:12px 16px; border-radius:14px; border:1px solid var(--bdGlass); background:var(--bgGlass); -webkit-backdrop-filter: blur(6px) saturate(120%); backdrop-filter: blur(6px) saturate(120%); color:var(--ink); transition:transform .16s ease, background .16s ease, border-color .16s ease, box-shadow .16s ease; }
    .btn{cursor:pointer}
    .btn:hover{transform:translateY(-2px)}
    .btn.primary{background:#fff;color:#000;border-color:transparent}
    .btn.primary:hover{background:#ececec}
    .btn.ghost{background:transparent;border-color:#3a3a3a}
    .btn.ghost:hover{border-color:#fff}
    label{font-size:12px;color:var(--ink-2)}
    input:focus, select:focus{outline:0;border-color:#fff;box-shadow:0 0 6px rgba(255,255,255,.25)}
    .pw-wrap{position:relative}
    .pw-toggle{position:absolute; right:10px; top:50%; transform:translateY(-50%); border:0; background:transparent; color:var(--muted); cursor:pointer; font-size:14px;}
    .actions{display:flex; gap:12px; margin-top:4px; flex-wrap:wrap}
    .divider{display:flex;align-items:center;gap:10px;margin:2px 0 6px}
    .divider::before,.divider::after{content:"";flex:1;height:1px;background:rgba(255,255,255,.12)}
    .divider span{font-size:12px;color:var(--muted)}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .status{min-height:18px;font-size:12px;text-align:center;color:var(--muted)}

    /* Global fixed footer */
    .foot{position:fixed;left:0;right:0;bottom:12px;text-align:center;font-size:12px;color:var(--muted)}

    /* Route containers */
    .route-auth{display:block;}
    .route-frame{display:none;}
    .route-active{display:block !important;}
    #view-auth, #view-create { display:none; }
    #view-auth.active, #view-create.active { display:block; }

    /* Iframe system for SPA pages */
    .frame-wrap{ position:fixed; inset:0; z-index:2; overflow:hidden; }
    .route-iframe{ position:absolute; inset:0; width:100%; height:100%; border:0; background:transparent; opacity:0; transition:opacity .18s ease; pointer-events:none; }
    .route-iframe.visible{opacity:1; pointer-events:auto;}
    .app-shell.frame-active #route-auth { display: none !important; }

    /* ===== Create Account (4-step UI) ===== */
    .wrapCA{position:relative; z-index:1; max-width:980px; margin:0 auto; padding:0 16px;}
    .ca-card{ background:var(--panel); border-radius:20px; padding:20px; box-shadow:0 0 24px rgba(255,215,0,.15); }
    .ambient{ position:absolute; inset:0; pointer-events:none; z-index:0; background: radial-gradient(600px 300px at 90% -10%, rgba(255,215,0,.08), transparent 60%), radial-gradient(500px 250px at -10% 100%, rgba(255,255,255,.06), transparent 60%); filter: blur(0.3px); animation: drift 18s ease-in-out infinite alternate; }
    @keyframes drift{ 0%{transform:translateY(0)} 100%{transform:translateY(6px)} }
    .logoCA{ position:relative; z-index:2; color:var(--accent); font-family:'Orbitron',sans-serif; font-weight:700; letter-spacing:.5px; text-align:center; margin-top:8px; }

    .stepper{display:flex; align-items:center; gap:10px; margin-bottom:18px;}
    .dot{ width:12px; height:12px; border-radius:999px; background:#333; }
    .dot.active{background:var(--accent)}
    .bar{flex:1; height:2px; background:#222; border-radius:4px; overflow:hidden}
    .bar>span{display:block; height:100%; width:0; background:var(--accent); transition:width .4s ease}
    .title{font-family:'Orbitron',sans-serif; font-size:20px; color:var(--ink); margin:4px 0 14px}
    .grid{display:grid; gap:12px}
    @media (min-width:700px){ .grid.cols-2{grid-template-columns:1fr 1fr} .grid.cols-3{grid-template-columns:repeat(3,1fr)} }
    .error{font-size:12px; color:var(--err); margin-top:6px; display:none}
    .hint{font-size:11px; color:#9aa3ad}
    .pill-select{ appearance:none; background:#111; border-radius:999px; padding:12px 16px; border:0; color:var(--ink) }
    .pill-col{flex:1 1 110px}
    .chipset{display:flex; flex-wrap:wrap; gap:8px}
    .chip{ padding:8px 12px; border-radius:999px; background:#111; font-size:12px; cursor:pointer; user-select:none }
    .chip.active{ background:var(--accent); color:#000; font-weight:700 }
    .avatar-upload{display:flex; align-items:center; gap:14px}
    .avatar{ width:72px; height:72px; border-radius:999px; background:#111; overflow:hidden; flex:0 0 auto; border:1px solid #222 }
    .avatar img{ width:100%; height:100%; object-fit:cover }
    .btn[disabled]{opacity:.5; pointer-events:none}
    .ca-step{display:none}
    .ca-step.active{display:block}
    .ca-success{ position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; align-items:center; justify-content:center; z-index:20; }
    .ca-success .box{ background:linear-gradient(180deg, rgba(255,215,0,.15), rgba(255,215,0,.05)); border:1px solid rgba(255,215,0,.25); padding:28px 22px; border-radius:18px; text-align:center; max-width:360px; box-shadow:0 0 80px rgba(255,215,0,.35), inset 0 0 60px rgba(255,215,0,.08); animation: pop .3s ease; }
    .ca-success h3{margin:0 0 8px; color:var(--accent)}
    .ca-success p{margin:0; color:var(--ink-2); font-size:13px}
    @keyframes pop{from{transform:scale(.98); opacity:0} to{transform:scale(1); opacity:1}}

    /* --- tiny styles for account-type chips / errors (NEW) --- */
    #accountTypeChips .chip { background:#111; }
    #accountTypeChips .chip.active { background:var(--accent); color:#000; font-weight:700; }
    #companyFields .error, #err-ads-policy { margin-top:6px; }

    /* Card-only disclaimer footer (no fixed positioning) */
    .ca-foot{ text-align:center; margin-top:14px; font-size:12px; color:#9aa3ad }
    .ca-foot a{ color:#cfd6dd; text-decoration:none }
  </style>
</head>
<body>
  <canvas id="bg3d"></canvas>

  <main class="app-shell">
    <!-- ===== AUTH ROUTE (Login + Create) ===== -->
    <div id="route-auth" class="route-auth route-active">
      <div class="stack">
        <header>
          <div class="title-wrap" id="titleWrap">
            <div class="title-3d" id="title3d">
              <h1>3ATTLE33ILLIONS</h1>
              <span class="title-sheen" aria-hidden="true"></span>
            </div>
          </div>
        </header>

        <!-- ===== LOGIN ===== -->
        <section id="view-auth" class="active">
          <form id="authForm" class="form" autocomplete="on">
            <div>
              <label for="email">Email</label>
              <input id="email" type="email" placeholder="you@example.com" required />
            </div>
            <div>
              <label for="password">Password</label>
              <div class="pw-wrap">
                <input id="password" type="password" minlength="6" placeholder="••••••••" required />
                <button type="button" id="togglePw" class="pw-toggle" aria-label="Show password" aria-pressed="false">👁</button>
              </div>
            </div>
            <div class="actions">
              <button id="submitBtn" type="submit" class="btn primary">Sign In</button>
              <button id="modeBtn" type="button" class="btn ghost">Create account</button>
            </div>
          </form>
          <p id="status" class="status" aria-live="polite"></p>
        </section>

        <!-- ===== CREATE ACCOUNT (4-step wizard) ===== -->
        <section id="view-create">
          <div class="wrapCA">
            <div class="ambient" aria-hidden="true"></div>
            <div class="logoCA">BattleBillions</div>

            <div class="ca-card">
              <div class="stepper">
                <div class="dot" data-stepdot="1"></div>
                <div class="bar"><span id="barFill" style="width:0%"></span></div>
                <div class="dot" data-stepdot="2"></div>
                <div class="dot" data-stepdot="3"></div>
                <div class="dot" data-stepdot="4"></div>
              </div>

              <!-- Step 1: Basics -->
              <section class="ca-step" data-step="1">
                <h2 class="title">Account Basics</h2>

                <!-- Account type choice (NEW) -->
                <div class="chipset" id="accountTypeChips" style="margin-bottom:10px">
                  <div class="chip active" data-type="user">I’m a Creator / User</div>
                  <div class="chip" data-type="company">I’m a Company / Brand</div>
                </div>
                <div class="hint" id="acctHint">You can create ad battles later if you’re a company.</div>

                <div class="grid cols-2">
                  <div>
                    <label for="ca-handle">Username / Handle</label>
                    <input id="ca-handle" type="text" placeholder="@yourname" autocomplete="nickname" maxlength="20" required/>
                    <div class="hint">3–20 chars, letters/numbers/underscore</div>
                    <div class="error" id="err-handle">Invalid or taken handle.</div>
                  </div>
                  <div>
                    <label for="ca-invite">Invite Code (optional)</label>
                    <input id="ca-invite" type="text" placeholder="Enter code (if any)"/>
                  </div>
                  <div id="emailRow">
                    <label for="ca-email">Email</label>
                    <input id="ca-email" type="email" placeholder="you@example.com" autocomplete="email" required/>
                    <div class="error" id="err-email">Enter a valid email.</div>
                  </div>
                  <div id="pwRow">
                    <label for="ca-password">Password</label>
                    <input id="ca-password" type="password" placeholder="8+ chars, 1 letter & 1 number" autocomplete="new-password" required/>
                    <div class="hint" id="pw-hint">Strength: —</div>
                    <div class="error" id="err-password">Password too weak.</div>
                  </div>
                  <div id="pw2Row">
                    <label for="ca-password2">Confirm Password</label>
                    <input id="ca-password2" type="password" placeholder="Re-enter password" autocomplete="new-password" required/>
                    <div class="error" id="err-password2">Passwords don’t match.</div>
                  </div>
                </div>

                <!-- Company-only fields (NEW) -->
                <div id="companyFields" style="display:none; margin-top:8px">
                  <div class="grid cols-2">
                    <div>
                      <label for="co-name">Company / Brand Name</label>
                      <input id="co-name" type="text" placeholder="Brand Inc." />
                      <div class="error" id="err-co-name">Please enter your company/brand name.</div>
                    </div>
                    <div>
                      <label for="co-website">Website (optional)</label>
                      <input id="co-website" type="url" placeholder="https://yourbrand.com" />
                    </div>
                    <div>
                      <label for="co-contact-name">Primary Contact Name</label>
                      <input id="co-contact-name" type="text" placeholder="Jane Doe" />
                      <div class="error" id="err-co-contact">Please enter a contact name.</div>
                    </div>
                    <div>
                      <label for="co-contact-email">Primary Contact Email</label>
                      <input id="co-contact-email" type="email" placeholder="ads@yourbrand.com" />
                      <div class="error" id="err-co-contact-email">Enter a valid contact email.</div>
                    </div>
                  </div>
                  <div class="hint">Companies use this to run <b>Ad Battles</b> (sponsored placements).</div>
                </div>

                <div class="actions">
                  <button class="btn ghost" id="ca-cancel-1">Cancel</button>
                  <button class="btn primary" id="ca-next-1">Next</button>
                </div>
                <p id="createStatus1" class="status"></p>
              </section>

              <!-- Step 2: Identity & Region -->
              <section class="ca-step" data-step="2">
                <h2 class="title">Identity & Region</h2>
                <div class="grid cols-3">
                  <div>
                    <label for="ca-country">Country</label>
                    <select id="ca-country" class="pill-select">
                      <option value="">Select country</option>
                      <option>United States</option><option>Canada</option><option>United Kingdom</option><option>Australia</option><option>Other</option>
                    </select>
                  </div>
                  <div>
                    <label for="ca-state">State / Province</label>
                    <input id="ca-state" type="text" placeholder="State / Province"/>
                  </div>
                  <div>
                    <label for="ca-city">City</label>
                    <input id="ca-city" type="text" placeholder="City"/>
                  </div>

                  <div class="pill-col" id="dob-month-wrap">
                    <label for="ca-dob-month">Birth Month</label>
                    <select id="ca-dob-month" class="pill-select"></select>
                  </div>
                  <div class="pill-col" id="dob-day-wrap">
                    <label for="ca-dob-day">Birth Day</label>
                    <select id="ca-dob-day" class="pill-select"></select>
                  </div>
                  <div class="pill-col" id="dob-year-wrap">
                    <label for="ca-dob-year">Birth Year</label>
                    <select id="ca-dob-year" class="pill-select"></select>
                  </div>
                  <div class="hint" id="dob-hint" style="grid-column:1/-1">Select Month • Day • Year</div>
                  <div class="error" id="err-dob" style="grid-column:1/-1">You must be 13+ to join.</div>

                  <div id="zodiac-wrap">
                    <label for="ca-zodiac">Chinese Zodiac</label>
                    <select id="ca-zodiac" class="pill-select">
                      <option value="">Auto (from year)</option>
                      <option>Rat</option><option>Ox</option><option>Tiger</option><option>Rabbit</option>
                      <option>Dragon</option><option>Snake</option><option>Horse</option><option>Goat</option>
                      <option>Monkey</option><option>Rooster</option><option>Dog</option><option>Pig</option>
                    </select>
                    <div class="hint">Auto-fills from the selected year. You can override if you want.</div>
                  </div>

                  <div>
                    <label for="ca-lang">Languages</label>
                    <select id="ca-lang" multiple>
                      <option>English</option><option>Spanish</option><option>French</option><option>Arabic</option><option>Hindi</option><option>Chinese</option><option>Other</option>
                    </select>
                    <div class="hint">Hold Ctrl/Cmd to select multiple</div>
                  </div>
                  <div>
                    <label for="ca-ethnicity">Ethnicity (optional)</label>
                    <select id="ca-ethnicity" class="pill-select">
                      <option value="">Prefer not to say</option>
                      <option>African / African American</option><option>Asian</option><option>Hispanic / Latino</option><option>Middle Eastern / North African</option>
                      <option>Native / Indigenous</option><option>Pacific Islander</option><option>White</option><option>Other / Mixed</option>
                    </select>
                  </div>
                  <div>
                    <label for="ca-timezone">Timezone</label>
                    <select id="ca-timezone" class="pill-select">
                      <option value="">Auto-detect</option>
                      <option>America/New_York</option><option>America/Chicago</option><option>America/Denver</option><option>America/Los_Angeles</option><option>UTC</option>
                    </select>
                  </div>
                </div>

                <div class="actions">
                  <button class="btn ghost" id="ca-back-2">Back</button>
                  <button class="btn primary" id="ca-next-2">Next</button>
                </div>
                <p id="createStatus2" class="status"></p>
              </section>

              <!-- Step 3: Education & Community -->
              <section class="ca-step" data-step="3">
                <h2 class="title">Education & Community</h2>
                <div class="grid cols-2">
                  <div>
                    <label for="ca-hs">High School</label>
                    <input id="ca-hs" type="text" placeholder="Type your high school"/>
                  </div>
                  <div>
                    <label for="ca-college">College / University</label>
                    <input id="ca-college" type="text" placeholder="Type your college"/>
                  </div>
                  <div>
                    <label for="ca-role">Role (optional)</label>
                    <select id="ca-role" class="pill-select">
                      <option value="">Select role</option>
                      <option>Student</option><option>Creator</option><option>Athlete</option><option>Musician</option><option>Entrepreneur</option><option>Other</option>
                    </select>
                  </div>
                </div>
                <div class="actions">
                  <button class="btn ghost" id="ca-back-3">Back</button>
                  <button class="btn primary" id="ca-next-3">Next</button>
                </div>
                <p id="createStatus3" class="status"></p>
              </section>

              <!-- Step 4: Battle Setup -->
              <section class="ca-step" data-step="4">
                <h2 class="title">Battle Setup</h2>
                <div class="grid">
                  <div class="avatar-upload">
                    <div class="avatar" id="avatarPreview"><img id="avatarImg" alt="" style="display:none"/></div>
                    <div>
                      <label for="ca-avatar">Profile Photo</label>
                      <input id="ca-avatar" type="file" accept="image/*" class="file-btn"/>
                      <div class="hint">Square images look best</div>
                    </div>
                  </div>

                  <div>
                    <label>Preferred Categories</label>
                    <div class="chipset" id="catChips">
                      <div class="chip">Rap</div><div class="chip">Dance</div><div class="chip">Gaming</div>
                      <div class="chip">Art</div><div class="chip">Sports</div><div class="chip">Comedy</div>
                    </div>
                  </div>

                  <div>
                    <label><input type="checkbox" id="ca-terms"/> I agree to the Terms</label>
                    <div class="hint">You must accept Terms & Privacy to continue</div>
                  </div>
                  <div>
                    <label><input type="checkbox" id="ca-privacy"/> I agree to the Privacy Policy</label>
                  </div>

                  <!-- Ads policy consent (company only) (NEW) -->
                  <div id="adsPolicyRow" style="display:none">
                    <label><input type="checkbox" id="ads-policy" /> I agree to the Ads Policy</label>
                    <div class="hint">Required for companies to run sponsored Ad Battles.</div>
                    <div class="error" id="err-ads-policy" style="display:none">Please agree to the Ads Policy.</div>
                  </div>
                </div>

                <div class="actions">
                  <button class="btn ghost" id="ca-back-4">Back</button>
                  <button class="btn primary" id="ca-submit">Create Account</button>
                </div>
                <p id="createStatus4" class="status"></p>
              </section>

              <div class="ca-foot">
                By creating an account you agree to our
                <a href="#">Terms</a> & <a href="#">Privacy</a>.
              </div>
            </div>
          </div>

          <div class="ca-success" id="success">
            <div class="box">
              <h3>Account Created</h3>
              <p>Welcome to BattleBillions — redirecting to your home...</p>
            </div>
          </div>
        </section>

        <footer class="foot">© <span id="year"></span> BattleBillions</footer>
      </div>
    </div>

    <!-- ===== FRAME ROUTE (SPA pages) ===== -->
    <div id="route-frame" class="route-frame">
      <div class="frame-wrap">
        <iframe id="frameA" class="route-iframe visible"  title="BattleBillions View A" allow="autoplay; clipboard-read; clipboard-write"></iframe>
        <iframe id="frameB" class="route-iframe"          title="BattleBillions View B" allow="autoplay; clipboard-read; clipboard-write"></iframe>
      </div>
    </div>
  </main>

  <!-- ===== ROUTER & UI (no social logins here) ===== -->
  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    // Show/Hide password (login)
    (function(){
      const pw = document.getElementById("password");
      const btn = document.getElementById("togglePw");
      btn.addEventListener("click", (e)=>{
        e.preventDefault();
        const to = pw.type === "password" ? "text" : "password";
        pw.type = to;
        btn.setAttribute("aria-label", to==="password" ? "Show password" : "Hide password");
        btn.setAttribute("aria-pressed", to==="text" ? "true" : "false");
      });
    })();

    // Title parallax
    (function(){
      const wrap = document.getElementById("titleWrap");
      const el   = document.getElementById("title3d");
      if(!wrap || !el) return;
      let rect = null;
      const updateRect = ()=>{ rect = wrap.getBoundingClientRect(); };
      updateRect(); addEventListener("resize", updateRect, {passive:true});
      wrap.addEventListener("mousemove", (ev)=>{
        if(!rect) return;
        const x = (ev.clientX - rect.left)/rect.width - 0.5;
        const y = (ev.clientY - rect.top )/rect.height - 0.5;
        el.style.transform = `rotateY(${x*10}deg) rotateX(${-y*8}deg) translateZ(0)`;
      });
      wrap.addEventListener("mouseleave", ()=>{ el.style.transform = "rotateY(0deg) rotateX(0deg)"; });
    })();

    /* ===== Hash Router ===== */
    const routes = {
      "/auth/login":  { type:"auth", sub:"login" },
      "/auth/create": { type:"auth", sub:"create" },
      "/home":        { type:"frame", src:"home.html" },
      "/discover":    { type:"frame", src:"discover.html" },
      "/opponent":    { type:"frame", src:"opponent.html" },
      "/battle":      { type:"frame", src:"live.html" },
      "/leaderboard": { type:"frame", src:"leaderboard.html" },
      "/profile":     { type:"frame", src:"profile.html" }
    };

    const authContainer = document.getElementById("route-auth");
    const loginView     = document.getElementById("view-auth");
    const createView    = document.getElementById("view-create");
    const frameView     = document.getElementById("route-frame");
    const appShell      = document.querySelector(".app-shell");
    const statusEl      = document.getElementById("status");

    // Iframes (double buffer to avoid flash)
    const frameA = document.getElementById("frameA");
    const frameB = document.getElementById("frameB");
    let visible = frameA, hidden = frameB;

    function showAuth(sub){
      appShell.classList.remove("frame-active");
      frameView.classList.remove("route-active");
      authContainer.classList.add("route-active");
      loginView.classList.toggle("active", sub==="login");
      createView.classList.toggle("active", sub==="create");
      if(sub==="create"){ initCreateWizardUI(); }
    }
    function showFrame(src){
      appShell.classList.add("frame-active");
      authContainer.classList.remove("route-active");
      frameView.classList.add("route-active");

      // Always resolve to absolute for both compare and assignment
      const abs = new URL(src, location.href).href;
      if (visible.src === abs) return;

      hidden.removeAttribute("src");
      hidden.classList.remove("visible");
      hidden.addEventListener("load", ()=>{
        visible.classList.remove("visible");
        hidden.classList.add("visible");
        [visible,hidden] = [hidden,visible];
        hidden.removeAttribute("src");
        hidden.classList.remove("visible");
      }, {once:true});
      hidden.src = abs;
    }
    function parseHash(){
      const raw  = location.hash || "#/auth/login";
      const [path, query] = raw.slice(1).split("?");
      const parts = path.split("/").filter(Boolean);
      if (parts[0]==="auth" && (parts[1]==="login" || parts[1]==="create")){
        return { base:`/auth/${parts[1]}`, query:new URLSearchParams(query||"") };
      }
      const base = `/${parts[0]||"auth"}`;
      if (base==="/auth") return { base:"/auth/login", query:new URLSearchParams(query||"") };
      return { base, query:new URLSearchParams(query||"") };
    }
    function navigate(){
      const { base } = parseHash();
      const route = routes[base] || routes["/auth/login"];
      if (route.type==="auth"){ showAuth(route.sub); return; }
      if (route.type==="frame"){ showFrame(route.src); return; }
      showAuth("login");
    }
    window.addEventListener("hashchange", navigate);
    if(!location.hash) location.hash="/auth/login";
    navigate();

    document.getElementById("modeBtn").addEventListener("click",()=>{ location.hash="/auth/create"; });
  </script>

  <!-- ===== Advanced Three.js Background (GPU + Bloom, with fallbacks) ===== -->
  <script type="module">
  import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
  import { GPUComputationRenderer } from 'https://unpkg.com/three@0.160.0/examples/jsm/misc/GPUComputationRenderer.js';
  import { EffectComposer } from 'https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/EffectComposer.js';
  import { RenderPass } from 'https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/RenderPass.js';
  import { UnrealBloomPass } from 'https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/UnrealBloomPass.js';

  (function(){
    const reduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const canvas = document.getElementById('bg3d');

    // Quick capability gate (keeps login UI snappy on low devices)
    const gl = canvas.getContext('webgl2', { alpha:true, antialias:false, powerPreference:'high-performance' });
    if (!gl || reduced) {
      // Minimal starfield fallback (static twinkle) to honor reduced motion or missing WebGL2
      const ctx = canvas.getContext('2d');
      function resize2d(){ canvas.width = innerWidth; canvas.height = innerHeight; draw(); }
      function draw(){
        const w=canvas.width,h=canvas.height;
        const grd = ctx.createRadialGradient(w*0.3,h*0.2,0,w*0.3,h*0.2,Math.max(w,h)*0.8);
        grd.addColorStop(0,'#101012'); grd.addColorStop(1,'#000');
        ctx.fillStyle = grd; ctx.fillRect(0,0,w,h);
        const n = Math.min(800, Math.floor(w*h/3000));
        for(let i=0;i<n;i++){
          const x=Math.random()*w, y=Math.random()*h, r=Math.random()*1.4+0.2, a=Math.random()*0.6+0.2;
          ctx.fillStyle = `rgba(255,240,200,${a})`;
          ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
        }
      }
      addEventListener('resize', resize2d, {passive:true}); resize2d();
      return;
    }

    // ========= THREE Setup =========
    const renderer = new THREE.WebGLRenderer({ canvas, context: gl, alpha:true, antialias:false, preserveDrawingBuffer:false });
    const DPR_LIMIT = 1.75;
    renderer.setPixelRatio(Math.min(window.devicePixelRatio||1, DPR_LIMIT));
    renderer.setSize(innerWidth, innerHeight, false);
    renderer.setClearColor(0x000000, 0);

    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x000000, 0.0011);

    const camera = new THREE.PerspectiveCamera(55, innerWidth/innerHeight, 0.1, 4000);
    const baseCam = new THREE.Vector3(0,0,140);
    camera.position.copy(baseCam);

    // Lighting to give the rings a warm gold tone
    const hemi = new THREE.HemisphereLight(0x999999, 0x080808, 0.7);
    const dir  = new THREE.DirectionalLight(0xffe7a4, 0.9); dir.position.set(80, 120, 160);
    scene.add(hemi, dir);

    // ========= Post FX (Bloom) =========
    const composer = new EffectComposer(renderer);
    const renderPass = new RenderPass(scene, camera);
    composer.addPass(renderPass);
    const bloom = new UnrealBloomPass(new THREE.Vector2(innerWidth, innerHeight), 0.9, 0.8, 0.85);
    composer.addPass(bloom);

    // ========= GPU Compute (positions + velocities) =========
    const SIZE = 256; // 256x256 = 65,536 particles (scales well on mobiles)
    const gpu = new GPUComputationRenderer(SIZE, SIZE, renderer);
    const dtPos = gpu.createTexture();
    const dtVel = gpu.createTexture();

    // Seed textures
    (function seed(){
      const p = dtPos.image.data;
      const v = dtVel.image.data;
      for (let i=0; i<p.length; i+=4){
        // Spiral-ish seed near origin
        const r = Math.random()*6 + Math.random()*8;
        const a = Math.random()*Math.PI*2;
        const h = (Math.random()-0.5)*4.0;
        p[i+0] = Math.cos(a)*r;
        p[i+1] = h;
        p[i+2] = Math.sin(a)*r;
        p[i+3] = 1;

        // Tangential initial velocity
        const speed = 0.6 + Math.random()*0.8;
        v[i+0] = -Math.sin(a)*speed * 0.6;
        v[i+1] = (Math.random()-0.5)*0.2;
        v[i+2] =  Math.cos(a)*speed;
        v[i+3] = 1;
      }
    })();

    const posVar = gpu.addVariable('texturePosition', `
      uniform float uTime;
      uniform float uAttractorStrength;
      uniform sampler2D textureVelocity;
      vec2 uvCell = gl_FragCoord.xy / resolution.xy;

      void main(){
        vec4 pos = texture2D(texturePosition, uvCell);
        vec4 vel = texture2D(textureVelocity, uvCell);

        // Integrate
        pos.xyz += vel.xyz;

        // Soft boundary to keep swarm in view (spherical)
        float R = 120.0;
        float d = length(pos.xyz);
        if (d > R){
          pos.xyz *= 0.98; // gentle pull-back
        }

        gl_FragColor = pos;
      }
    `, dtPos);

    const velVar = gpu.addVariable('textureVelocity', `
      uniform float uTime;
      uniform float uAttractorStrength;
      uniform vec3  uAttractor;
      uniform float uCurlScale;

      // Simple curl noise based on 3D noise derivative (cheap-ish)
      // Hash/Noise helpers
      float hash(vec3 p){ return fract(sin(dot(p, vec3(127.1,311.7, 74.7)))*43758.5453); }
      float noise(vec3 x){
        vec3 p = floor(x), f = fract(x);
        f = f*f*(3.0-2.0*f);
        float n = p.x + p.y*57.0 + 113.0*p.z;
        float res = mix(
          mix(mix(hash(vec3(n+0.0, n+1.0, n+2.0)), hash(vec3(n+1.0, n+2.0, n+3.0)), f.x),
              mix(hash(vec3(n+57.0, n+58.0, n+59.0)), hash(vec3(n+58.0, n+59.0, n+60.0)), f.x), f.y),
          mix(mix(hash(vec3(n+113.0, n+114.0, n+115.0)), hash(vec3(n+114.0, n+115.0, n+116.0)), f.x),
              mix(hash(vec3(n+170.0, n+171.0, n+172.0)), hash(vec3(n+171.0, n+172.0, n+173.0)), f.x), f.y),
          f.z);
        return res;
      }
      vec3 curl(vec3 p){
        float e = 0.1;
        vec3 dx = vec3(e,0.0,0.0), dy = vec3(0.0,e,0.0), dz = vec3(0.0,0.0,e);
        float p_yz1 = noise(p + dy) - noise(p - dy);
        float p_zz1 = noise(p + dz) - noise(p - dz);
        float p_xz1 = noise(p + dx) - noise(p - dx);
        return normalize(vec3(p_yz1 - p_zz1, p_zz1 - p_xz1, p_xz1 - p_yz1) + 1e-6);
      }

      void main(){
        vec2 uvCell = gl_FragCoord.xy / resolution.xy;
        vec4 pos = texture2D(texturePosition, uvCell);
        vec4 vel = texture2D(textureVelocity, uvCell);

        // Core golden reactor attractor + curl flow
        vec3 toCore = normalize(uAttractor - pos.xyz);
        vec3 flow   = curl(pos.xyz * 0.035 + vec3(uTime*0.03)) * uCurlScale;

        vec3 acc = toCore * uAttractorStrength + flow;

        // Gentle angular momentum (swirl)
        acc += cross(toCore, vec3(0.0, 0.8, 0.0)) * 0.12;

        vel.xyz = mix(vel.xyz * 0.985, vel.xyz + acc * 0.06, 0.9);

        // Cap velocity slightly for stability
        float m = length(vel.xyz);
        if (m > 2.0) vel.xyz = normalize(vel.xyz) * 2.0;

        gl_FragColor = vel;
      }
    `, dtVel);

    gpu.setVariableDependencies(posVar, [posVar, velVar]);
    gpu.setVariableDependencies(velVar, [posVar, velVar]);

    posVar.material.uniforms = {
      uTime: { value: 0 },
      uAttractorStrength: { value: 0.06 },
      textureVelocity: { value: null }
    };
    velVar.material.uniforms = {
      uTime: { value: 0 },
      uAttractorStrength: { value: 0.06 },
      uAttractor: { value: new THREE.Vector3(0,0,0) },
      uCurlScale: { value: 1.2 }
    };

    const initOk = gpu.init();
    if (initOk !== null) {
      console.warn('GPUComputation init error:', initOk);
      // If something fails, bail to simple fallback
      renderer.getContext().finish();
      return;
    }

    // ========= Particle Render Material =========
    const particleGeo = new THREE.BufferGeometry();
    const num = SIZE*SIZE;
    const ref = new Float32Array(num*2);
    let p = 0;
    for(let y=0; y<SIZE; y++){
      for(let x=0; x<SIZE; x++){
        ref[p++] = x/(SIZE-1);
        ref[p++] = y/(SIZE-1);
      }
    }
    particleGeo.setAttribute('ref', new THREE.BufferAttribute(ref, 2));
    // Screen-space size attenuation via shader; no per-vertex size attr needed.

    const particleMat = new THREE.ShaderMaterial({
      transparent: true,
      depthWrite: false,
      blending: THREE.AdditiveBlending,
      uniforms: {
        uTime: { value: 0 },
        uPos:  { value: null },
        uVel:  { value: null },
        uColorA: { value: new THREE.Color('#fff4cc') },
        uColorB: { value: new THREE.Color('#ffd700') },
        uColorC: { value: new THREE.Color('#ffb84d') },
        uSize:   { value: 16.0 },
        uCam:    { value: new THREE.Vector3().copy(baseCam) }
      },
      vertexShader: `
        precision highp float;
        uniform sampler2D uPos;
        uniform sampler2D uVel;
        uniform float uTime;
        uniform float uSize;
        attribute vec2 ref;
        varying float vHot;
        varying vec3  vColMix;

        void main(){
          vec3 pos = texture2D(uPos, ref).xyz;
          vec3 vel = texture2D(uVel, ref).xyz;

          // Hotness from speed (trails feel)
          float speed = clamp(length(vel)*0.5, 0.0, 1.0);
          vHot = speed;

          // Slight pulsation
          float pulse = 0.5 + 0.5*sin(uTime*2.0 + ref.x*20.0 + ref.y*10.0);

          vec4 mv = modelViewMatrix * vec4(pos,1.0);
          gl_Position = projectionMatrix * mv;

          // Size attenuates with perspective
          gl_PointSize = uSize * (1.0 + speed*0.6 + pulse*0.2) * (300.0 / -mv.z);
          vColMix = normalize(vel*0.5 + vec3(0.5));
        }
      `,
      fragmentShader: `
        precision highp float;
        varying float vHot;
        varying vec3  vColMix;
        uniform vec3  uColorA;
        uniform vec3  uColorB;
        uniform vec3  uColorC;

        void main(){
          // Smooth circular sprite
          vec2 uv = gl_PointCoord*2.0 - 1.0;
          float r = dot(uv, uv);
          float alpha = smoothstep(1.0, 0.2, r);

          // Gold gradient based on heat + velocity direction
          vec3 col = mix(uColorA, uColorB, vHot);
          col = mix(col, uColorC, clamp(vColMix.y*0.6+0.5, 0.0, 1.0));

          gl_FragColor = vec4(col, alpha * (0.6 + vHot*0.4));
        }
      `
    });

    const particles = new THREE.Points(particleGeo, particleMat);
    particles.frustumCulled = false;
    scene.add(particles);

    // ========= Golden Shockwave Rings =========
    function makeShockwave(){
      const geo = new THREE.RingGeometry(4.5, 5.8, 96, 1);
      const mat = new THREE.ShaderMaterial({
        transparent:true, depthWrite:false, blending:THREE.AdditiveBlending,
        uniforms: {
          uTime: { value: 0 },
          uHue:  { value: 0.12 }, // gold-ish
          uOpacity: { value: 0.9 }
        },
        vertexShader: `
          varying vec2 vUv;
          void main(){
            vUv = uv;
            vec4 mv = modelViewMatrix * vec4(position,1.0);
            gl_Position = projectionMatrix * mv;
          }
        `,
        fragmentShader: `
          varying vec2 vUv;
          uniform float uHue;
          uniform float uOpacity;
          // simple H to RGB
          vec3 h2rgb(float h){
            vec3 rgb = clamp(abs(mod(h*6.0+vec3(0.0,4.0,2.0), 6.0) - 3.0) - 1.0, 0.0, 1.0);
            return rgb;
          }
          void main(){
            float rim = smoothstep(0.0, 0.15, 1.0 - abs(vUv.y - 0.5)*2.0);
            vec3 gold = mix(vec3(1.0), h2rgb(uHue), 0.7);
            gl_FragColor = vec4(gold, rim * uOpacity);
          }
        `
      });
      const mesh = new THREE.Mesh(geo, mat);
      mesh.scale.setScalar(1);
      mesh.position.set(0,0,0);
      mesh.userData.t = 0;
      return mesh;
    }

    const waves = [];
    let lastWave = performance.now();
    const WAVE_INTERVAL = 1000; // ms

    // ========= Ambient Backdrop (soft points) =========
    const ambientCount = 900;
    const ambientGeo = new THREE.BufferGeometry();
    const ambientPos = new Float32Array(ambientCount*3);
    const ambientCol = new Float32Array(ambientCount*3);
    for(let i=0;i<ambientCount;i++){
      ambientPos[i*3+0] = (Math.random()-0.5)*480;
      ambientPos[i*3+1] = (Math.random()-0.5)*300;
      ambientPos[i*3+2] = Math.random()*260 - 200;
      const t = Math.random()*0.4 + 0.35;
      ambientCol[i*3+0] = t; ambientCol[i*3+1] = t*0.9; ambientCol[i*3+2] = t*0.85;
    }
    ambientGeo.setAttribute('position', new THREE.BufferAttribute(ambientPos,3));
    ambientGeo.setAttribute('color', new THREE.BufferAttribute(ambientCol,3));
    const ambientMat = new THREE.PointsMaterial({
      size: 2.8, transparent:true, depthWrite:false, vertexColors:true, blending:THREE.AdditiveBlending
    });
    const ambientPts = new THREE.Points(ambientGeo, ambientMat);
    ambientPts.frustumCulled = false;
    scene.add(ambientPts);

    // ========= Resize =========
    function resize(){
      renderer.setPixelRatio(Math.min(devicePixelRatio||1, DPR_LIMIT));
      renderer.setSize(innerWidth, innerHeight, false);
      camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix();
      composer.setSize(innerWidth, innerHeight);
      bloom.setSize(innerWidth, innerHeight);
    }
    addEventListener('resize', resize, {passive:true});

    // ========= Loop =========
    let prev = performance.now();
    function loop(now){
      const dt = Math.min(0.05, (now - prev)/1000); prev = now;
      const t  = now * 0.001;

      // Spawn shockwave
      if (now - lastWave > WAVE_INTERVAL){
        const wave = makeShockwave();
        scene.add(wave);
        waves.push(wave);
        lastWave = now;
      }

      // Update GPU fields
      posVar.material.uniforms.uTime.value = t;
      velVar.material.uniforms.uTime.value = t;
      gpu.compute();

      // Bind compute textures to particle material
      particles.material.uniforms.uTime.value = t;
      particles.material.uniforms.uPos.value  = gpu.getCurrentRenderTarget(posVar).texture;
      particles.material.uniforms.uVel.value  = gpu.getCurrentRenderTarget(velVar).texture;

      // Gentle camera float + micro shake synced to waves
      camera.position.copy(baseCam);
      camera.position.x += Math.sin(t*0.25)*1.2;
      camera.position.y += Math.sin(t*0.33)*0.8;

      // Animate ambient twinkle
      const aPos = ambientGeo.getAttribute('position');
      for(let i=0;i<ambientCount;i++){
        const iy = i*3+1;
        aPos.array[iy] += Math.sin(t*0.7 + i*0.13)*0.003; // tiny oscillation
      }
      aPos.needsUpdate = true;

      // Animate shockwaves
      for (let i=waves.length-1;i>=0;i--){
        const w = waves[i];
        w.userData.t += dt;
        const f = w.userData.t;
        const s = 1 + f*120; // expand
        w.scale.setScalar(s);
        w.material.uniforms.uOpacity.value = Math.max(0, 0.9 - f*1.2);
        w.lookAt(camera.position);
        if (f > 1.0){
          scene.remove(w); waves.splice(i,1);
        }
      }

      composer.render();
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);
  })();
  </script>
</body>
</html>
