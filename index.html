<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3ATTLE33ILLIONS — App</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --ink:#f5f5f5; --ink-2:#cecece; --muted:#8a8a8a;
      --accent:#ffd700;
      --panel:rgba(255,255,255,.05);
      --ring:0 0 0 3px rgba(255,255,255,.12);
      --err:#ff6b6b;
      --ok:#3ddc97;
      --bgGlass: rgba(15,15,17,.28);
      --bdGlass: rgba(255,255,255,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:#000;color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}

    /* Background */
    #bg3d{position:fixed; inset:0; width:100%; height:100%; display:block; pointer-events:none; background:radial-gradient(1200px 800px at 30% 20%, #101012 0%, #000 70%); z-index:0;}

    /* App Shell */
    .app-shell{position:relative; z-index:1; min-height:100vh; display:grid; place-items:center; padding:25px;}
    .stack{width:min(92vw,980px); display:grid; gap:18px}
    header{text-align:center}

    /* Title */
    .title-wrap{ perspective:1200px; display:inline-block; user-select:none; }
    .title-3d{ position:relative; display:inline-block; transform-style:preserve-3d; transition:transform .3s ease; }
    header h1{
      --shine: linear-gradient(180deg, #fafafa 0%, #dcdcdc 28%, #a9a9a9 55%, #f3f3f3 82%);
      margin:0; font-size:38px; letter-spacing:.6px; text-transform:uppercase; line-height:1;
      background:linear-gradient(120deg, rgba(255,255,255,.18) 0%, rgba(255,255,255,0) 22% 78%, rgba(255,255,255,.18) 100%),var(--shine);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      filter: drop-shadow(0 8px 22px rgba(0,0,0,.35)) drop-shadow(0 2px 8px rgba(255,215,0,.18));
      position:relative; z-index:2; animation:titleGlow 7.2s ease-in-out infinite;
    }
    header h1::before{content:"3ATTLE33ILLIONS"; position:absolute; inset:0; color:#0e0e10; opacity:.5; z-index:-1; transform: translate3d(0,0,-3px); filter: blur(.6px); text-shadow:0 1px 0 #09090a,0 2px 0 #0b0b0d,0 3px 0 #0d0d10,0 4px 0 #0f0f12;}
    header h1::after{content:"3ATTLE33ILLIONS"; position:absolute; inset:0; z-index:3; background: linear-gradient(90deg, rgba(255,215,0,.0), rgba(255,215,0,.55), rgba(255,215,0,.0)); -webkit-background-clip:text; background-clip:text; color:transparent; mix-blend-mode:screen; opacity:.55; animation: rimSweep 3.6s linear infinite;}
    .title-sheen{ position:absolute; left:-8%; top:-20%; width:120%; height:140%; background: linear-gradient(100deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.22) 50%, rgba(255,255,255,0) 100%); transform: translateZ(8px) skewX(-18deg); pointer-events:none; filter: blur(8px) opacity(.55); animation: sheenSlide 4.8s ease-in-out infinite; }
    @keyframes sheenSlide{ 0%{ transform:translate(-20%, -10%) skewX(-18deg) translateZ(8px); opacity:.25 } 50%{ transform:translate(10%, 0%) skewX(-18deg) translateZ(8px); opacity:.6 } 100%{ transform:translate(-20%, -10%) skewX(-18deg) translateZ(8px); opacity:.25 } }
    @keyframes rimSweep{ 0%{ clip-path: polygon(0 0, 12% 0, 18% 100%, 0 100%);} 50%{ clip-path: polygon(40% 0, 62% 0, 58% 100%, 36% 100%);} 100%{ clip-path: polygon(88% 0, 100% 0, 100% 100%, 82% 100%);} }
    @keyframes titleGlow{ 0%,100%{ filter: drop-shadow(0 8px 22px rgba(0,0,0,.35)) drop-shadow(0 2px 8px rgba(255,215,0,.18)); } 50%{ filter: drop-shadow(0 10px 26px rgba(0,0,0,.45)) drop-shadow(0 2px 12px rgba(255,235,140,.28)); } }

    /* Inputs/Buttons */
    .form{display:grid; gap:12px}
    .btn, input, select{ width:100%; padding:12px 16px; border-radius:14px; border:1px solid var(--bdGlass); background:var(--bgGlass); -webkit-backdrop-filter: blur(6px) saturate(120%); backdrop-filter: blur(6px) saturate(120%); color:var(--ink); transition:transform .16s ease, background .16s ease, border-color .16s ease, box-shadow .16s ease; }
    .btn{cursor:pointer}
    .btn:hover{transform:translateY(-2px)}
    .btn.primary{background:#fff;color:#000;border-color:transparent}
    .btn.primary:hover{background:#ececec}
    .btn.ghost{background:transparent;border-color:#3a3a3a}
    .btn.ghost:hover{border-color:#fff}
    label{font-size:12px;color:var(--ink-2)}
    input:focus, select:focus{outline:0;border-color:#fff;box-shadow:0 0 6px rgba(255,255,255,.25)}
    .pw-wrap{position:relative}
    .pw-toggle{position:absolute; right:10px; top:50%; transform:translateY(-50%); border:0; background:transparent; color:var(--muted); cursor:pointer; font-size:14px;}
    .actions{display:flex; gap:12px; margin-top:4px; flex-wrap:wrap}
    .divider{display:flex;align-items:center;gap:10px;margin:2px 0 6px}
    .divider::before,.divider::after{content:"";flex:1;height:1px;background:rgba(255,255,255,.12)}
    .divider span{font-size:12px;color:var(--muted)}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .status{min-height:18px;font-size:12px;text-align:center;color:var(--muted)}

    /* Global fixed footer */
    .foot{position:fixed;left:0;right:0;bottom:12px;text-align:center;font-size:12px;color:var(--muted)}

    /* Route containers */
    .route-auth{display:block;}
    .route-frame{display:none;}
    .route-active{display:block !important;}
    #view-auth, #view-create { display:none; }
    #view-auth.active, #view-create.active { display:block; }

    /* Iframe system for SPA pages */
    .frame-wrap{ position:fixed; inset:0; z-index:2; overflow:hidden; }
    .route-iframe{ position:absolute; inset:0; width:100%; height:100%; border:0; background:transparent; opacity:0; transition:opacity .18s ease; pointer-events:none; }
    .route-iframe.visible{opacity:1; pointer-events:auto;}
    .app-shell.frame-active #route-auth { display: none !important; }

    /* ===== Create Account (4-step UI) ===== */
    .wrapCA{position:relative; z-index:1; max-width:980px; margin:0 auto; padding:0 16px;}
    .ca-card{ background:var(--panel); border-radius:20px; padding:20px; box-shadow:0 0 24px rgba(255,215,0,.15); }
    .ambient{ position:absolute; inset:0; pointer-events:none; z-index:0; background: radial-gradient(600px 300px at 90% -10%, rgba(255,215,0,.08), transparent 60%), radial-gradient(500px 250px at -10% 100%, rgba(255,255,255,.06), transparent 60%); filter: blur(0.3px); animation: drift 18s ease-in-out infinite alternate; }
    @keyframes drift{ 0%{transform:translateY(0)} 100%{transform:translateY(6px)} }
    .logoCA{ position:relative; z-index:2; color:var(--accent); font-family:'Orbitron',sans-serif; font-weight:700; letter-spacing:.5px; text-align:center; margin-top:8px; }

    .stepper{display:flex; align-items:center; gap:10px; margin-bottom:18px;}
    .dot{ width:12px; height:12px; border-radius:999px; background:#333; }
    .dot.active{background:var(--accent)}
    .bar{flex:1; height:2px; background:#222; border-radius:4px; overflow:hidden}
    .bar>span{display:block; height:100%; width:0; background:var(--accent); transition:width .4s ease}
    .title{font-family:'Orbitron',sans-serif; font-size:20px; color:var(--ink); margin:4px 0 14px}
    .grid{display:grid; gap:12px}
    @media (min-width:700px){ .grid.cols-2{grid-template-columns:1fr 1fr} .grid.cols-3{grid-template-columns:repeat(3,1fr)} }
    .error{font-size:12px; color:var(--err); margin-top:6px; display:none}
    .hint{font-size:11px; color:#9aa3ad}
    .pill-select{ appearance:none; background:#111; border-radius:999px; padding:12px 16px; border:0; color:var(--ink) }
    .pill-col{flex:1 1 110px}
    .chipset{display:flex; flex-wrap:wrap; gap:8px}
    .chip{ padding:8px 12px; border-radius:999px; background:#111; font-size:12px; cursor:pointer; user-select:none }
    .chip.active{ background:var(--accent); color:#000; font-weight:700 }
    .avatar-upload{display:flex; align-items:center; gap:14px}
    .avatar{ width:72px; height:72px; border-radius:999px; background:#111; overflow:hidden; flex:0 0 auto; border:1px solid #222 }
    .avatar img{ width:100%; height:100%; object-fit:cover }
    .btn[disabled]{opacity:.5; pointer-events:none}
    .ca-step{display:none}
    .ca-step.active{display:block}
    .ca-success{ position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; align-items:center; justify-content:center; z-index:20; }
    .ca-success .box{ background:linear-gradient(180deg, rgba(255,215,0,.15), rgba(255,215,0,.05)); border:1px solid rgba(255,215,0,.25); padding:28px 22px; border-radius:18px; text-align:center; max-width:360px; box-shadow:0 0 80px rgba(255,215,0,.35), inset 0 0 60px rgba(255,215,0,.08); animation: pop .3s ease; }
    .ca-success h3{margin:0 0 8px; color:var(--accent)}
    .ca-success p{margin:0; color:var(--ink-2); font-size:13px}
    @keyframes pop{from{transform:scale(.98); opacity:0} to{transform:scale(1); opacity:1}}

    /* --- tiny styles for account-type chips / errors (NEW) --- */
    #accountTypeChips .chip { background:#111; }
    #accountTypeChips .chip.active { background:var(--accent); color:#000; font-weight:700; }
    #companyFields .error, #err-ads-policy { margin-top:6px; }

    /* Card-only disclaimer footer (no fixed positioning) */
    .ca-foot{ text-align:center; margin-top:14px; font-size:12px; color:#9aa3ad }
    .ca-foot a{ color:#cfd6dd; text-decoration:none }
  </style>
</head>
<body>
  <canvas id="bg3d"></canvas>

  <main class="app-shell">
    <!-- ===== AUTH ROUTE (Login + Create) ===== -->
    <div id="route-auth" class="route-auth route-active">
      <div class="stack">
        <header>
          <div class="title-wrap" id="titleWrap">
            <div class="title-3d" id="title3d">
              <h1>3ATTLE33ILLIONS</h1>
              <span class="title-sheen" aria-hidden="true"></span>
            </div>
          </div>
        </header>

        <!-- ===== LOGIN ===== -->
        <section id="view-auth" class="active">
          <form id="authForm" class="form" autocomplete="on">
            <div>
              <label for="email">Email</label>
              <input id="email" type="email" placeholder="you@example.com" required />
            </div>
            <div>
              <label for="password">Password</label>
              <div class="pw-wrap">
                <input id="password" type="password" minlength="6" placeholder="••••••••" required />
                <button type="button" id="togglePw" class="pw-toggle" aria-label="Show password" aria-pressed="false">👁</button>
              </div>
            </div>
            <div class="actions">
              <button id="submitBtn" type="submit" class="btn primary">Sign In</button>
              <button id="modeBtn" type="button" class="btn ghost">Create account</button>
            </div>
          </form>
          <p id="status" class="status" aria-live="polite"></p>
        </section>

        <!-- ===== CREATE ACCOUNT (4-step wizard) ===== -->
        <section id="view-create">
          <div class="wrapCA">
            <div class="ambient" aria-hidden="true"></div>
            <div class="logoCA">BattleBillions</div>

            <div class="ca-card">
              <div class="stepper">
                <div class="dot" data-stepdot="1"></div>
                <div class="bar"><span id="barFill" style="width:0%"></span></div>
                <div class="dot" data-stepdot="2"></div>
                <div class="dot" data-stepdot="3"></div>
                <div class="dot" data-stepdot="4"></div>
              </div>

              <!-- Step 1: Basics -->
              <section class="ca-step" data-step="1">
                <h2 class="title">Account Basics</h2>

                <!-- Account type choice (NEW) -->
                <div class="chipset" id="accountTypeChips" style="margin-bottom:10px">
                  <div class="chip active" data-type="user">I’m a Creator / User</div>
                  <div class="chip" data-type="company">I’m a Company / Brand</div>
                </div>
                <div class="hint" id="acctHint">You can create ad battles later if you’re a company.</div>

                <div class="grid cols-2">
                  <div>
                    <label for="ca-handle">Username / Handle</label>
                    <input id="ca-handle" type="text" placeholder="@yourname" autocomplete="nickname" maxlength="20" required/>
                    <div class="hint">3–20 chars, letters/numbers/underscore</div>
                    <div class="error" id="err-handle">Invalid or taken handle.</div>
                  </div>
                  <div>
                    <label for="ca-invite">Invite Code (optional)</label>
                    <input id="ca-invite" type="text" placeholder="Enter code (if any)"/>
                  </div>
                  <div id="emailRow">
                    <label for="ca-email">Email</label>
                    <input id="ca-email" type="email" placeholder="you@example.com" autocomplete="email" required/>
                    <div class="error" id="err-email">Enter a valid email.</div>
                  </div>
                  <div id="pwRow">
                    <label for="ca-password">Password</label>
                    <input id="ca-password" type="password" placeholder="8+ chars, 1 letter & 1 number" autocomplete="new-password" required/>
                    <div class="hint" id="pw-hint">Strength: —</div>
                    <div class="error" id="err-password">Password too weak.</div>
                  </div>
                  <div id="pw2Row">
                    <label for="ca-password2">Confirm Password</label>
                    <input id="ca-password2" type="password" placeholder="Re-enter password" autocomplete="new-password" required/>
                    <div class="error" id="err-password2">Passwords don’t match.</div>
                  </div>
                </div>

                <!-- Company-only fields (NEW) -->
                <div id="companyFields" style="display:none; margin-top:8px">
                  <div class="grid cols-2">
                    <div>
                      <label for="co-name">Company / Brand Name</label>
                      <input id="co-name" type="text" placeholder="Brand Inc." />
                      <div class="error" id="err-co-name">Please enter your company/brand name.</div>
                    </div>
                    <div>
                      <label for="co-website">Website (optional)</label>
                      <input id="co-website" type="url" placeholder="https://yourbrand.com" />
                    </div>
                    <div>
                      <label for="co-contact-name">Primary Contact Name</label>
                      <input id="co-contact-name" type="text" placeholder="Jane Doe" />
                      <div class="error" id="err-co-contact">Please enter a contact name.</div>
                    </div>
                    <div>
                      <label for="co-contact-email">Primary Contact Email</label>
                      <input id="co-contact-email" type="email" placeholder="ads@yourbrand.com" />
                      <div class="error" id="err-co-contact-email">Enter a valid contact email.</div>
                    </div>
                  </div>
                  <div class="hint">Companies use this to run <b>Ad Battles</b> (sponsored placements).</div>
                </div>

                <div class="actions">
                  <button class="btn ghost" id="ca-cancel-1">Cancel</button>
                  <button class="btn primary" id="ca-next-1">Next</button>
                </div>
                <p id="createStatus1" class="status"></p>
              </section>

              <!-- Step 2: Identity & Region -->
              <section class="ca-step" data-step="2">
                <h2 class="title">Identity & Region</h2>
                <div class="grid cols-3">
                  <div>
                    <label for="ca-country">Country</label>
                    <select id="ca-country" class="pill-select">
                      <option value="">Select country</option>
                      <option>United States</option><option>Canada</option><option>United Kingdom</option><option>Australia</option><option>Other</option>
                    </select>
                  </div>
                  <div>
                    <label for="ca-state">State / Province</label>
                    <input id="ca-state" type="text" placeholder="State / Province"/>
                  </div>
                  <div>
                    <label for="ca-city">City</label>
                    <input id="ca-city" type="text" placeholder="City"/>
                  </div>

                  <div class="pill-col" id="dob-month-wrap">
                    <label for="ca-dob-month">Birth Month</label>
                    <select id="ca-dob-month" class="pill-select"></select>
                  </div>
                  <div class="pill-col" id="dob-day-wrap">
                    <label for="ca-dob-day">Birth Day</label>
                    <select id="ca-dob-day" class="pill-select"></select>
                  </div>
                  <div class="pill-col" id="dob-year-wrap">
                    <label for="ca-dob-year">Birth Year</label>
                    <select id="ca-dob-year" class="pill-select"></select>
                  </div>
                  <div class="hint" id="dob-hint" style="grid-column:1/-1">Select Month • Day • Year</div>
                  <div class="error" id="err-dob" style="grid-column:1/-1">You must be 13+ to join.</div>

                  <div id="zodiac-wrap">
                    <label for="ca-zodiac">Chinese Zodiac</label>
                    <select id="ca-zodiac" class="pill-select">
                      <option value="">Auto (from year)</option>
                      <option>Rat</option><option>Ox</option><option>Tiger</option><option>Rabbit</option>
                      <option>Dragon</option><option>Snake</option><option>Horse</option><option>Goat</option>
                      <option>Monkey</option><option>Rooster</option><option>Dog</option><option>Pig</option>
                    </select>
                    <div class="hint">Auto-fills from the selected year. You can override if you want.</div>
                  </div>

                  <div>
                    <label for="ca-lang">Languages</label>
                    <select id="ca-lang" multiple>
                      <option>English</option><option>Spanish</option><option>French</option><option>Arabic</option><option>Hindi</option><option>Chinese</option><option>Other</option>
                    </select>
                    <div class="hint">Hold Ctrl/Cmd to select multiple</div>
                  </div>
                  <div>
                    <label for="ca-ethnicity">Ethnicity (optional)</label>
                    <select id="ca-ethnicity" class="pill-select">
                      <option value="">Prefer not to say</option>
                      <option>African / African American</option><option>Asian</option><option>Hispanic / Latino</option><option>Middle Eastern / North African</option>
                      <option>Native / Indigenous</option><option>Pacific Islander</option><option>White</option><option>Other / Mixed</option>
                    </select>
                  </div>
                  <div>
                    <label for="ca-timezone">Timezone</label>
                    <select id="ca-timezone" class="pill-select">
                      <option value="">Auto-detect</option>
                      <option>America/New_York</option><option>America/Chicago</option><option>America/Denver</option><option>America/Los_Angeles</option><option>UTC</option>
                    </select>
                  </div>
                </div>

                <div class="actions">
                  <button class="btn ghost" id="ca-back-2">Back</button>
                  <button class="btn primary" id="ca-next-2">Next</button>
                </div>
                <p id="createStatus2" class="status"></p>
              </section>

              <!-- Step 3: Education & Community -->
              <section class="ca-step" data-step="3">
                <h2 class="title">Education & Community</h2>
                <div class="grid cols-2">
                  <div>
                    <label for="ca-hs">High School</label>
                    <input id="ca-hs" type="text" placeholder="Type your high school"/>
                  </div>
                  <div>
                    <label for="ca-college">College / University</label>
                    <input id="ca-college" type="text" placeholder="Type your college"/>
                  </div>
                  <div>
                    <label for="ca-role">Role (optional)</label>
                    <select id="ca-role" class="pill-select">
                      <option value="">Select role</option>
                      <option>Student</option><option>Creator</option><option>Athlete</option><option>Musician</option><option>Entrepreneur</option><option>Other</option>
                    </select>
                  </div>
                </div>
                <div class="actions">
                  <button class="btn ghost" id="ca-back-3">Back</button>
                  <button class="btn primary" id="ca-next-3">Next</button>
                </div>
                <p id="createStatus3" class="status"></p>
              </section>

              <!-- Step 4: Battle Setup -->
              <section class="ca-step" data-step="4">
                <h2 class="title">Battle Setup</h2>
                <div class="grid">
                  <div class="avatar-upload">
                    <div class="avatar" id="avatarPreview"><img id="avatarImg" alt="" style="display:none"/></div>
                    <div>
                      <label for="ca-avatar">Profile Photo</label>
                      <input id="ca-avatar" type="file" accept="image/*" class="file-btn"/>
                      <div class="hint">Square images look best</div>
                    </div>
                  </div>

                  <div>
                    <label>Preferred Categories</label>
                    <div class="chipset" id="catChips">
                      <div class="chip">Rap</div><div class="chip">Dance</div><div class="chip">Gaming</div>
                      <div class="chip">Art</div><div class="chip">Sports</div><div class="chip">Comedy</div>
                    </div>
                  </div>

                  <div>
                    <label><input type="checkbox" id="ca-terms"/> I agree to the Terms</label>
                    <div class="hint">You must accept Terms & Privacy to continue</div>
                  </div>
                  <div>
                    <label><input type="checkbox" id="ca-privacy"/> I agree to the Privacy Policy</label>
                  </div>

                  <!-- Ads policy consent (company only) (NEW) -->
                  <div id="adsPolicyRow" style="display:none">
                    <label><input type="checkbox" id="ads-policy" /> I agree to the Ads Policy</label>
                    <div class="hint">Required for companies to run sponsored Ad Battles.</div>
                    <div class="error" id="err-ads-policy" style="display:none">Please agree to the Ads Policy.</div>
                  </div>
                </div>

                <div class="actions">
                  <button class="btn ghost" id="ca-back-4">Back</button>
                  <button class="btn primary" id="ca-submit">Create Account</button>
                </div>
                <p id="createStatus4" class="status"></p>
              </section>

              <div class="ca-foot">
                By creating an account you agree to our
                <a href="#">Terms</a> & <a href="#">Privacy</a>.
              </div>
            </div>
          </div>

          <div class="ca-success" id="success">
            <div class="box">
              <h3>Account Created</h3>
              <p>Welcome to BattleBillions — redirecting to your home...</p>
            </div>
          </div>
        </section>

        <footer class="foot">© <span id="year"></span> BattleBillions</footer>
      </div>
    </div>

    <!-- ===== FRAME ROUTE (SPA pages) ===== -->
    <div id="route-frame" class="route-frame">
      <div class="frame-wrap">
        <iframe id="frameA" class="route-iframe visible"  title="BattleBillions View A" allow="autoplay; clipboard-read; clipboard-write"></iframe>
        <iframe id="frameB" class="route-iframe"          title="BattleBillions View B" allow="autoplay; clipboard-read; clipboard-write"></iframe>
      </div>
    </div>
  </main>

  <!-- ===== ROUTER & UI (no social logins here) ===== -->
  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    // Show/Hide password (login)
    (function(){
      const pw = document.getElementById("password");
      const btn = document.getElementById("togglePw");
      btn.addEventListener("click", (e)=>{
        e.preventDefault();
        const to = pw.type === "password" ? "text" : "password";
        pw.type = to;
        btn.setAttribute("aria-label", to==="password" ? "Show password" : "Hide password");
        btn.setAttribute("aria-pressed", to==="text" ? "true" : "false");
      });
    })();

    // Title parallax
    (function(){
      const wrap = document.getElementById("titleWrap");
      const el   = document.getElementById("title3d");
      if(!wrap || !el) return;
      let rect = null;
      const updateRect = ()=>{ rect = wrap.getBoundingClientRect(); };
      updateRect(); addEventListener("resize", updateRect, {passive:true});
      wrap.addEventListener("mousemove", (ev)=>{
        if(!rect) return;
        const x = (ev.clientX - rect.left)/rect.width - 0.5;
        const y = (ev.clientY - rect.top )/rect.height - 0.5;
        el.style.transform = `rotateY(${x*10}deg) rotateX(${-y*8}deg) translateZ(0)`;
      });
      wrap.addEventListener("mouseleave", ()=>{ el.style.transform = "rotateY(0deg) rotateX(0deg)"; });
    })();

    /* ===== Hash Router ===== */
    const routes = {
      "/auth/login":  { type:"auth", sub:"login" },
      "/auth/create": { type:"auth", sub:"create" },
      "/home":        { type:"frame", src:"home.html" },
      "/discover":    { type:"frame", src:"discover.html" },
      "/opponent":    { type:"frame", src:"opponent.html" },
      "/battle":      { type:"frame", src:"live.html" },
      "/leaderboard": { type:"frame", src:"leaderboard.html" },
      "/profile":     { type:"frame", src:"profile.html" }
    };

    const authContainer = document.getElementById("route-auth");
    const loginView     = document.getElementById("view-auth");
    const createView    = document.getElementById("view-create");
    const frameView     = document.getElementById("route-frame");
    const appShell      = document.querySelector(".app-shell");
    const statusEl      = document.getElementById("status");

    // Iframes (double buffer to avoid flash)
    const frameA = document.getElementById("frameA");
    const frameB = document.getElementById("frameB");
    let visible = frameA, hidden = frameB;

    function showAuth(sub){
      appShell.classList.remove("frame-active");
      frameView.classList.remove("route-active");
      authContainer.classList.add("route-active");
      loginView.classList.toggle("active", sub==="login");
      createView.classList.toggle("active", sub==="create");
      if(sub==="create"){ initCreateWizardUI(); }
    }
    function showFrame(src){
      appShell.classList.add("frame-active");
      authContainer.classList.remove("route-active");
      frameView.classList.add("route-active");

      // Always resolve to absolute for both compare and assignment
      const abs = new URL(src, location.href).href;
      if (visible.src === abs) return;

      hidden.removeAttribute("src");
      hidden.classList.remove("visible");
      hidden.addEventListener("load", ()=>{
        visible.classList.remove("visible");
        hidden.classList.add("visible");
        [visible,hidden] = [hidden,visible];
        hidden.removeAttribute("src");
        hidden.classList.remove("visible");
      }, {once:true});
      hidden.src = abs;
    }
    function parseHash(){
      const raw  = location.hash || "#/auth/login";
      const [path, query] = raw.slice(1).split("?");
      const parts = path.split("/").filter(Boolean);
      if (parts[0]==="auth" && (parts[1]==="login" || parts[1]==="create")){
        return { base:`/auth/${parts[1]}`, query:new URLSearchParams(query||"") };
      }
      const base = `/${parts[0]||"auth"}`;
      if (base==="/auth") return { base:"/auth/login", query:new URLSearchParams(query||"") };
      return { base, query:new URLSearchParams(query||"") };
    }
    function navigate(){
      const { base } = parseHash();
      const route = routes[base] || routes["/auth/login"];
      if (route.type==="auth"){ showAuth(route.sub); return; }
      if (route.type==="frame"){ showFrame(route.src); return; }
      showAuth("login");
    }
    window.addEventListener("hashchange", navigate);
    if(!location.hash) location.hash="/auth/login";
    navigate();

    document.getElementById("modeBtn").addEventListener("click",()=>{ location.hash="/auth/create"; });
  </script>

  <!-- ===== FIREBASE EMAIL/PASSWORD ONLY ===== -->
  <script type="module">
    // Try your local firebase.js (should export initialized auth + db)
    let local = {};
    try{ local = await import("./firebase.js"); }catch{}

    const {
      auth, db,
      onAuthStateChanged:OASC, signInWithEmailAndPassword:SWE,
      createUserWithEmailAndPassword:CUW,
      doc:DOC, getDoc:GDC, setDoc:SDC, serverTimestamp:SVT
    } = local;

    // Backfill from CDN if some helpers missing (still use your initialized auth/db)
    let onAuthStateChanged=OASC, signInWithEmailAndPassword=SWE, createUserWithEmailAndPassword=CUW;
    let doc=DOC, getDoc=GDC, setDoc=SDC, serverTimestamp=SVT;

    if(!(onAuthStateChanged && signInWithEmailAndPassword && createUserWithEmailAndPassword)){
      const a = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
      onAuthStateChanged = onAuthStateChanged || a.onAuthStateChanged;
      signInWithEmailAndPassword = signInWithEmailAndPassword || a.signInWithEmailAndPassword;
      createUserWithEmailAndPassword = createUserWithEmailAndPassword || a.createUserWithEmailAndPassword;
    }
    if(!(doc && getDoc && setDoc && serverTimestamp)){
      const f = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
      doc=doc||f.doc; getDoc=getDoc||f.getDoc; setDoc=setDoc||f.setDoc; serverTimestamp=serverTimestamp||f.serverTimestamp;
    }

    const statusEl = document.getElementById("status");

    // Ensure user doc exists; minimal profile scaffold
    async function ensureUserDoc(user){
      if(!db) return {existed:true, data:null}; // allow nav without DB write
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref, {
          email:user.email||"", avatarURL:user.photoURL||"", createdAt:serverTimestamp(),
          account_type:null,
          username:null, country:null,state:null,city:null,tz:null,
          dob:null, age:null, chineseZodiac:null, languages:[], ethnicity:null,
          education:{ hs:null, college:null, role:null }, categories:[]
        });
        return {existed:false, data:null};
      }
      return {existed:true, data:snap.data()};
    }

    // Different completion rules for user vs company (NEW)
    const needsCompletion = (d)=>{
      if(!d) return true;
      if(d.account_type === 'company'){
        // For companies, just require a handle at minimum (no DOB/age)
        return !(d.username);
      }
      return !(d && d.username && d.dob && typeof d.age==="number");
    };

    // Email Login
    document.getElementById("authForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const email=(document.getElementById("email").value||"").trim();
      const pw=document.getElementById("password").value||"";
      statusEl.textContent="Signing in...";
      try{
        if(auth){ await signInWithEmailAndPassword(auth, email, pw); }
        else{
          statusEl.textContent = "Auth is not configured. Add firebase.js to enable sign-in.";
        }
      }catch(err){
        statusEl.textContent = err?.message || "Sign-in failed.";
      }
    });

    // Auth state -> route
    if(auth && onAuthStateChanged){
      onAuthStateChanged(auth, async (u)=>{
        if(!u) return;
        if(location.hash.startsWith("#/auth")){
          try{
            const { data } = await ensureUserDoc(u);
            location.hash = needsCompletion(data) ? "/auth/create" : "/home";
          }catch{
            location.hash="/home";
          }
        }
      });
    }

    /* ===== Create Wizard: UI + Submit ===== */
    let _wizardReady = false;
    function initCreateWizardUI(){
      if(_wizardReady) return; _wizardReady=true;

      // helper: get hash ?type=
      function getHashParam(key){
        try{
          const raw = location.hash || "#/auth/create";
          const q = raw.split("?")[1] || "";
          const params = new URLSearchParams(q);
          return params.get(key);
        }catch{ return null; }
      }

      const steps = Array.from(document.querySelectorAll('.ca-step'));
      const dots  = Array.from(document.querySelectorAll('[data-stepdot]'));
      const barFill = document.getElementById('barFill');
      const get = id => document.getElementById(id);

      const f = {
        handle:get('ca-handle'), invite:get('ca-invite'),
        email:get('ca-email'), pw:get('ca-password'), pw2:get('ca-password2'),
        m:get('ca-dob-month'), d:get('ca-dob-day'), y:get('ca-dob-year'),
        zodiac:get('ca-zodiac'), tz:get('ca-timezone'),
        terms:get('ca-terms'), privacy:get('ca-privacy'),
        country:get('ca-country'), state:get('ca-state'), city:get('ca-city'),
        hs:get('ca-hs'), college:get('ca-college'), role:get('ca-role')
      };
      const err = {
        handle:get('err-handle'), email:get('err-email'),
        pw:get('err-password'), pw2:get('err-password2'), dob:get('err-dob')
      };
      // Validate case-insensitively here; normalize later on submit
      const reHandle=/^[a-z0-9_]{3,20}$/i; const reEmail=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      /* --- NEW: account type + company refs --- */
      let accountType = "user"; // "user" | "company"
      const acctChips = document.getElementById('accountTypeChips');
      const acctHint  = document.getElementById('acctHint');
      const companyFields = document.getElementById('companyFields');
      const adsPolicyRow = document.getElementById('adsPolicyRow');

      const co = {
        name: document.getElementById('co-name'),
        website: document.getElementById('co-website'),
        contactName: document.getElementById('co-contact-name'),
        contactEmail: document.getElementById('co-contact-email'),
        adsPolicy: document.getElementById('ads-policy')
      };
      const errCo = {
        name: document.getElementById('err-co-name'),
        contact: document.getElementById('err-co-contact'),
        contactEmail: document.getElementById('err-co-contact-email'),
        adsPolicy: document.getElementById('err-ads-policy')
      };

      // Elements we hide for companies (DOB + zodiac + step 3)
      const dobWraps = [
        document.getElementById('dob-month-wrap'),
        document.getElementById('dob-day-wrap'),
        document.getElementById('dob-year-wrap'),
      ];
      const dobHintEl = document.getElementById('dob-hint');
      const zodiacWrap = document.getElementById('zodiac-wrap');
      const step3 = document.querySelector('.ca-step[data-step="3"]');

      function applyTypeVisibility(){
        const isCo = accountType === 'company';
        companyFields.style.display = isCo ? 'block' : 'none';
        adsPolicyRow.style.display = isCo ? 'block' : 'none';
        acctHint.textContent = isCo
          ? "Company accounts can run Ad Battles and appear in Discover/Live feeds."
          : "You can create ad battles later if you’re a company.";

        // Hide DOB/zodiac for companies
        dobWraps.forEach(el => { if(el) el.style.display = isCo ? 'none' : 'block'; });
        if(dobHintEl) dobHintEl.style.display = isCo ? 'none' : 'block';
        if(zodiacWrap) zodiacWrap.style.display = isCo ? 'none' : 'block';

        // Hide entire Step 3 for companies (education/community)
        if(step3){
          if(isCo && step3.classList.contains('active')) showStep(4);
          step3.style.display = isCo ? 'none' : '';
          // Recompute progress right away after visibility changes
          updateProgressForCurrent();
        }
      }

      // Preselect type from URL hash
      const typeFromHash = (getHashParam('type')||'').toLowerCase();
      if(typeFromHash === 'company'){
        accountType = 'company';
        [...acctChips.children].forEach(c=>{
          c.classList.toggle('active', c.dataset.type === 'company');
        });
      }

      // Months/Years
      const months=['January','February','March','April','May','June','July','August','September','October','November','December'];
      f.m.innerHTML = '<option value="">Month</option>' + months.map((m,i)=>`<option value="${i+1}">${m}</option>`).join('');
      const now=new Date(), startYear=now.getFullYear()-100, endYear=now.getFullYear();
      let yhtml='<option value="">Year</option>'; for(let y=endYear; y>=startYear; y--){ yhtml+=`<option value="${y}">${y}</option>`; } f.y.innerHTML=yhtml;
      function daysInMonth(m,y){ if(!m||!y) return 31; return new Date(y,m,0).getDate(); }
      function refreshDays(){ const m=parseInt(f.m.value||'0',10), y=parseInt(f.y.value||'0',10), max=daysInMonth(m,y); const cur=parseInt(f.d.value||'0',10); let html='<option value="">Day</option>'; for(let i=1;i<=max;i++){ html+=`<option value="${i}">${i}</option>`;} f.d.innerHTML=html; if(cur&&cur<=max) f.d.value=String(cur); }
      f.m.addEventListener('change', refreshDays); f.y.addEventListener('change', refreshDays); refreshDays();

      // Chinese zodiac
      const zodiacNames=['Rat','Ox','Tiger','Rabbit','Dragon','Snake','Horse','Goat','Monkey','Rooster','Dog','Pig'];
      function chineseZodiacByYear(year){ const idx=((year-2008)%12+12)%12; return zodiacNames[idx]; }
      f.y.addEventListener('change', ()=>{ const y=parseInt(f.y.value,10); if(y && !f.zodiac.dataset.userOverride){ f.zodiac.value=chineseZodiacByYear(y); } });
      f.zodiac.addEventListener('change', ()=>{ f.zodiac.dataset.userOverride='1'; });

      // Password strength
      const pwHint = document.getElementById('pw-hint');
      f.pw && f.pw.addEventListener('input', ()=>{ const s=f.pw.value; let score=0; if(s.length>=8)score++; if(/[a-zA-Z]/.test(s))score++; if(/[0-9]/.test(s))score++; pwHint.textContent='Strength: '+(['—','Weak','OK','Strong'][score]); });

      // Stepper helpers
      function visibleSteps(){
        return steps.filter(s => s.style.display !== 'none');
      }
      function updateProgress(n){
        const vis = visibleSteps();
        const idx = vis.findIndex(s => Number(s.dataset.step) === n);
        const pct = idx <= 0 ? 0 : (idx/(vis.length-1))*100;
        barFill.style.width = pct+'%';
        dots.forEach((d,i)=> d.classList.toggle('active', i <= idx));
      }
      function updateProgressForCurrent(){
        const active = steps.find(s=>s.classList.contains('active'));
        if(active) updateProgress(Number(active.dataset.step));
      }
      function showStep(n){
        steps.forEach(s=>s.classList.toggle('active', Number(s.dataset.step)===n));
        updateProgress(n);
      }
      function ageFromParts(y,m,d){ if(!y||!m||!d) return 0; const t=new Date(), dob=new Date(y,m-1,d); let a=t.getFullYear()-dob.getFullYear(); const mm=t.getMonth()-dob.getMonth(); if(mm<0||(mm===0&&t.getDate()<dob.getDate())) a--; return a; }

      // Toggle account type chips (NEW)
      acctChips.addEventListener('click', (e)=>{
        const chip = e.target.closest('.chip');
        if(!chip) return;
        [...acctChips.children].forEach(c=>c.classList.remove('active'));
        chip.classList.add('active');
        accountType = chip.dataset.type || 'user';
        applyTypeVisibility();
      });

      // Nav buttons
      get('ca-cancel-1').onclick=()=>{ location.hash='/auth/login'; };
      get('ca-next-1').onclick=()=>{
        let ok=true;
        const handleVal = (f.handle.value||'').trim();
        if(!reHandle.test(handleVal)){ err.handle.style.display='block'; ok=false; } else err.handle.style.display='none';
        if(!reEmail.test((f.email.value||'').trim())){ err.email.style.display='block'; ok=false; } else err.email.style.display='none';
        const pw=f.pw.value||'', pw2=f.pw2.value||''; const pwOk=pw.length>=8 && /[a-zA-Z]/.test(pw) && /[0-9]/.test(pw);
        if(!pwOk){ err.pw.style.display='block'; ok=false; } else err.pw.style.display='none';
        if(pw2!==pw){ err.pw2.style.display='block'; ok=false; } else err.pw2.style.display='none';

        // company-only validation (NEW)
        if(accountType === 'company'){
          const nameOk = (co.name.value||'').trim().length >= 2;
          const contactOk = (co.contactName.value||'').trim().length >= 2;
          const contactEmailOk = reEmail.test((co.contactEmail.value||'').trim());
          errCo.name.style.display = nameOk ? 'none' : 'block';
          errCo.contact.style.display = contactOk ? 'none' : 'block';
          errCo.contactEmail.style.display = contactEmailOk ? 'none' : 'block';
          ok = ok && nameOk && contactOk && contactEmailOk;
        }

        if(ok) showStep(2);
      };
      get('ca-back-2').onclick=()=> showStep(1);
      get('ca-next-2').onclick=()=>{
        if(accountType !== 'company'){
          const y=parseInt(f.y.value,10), m=parseInt(f.m.value,10), d=parseInt(f.d.value,10);
          const a=ageFromParts(y,m,d);
          if(a<13 || !y || !m || !d){ err.dob.style.display='block'; return; } else err.dob.style.display='none';
        }
        if(!f.tz.value){ try{ f.tz.value=Intl.DateTimeFormat().resolvedOptions().timeZone||''; }catch{} }
        // Skip step 3 for companies
        showStep(accountType==='company' ? 4 : 3);
      };
      get('ca-back-3').onclick=()=> showStep(2);
      get('ca-next-3').onclick=()=> showStep(4);
      get('ca-back-4').onclick=()=> showStep(accountType==='company' ? 2 : 3);

      // Avatar preview
      document.getElementById('ca-avatar').addEventListener('change', (e)=>{
        const file=e.target.files?.[0]; if(!file) return;
        const img=document.getElementById('avatarImg'); const reader=new FileReader();
        reader.onload=ev=>{ img.src=ev.target.result; img.style.display='block'; }; reader.readAsDataURL(file);
      });

      // Category chips
      document.getElementById('catChips').addEventListener('click',(e)=>{ const c=e.target.closest('.chip'); if(!c) return; c.classList.toggle('active'); });

      // Initial tz
      try{ f.tz.value=Intl.DateTimeFormat().resolvedOptions().timeZone||''; }catch{}

      // Submit (create)
      document.getElementById('ca-submit').onclick=async ()=>{
        const st = document.getElementById('createStatus4');
        st.textContent="";
        const unameRaw=(f.handle.value||'').trim();
        const uname=unameRaw.toLowerCase(); // normalize for storage
        const email=(f.email.value||'').trim();
        const pw=f.pw.value||'';
        const pw2=f.pw2.value||'';
        const y=parseInt(f.y.value||'0',10), m=parseInt(f.m.value||'0',10), d=parseInt(f.d.value||'0',10);
        const dobISO = (accountType==='company') ? null : ((y && m && d) ? `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}` : null);
        const age=(function(){ if(!dobISO) return null; const t=new Date(); const dd=new Date(y,m-1,d); let a=t.getFullYear()-dd.getFullYear(); const mm=t.getMonth()-dd.getMonth(); if(mm<0||(mm===0&&t.getDate()<dd.getDate())) a--; return a; })();

        if(!/^[a-z0-9_]{3,20}$/.test(uname)) return void(st.textContent="Invalid username.");
        if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return void(st.textContent="Enter a valid email.");
        if(!(pw.length>=8 && /[A-Za-z]/.test(pw) && /[0-9]/.test(pw))) return void(st.textContent="Password too weak.");
        if(pw2!==pw) return void(st.textContent="Passwords don’t match.");
        if(accountType!=='company' && (age===null || age<13)) return void(st.textContent="You must be at least 13.");
        if(!(document.getElementById('ca-terms').checked && document.getElementById('ca-privacy').checked)) return void(st.textContent="Please accept Terms & Privacy.");

        // If company, require Ads Policy consent (NEW)
        if(accountType === 'company'){
          if(!co.adsPolicy.checked){
            errCo.adsPolicy.style.display = 'block';
            return;
          } else {
            errCo.adsPolicy.style.display = 'none';
          }
        }

        st.textContent="Creating your account...";
        try{
          let user = auth ? (await createUserWithEmailAndPassword(auth, email, pw)).user : null;

          // Save profile if Firestore is configured
          if(user && db && setDoc){
            const ref = doc(db, "users", user.uid);
            const languages=[...document.getElementById('ca-lang').selectedOptions].map(o=>o.value);
            const categories=[...document.querySelectorAll('#catChips .chip.active')].map(c=>c.textContent.trim());

            // Base user payload (NEW: account_type)
            const userPayload = {
              email, createdAt:serverTimestamp(), username:uname,
              account_type: accountType,
              country:f.country.value||"", state:f.state.value||"", city:f.city.value||"", tz:f.tz.value||"",
              dob:dobISO, age:(age===null?null:age), chineseZodiac:(accountType==='company'?null:(f.zodiac.value||null)),
              languages, ethnicity:document.getElementById('ca-ethnicity').value||"",
              education:(accountType==='company'?{ hs:"", college:"", role:"" }:{ hs:f.hs.value||"", college:f.college.value||"", role:f.role.value||"" }),
              categories
            };

            // If company, create companies/{cmp_uid} and link it (NEW)
            if(accountType === 'company'){
              const companyId = `cmp_${user.uid}`;
              const cRef = doc(db, "companies", companyId);
              await setDoc(cRef, {
                company_id: companyId,
                owner_uid: user.uid,
                name_public: (co.name.value||'').trim(),
                website: (co.website.value||'').trim() || null,
                contact: {
                  name: (co.contactName.value||'').trim(),
                  email: (co.contactEmail.value||'').trim()
                },
                country: f.country.value||"",
                ads_policy_accepted: true,
                status: "active",
                created_at: serverTimestamp(),
                updated_at: serverTimestamp()
              }, { merge:true });

              userPayload.company_id = companyId;
            }

            await setDoc(ref, userPayload, { merge:true });
          }

          // Success & route
          document.getElementById('success').style.display='flex';
          setTimeout(()=>{
            if(accountType === 'company'){ location.href = "adsarena.html"; }
            else { location.hash="/home"; }
          }, 1000);
        }catch(err){
          st.textContent = err?.message || "Could not create your account.";
        }
      };

      // Start
      showStep(1);
      applyTypeVisibility();
    }

    // Expose to router init
    window.initCreateWizardUI = initCreateWizardUI;
  </script>

  <!-- ===== Three.js Background ===== -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script>
  (function(){
    const reduced = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
    const DPR_LIMIT = 1.75, MAX_EXPLOSIONS = reduced ? 6 : 12, BLAST_INTERVAL = reduced ? 1700 : 1200, START_WITH_BLAST = true;
    const canvas = document.getElementById('bg3d');
    try{ const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl'); if(!gl) throw 0; }catch(e){ return; }
    const renderer = new THREE.WebGLRenderer({ canvas, antialias:false, alpha:true, powerPreference:'high-performance' });
    renderer.setClearColor(0x000000, 0);
    const scene = new THREE.Scene(); scene.fog = new THREE.FogExp2(0x000000, reduced ? 0.0008 : 0.0012);
    let width = window.innerWidth, height = window.innerHeight;
    renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, DPR_LIMIT)); renderer.setSize(width, height, false);

    // Keep base camera pos; apply transient shake each frame without drift
    const camera = new THREE.PerspectiveCamera(55, width/height, 0.1, 3000);
    const baseCamPos = new THREE.Vector3(0, 0, 140);
    camera.position.copy(baseCamPos);

    const hemi = new THREE.HemisphereLight(0xaaaaaa, 0x0a0a0a, 0.8);
    const dir  = new THREE.DirectionalLight(0xffe7a4, 0.7); dir.position.set(60, 80, 120); scene.add(hemi, dir);
    const particleTex = (function(){ const size=128,c=document.createElement('canvas'); c.width=c.height=size; const g=c.getContext('2d'); const grad=g.createRadialGradient(size/2,size/2,0,size/2,size/2,size/2); grad.addColorStop(0,'rgba(255,255,255,0.95)'); grad.addColorStop(0.35,'rgba(255,255,255,0.35)'); grad.addColorStop(1,'rgba(255,255,255,0.0)'); g.fillStyle=grad; g.fillRect(0,0,size,size); const tex=new THREE.CanvasTexture(c); tex.minFilter=THREE.LinearFilter; tex.magFilter=THREE.LinearFilter; tex.anisotropy=1; return tex;})();
    const baseMat = new THREE.PointsMaterial({ size:(reduced?16:20), map:particleTex, transparent:true, depthWrite:false, blending:THREE.AdditiveBlending, vertexColors:true, sizeAttenuation:true });

    const ringMatStrong = new THREE.MeshBasicMaterial({ color:0xffd700, transparent:true, opacity:0.9, blending:THREE.AdditiveBlending, side:THREE.DoubleSide });
    const ringMatSoft   = new THREE.MeshBasicMaterial({ color:0xffe18a, transparent:true, opacity:0.6, blending:THREE.AdditiveBlending, side:THREE.DoubleSide });

    const pool=[];
    function getPoints(count){
      for(let i=pool.length-1;i>=0;i--){
        const p=pool[i];
        const existing=p.geometry.getAttribute('position').count;
        if(existing>=count){
          pool.splice(i,1);
          p.visible=true;
          return p;
        }
      }
      const g=new THREE.BufferGeometry();
      const positions=new Float32Array(count*3);
      const colors=new Float32Array(count*3);
      // NOTE: PointsMaterial ignores custom per-vertex "size" without a custom shader;
      // so we skip a size attribute to reduce churn.
      g.setAttribute('position', new THREE.BufferAttribute(positions,3));
      g.setAttribute('color', new THREE.BufferAttribute(colors,3));
      const m=baseMat.clone();
      const points=new THREE.Points(g,m);
      points.frustumCulled=false;
      return points;
    }
    function releasePoints(points){ points.visible=false; pool.push(points); }

    class Explosion{
      constructor(){
        const x=(Math.random()-0.5)*140, y=(Math.random()-0.5)*90, z=Math.random()*80-60;
        this.center=new THREE.Vector3(x,y,z);
        this.life=reduced?1.5:1.9; this.t=0;
        this.count=(Math.random()*50+(reduced?75:120))|0;
        this.points=getPoints(this.count);
        this.points.position.copy(this.center);

        const g=this.points.geometry, pos=g.getAttribute('position').array, col=g.getAttribute('color').array;
        this.vel=new Float32Array(this.count*3);
        for(let i=0;i<this.count;i++){
          const dirv=new THREE.Vector3().randomDirection();
          const speed=Math.random()*22+12;
          this.vel[i*3+0]=dirv.x*speed; this.vel[i*3+1]=dirv.y*speed; this.vel[i*3+2]=dirv.z*speed;
          pos[i*3+0]=dirv.x*1.6; pos[i*3+1]=dirv.y*1.6; pos[i*3+2]=dirv.z*1.6;
          col[i*3+0]=1; col[i*3+1]=1; col[i*3+2]=1;
        }
        g.getAttribute('position').needsUpdate=true; g.getAttribute('color').needsUpdate=true;

        const ringGeo=new THREE.RingGeometry(5,6.6,64);
        this.ring1=new THREE.Mesh(ringGeo, ringMatStrong.clone());
        this.ring2=new THREE.Mesh(ringGeo, ringMatSoft.clone());
        this.r1=5; this.r2=5;
        this.ring1.position.copy(this.center); this.ring2.position.copy(this.center);
        scene.add(this.ring1,this.ring2);

        this.shake=0.45;
      }
      update(dt){
        this.t+=dt; const f=this.t/this.life;
        const g=this.points.geometry, pos=g.getAttribute('position').array, col=g.getAttribute('color').array;
        const drag=1-Math.min(0.05*dt*60,0.05);
        for(let i=0;i<this.count;i++){
          const ix=i*3;
          pos[ix]+=this.vel[ix]*dt;
          pos[ix+1]+=this.vel[ix+1]*dt;
          pos[ix+2]+=this.vel[ix+2]*dt;
          this.vel[ix]*=drag; this.vel[ix+1]*=drag; this.vel[ix+2]*=drag;

          const toGold = (f-0.25)/0.3;
          const t=Math.max(0,Math.min(1,toGold));
          col[ix]=1; col[ix+1]=1-0.28*t; col[ix+2]=1-0.72*t;
        }
        g.getAttribute('position').needsUpdate=true; g.getAttribute('color').needsUpdate=true;

        this.r1+=100*dt; this.r2+=125*dt;
        this.ring1.scale.setScalar(this.r1/5); this.ring2.scale.setScalar(this.r2/5);
        this.ring1.material.opacity=Math.max(0,0.95-f*1.25);
        this.ring2.material.opacity=Math.max(0,0.65-f*1.3);
        this.ring1.lookAt(camera.position); this.ring2.lookAt(camera.position);

        return this.t<this.life;
      }
      dispose(){
        scene.remove(this.points); releasePoints(this.points);
        scene.remove(this.ring1); scene.remove(this.ring2);
      }
    }

    // Ambient field with base positions (no vertical accumulation)
    const ambient=(function(){
      const COUNT=reduced?400:800;
      const basePos=new Float32Array(COUNT*3);
      const g=new THREE.BufferGeometry();
      const positions=new Float32Array(COUNT*3);
      const colors=new Float32Array(COUNT*3);
      for(let i=0;i<COUNT;i++){
        const bx=(Math.random()-0.5)*440;
        const by=(Math.random()-0.5)*280;
        const bz=Math.random()*240-180;
        basePos[i*3]=bx; basePos[i*3+1]=by; basePos[i*3+2]=bz;
        positions[i*3]=bx; positions[i*3+1]=by; positions[i*3+2]=bz;
        const t=Math.random()*0.5+0.35;
        colors[i*3]=t; colors[i*3+1]=t*0.9; colors[i*3+2]=t*0.85;
      }
      g.setAttribute('position',new THREE.BufferAttribute(positions,3));
      g.setAttribute('color',new THREE.BufferAttribute(colors,3));
      const m=new THREE.PointsMaterial({ size:reduced?2.2:3.2, map:particleTex, transparent:true, depthWrite:false, vertexColors:true, blending:THREE.AdditiveBlending });
      const p=new THREE.Points(g,m);
      p.frustumCulled=false;
      p.userData={t:0, base:basePos};
      return p;
    })();
    scene.add(ambient);

    function resize(){
      width=window.innerWidth; height=window.innerHeight;
      renderer.setPixelRatio(Math.min(window.devicePixelRatio||1,DPR_LIMIT));
      renderer.setSize(width,height,false);
      camera.aspect=width/height; camera.updateProjectionMatrix();
    }
    window.addEventListener('resize', resize, { passive:true });

    const explosions=[];
    let prev=performance.now(), lastBlast=prev;
    if(START_WITH_BLAST) explosions.push(new Explosion());

    function loop(now){
      const dt=Math.min(0.05,(now-prev)/1000); prev=now;

      // Ambient oscillation around base
      ambient.userData.t+=dt*0.2;
      const apos=ambient.geometry.getAttribute('position').array;
      const base=ambient.userData.base;
      const t=ambient.userData.t;
      for(let i=0;i<apos.length/3;i++){
        const ix=i*3;
        apos[ix]=base[ix];
        apos[ix+1]=base[ix+1] + Math.sin(t+i*0.15)*0.7; // small oscillation
        apos[ix+2]=base[ix+2];
      }
      ambient.geometry.getAttribute('position').needsUpdate=true;

      // Camera base + transient shake based on active explosions
      camera.position.copy(baseCamPos);
      let shakeAmt=0;
      for(let i=explosions.length-1;i>=0;i--){
        if(!explosions[i].update(dt)){ explosions[i].dispose(); explosions.splice(i,1); }
      }
      // proportional shake if any explosion exists
      if(explosions.length){
        shakeAmt = 0.35;
        camera.position.x += (Math.random()-0.5)*shakeAmt;
        camera.position.y += (Math.random()-0.5)*shakeAmt;
      }

      if(now-lastBlast>BLAST_INTERVAL && explosions.length<MAX_EXPLOSIONS){
        explosions.push(new Explosion()); lastBlast=now;
      }

      renderer.render(scene,camera);
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);
  })();
  </script>
</body>
</html>
