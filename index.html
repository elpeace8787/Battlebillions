<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3ATTLE33ILLIONS ‚Äî App</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --ink:#f5f5f5; --ink-2:#cecece; --muted:#8a8a8a;
      --google-border:#dadce0;
      --facebook:#1877F2;
      --tiktok:#000000;
      --ig1:#f58529; --ig2:#dd2a7b; --ig3:#8134af; --ig4:#515bd4;
      --accent:#ffd700;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#000;color:var(--ink)}
    /* Background canvas */
    #bg3d{
      position:fixed; inset:0; width:100%; height:100%; display:block;
      pointer-events:none; background:radial-gradient(1200px 800px at 30% 20%, #101012 0%, #000 70%);
      z-index:0;
    }

    /* ====== APP SHELL ====== */
    .app-shell{position:relative; z-index:1; min-height:100vh; display:grid; place-items:center; padding:25px;}
    .stack{width:min(92vw,980px); display:grid; gap:18px}
    header{text-align:center}

    /* ===== Advanced 3D Title (unchanged) ===== */
    .title-wrap{ perspective:1200px; display:inline-block; user-select:none; }
    .title-3d{ position:relative; display:inline-block; transform-style:preserve-3d; transition:transform .3s ease; }
    header h1{
      --shine: linear-gradient(180deg, #fafafa 0%, #dcdcdc 28%, #a9a9a9 55%, #f3f3f3 82%);
      margin:0; font-size:38px; letter-spacing:.6px; text-transform:uppercase; line-height:1;
      background:
        linear-gradient(120deg, rgba(255,255,255,.18) 0%, rgba(255,255,255,0) 22% 78%, rgba(255,255,255,.18) 100%),
        var(--shine);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      filter: drop-shadow(0 8px 22px rgba(0,0,0,.35)) drop-shadow(0 2px 8px rgba(255,215,0,.18));
      position:relative; z-index:2; animation:titleGlow 7.2s ease-in-out infinite;
    }
    header h1::before{
      content:"3ATTLE33ILLIONS"; position:absolute; inset:0; color:#0e0e10; opacity:.5; z-index:-1;
      transform: translate3d(0, 0, -3px); filter: blur(.6px);
      text-shadow: 0 1px 0 #09090a, 0 2px 0 #0b0b0d, 0 3px 0 #0d0d10, 0 4px 0 #0f0f12;
    }
    header h1::after{
      content:"3ATTLE33ILLIONS"; position:absolute; inset:0; z-index:3;
      background: linear-gradient(90deg, rgba(255,215,0,.0), rgba(255,215,0,.55), rgba(255,215,0,.0));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      mix-blend-mode:screen; opacity:.55; animation: rimSweep 3.6s linear infinite;
    }
    .title-sheen{
      position:absolute; left:-8%; top:-20%; width:120%; height:140%;
      background: linear-gradient(100deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.22) 50%, rgba(255,255,255,0) 100%);
      transform: translateZ(8px) skewX(-18deg); pointer-events:none; filter: blur(8px) opacity(.55);
      animation: sheenSlide 4.8s ease-in-out infinite;
    }
    @keyframes sheenSlide{
      0%{ transform:translate(-20%, -10%) skewX(-18deg) translateZ(8px); opacity:.25 }
      50%{ transform:translate(10%, 0%) skewX(-18deg) translateZ(8px); opacity:.6 }
      100%{ transform:translate(-20%, -10%) skewX(-18deg) translateZ(8px); opacity:.25 }
    }
    @keyframes rimSweep{
      0%{ clip-path: polygon(0 0, 12% 0, 18% 100%, 0 100%); }
      50%{ clip-path: polygon(40% 0, 62% 0, 58% 100%, 36% 100%); }
      100%{ clip-path: polygon(88% 0, 100% 0, 100% 100%, 82% 100%); }
    }
    @keyframes titleGlow{
      0%,100%{ filter: drop-shadow(0 8px 22px rgba(0,0,0,.35)) drop-shadow(0 2px 8px rgba(255,215,0,.18)); }
      50%{    filter: drop-shadow(0 10px 26px rgba(0,0,0,.45)) drop-shadow(0 2px 12px rgba(255,235,140,.28)); }
    }

    /* ===== Auth view (unchanged visuals) ===== */
    .form{display:grid; gap:12px}
    .btn, input{
      width:100%; padding:12px 16px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(15,15,17,.28);
      -webkit-backdrop-filter: blur(6px) saturate(120%); backdrop-filter: blur(6px) saturate(120%);
      color:var(--ink); transition:transform .16s ease, background .16s ease, border-color .16s ease, box-shadow .16s ease;
      cursor:pointer;
    }
    .btn:hover{transform:translateY(-2px)}
    .btn.primary{background:#fff;color:#000;border-color:transparent}
    .btn.primary:hover{background:#ececec}
    .btn.ghost{background:transparent;border-color:#3a3a3a}
    .btn.ghost:hover{border-color:#fff}
    label{font-size:12px;color:var(--ink-2)}
    input{color:#eaeaea}
    input:focus{outline:0;border-color:#fff;box-shadow:0 0 6px rgba(255,255,255,.25)}
    .pw-wrap{position:relative}
    .pw-toggle{position:absolute; right:10px; top:50%; transform:translateY(-50%); border:0; background:transparent; color:var(--muted); cursor:pointer; font-size:14px;}
    .actions{display:flex; gap:12px; margin-top:4px}
    .divider{display:flex;align-items:center;gap:10px;margin:2px 0 6px}
    .divider::before,.divider::after{content:"";flex:1;height:1px;background:rgba(255,255,255,.12)}
    .divider span{font-size:12px;color:var(--muted)}
    .providers{display:grid; gap:10px}
    .provider-bar{ display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }
    .pbtn{
      width:44px; height:44px; border-radius:10px; display:inline-flex; align-items:center; justify-content:center;
      border:1px solid rgba(255,255,255,.14); background:rgba(15,15,17,.35);
      backdrop-filter: blur(6px) saturate(120%); transition:transform .16s ease, box-shadow .16s ease, border-color .16s ease;
    }
    .pbtn:hover{ transform:translateY(-2px); border-color:rgba(255,255,255,.3) }
    .pbtn svg{ width:22px; height:22px; }
    .pbtn.google{ background:rgba(255,255,255,0.9); border-color:var(--google-border) }
    .pbtn.facebook{ background:rgba(24,119,242,0.9); border-color:rgba(24,119,242,1) }
    .pbtn.instagram{ background:conic-gradient(from 180deg, var(--ig1), var(--ig2), var(--ig3), var(--ig4), var(--ig1)); border-color:rgba(255,255,255,.18) }
    .pbtn.tiktok{ background:rgba(0,0,0,0.85); border-color:#222 }
    .status{min-height:18px;font-size:12px;text-align:center;color:var(--muted)}
    .foot{position:fixed;left:0;right:0;bottom:12px;text-align:center;font-size:12px;color:var(--muted)}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .hidden{display:none !important;}
    @media (prefers-reduced-motion: reduce){ #bg3d{opacity:.6} .title-3d{transform:none !important} .title-sheen{animation:none} header h1{animation:none} }

    /* ===== Route outlet for SPA pages ===== */
    .route-auth{display:block;}       /* login route container */
    .route-frame{display:none;}       /* iframe route container */
    .route-active{display:block !important;}

    .frame-wrap{
      position:fixed; inset:0; display:grid; place-items:stretch;
      z-index:2; /* above bg */
    }
    .route-iframe{
      width:100vw; height:100vh; border:0; background:transparent;
    }
  </style>
</head>
<body>
  <!-- Background explosions -->
  <canvas id="bg3d"></canvas>

  <!-- ====== APP SHELL ====== -->
  <main class="app-shell">
    <!-- ===== Auth/Login Route (kept exactly as your design) ===== -->
    <div id="route-auth" class="route-auth route-active">
      <div class="stack">
        <header>
          <div class="title-wrap" id="titleWrap">
            <div class="title-3d" id="title3d">
              <h1>3ATTLE33ILLIONS</h1>
              <span class="title-sheen" aria-hidden="true"></span>
            </div>
          </div>
        </header>

        <section id="view-auth">
          <form id="authForm" class="form" autocomplete="on">
            <div class="row">
              <label for="email">Email</label>
              <input id="email" type="email" placeholder="you@example.com" required />
            </div>
            <div class="row">
              <label for="password">Password</label>
              <div class="pw-wrap">
                <input id="password" type="password" minlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
                <button type="button" id="togglePw" class="pw-toggle" aria-label="Show password">üëÅ</button>
              </div>
            </div>
            <div class="actions">
              <button id="submitBtn" type="submit" class="btn primary">Sign In</button>
              <button id="modeBtn" type="button" class="btn ghost">Create account</button>
            </div>
          </form>

          <div class="divider"><span>or continue with</span></div>

          <section class="providers">
            <div class="provider-bar">
              <button id="googleBtn" class="pbtn google" title="Continue with Google" aria-label="Continue with Google">
                <span class="sr-only">Continue with Google</span>
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path fill="#EA4335" d="M12 10.2v3.6h5.02c-.22 1.3-1.52 3.8-5.02 3.8-3.03 0-5.5-2.5-5.5-5.6s2.47-5.6 5.5-5.6c1.73 0 2.9.73 3.57 1.36l2.43-2.36C16.7 3.7 14.55 2.8 12 2.8 6.98 2.8 2.9 6.88 2.9 12s4.08 9.2 9.1 9.2c5.25 0 8.7-3.68 8.7-8.86 0-.6-.06-1.06-.14-1.54H12z"/>
                  <path fill="#FBBC05" d="M12 21.2c2.88 0 5.3-.94 7.07-2.56l-3.3-2.7c-.89.6-2.07.96-3.77.96-3.01 0-5.54-2.5-5.54-5.6 0-.87.2-1.69.55-2.41L3.5 7.4A9.16 9.16 0 0 0 2.9 12c0 5.12 4.08 9.2 9.1 9.2z"/>
                  <path fill="#34A853" d="M21.1 12c0-.6-.06-1.06-.14-1.54H12v3.6h5.02c-.22 1.3-1.52 3.8-5.02 3.8-1.89 0-3.5-.79-4.6-2.05l-3.3 2.56A9.2 9.2 0  0 0 12 21.2c5.25 0 8.7-3.68 8.7-8.86z"/>
                </svg>
              </button>

              <button id="facebookBtn" class="pbtn facebook" title="Continue with Facebook" aria-label="Continue with Facebook">
                <span class="sr-only">Continue with Facebook</span>
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path fill="#FFFFFF" d="M22 12.07C22 6.47 17.52 2 11.93 2 6.34 2 1.86 6.47 1.86 12.07c0 4.99 3.64 9.14 8.4 9.95v-7.03H7.96v-2.92h2.3V9.77c0-2.27 1.35-3.53 3.42-3.53.99 0 2.03.18 2.03.18v2.23h-1.14c-1.12 0-1.47.7-1.47 1.42v1.71h2.5l-.4 2.92h-2.1V22c4.77-.81 8.4-4.96 8.4-9.93z"/>
                </svg>
              </button>

              <button id="instagramBtn" class="pbtn instagram" title="Continue with Instagram" aria-label="Continue with Instagram">
                <span class="sr-only">Continue with Instagram</span>
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <rect x="3" y="3" width="18" height="18" rx="5" ry="5" fill="none" stroke="white" stroke-width="2"/>
                  <circle cx="12" cy="12" r="4.5" fill="none" stroke="white" stroke-width="2"/>
                  <circle cx="17.5" cy="6.5" r="1.5" fill="white"/>
                </svg>
              </button>

              <button id="tiktokBtn" class="pbtn tiktok" title="Continue with TikTok" aria-label="Continue with TikTok">
                <span class="sr-only">Continue with TikTok</span>
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M14.5 2v9.2a3.8 3.8 0 1 1-3-3.7" fill="none" stroke="#69C9D0" stroke-width="2" stroke-linecap="round"/>
                  <path d="M14.5 4.2c.9 1.6 2.6 3 4.5 3.2V10c-1.9-.1-3.4-.7-4.5-1.5v4.7a5.8 5.8 0 1 1-4.6-5.6" fill="none" stroke="#EE1D52" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </button>
            </div>
          </section>

          <p id="status" class="status" role="status" aria-live="polite"></p>
        </section>
      </div>
      <footer class="foot">¬© <span id="year"></span> BattleBillions</footer>
    </div>

    <!-- ===== Frame Route (loads existing pages inside the shell) ===== -->
    <div id="route-frame" class="route-frame">
      <div class="frame-wrap">
        <iframe id="pageFrame" class="route-iframe" title="BattleBillions View" allow="autoplay; clipboard-read; clipboard-write"></iframe>
      </div>
    </div>
  </main>

  <!-- ===================== APP LOGIC ===================== -->
  <script>
    // Year stamp
    document.getElementById("year").textContent = new Date().getFullYear();

    // Password toggle
    (function(){
      const pw = document.getElementById("password");
      const btn = document.getElementById("togglePw");
      btn.addEventListener("click", ()=>{
        const toType = pw.type === "password" ? "text" : "password";
        pw.type = toType;
        btn.setAttribute("aria-label", toType==="password" ? "Show password" : "Hide password");
      });
    })();

    // 3D Title parallax
    (function(){
      const wrap = document.getElementById("titleWrap");
      const el   = document.getElementById("title3d");
      if(!wrap || !el) return;
      let rect = null;
      const updateRect = ()=>{ rect = wrap.getBoundingClientRect(); };
      updateRect(); addEventListener("resize", updateRect, {passive:true});
      wrap.addEventListener("mousemove", (ev)=>{
        if(!rect) return;
        const x = (ev.clientX - rect.left)/rect.width - 0.5;
        const y = (ev.clientY - rect.top )/rect.height - 0.5;
        el.style.transform = `rotateY(${x*10}deg) rotateX(${-y*8}deg) translateZ(0)`;
      });
      wrap.addEventListener("mouseleave", ()=>{ el.style.transform = "rotateY(0deg) rotateX(0deg)"; });
    })();

    /* ===== Simple Hash Router (no auth blocking) ===== */
    const routes = {
      "/auth/login": { type:"auth" },
      "/auth/create": { type:"frame", src:"createaccount.html" },
      "/home":       { type:"frame", src:"home.html" },
      "/discover":   { type:"frame", src:"discover.html" },
      "/opponent":   { type:"frame", src:"opponent.html" },
      "/battle":     { type:"frame", src:"live.html" },
      "/leaderboard":{ type:"frame", src:"leaderboard.html" },
      "/profile":    { type:"frame", src:"profile.html" } // supports /profile/<uid>
    };

    const authView  = document.getElementById("route-auth");
    const frameView = document.getElementById("route-frame");
    const frameEl   = document.getElementById("pageFrame");

    function parseHash(){
      const raw = location.hash || "#/auth/login";
      const m = raw.match(/^#(\/[^?]*)/);
      const path = m ? m[1] : "/auth/login";
      const parts = path.split("/").filter(Boolean); // ["profile","uid"] etc
      const base = parts.length > 1 ? `/${parts[0]}` : `/${parts[0]||"auth"}`;
      const id = parts.length > 1 ? parts[1] : null;
      return { base, id };
    }

    function showAuth(){
      authView.classList.add("route-active");
      frameView.classList.remove("route-active");
    }
    function showFrame(src){
      // Avoid unnecessary reloads
      if(frameEl.src !== new URL(src, location.href).href){
        frameEl.src = src;
      }
      frameView.classList.add("route-active");
      authView.classList.remove("route-active");
    }

    function navigate(){
      const { base, id } = parseHash();
      const route = routes[base] || routes["/auth/login"];

      if(route.type === "auth"){
        showAuth();
        return;
      }

      if(route.type === "frame"){
        let src = route.src;
        if(base === "/profile" && id){ src = `${src}?uid=${encodeURIComponent(id)}`; }
        showFrame(src);
        return;
      }

      // Fallback
      showAuth();
    }

    window.addEventListener("hashchange", navigate);

    // Hook up buttons to routes (no auth blocking)
    document.getElementById("authForm").addEventListener("submit", (e)=>{
      e.preventDefault();
      location.hash = "/home";
    });
    document.getElementById("modeBtn").addEventListener("click", ()=>{ location.hash = "/auth/create"; });
    document.getElementById("googleBtn").addEventListener("click", ()=>{ location.hash = "/home"; });
    document.getElementById("facebookBtn").addEventListener("click", ()=>{ location.hash = "/home"; });
    document.getElementById("instagramBtn").addEventListener("click", ()=>{ location.hash = "/home"; });
    document.getElementById("tiktokBtn").addEventListener("click", ()=>{ location.hash = "/home"; });

    // Default route on first load
    if(!location.hash){ location.hash = "/auth/login"; }
    navigate();
  </script>

  <!-- Three.js background -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script>
  (function(){
    const reduced = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
    const DPR_LIMIT = 1.75;
    const MAX_EXPLOSIONS = reduced ? 6 : 12;
    const BLAST_INTERVAL = reduced ? 1700 : 1200;
    const START_WITH_BLAST = true;

    const canvas = document.getElementById('bg3d');
    try{
      const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
      if(!gl) throw new Error('WebGL not supported');
    }catch(e){
      console.warn('WebGL unavailable, showing gradient fallback.');
      return;
    }

    const renderer = new THREE.WebGLRenderer({ canvas, antialias:false, alpha:true, powerPreference:'high-performance' });
    renderer.setClearColor(0x000000, 0);
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x000000, reduced ? 0.0008 : 0.0012);

    let width = window.innerWidth, height = window.innerHeight;
    renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, DPR_LIMIT));
    renderer.setSize(width, height, false);

    const camera = new THREE.PerspectiveCamera(55, width/height, 0.1, 3000);
    camera.position.set(0, 0, 140);

    const hemi = new THREE.HemisphereLight(0xaaaaaa, 0x0a0a0a, 0.8);
    const dir  = new THREE.DirectionalLight(0xffe7a4, 0.7);
    dir.position.set(60, 80, 120);
    scene.add(hemi, dir);

    const particleTex = (function makeTex(){
      const size = 128, c = document.createElement('canvas'); c.width=c.height=size;
      const g = c.getContext('2d');
      const grad = g.createRadialGradient(size/2,size/2,0, size/2,size/2,size/2);
      grad.addColorStop(0,'rgba(255,255,255,0.95)');
      grad.addColorStop(0.35,'rgba(255,255,255,0.35)');
      grad.addColorStop(1,'rgba(255,255,255,0.0)');
      g.fillStyle = grad; g.fillRect(0,0,size,size);
      const tex = new THREE.CanvasTexture(c);
      tex.minFilter = THREE.LinearFilter; tex.magFilter = THREE.LinearFilter; tex.anisotropy = 1;
      return tex;
    })();

    const baseMat = new THREE.PointsMaterial({
      size: (reduced? 16 : 20),
      map: particleTex, transparent:true, depthWrite:false,
      blending:THREE.AdditiveBlending, vertexColors:true, sizeAttenuation:true
    });

    const ringMatStrong = new THREE.MeshBasicMaterial({ color:0xffd700, transparent:true, opacity:0.9, blending:THREE.AdditiveBlending, side:THREE.DoubleSide });
    const ringMatSoft   = new THREE.MeshBasicMaterial({ color:0xffe18a, transparent:true, opacity:0.6, blending:THREE.AdditiveBlending, side:THREE.DoubleSide });

    const pool = [];
    function getPoints(count){
      for(let i=pool.length-1;i>=0;i--){
        const p = pool[i];
        const existing = p.geometry.getAttribute('position').count;
        if(existing >= count){ pool.splice(i,1); p.visible=true; return p; }
      }
      const g = new THREE.BufferGeometry();
      const positions = new Float32Array(count*3);
      const colors    = new Float32Array(count*3);
      const sizes     = new Float32Array(count);
      g.setAttribute('position', new THREE.BufferAttribute(positions,3));
      g.setAttribute('color',    new THREE.BufferAttribute(colors,3));
      g.setAttribute('size',     new THREE.BufferAttribute(sizes,1));
      const m = baseMat.clone();
      const points = new THREE.Points(g, m);
      points.frustumCulled = false;
      return points;
    }
    function releasePoints(points){ points.visible=false; pool.push(points); }

    class Explosion {
      constructor(){
        const x = rand(-0.42*width, 0.42*width) / 6;
        const y = rand(-0.45* height, 0.45*height) / 6;
        const z = rand(-60, 20);
        this.center = new THREE.Vector3(x,y,z);

        this.life = reduced ? 1.5 : 1.9;
        this.t = 0;

        this.count = (Math.random()*50 + (reduced? 75 : 120)) | 0;
        this.points = getPoints(this.count);
        this.points.position.copy(this.center);

        const g = this.points.geometry;
        const pos = g.getAttribute('position').array;
        const col = g.getAttribute('color').array;
        const siz = g.getAttribute('size').array;

        this.vel = new Float32Array(this.count*3);
        for(let i=0;i<this.count;i++){
          const dirv = new THREE.Vector3().randomDirection();
          const speed = rand(12, 34);
          this.vel[i*3+0] = dirv.x*speed;
          this.vel[i*3+1] = dirv.y*speed;
          this.vel[i*3+2] = dirv.z*speed;

          pos[i*3+0] = dirv.x*1.6;
          pos[i*3+1] = dirv.y*1.6;
          pos[i*3+2] = dirv.z*1.6;

          col[i*3+0] = 1.0; col[i*3+1] = 1.0; col[i*3+2] = 1.0;
          siz[i] = rand(8, 14);
        }
        g.getAttribute('position').needsUpdate = true;
        g.getAttribute('color').needsUpdate    = true;
        g.getAttribute('size').needsUpdate     = true;

        scene.add(this.points);

        const ringGeo = new THREE.RingGeometry(5, 6.6, 64);
        this.ring1 = new THREE.Mesh(ringGeo, ringMatStrong.clone());
        this.ring2 = new THREE.Mesh(ringGeo, ringMatSoft.clone());
        this.ring1.position.copy(this.center);
        this.ring2.position.copy(this.center);
        this.r1 = 5; this.r2 = 5;
        scene.add(this.ring1, this.ring2);

        this.shake = 0.45;
      }

      update(dt){
        this.t += dt;
        const f = this.t/this.life;

        const g = this.points.geometry;
        const pos = g.getAttribute('position').array;
        const col = g.getAttribute('color').array;
        const siz = g.getAttribute('size').array;

        const drag = 1.0 - Math.min(0.05*dt*60, 0.05);

        for(let i=0;i<this.count;i++){
          const ix = i*3;
          pos[ix+0] += this.vel[ix+0]*dt;
          pos[ix+1] += this.vel[ix+1]*dt;
          pos[ix+2] += this.vel[ix+2]*dt;
          this.vel[ix+0] *= drag;
          this.vel[ix+1] *= drag;
          this.vel[ix+2] *= drag;

          const toGold = smoothstep(0.25, 0.55, f);
          col[ix+0] = lerp(1.0, 1.00, toGold);
          col[ix+1] = lerp(1.0, 0.72, toGold);
          col[ix+2] = lerp(1.0, 0.28, toGold);

          siz[i] *= (1 - dt*0.1);
          siz[i] = Math.max(7, siz[i]);
        }
        g.getAttribute('position').needsUpdate = true;
        g.getAttribute('color').needsUpdate    = true;
        g.getAttribute('size').needsUpdate     = true;

        this.r1 += 100*dt;
        this.r2 += 125*dt;
        this.ring1.scale.setScalar(this.r1/5);
        this.ring2.scale.setScalar(this.r2/5);
        this.ring1.material.opacity = Math.max(0, 0.95 - f*1.25);
        this.ring2.material.opacity = Math.max(0, 0.65 - f*1.3);
        this.ring1.lookAt(camera.position);
        this.ring2.lookAt(camera.position);

        if(this.shake>0){
          const s = this.shake*(1-f);
          camera.position.x += (Math.random()-0.5)*s;
          camera.position.y += (Math.random()-0.5)*s;
        }

        return this.t < this.life;
      }

      dispose(){
        scene.remove(this.points); releasePoints(this.points);
        scene.remove(this.ring1); scene.remove(this.ring2);
      }
    }

    const ambient = (function makeAmbient(){
      const COUNT = reduced ? 400 : 800;
      const g = new THREE.BufferGeometry();
      const positions = new Float32Array(COUNT*3);
      const colors    = new Float32Array(COUNT*3);
      for(let i=0;i<COUNT;i++){
        positions[i*3+0] = rand(-220,220);
        positions[i*3+1] = rand(-140,140);
        positions[i*3+2] = rand(-180,60);
        const t = Math.random()*0.5+0.35;
        colors[i*3+0] = t; colors[i*3+1] = t*0.9; colors[i*3+2] = t*0.85;
      }
      g.setAttribute('position', new THREE.BufferAttribute(positions,3));
      g.setAttribute('color', new THREE.BufferAttribute(colors,3));
      const m = new THREE.PointsMaterial({
        size: reduced ? 2.2 : 3.2, map:particleTex, transparent:true, depthWrite:false,
        vertexColors:true, blending:THREE.AdditiveBlending
      });
      const p = new THREE.Points(g,m);
      p.frustumCulled = false;
      p.userData = { t:0 };
      return p;
    })();
    scene.add(ambient);

    function rand(a,b){ return a + Math.random()*(b-a); }
    function lerp(a,b,t){ return a + (b-a)*t; }
    function smoothstep(a,b,x){ const t = Math.max(0, Math.min(1, (x-a)/(b-a))); return t*t*(3 - 2*t); }

    function resize(){
      width = window.innerWidth; height = window.innerHeight;
      renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, DPR_LIMIT));
      renderer.setSize(width, height, false);
      camera.aspect = width/height;
      camera.updateProjectionMatrix();
    }
    window.addEventListener('resize', resize, { passive:true });

    const explosions = [];
    let prev = performance.now(), lastBlast = prev;

    if(START_WITH_BLAST){ explosions.push(new Explosion()); }

    function loop(now){
      const dt = Math.min(0.05, (now - prev)/1000); prev = now;

      ambient.userData.t += dt*0.2;
      ambient.position.y = Math.sin(ambient.userData.t)*2;
      ambient.rotation.z += dt*0.02;

      if(now - lastBlast > BLAST_INTERVAL){
        if(explosions.length > MAX_EXPLOSIONS){
          const old = explosions.shift(); old.dispose();
        }
        explosions.push(new Explosion());
        lastBlast = now;
      }

      for(let i=explosions.length-1;i>=0;i--){
        if(!explosions[i].update(dt)){
          explosions[i].dispose();
          explosions.splice(i,1);
        }
      }

      camera.lookAt(0,0,0);
      renderer.render(scene, camera);
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);
  })();
  </script>

  <noscript>Enable JavaScript to use BattleBillions.</noscript>
</body>
</html>
