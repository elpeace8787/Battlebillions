<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3ATTLE33ILLIONS ‚Äî App</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --ink:#f5f5f5; --ink-2:#cecece; --muted:#8a8a8a;
      --google-border:#dadce0;
      --facebook:#1877F2;
      --twitter:#1DA1F2;
      --accent:#ffd700;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#000;color:var(--ink)}
    /* Background canvas */
    #bg3d{
      position:fixed; inset:0; width:100%; height:100%; display:block;
      pointer-events:none; background:radial-gradient(1200px 800px at 30% 20%, #101012 0%, #000 70%);
      z-index:0;
    }

    /* ====== APP SHELL ====== */
    .app-shell{position:relative; z-index:1; min-height:100vh; display:grid; place-items:center; padding:25px;}
    .stack{width:min(92vw,980px); display:grid; gap:18px}
    header{text-align:center}

    /* ===== Advanced 3D Title ===== */
    .title-wrap{ perspective:1200px; display:inline-block; user-select:none; }
    .title-3d{ position:relative; display:inline-block; transform-style:preserve-3d; transition:transform .3s ease; }
    header h1{
      --shine: linear-gradient(180deg, #fafafa 0%, #dcdcdc 28%, #a9a9a9 55%, #f3f3f3 82%);
      margin:0; font-size:38px; letter-spacing:.6px; text-transform:uppercase; line-height:1;
      background:
        linear-gradient(120deg, rgba(255,255,255,.18) 0%, rgba(255,255,255,0) 22% 78%, rgba(255,255,255,.18) 100%),
        var(--shine);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      filter: drop-shadow(0 8px 22px rgba(0,0,0,.35)) drop-shadow(0 2px 8px rgba(255,215,0,.18));
      position:relative; z-index:2; animation:titleGlow 7.2s ease-in-out infinite;
    }
    header h1::before{
      content:"3ATTLE33ILLIONS"; position:absolute; inset:0; color:#0e0e10; opacity:.5; z-index:-1;
      transform: translate3d(0, 0, -3px); filter: blur(.6px);
      text-shadow: 0 1px 0 #09090a, 0 2px 0 #0b0b0d, 0 3px 0 #0d0d10, 0 4px 0 #0f0f12;
    }
    header h1::after{
      content:"3ATTLE33ILLIONS"; position:absolute; inset:0; z-index:3;
      background: linear-gradient(90deg, rgba(255,215,0,.0), rgba(255,215,0,.55), rgba(255,215,0,.0));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      mix-blend-mode:screen; opacity:.55; animation: rimSweep 3.6s linear infinite;
    }
    .title-sheen{
      position:absolute; left:-8%; top:-20%; width:120%; height:140%;
      background: linear-gradient(100deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.22) 50%, rgba(255,255,255,0) 100%);
      transform: translateZ(8px) skewX(-18deg); pointer-events:none; filter: blur(8px) opacity(.55);
      animation: sheenSlide 4.8s ease-in-out infinite;
    }
    @keyframes sheenSlide{
      0%{ transform:translate(-20%, -10%) skewX(-18deg) translateZ(8px); opacity:.25 }
      50%{ transform:translate(10%, 0%) skewX(-18deg) translateZ(8px); opacity:.6 }
      100%{ transform:translate(-20%, -10%) skewX(-18deg) translateZ(8px); opacity:.25 }
    }
    @keyframes rimSweep{
      0%{ clip-path: polygon(0 0, 12% 0, 18% 100%, 0 100%); }
      50%{ clip-path: polygon(40% 0, 62% 0, 58% 100%, 36% 100%); }
      100%{ clip-path: polygon(88% 0, 100% 0, 100% 100%, 82% 100%); }
    }
    @keyframes titleGlow{
      0%,100%{ filter: drop-shadow(0 8px 22px rgba(0,0,0,.35)) drop-shadow(0 2px 8px rgba(255,215,0,.18)); }
      50%{    filter: drop-shadow(0 10px 26px rgba(0,0,0,.45)) drop-shadow(0 2px 12px rgba(255,235,140,.28)); }
    }

    /* ===== Forms / Buttons ===== */
    .form{display:grid; gap:12px}
    .btn, input, select{
      width:100%; padding:12px 16px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(15,15,17,.28);
      -webkit-backdrop-filter: blur(6px) saturate(120%);
      backdrop-filter: blur(6px) saturate(120%);
      color:var(--ink); transition:transform .16s ease, background .16s ease, border-color .16s ease, box-shadow .16s ease;
      cursor:pointer;
    }
    .btn:hover{transform:translateY(-2px)}
    .btn.primary{background:#fff;color:#000;border-color:transparent}
    .btn.primary:hover{background:#ececec}
    .btn.ghost{background:transparent;border-color:#3a3a3a}
    .btn.ghost:hover{border-color:#fff}

    label{font-size:12px;color:var(--ink-2)}
    input:focus, select:focus{outline:0;border-color:#fff;box-shadow:0 0 6px rgba(255,255,255,.25)}
    .pw-wrap{position:relative}
    .pw-toggle{position:absolute; right:10px; top:50%; transform:translateY(-50%); border:0; background:transparent; color:var(--muted); cursor:pointer; font-size:14px;}
    .actions{display:flex; gap:12px; margin-top:4px; flex-wrap:wrap}

    .divider{display:flex;align-items:center;gap:10px;margin:2px 0 6px}
    .divider::before,.divider::after{content:"";flex:1;height:1px;background:rgba(255,255,255,.12)}
    .divider span{font-size:12px;color:var(--muted)}

    .providers{display:grid; gap:10px}
    .provider-bar{ display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }
    .pbtn{
      width:44px; height:44px; border-radius:10px; display:inline-flex;
      align-items:center; justify-content:center; border:1px solid rgba(255,255,255,.14);
      background:rgba(15,15,17,.35); backdrop-filter: blur(6px) saturate(120%);
      transition:transform .16s ease, box-shadow .16s ease, border-color .16s ease;
    }
    .pbtn:hover{ transform:translateY(-2px); border-color:rgba(255,255,255,.3) }
    .pbtn svg{ width:22px; height:22px; }
    .pbtn.google{ background:rgba(255,255,255,0.9); border-color:var(--google-border) }
    .pbtn.facebook{ background:rgba(24,119,242,0.9); border-color:rgba(24,119,242,1) }
    .pbtn.twitter{ background:rgba(29,161,242,0.95); border-color:#1a8cd8 }

    .status{min-height:18px;font-size:12px;text-align:center;color:var(--muted)}
    .foot{position:fixed;left:0;right:0;bottom:12px;text-align:center;font-size:12px;color:var(--muted)}

    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .hidden{display:none !important;}

    @media (prefers-reduced-motion: reduce){ #bg3d{opacity:.6} .title-3d{transform:none !important} .title-sheen{animation:none} header h1{animation:none} }

    /* ===== Routes ===== */
    .route-auth{display:block;}
    .route-frame{display:none;}
    .route-active{display:block !important;}

    /* Auth subviews */
    #view-auth, #view-create { display:none; }
    #view-auth.active, #view-create.active { display:block; }

    /* Create wizard steps */
    .step{display:none}
    .step.active{display:block}

    /* Frame system for non-auth routes */
    .frame-wrap{ position:fixed; inset:0; z-index:2; overflow:hidden; }
    .route-iframe{
      position:absolute; inset:0; width:100%; height:100%; border:0; background:transparent;
      opacity:0; transition:opacity .18s ease; pointer-events:none;
    }
    .route-iframe.visible{opacity:1; pointer-events:auto;}

    /* When frames are active, hide entire auth container */
    .app-shell.frame-active #route-auth { display: none !important; }
  </style>
</head>
<body>
  <!-- Background explosions -->
  <canvas id="bg3d"></canvas>

  <main class="app-shell">
    <!-- ===== Auth container (has Login + Create as subviews) ===== -->
    <div id="route-auth" class="route-auth route-active">
      <div class="stack">
        <header>
          <div class="title-wrap" id="titleWrap">
            <div class="title-3d" id="title3d">
              <h1>3ATTLE33ILLIONS</h1>
              <span class="title-sheen" aria-hidden="true"></span>
            </div>
          </div>
        </header>

        <!-- ===== LOGIN VIEW ===== -->
        <section id="view-auth" class="active">
          <form id="authForm" class="form" autocomplete="on">
            <div class="row">
              <label for="email">Email</label>
              <input id="email" type="email" placeholder="you@example.com" required />
            </div>
            <div class="row">
              <label for="password">Password</label>
              <div class="pw-wrap">
                <input id="password" type="password" minlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
                <button type="button" id="togglePw" class="pw-toggle" aria-label="Show password">üëÅ</button>
              </div>
            </div>
            <div class="actions">
              <button id="submitBtn" type="submit" class="btn primary">Sign In</button>
              <button id="modeBtn" type="button" class="btn ghost">Create account</button>
            </div>
          </form>

          <div class="divider"><span>or continue with</span></div>
          <section class="providers">
            <div class="provider-bar">
              <!-- Google -->
              <button id="googleBtn" class="pbtn google" title="Continue with Google" aria-label="Continue with Google">
                <span class="sr-only">Continue with Google</span>
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path fill="#EA4335" d="M12 10.2v3.6h5.02c-.22 1.3-1.52 3.8-5.02 3.8-3.03 0-5.5-2.5-5.5-5.6s2.47-5.6 5.5-5.6c1.73 0 2.9.73 3.57 1.36l2.43-2.36C16.7 3.7 14.55 2.8 12 2.8 6.98 2.8 2.9 6.88 2.9 12s4.08 9.2 9.1 9.2c5.25 0 8.7-3.68 8.7-8.86 0-.6-.06-1.06-.14-1.54H12z"/>
                  <path fill="#FBBC05" d="M12 21.2c2.88 0 5.3-.94 7.07-2.56l-3.3-2.7c-.89.6-2.07.96-3.77.96-3.01 0-5.54-2.5-5.54-5.6 0-.87.2-1.69.55-2.41L3.5 7.4A9.16 9.16 0 0 0 2.9 12c0 5.12 4.08 9.2 9.1 9.2z"/>
                  <path fill="#34A853" d="M21.1 12c0-.6-.06-1.06-.14-1.54H12v3.6h5.02c-.22 1.3-1.52 3.8-5.02 3.8-1.89 0-3.5-.79-4.6-2.05l-3.3 2.56A9.2 9.2 0  0 0 12 21.2c5.25 0 8.7-3.68 8.7-8.86z"/>
                </svg>
              </button>

              <!-- Facebook -->
              <button id="facebookBtn" class="pbtn facebook" title="Continue with Facebook" aria-label="Continue with Facebook">
                <span class="sr-only">Continue with Facebook</span>
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path fill="#FFFFFF" d="M22 12.07C22 6.47 17.52 2 11.93 2 6.34 2 1.86 6.47 1.86 12.07c0 4.99 3.64 9.14 8.4 9.95v-7.03H7.96v-2.92h2.3V9.77c0-2.27 1.35-3.53 3.42-3.53.99 0 2.03.18 2.03.18v2.23h-1.14c-1.12 0-1.47.7-1.47 1.42v1.71h2.5l-.4 2.92h-2.1V22c4.77-.81 8.4-4.96 8.4-9.93z"/>
                </svg>
              </button>

              <!-- Twitter -->
              <button id="twitterBtn" class="pbtn twitter" title="Continue with Twitter" aria-label="Continue with Twitter">
                <span class="sr-only">Continue with Twitter</span>
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path fill="#ffffff" d="M23 5.92a9.54 9.54 0 0 1-2.77.76 4.81 4.81 0 0 0 2.1-2.65 9.6 9.6 0 0 1-3.04 1.17 4.78 4.78 0 0 0-8.14 4.36A13.58 13.58 0 0 1 3.16 4.6a4.78 4.78 0 0 0 1.48 6.38 4.74 4.74 0 0 1-2.16-.6v.06a4.78 4.78 0 0 0 3.83 4.69 4.8 4.8 0 0 1-2.15.08 4.78 4.78 0 0 0 4.46 3.31A9.59 9.59 0 0 1 2 20.54a13.53 13.53 0 0 0 7.32 2.15c8.79 0 13.6-7.28 13.6-13.6 0-.21 0-.42-.02-.63A9.71 9.71 0 0 0 23 5.92z"/>
                </svg>
              </button>
            </div>
          </section>

          <p id="status" class="status" role="status" aria-live="polite"></p>
        </section>

        <!-- ===== CREATE ACCOUNT VIEW (merged wizard) ===== -->
        <section id="view-create">
          <!-- step 1 -->
          <form id="createStep1" class="form step active" autocomplete="on">
            <p class="status" id="createStatus1"></p>

            <div id="credBlock">
              <div class="row">
                <label for="caEmail">Email</label>
                <input id="caEmail" type="email" placeholder="you@example.com" autocomplete="email" />
              </div>
              <div class="row">
                <label for="caPassword">Password</label>
                <input id="caPassword" type="password" minlength="6" placeholder="At least 6 characters" autocomplete="new-password" />
              </div>
              <div class="row">
                <label for="caConfirm">Confirm Password</label>
                <input id="caConfirm" type="password" minlength="6" placeholder="Re-enter password" autocomplete="new-password" />
              </div>
              <div class="divider"></div>
            </div>

            <div class="row">
              <label for="username">Username <span class="sr-only">(required)</span></label>
              <input id="username" type="text" maxlength="24" placeholder="e.g., elpeace8787" required />
            </div>

            <div class="actions">
              <button type="submit" class="btn primary">Next</button>
              <button type="button" id="step1Back" class="btn ghost">Back</button>
            </div>
          </form>

          <!-- step 2 -->
          <form id="createStep2" class="form step" autocomplete="on">
            <p class="status" id="createStatus2"></p>

            <div class="row">
              <label>Date of Birth</label>
              <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px">
                <select id="dobMonth" required>
                  <option value="">Month</option>
                  <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option>
                  <option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option>
                  <option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option>
                  <option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
                </select>
                <select id="dobDay" required><option value="">Day</option></select>
                <select id="dobYear" required><option value="">Year</option></select>
              </div>
            </div>

            <div id="badgePreview" class="status"></div>

            <div class="actions">
              <button type="button" id="step2Back" class="btn ghost">Back</button>
              <button type="submit" id="createSubmit" class="btn primary">Save & Continue</button>
            </div>
          </form>
        </section>
      </div>

      <footer class="foot">¬© <span id="year"></span> BattleBillions</footer>
    </div>

    <!-- ===== Frame Route (for non-auth pages) ===== -->
    <div id="route-frame" class="route-frame">
      <div class="frame-wrap">
        <iframe id="frameA" class="route-iframe visible"  title="BattleBillions View A" allow="autoplay; clipboard-read; clipboard-write"></iframe>
        <iframe id="frameB" class="route-iframe"          title="BattleBillions View B" allow="autoplay; clipboard-read; clipboard-write"></iframe>
      </div>
    </div>
  </main>

  <!-- ===================== APP LOGIC ===================== -->
  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    // Password toggle (login)
    (function(){
      const pw = document.getElementById("password");
      const btn = document.getElementById("togglePw");
      btn.addEventListener("click", ()=>{
        const toType = pw.type === "password" ? "text" : "password";
        pw.type = toType;
        btn.setAttribute("aria-label", toType==="password" ? "Show password" : "Hide password");
      });
    })();

    // 3D Title parallax
    (function(){
      const wrap = document.getElementById("titleWrap");
      const el   = document.getElementById("title3d");
      if(!wrap || !el) return;
      let rect = null;
      const updateRect = ()=>{ rect = wrap.getBoundingClientRect(); };
      updateRect(); addEventListener("resize", updateRect, {passive:true});
      wrap.addEventListener("mousemove", (ev)=>{
        if(!rect) return;
        const x = (ev.clientX - rect.left)/rect.width - 0.5;
        const y = (ev.clientY - rect.top )/rect.height - 0.5;
        el.style.transform = `rotateY(${x*10}deg) rotateX(${-y*8}deg) translateZ(0)`;
      });
      wrap.addEventListener("mouseleave", ()=>{ el.style.transform = "rotateY(0deg) rotateX(0deg)"; });
    })();

    /* ===== Hash Router ===== */
    const routes = {
      "/auth/login":  { type:"auth", sub:"login" },
      "/auth/create": { type:"auth", sub:"create" },
      "/home":        { type:"frame", src:"home.html" },
      "/discover":    { type:"frame", src:"discover.html" },
      "/opponent":    { type:"frame", src:"opponent.html" },
      "/battle":      { type:"frame", src:"live.html" },
      "/leaderboard": { type:"frame", src:"leaderboard.html" },
      "/profile":     { type:"frame", src:"profile.html" }
    };

    const authContainer = document.getElementById("route-auth");
    const loginView     = document.getElementById("view-auth");
    const createView    = document.getElementById("view-create");
    const frameView     = document.getElementById("route-frame");
    const appShell      = document.querySelector(".app-shell");
    const statusEl      = document.getElementById("status");
    const cs1           = document.getElementById("createStatus1");
    const cs2           = document.getElementById("createStatus2");

    // Double-buffer iframes
    const frameA = document.getElementById("frameA");
    const frameB = document.getElementById("frameB");
    let visible = frameA;
    let hidden  = frameB;

    function setAuthSubview(which){
      loginView.classList.remove("active");
      createView.classList.remove("active");
      if (which === "login") loginView.classList.add("active");
      if (which === "create") createView.classList.add("active");
    }

    function parseHash(){
      const raw  = location.hash || "#/auth/login";
      const [path, query] = raw.slice(1).split("?");
      const parts = path.split("/").filter(Boolean);

      if (parts[0] === "auth" && (parts[1] === "login" || parts[1] === "create")){
        return { base: `/auth/${parts[1]}`, query: new URLSearchParams(query||"") };
      }
      if (parts[0] === "profile" && parts[1]) {
        return { base: "/profile", id: parts[1], query: new URLSearchParams(query||"") };
      }
      const base = `/${parts[0] || "auth"}`;
      if (base === "/auth") return { base:"/auth/login", query:new URLSearchParams(query||"") };
      return { base, query:new URLSearchParams(query||"") };
    }

    function showAuth(sub){
      appShell.classList.remove("frame-active");
      frameView.classList.remove("route-active");
      authContainer.classList.add("route-active");
      setAuthSubview(sub);
      // Toggle wizard default step
      if(sub==="create"){setStep(1);}
    }

    function showFrame(src){
      appShell.classList.add("frame-active");
      authContainer.classList.remove("route-active");
      frameView.classList.add("route-active");

      const abs = new URL(src, location.href).href;
      if (visible.src === abs) return;

      hidden.removeAttribute("src");
      hidden.classList.remove("visible");
      hidden.addEventListener("load", ()=>{
        visible.classList.remove("visible");
        hidden.classList.add("visible");
        const tmp = visible; visible = hidden; hidden = tmp;
        hidden.removeAttribute("src");
        hidden.classList.remove("visible");
      }, { once:true });
      hidden.src = src;
    }

    function navigate(){
      const { base, id, query } = parseHash();
      const route = routes[base] || routes["/auth/login"];

      if (route.type === "auth"){
        const sub = route.sub === "create" ? "create" : "login";
        showAuth(sub);
        window.__completionMode = (sub === "create" && (query && query.get("mode")==="complete"));
        updateCreateUIForMode();
        return;
      }

      if (route.type === "frame"){
        let src = route.src;
        if (base === "/profile" && id) src = `${src}?uid=${encodeURIComponent(id)}`;
        showFrame(src);
        return;
      }

      showAuth("login");
    }

    window.addEventListener("hashchange", navigate);
    document.getElementById("authForm").addEventListener("submit", (e)=>{
      e.preventDefault();
      location.hash = "/home"; // wire real email login later if needed
    });
    document.getElementById("modeBtn").addEventListener("click", ()=>{ location.hash = "/auth/create"; });

    if(!location.hash){ location.hash = "/auth/login"; }
    navigate();

    // ===== Create wizard state
    const step1 = document.getElementById('createStep1');
    const step2 = document.getElementById('createStep2');
    function setStep(n){
      step1.classList.toggle('active', n===1);
      step2.classList.toggle('active', n===2);
      cs1.textContent = ""; cs2.textContent = "";
    }
    document.getElementById('step1Back').addEventListener('click', ()=>{
      if (completionMode()) location.hash="/home"; else location.hash="/auth/login";
    });
    document.getElementById('step2Back').addEventListener('click', ()=> setStep(1));

    // DOB options
    (function initDOBOptions(){
      const mEl = document.getElementById('dobMonth');
      const dEl = document.getElementById('dobDay');
      const yEl = document.getElementById('dobYear');
      const now = new Date();
      const currentYear = now.getFullYear();
      const minYear = currentYear - 100;
      for(let y=currentYear; y>=minYear; y--) {
        const opt = document.createElement('option');
        opt.value = String(y); opt.textContent = String(y);
        yEl.appendChild(opt);
      }
      function fillDays(){
        const m = parseInt(mEl.value||'0',10);
        const y = parseInt(yEl.value||'0',10);
        const daysInMonth = (m && y) ? new Date(y, m, 0).getDate() : 31;
        const cur = dEl.value;
        dEl.innerHTML = '<option value="">Day</option>';
        for(let d=1; d<=daysInMonth; d++){
          const opt = document.createElement('option');
          opt.value=String(d); opt.textContent=String(d);
          dEl.appendChild(opt);
        }
        if(cur && parseInt(cur,10)<=daysInMonth) dEl.value = cur;
      }
      mEl.addEventListener('change', fillDays);
      yEl.addEventListener('change', fillDays);
      fillDays();
    })();

    // Helpers shared with module script
    window.__sanitizeUsername = u => (u||"").trim().toLowerCase().replace(/\s+/g,'').replace(/[^a-z0-9._-]/g,'').slice(0,24);
    window.__completionMode = false;
    function completionMode(){ return !!window.__completionMode; }
    function updateCreateUIForMode(){
      const credBlock = document.getElementById('credBlock');
      credBlock.style.display = completionMode() ? "none" : "";
    }

  </script>

  <!-- ===== Firebase auth + social fallback + wizard save ===== -->
  <script type="module">
    import {
      auth, db,
      googleProvider, facebookProvider, twitterProvider,
      signInWithPopup, signInWithRedirect, getRedirectResult, onAuthStateChanged,
      // optionally provided by your firebase.js; if not, we‚Äôll import from CDN below
      createUserWithEmailAndPassword,
      doc, getDoc, setDoc, serverTimestamp
    } from "./firebase.js";

    // Fallback if createUserWithEmailAndPassword isn't exported from your file
    let createUserFn = createUserWithEmailAndPassword;
    if (!createUserFn) {
      const m = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
      createUserFn = m.createUserWithEmailAndPassword;
    }

    const statusEl = document.getElementById("status");
    const cs1 = document.getElementById("createStatus1");
    const cs2 = document.getElementById("createStatus2");
    const badgePreview = document.getElementById("badgePreview");

    // Chinese New Year (1980‚Äì2030)
    const CNY = {1980:"1980-02-16",1981:"1981-02-05",1982:"1982-01-25",1983:"1983-02-13",1984:"1984-02-02",
      1985:"1985-02-20",1986:"1986-02-09",1987:"1987-01-29",1988:"1988-02-17",1989:"1989-02-06",
      1990:"1990-01-27",1991:"1991-02-15",1992:"1992-02-04",1993:"1993-01-23",1994:"1994-02-10",
      1995:"1995-01-31",1996:"1996-02-19",1997:"1997-02-07",1998:"1998-01-28",1999:"1999-02-16",
      2000:"2000-02-05",2001:"2001-01-24",2002:"2002-02-12",2003:"2003-02-01",2004:"2004-01-22",
      2005:"2005-02-09",2006:"2006-01-29",2007:"2007-02-18",2008:"2008-02-07",2009:"2009-01-26",
      2010:"2010-02-14",2011:"2011-02-03",2012:"2012-01-23",2013:"2013-02-10",2014:"2014-01-31",
      2015:"2015-02-19",2016:"2016-02-08",2017:"2017-01-28",2018:"2018-02-16",2019:"2019-02-05",
      2020:"2020-01-25",2021:"2021-02-12",2022:"2022-02-01",2023:"2023-01-22",2024:"2024-02-10",
      2025:"2025-01-29",2026:"2026-02-17",2027:"2027-02-06",2028:"2028-01-26",2029:"2029-02-13",
      2030:"2030-02-03"};
    const CH_ANIMALS = ["Rat","Ox","Tiger","Rabbit","Dragon","Snake","Horse","Goat","Monkey","Rooster","Dog","Pig"];
    const pad = n => String(n).padStart(2,'0');
    const iso = (y,m,d) => `${y}-${pad(m)}-${pad(d)}`;
    const computeAge = (dob)=>{
      const today = new Date();
      let age = today.getFullYear() - dob.getFullYear();
      const m = today.getMonth() - dob.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;
      return age;
    };
    const westernZodiac = (m,d)=>{
      const s=[{n:"Capricorn",f:[12,22],t:[1,19]},{n:"Aquarius",f:[1,20],t:[2,18]},{n:"Pisces",f:[2,19],t:[3,20]},
               {n:"Aries",f:[3,21],t:[4,19]},{n:"Taurus",f:[4,20],t:[5,20]},{n:"Gemini",f:[5,21],t:[6,20]},
               {n:"Cancer",f:[6,21],t:[7,22]},{n:"Leo",f:[7,23],t:[8,22]},{n:"Virgo",f:[8,23],t:[9,22]},
               {n:"Libra",f:[9,23],t:[10,22]},{n:"Scorpio",f:[10,23],t:[11,21]},{n:"Sagittarius",f:[11,22],t:[12,21]}];
      for(const x of s){const[fm,fd]=x.f,[tm,td]=x.t;if(fm<=tm){if((m>fm||(m===fm&&d>=fd))&&(m<tm||(m===tm&&d<=td)))return x.n;}else{if((m>fm||(m===fm&&d>=fd))||(m<tm||(m===tm&&d<=td)))return x.n;}}
      return "Capricorn";
    };
    const chineseZodiac = (y,m,d)=>{
      let year=y;
      if(CNY[y]){
        const cny = new Date(CNY[y]+"T00:00:00Z");
        const dob = new Date(`${iso(y,m,d)}T00:00:00Z`);
        if(dob < cny) year=y-1;
      }
      const idx=(year-1900)%12;
      return CH_ANIMALS[(idx+12)%12];
    };
    const sanitizeUsername = u => (u||"").trim().toLowerCase().replace(/\s+/g,'').replace(/[^a-z0-9._-]/g,'').slice(0,24);

    async function ensureUserDoc(user){
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref, {
          email: user.email || "",
          avatarURL: user.photoURL || "",
          createdAt: serverTimestamp(),
          username:null, dob:null, age:null, westernZodiac:null, chineseZodiac:null
        });
        return {existed:false, data:null};
      }
      return {existed:true, data:snap.data()};
    }
    const needsCompletion = (data)=>!(data && data.username && data.dob && data.age && data.westernZodiac && data.chineseZodiac);

    // ===== Social Login (Popup with Redirect fallback)
    async function socialSignIn(provider){
      statusEl.textContent = "";
      try{
        // Attempt popup
        await signInWithPopup(auth, provider);
        // success handled by onAuthStateChanged below
      }catch(err){
        // If popup blocked or requires redirect, fallback
        if (err && (err.code === "auth/popup-blocked" || err.code === "auth/operation-not-supported-in-this-environment")) {
          try{
            await signInWithRedirect(auth, provider);
          }catch(e2){
            statusEl.textContent = e2?.message || "Social sign-in failed.";
          }
        } else {
          statusEl.textContent = err?.message || "Social sign-in failed.";
        }
      }
    }

    // Handle redirect result on load (covers Twitter/Facebook/Google)
    getRedirectResult(auth).then(async (res)=>{
      if(!res) return;
      const user = res.user;
      const { data } = await ensureUserDoc(user);
      if (needsCompletion(data)) location.hash="/auth/create?mode=complete"; else location.hash="/home";
    }).catch(err=>{
      if (err && err.message) statusEl.textContent = err.message;
    });

    document.getElementById("googleBtn")?.addEventListener("click", ()=> socialSignIn(googleProvider));
    document.getElementById("facebookBtn")?.addEventListener("click", ()=> socialSignIn(facebookProvider));
    document.getElementById("twitterBtn")?.addEventListener("click", ()=> socialSignIn(twitterProvider));

    onAuthStateChanged(auth, async (u)=>{
      if(!u) return;
      if(location.hash.startsWith("#/auth")){
        const ref = doc(db, "users", u.uid);
        const snap = await getDoc(ref);
        if(!snap.exists() || needsCompletion(snap.data())){
          location.hash = "/auth/create?mode=complete";
        }else{
          location.hash = "/home";
        }
      }
    });

    // ===== Create Wizard Logic
    const step1Form = document.getElementById('createStep1');
    const step2Form = document.getElementById('createStep2');
    const caEmailEl   = document.getElementById("caEmail");
    const caPwEl      = document.getElementById("caPassword");
    const caConfirmEl = document.getElementById("caConfirm");
    const usernameEl  = document.getElementById("username");

    const mEl = document.getElementById('dobMonth');
    const dEl = document.getElementById('dobDay');
    const yEl = document.getElementById('dobYear');

    function setStep(n){
      step1Form.classList.toggle('active', n===1);
      step2Form.classList.toggle('active', n===2);
      cs1.textContent = ""; cs2.textContent = "";
      // preview badges when entering step 2
      if(n===2) previewBadges();
    }
    window.setStep = setStep; // reuse from router‚Äôs call

    function completionMode(){ return !!window.__completionMode; }
    function updateCreateUIForMode(){
      const credBlock = document.getElementById('credBlock');
      credBlock.style.display = completionMode() ? "none" : "";
    }
    window.addEventListener("hashchange", updateCreateUIForMode);
    updateCreateUIForMode();

    step1Form.addEventListener('submit', (e)=>{
      e.preventDefault();
      cs1.textContent = "";
      const uname = sanitizeUsername(usernameEl.value);
      if(!uname){ cs1.textContent="Please enter a valid username."; return; }

      if (!completionMode()){
        const email = (caEmailEl.value||"").trim();
        const pw    = caPwEl.value||"";
        const cfm   = caConfirmEl.value||"";
        if(!email || !pw || !cfm){ cs1.textContent="Fill email and both password fields."; return; }
        if(pw.length<6){ cs1.textContent="Password must be at least 6 characters."; return; }
        if(pw !== cfm){ cs1.textContent="Passwords do not match."; return; }
      }
      setStep(2);
    });

    function previewBadges(){
      const m = parseInt(mEl.value||"0",10);
      const d = parseInt(dEl.value||"0",10);
      const y = parseInt(yEl.value||"0",10);
      if(!m || !d || !y){ badgePreview.textContent = ""; return; }
      const dobISO = iso(y,m,d);
      const dob = new Date(`${dobISO}T00:00:00`);
      const age = computeAge(dob);
      const wz = westernZodiac(m,d);
      const cz = chineseZodiac(y,m,d);
      badgePreview.textContent = `Age: ${age} ‚Ä¢ Western: ${wz} ‚Ä¢ Chinese: ${cz}`;
    }
    mEl.addEventListener('change', previewBadges);
    dEl.addEventListener('change', previewBadges);
    yEl.addEventListener('change', previewBadges);

    step2Form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      cs2.textContent = "";

      const uname = sanitizeUsername(usernameEl.value);
      if(!uname){ cs2.textContent="Username missing."; return; }

      const m = parseInt(mEl.value||"0",10);
      const d = parseInt(dEl.value||"0",10);
      const y = parseInt(yEl.value||"0",10);
      if(!m || !d || !y){ cs2.textContent="Select your full date of birth."; return; }

      const dobISO = iso(y,m,d);
      const dob = new Date(`${dobISO}T00:00:00`);
      const age = computeAge(dob);
      if (age < 13){ cs2.textContent="You must be at least 13 years old to play."; return; }

      const wz = westernZodiac(m,d);
      const cz = chineseZodiac(y,m,d);

      try{
        let user = auth.currentUser;

        if (!completionMode()){
          const email = (caEmailEl.value||"").trim();
          const pw    = caPwEl.value||"";
          // Create account
          const cred = await createUserFn(auth, email, pw);
          user = cred.user;

          // Initialize doc
          const ref = doc(db, "users", user.uid);
          await setDoc(ref, {
            email, avatarURL: user.photoURL || "", createdAt: serverTimestamp(),
            username: uname, dob: dobISO, age, westernZodiac: wz, chineseZodiac: cz
          }, { merge:true });

        } else {
          if(!user){ cs2.textContent="Please sign in again to finish profile."; return; }
          const ref = doc(db, "users", user.uid);
          await setDoc(ref, {
            username: uname, dob: dobISO, age, westernZodiac: wz, chineseZodiac: cz
          }, { merge:true });
        }

        location.hash="/home";
      }catch(err){
        cs2.textContent = err?.message || "Could not save your profile.";
      }
    });

  </script>

  <!-- Three.js background -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script>
  (function(){
    const reduced = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
    const DPR_LIMIT = 1.75;
    const MAX_EXPLOSIONS = reduced ? 6 : 12;
    const BLAST_INTERVAL = reduced ? 1700 : 1200;
    const START_WITH_BLAST = true;

    const canvas = document.getElementById('bg3d');
    try{
      const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
      if(!gl) throw new Error('WebGL not supported');
    }catch(e){
      console.warn('WebGL unavailable, showing gradient fallback.');
      return;
    }

    const renderer = new THREE.WebGLRenderer({ canvas, antialias:false, alpha:true, powerPreference:'high-performance' });
    renderer.setClearColor(0x000000, 0);
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x000000, reduced ? 0.0008 : 0.0012);

    let width = window.innerWidth, height = window.innerHeight;
    renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, DPR_LIMIT));
    renderer.setSize(width, height, false);

    const camera = new THREE.PerspectiveCamera(55, width/height, 0.1, 3000);
    camera.position.set(0, 0, 140);

    const hemi = new THREE.HemisphereLight(0xaaaaaa, 0x0a0a0a, 0.8);
    const dir  = new THREE.DirectionalLight(0xffe7a4, 0.7);
    dir.position.set(60, 80, 120);
    scene.add(hemi, dir);

    const particleTex = (function makeTex(){
      const size = 128, c = document.createElement('canvas'); c.width=c.height=size;
      const g = c.getContext('2d');
      const grad = g.createRadialGradient(size/2,size/2,0, size/2,size/2,size/2);
      grad.addColorStop(0,'rgba(255,255,255,0.95)');
      grad.addColorStop(0.35,'rgba(255,255,255,0.35)');
      grad.addColorStop(1,'rgba(255,255,255,0.0)');
      g.fillStyle = grad; g.fillRect(0,0,size,size);
      const tex = new THREE.CanvasTexture(c);
      tex.minFilter = THREE.LinearFilter; tex.magFilter = THREE.LinearFilter; tex.anisotropy = 1;
      return tex;
    })();

    const baseMat = new THREE.PointsMaterial({
      size: (reduced? 16 : 20),
      map: particleTex, transparent:true, depthWrite:false,
      blending:THREE.AdditiveBlending, vertexColors:true, sizeAttenuation:true
    });

    const ringMatStrong = new THREE.MeshBasicMaterial({ color:0xffd700, transparent:true, opacity:0.9, blending:THREE.AdditiveBlending, side:THREE.DoubleSide });
    const ringMatSoft   = new THREE.MeshBasicMaterial({ color:0xffe18a, transparent:true, opacity:0.6, blending:THREE.AdditiveBlending, side:THREE.DoubleSide });

    const pool = [];
    function getPoints(count){
      for(let i=pool.length-1;i>=0;i--){
        const p = pool[i];
        const existing = p.geometry.getAttribute('position').count;
        if(existing >= count){ pool.splice(i,1); p.visible=true; return p; }
      }
      const g = new THREE.BufferGeometry();
      const positions = new Float32Array(count*3);
      const colors    = new Float32Array(count*3);
      const sizes     = new Float32Array(count);
      g.setAttribute('position', new THREE.BufferAttribute(positions,3));
      g.setAttribute('color',    new THREE.BufferAttribute(colors,3));
      g.setAttribute('size',     new THREE.BufferAttribute(sizes,1));
      const m = baseMat.clone();
      const points = new THREE.Points(g, m);
      points.frustumCulled = false;
      return points;
    }
    function releasePoints(points){ points.visible=false; pool.push(points); }

    class Explosion {
      constructor(){
        const x = rand(-0.42*width, 0.42*width) / 6;
        const y = rand(-0.45* height, 0.45*height) / 6;
        const z = rand(-60, 20);
        this.center = new THREE.Vector3(x,y,z);
        this.life = reduced ? 1.5 : 1.9;
        this.t = 0;

        this.count = (Math.random()*50 + (reduced? 75 : 120)) | 0;
        this.points = getPoints(this.count);
        this.points.position.copy(this.center);

        const g = this.points.geometry;
        const pos = g.getAttribute('position').array;
        const col = g.getAttribute('color').array;
        const siz = g.getAttribute('size').array;

        this.vel = new Float32Array(this.count*3);
        for(let i=0;i<this.count;i++){
          const dirv = new THREE.Vector3().randomDirection();
          const speed = rand(12, 34);
          this.vel[i*3+0] = dirv.x*speed;
          this.vel[i*3+1] = dirv.y*speed;
          this.vel[i*3+2] = dirv.z*speed;

          pos[i*3+0] = dirv.x*1.6;
          pos[i*3+1] = dirv.y*1.6;
          pos[i*3+2] = dirv.z*1.6;

          col[i*3+0] = 1.0; col[i*3+1] = 1.0; col[i*3+2] = 1.0;
          siz[i] = rand(8, 14);
        }
        g.getAttribute('position').needsUpdate = true;
        g.getAttribute('color').needsUpdate    = true;
        g.getAttribute('size').needsUpdate     = true;

        scene.add(this.points);

        const ringGeo = new THREE.RingGeometry(5, 6.6, 64);
        this.ring1 = new THREE.Mesh(ringGeo, ringMatStrong.clone());
        this.ring2 = new THREE.Mesh(ringGeo, ringMatSoft.clone());
        this.ring1.position.copy(this.center);
        this.ring2.position.copy(this.center);
        this.r1 = 5; this.r2 = 5;
        scene.add(this.ring1, this.ring2);

        this.shake = 0.45;
      }

      update(dt){
        this.t += dt;
        const f = this.t/this.life;

        const g = this.points.geometry;
        const pos = g.getAttribute('position').array;
        const col = g.getAttribute('color').array;
        const siz = g.getAttribute('size').array;

        const drag = 1.0 - Math.min(0.05*dt*60, 0.05);

        for(let i=0;i<this.count;i++){
          const ix = i*3;
          pos[ix+0] += this.vel[ix+0]*dt;
          pos[ix+1] += this.vel[ix+1]*dt;
          pos[ix+2] += this.vel[ix+2]*dt;
          this.vel[ix+0] *= drag;
          this.vel[ix+1] *= drag;
          this.vel[ix+2] *= drag;

          const toGold = smoothstep(0.25, 0.55, f);
          col[ix+0] = lerp(1.0, 1.00, toGold);
          col[ix+1] = lerp(1.0, 0.72, toGold);
          col[ix+2] = lerp(1.0, 0.28, toGold);

          siz[i] *= (1 - dt*0.1);
          siz[i] = Math.max(7, siz[i]);
        }
        g.getAttribute('position').needsUpdate = true;
        g.getAttribute('color').needsUpdate    = true;
        g.getAttribute('size').needsUpdate     = true;

        this.r1 += 100*dt;
        this.r2 += 125*dt;
        this.ring1.scale.setScalar(this.r1/5);
        this.ring2.scale.setScalar(this.r2/5);
        this.ring1.material.opacity = Math.max(0, 0.95 - f*1.25);
        this.ring2.material.opacity = Math.max(0, 0.65 - f*1.3);
        this.ring1.lookAt(camera.position);
        this.ring2.lookAt(camera.position);

        if(this.shake>0){
          const s = this.shake*(1-f);
          camera.position.x += (Math.random()-0.5)*s;
          camera.position.y += (Math.random()-0.5)*s;
        }

        return this.t < this.life;
      }

      dispose(){
        scene.remove(this.points); releasePoints(this.points);
        scene.remove(this.ring1); scene.remove(this.ring2);
      }
    }

    const ambient = (function makeAmbient(){
      const COUNT = reduced ? 400 : 800;
      const g = new THREE.BufferGeometry();
      const positions = new Float32Array(COUNT*3);
      const colors    = new Float32Array(COUNT*3);
      for(let i=0;i<COUNT;i++){
        positions[i*3+0] = rand(-220,220);
        positions[i*3+1] = rand(-140,140);
        positions[i*3+2] = rand(-180,60);
        const t = Math.random()*0.5+0.35;
        colors[i*3+0] = t; colors[i*3+1] = t*0.9; colors[i*3+2] = t*0.85;
      }
      g.setAttribute('position', new THREE.BufferAttribute(positions,3));
      g.setAttribute('color', new THREE.BufferAttribute(colors,3));
      const m = new THREE.PointsMaterial({
        size: reduced ? 2.2 : 3.2, map:particleTex, transparent:true, depthWrite:false,
        vertexColors:true, blending:THREE.AdditiveBlending
      });
      const p = new THREE.Points(g,m);
      p.frustumCulled = false;
      p.userData = { t:0 };
      return p;
    })();
    scene.add(ambient);

    function rand(a,b){ return a + Math.random()*(b-a); }
    function lerp(a,b,t){ return a + (b-a)*t; }
    function smoothstep(a,b,x){ const t = Math.max(0, Math.min(1, (x-a)/(b-a))); return t*t*(3 - 2*t); }

    function resize(){
      width = window.innerWidth; height = window.innerHeight;
      renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, DPR_LIMIT));
      renderer.setSize(width, height, false);
      camera.aspect = width/height;
      camera.updateProjectionMatrix();
    }
    window.addEventListener('resize', resize, { passive:true });

    const explosions = [];
    let prev = performance.now(), lastBlast = prev;

    if(START_WITH_BLAST){ explosions.push(new Explosion()); }

    function loop(now){
      const dt = Math.min(0.05, (now - prev)/1000); prev = now;

      ambient.userData.t += dt*0.2;
      ambient.position.y = Math.sin(ambient.userData.t)*2;
      ambient.rotation.z += dt*0.02;

      if(now - lastBlast > BLAST_INTERVAL){
        if(explosions.length > MAX_EXPLOSIONS){
          const old = explosions.shift(); old.dispose();
        }
        explosions.push(new Explosion());
        lastBlast = now;
      }

      for(let i=explosions.length-1;i>=0;i--){
        if(!explosions[i].update(dt)){
          explosions[i].dispose();
          explosions.splice(i,1);
        }
      }

      camera.lookAt(0,0,0);
      renderer.render(scene, camera);
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);
  })();
  </script>

  <noscript>Enable JavaScript to use BattleBillions.</noscript>
</body>
</html>
