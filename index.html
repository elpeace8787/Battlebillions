<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3ATTLE33ILLIONS ‚Äî App</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --ink:#f5f5f5; --ink-2:#cecece; --muted:#8a8a8a;
      --google-border:#dadce0;
      --facebook:#1877F2;
      --twitter:#1DA1F2;
      --accent:#ffd700;
      --panel:rgba(255,255,255,.05);
      --ring:0 0 0 3px rgba(255,255,255,.12);
      --err:#ff6b6b;
      --ok:#3ddc97;
      --bgGlass: rgba(15,15,17,.28);
      --bdGlass: rgba(255,255,255,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:#000;color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}

    /* Background */
    #bg3d{position:fixed; inset:0; width:100%; height:100%; display:block; pointer-events:none; background:radial-gradient(1200px 800px at 30% 20%, #101012 0%, #000 70%); z-index:0;}

    /* App Shell */
    .app-shell{position:relative; z-index:1; min-height:100vh; display:grid; place-items:center; padding:25px;}
    .stack{width:min(92vw,980px); display:grid; gap:18px}
    header{text-align:center}

    /* Title */
    .title-wrap{ perspective:1200px; display:inline-block; user-select:none; }
    .title-3d{ position:relative; display:inline-block; transform-style:preserve-3d; transition:transform .3s ease; }
    header h1{
      --shine: linear-gradient(180deg, #fafafa 0%, #dcdcdc 28%, #a9a9a9 55%, #f3f3f3 82%);
      margin:0; font-size:38px; letter-spacing:.6px; text-transform:uppercase; line-height:1;
      background:linear-gradient(120deg, rgba(255,255,255,.18) 0%, rgba(255,255,255,0) 22% 78%, rgba(255,255,255,.18) 100%),var(--shine);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      filter: drop-shadow(0 8px 22px rgba(0,0,0,.35)) drop-shadow(0 2px 8px rgba(255,215,0,.18));
      position:relative; z-index:2; animation:titleGlow 7.2s ease-in-out infinite;
    }
    header h1::before{content:"3ATTLE33ILLIONS"; position:absolute; inset:0; color:#0e0e10; opacity:.5; z-index:-1; transform: translate3d(0,0,-3px); filter: blur(.6px); text-shadow:0 1px 0 #09090a,0 2px 0 #0b0b0d,0 3px 0 #0d0d10,0 4px 0 #0f0f12;}
    header h1::after{content:"3ATTLE33ILLIONS"; position:absolute; inset:0; z-index:3; background: linear-gradient(90deg, rgba(255,215,0,.0), rgba(255,215,0,.55), rgba(255,215,0,.0)); -webkit-background-clip:text; background-clip:text; color:transparent; mix-blend-mode:screen; opacity:.55; animation: rimSweep 3.6s linear infinite;}
    .title-sheen{ position:absolute; left:-8%; top:-20%; width:120%; height:140%; background: linear-gradient(100deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.22) 50%, rgba(255,255,255,0) 100%); transform: translateZ(8px) skewX(-18deg); pointer-events:none; filter: blur(8px) opacity(.55); animation: sheenSlide 4.8s ease-in-out infinite; }
    @keyframes sheenSlide{ 0%{ transform:translate(-20%, -10%) skewX(-18deg) translateZ(8px); opacity:.25 } 50%{ transform:translate(10%, 0%) skewX(-18deg) translateZ(8px); opacity:.6 } 100%{ transform:translate(-20%, -10%) skewX(-18deg) translateZ(8px); opacity:.25 } }
    @keyframes rimSweep{ 0%{ clip-path: polygon(0 0, 12% 0, 18% 100%, 0 100%);} 50%{ clip-path: polygon(40% 0, 62% 0, 58% 100%, 36% 100%);} 100%{ clip-path: polygon(88% 0, 100% 0, 100% 100%, 82% 100%);} }
    @keyframes titleGlow{ 0%,100%{ filter: drop-shadow(0 8px 22px rgba(0,0,0,.35)) drop-shadow(0 2px 8px rgba(255,215,0,.18)); } 50%{ filter: drop-shadow(0 10px 26px rgba(0,0,0,.45)) drop-shadow(0 2px 12px rgba(255,235,140,.28)); } }

    /* Inputs/Buttons */
    .form{display:grid; gap:12px}
    .btn, input, select{ width:100%; padding:12px 16px; border-radius:14px; border:1px solid var(--bdGlass); background:var(--bgGlass); -webkit-backdrop-filter: blur(6px) saturate(120%); backdrop-filter: blur(6px) saturate(120%); color:var(--ink); transition:transform .16s ease, background .16s ease, border-color .16s ease, box-shadow .16s ease; }
    .btn{cursor:pointer}
    .btn:hover{transform:translateY(-2px)}
    .btn.primary{background:#fff;color:#000;border-color:transparent}
    .btn.primary:hover{background:#ececec}
    .btn.ghost{background:transparent;border-color:#3a3a3a}
    .btn.ghost:hover{border-color:#fff}
    label{font-size:12px;color:var(--ink-2)}
    input:focus, select:focus{outline:0;border-color:#fff;box-shadow:0 0 6px rgba(255,255,255,.25)}
    .pw-wrap{position:relative}
    .pw-toggle{position:absolute; right:10px; top:50%; transform:translateY(-50%); border:0; background:transparent; color:var(--muted); cursor:pointer; font-size:14px;}
    .actions{display:flex; gap:12px; margin-top:4px; flex-wrap:wrap}
    .divider{display:flex;align-items:center;gap:10px;margin:2px 0 6px}
    .divider::before,.divider::after{content:"";flex:1;height:1px;background:rgba(255,255,255,.12)}
    .divider span{font-size:12px;color:var(--muted)}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .status{min-height:18px;font-size:12px;text-align:center;color:var(--muted)}
    .foot{position:fixed;left:0;right:0;bottom:12px;text-align:center;font-size:12px;color:var(--muted)}

    /* Route containers */
    .route-auth{display:block;}
    .route-frame{display:none;}
    .route-active{display:block !important;}
    #view-auth, #view-create { display:none; }
    #view-auth.active, #view-create.active { display:block; }

    /* Social buttons on login */
    .provider-bar{ display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }
    .pbtn{ width:44px; height:44px; border-radius:10px; display:inline-flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,.14); background:rgba(15,15,17,.35); backdrop-filter: blur(6px) saturate(120%); transition:transform .16s ease, box-shadow .16s ease, border-color .16s ease; }
    .pbtn:hover{ transform:translateY(-2px); border-color:rgba(255,255,255,.3) }
    .pbtn svg{ width:22px; height:22px; }
    .pbtn.google{ background:#fff; border-color:var(--google-border) }
    .pbtn.facebook{ background:var(--facebook); }
    .pbtn.twitter{ background:var(--twitter); }

    /* Iframe system for SPA pages */
    .frame-wrap{ position:fixed; inset:0; z-index:2; overflow:hidden; }
    .route-iframe{ position:absolute; inset:0; width:100%; height:100%; border:0; background:transparent; opacity:0; transition:opacity .18s ease; pointer-events:none; }
    .route-iframe.visible{opacity:1; pointer-events:auto;}
    .app-shell.frame-active #route-auth { display: none !important; }

    /* ===== Create Account (your 4-step UI) ===== */
    .wrapCA{position:relative; z-index:1; max-width:980px; margin:0 auto; padding:0 16px;}
    .ca-card{ background:var(--panel); border-radius:20px; padding:20px; box-shadow:0 0 24px rgba(255,215,0,.15); }
    .ambient{ position:absolute; inset:0; pointer-events:none; z-index:0; background: radial-gradient(600px 300px at 90% -10%, rgba(255,215,0,.08), transparent 60%), radial-gradient(500px 250px at -10% 100%, rgba(255,255,255,.06), transparent 60%); filter: blur(0.3px); animation: drift 18s ease-in-out infinite alternate; }
    @keyframes drift{ 0%{transform:translateY(0)} 100%{transform:translateY(6px)} }
    .logoCA{ position:relative; z-index:2; color:var(--accent); font-family:'Orbitron',sans-serif; font-weight:700; letter-spacing:.5px; text-align:center; margin-top:8px; }

    .stepper{display:flex; align-items:center; gap:10px; margin-bottom:18px;}
    .dot{ width:12px; height:12px; border-radius:999px; background:#333; }
    .dot.active{background:var(--accent)}
    .bar{flex:1; height:2px; background:#222; border-radius:4px; overflow:hidden}
    .bar>span{display:block; height:100%; width:0; background:var(--accent); transition:width .4s ease}
    .title{font-family:'Orbitron',sans-serif; font-size:20px; color:var(--ink); margin:4px 0 14px}
    .grid{display:grid; gap:12px}
    @media (min-width:700px){ .grid.cols-2{grid-template-columns:1fr 1fr} .grid.cols-3{grid-template-columns:repeat(3,1fr)} }
    .error{font-size:12px; color:var(--err); margin-top:6px; display:none}
    .hint{font-size:11px; color:#9aa3ad}
    .pill-select{ appearance:none; background:#111; border-radius:999px; padding:12px 16px; border:0; color:var(--ink) }
    .pill-col{flex:1 1 110px}
    .chipset{display:flex; flex-wrap:wrap; gap:8px}
    .chip{ padding:8px 12px; border-radius:999px; background:#111; font-size:12px; cursor:pointer; user-select:none }
    .chip.active{ background:var(--accent); color:#000; font-weight:700 }
    .avatar-upload{display:flex; align-items:center; gap:14px}
    .avatar{ width:72px; height:72px; border-radius:999px; background:#111; overflow:hidden; flex:0 0 auto; border:1px solid #222 }
    .avatar img{ width:100%; height:100%; object-fit:cover }
    .btn[disabled]{opacity:.5; pointer-events:none}
    .ca-step{display:none}
    .ca-step.active{display:block}
    .ca-success{ position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; align-items:center; justify-content:center; z-index:20; }
    .ca-success .box{ background:linear-gradient(180deg, rgba(255,215,0,.15), rgba(255,215,0,.05)); border:1px solid rgba(255,215,0,.25); padding:28px 22px; border-radius:18px; text-align:center; max-width:360px; box-shadow:0 0 80px rgba(255,215,0,.35), inset 0 0 60px rgba(255,215,0,.08); animation: pop .3s ease; }
    .ca-success h3{margin:0 0 8px; color:var(--accent)}
    .ca-success p{margin:0; color:var(--ink-2); font-size:13px}
    @keyframes pop{from{transform:scale(.98); opacity:0} to{transform:scale(1); opacity:1}}
    .providers-inline{display:flex; gap:10px; flex-wrap:wrap}
    .provider-inline{ flex:1 1 120px; display:flex; align-items:center; justify-content:center; gap:8px; padding:10px 12px; border-radius:12px; background:#101010; text-decoration:none; color:var(--ink-2); font-size:12px }
  </style>
</head>
<body>
  <canvas id="bg3d"></canvas>

  <main class="app-shell">
    <!-- ===== AUTH ROUTE (Login + Create) ===== -->
    <div id="route-auth" class="route-auth route-active">
      <div class="stack">
        <header>
          <div class="title-wrap" id="titleWrap">
            <div class="title-3d" id="title3d">
              <h1>3ATTLE33ILLIONS</h1>
              <span class="title-sheen" aria-hidden="true"></span>
            </div>
          </div>
        </header>

        <!-- ===== LOGIN ===== -->
        <section id="view-auth" class="active">
          <form id="authForm" class="form" autocomplete="on">
            <div>
              <label for="email">Email</label>
              <input id="email" type="email" placeholder="you@example.com" required />
            </div>
            <div>
              <label for="password">Password</label>
              <div class="pw-wrap">
                <input id="password" type="password" minlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
                <button type="button" id="togglePw" class="pw-toggle" aria-label="Show password">üëÅ</button>
              </div>
            </div>
            <div class="actions">
              <button id="submitBtn" type="submit" class="btn primary">Sign In</button>
              <button id="modeBtn" type="button" class="btn ghost">Create account</button>
            </div>
          </form>

          <div class="divider"><span>or continue with</span></div>
          <div class="provider-bar">
            <button id="googleBtn" class="pbtn google" title="Google" aria-label="Google">
              <span class="sr-only">Google</span>
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path fill="#EA4335" d="M12 10.2v3.6h5.02c-.22 1.3-1.52 3.8-5.02 3.8-3.03 0-5.5-2.5-5.5-5.6s2.47-5.6 5.5-5.6c1.73 0 2.9.73 3.57 1.36l2.43-2.36C16.7 3.7 14.55 2.8 12 2.8 6.98 2.8 2.9 6.88 2.9 12s4.08 9.2 9.1 9.2c5.25 0 8.7-3.68 8.7-8.86 0-.6-.06-1.06-.14-1.54H12z"/>
                <path fill="#FBBC05" d="M12 21.2c2.88 0 5.3-.94 7.07-2.56l-3.3-2.7c-.89.6-2.07.96-3.77.96-3.01 0-5.54-2.5-5.54-5.6 0-.87.2-1.69.55-2.41L3.5 7.4A9.16 9.16 0 0 0 2.9 12c0 5.12 4.08 9.2 9.1 9.2z"/>
                <path fill="#34A853" d="M21.1 12c0-.6-.06-1.06-.14-1.54H12v3.6h5.02c-.22 1.3-1.52 3.8-5.02 3.8-1.89 0-3.5-.79-4.6-2.05l-3.3 2.56A9.2 9.2 0  0 0 12 21.2c5.25 0 8.7-3.68 8.7-8.86z"/>
              </svg>
            </button>
            <button id="facebookBtn" class="pbtn facebook" title="Facebook" aria-label="Facebook">
              <span class="sr-only">Facebook</span>
              <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="#fff" d="M22 12.07C22 6.47 17.52 2 11.93 2 6.34 2 1.86 6.47 1.86 12.07c0 4.99 3.64 9.14 8.4 9.95v-7.03H7.96v-2.92h2.3V9.77c0-2.27 1.35-3.53 3.42-3.53.99 0 2.03.18 2.03.18v2.23h-1.14c-1.12 0-1.47.7-1.47 1.42v1.71h2.5l-.4 2.92h-2.1V22c4.77-.81 8.4-4.96 8.4-9.93z"/></svg>
            </button>
            <button id="twitterBtn" class="pbtn twitter" title="Twitter" aria-label="Twitter">
              <span class="sr-only">Twitter</span>
              <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="#fff" d="M23 5.92a9.54 9.54 0 0 1-2.77.76 4.81 4.81 0 0 0 2.1-2.65 9.6 9.6 0 0 1-3.04 1.17 4.78 4.78 0 0 0-8.14 4.36A13.58 13.58 0 0 1 3.16 4.6a4.78 4.78 0 0 0 1.48 6.38 4.74 4.74 0 0 1-2.16-.6v.06a4.78 4.78 0 0 0 3.83 4.69 4.8 4.8 0 0 1-2.15.08 4.78 4.78 0 0 0 4.46 3.31A9.59 9.59 0 0 1 2 20.54a13.53 13.53 0 0 0 7.32 2.15c8.79 0 13.6-7.28 13.6-13.6 0-.21 0-.42-.02-.63A9.71 9.71 0  0 0 23 5.92z"/></svg>
            </button>
          </div>
          <p id="status" class="status" aria-live="polite"></p>
        </section>

        <!-- ===== CREATE ACCOUNT (4-step wizard from your file) ===== -->
        <section id="view-create">
          <div class="wrapCA">
            <div class="ambient" aria-hidden="true"></div>
            <div class="logoCA">BattleBillions</div>

            <div class="ca-card">
              <div class="stepper">
                <div class="dot" data-stepdot="1"></div>
                <div class="bar"><span id="barFill" style="width:0%"></span></div>
                <div class="dot" data-stepdot="2"></div>
                <div class="dot" data-stepdot="3"></div>
                <div class="dot" data-stepdot="4"></div>
              </div>

              <!-- Step 1: Basics -->
              <section class="ca-step" data-step="1">
                <h2 class="title">Account Basics</h2>
                <div class="grid cols-2">
                  <div>
                    <label for="ca-handle">Username / Handle</label>
                    <input id="ca-handle" type="text" placeholder="@yourname" autocomplete="nickname" maxlength="20"/>
                    <div class="hint">3‚Äì20 chars, letters/numbers/underscore</div>
                    <div class="error" id="err-handle">Invalid or taken handle.</div>
                  </div>
                  <div>
                    <label for="ca-invite">Invite Code (optional)</label>
                    <input id="ca-invite" type="text" placeholder="Enter code (if any)"/>
                  </div>
                  <div id="emailRow">
                    <label for="ca-email">Email</label>
                    <input id="ca-email" type="email" placeholder="you@example.com" autocomplete="email"/>
                    <div class="error" id="err-email">Enter a valid email.</div>
                  </div>
                  <div id="pwRow">
                    <label for="ca-password">Password</label>
                    <input id="ca-password" type="password" placeholder="8+ chars, 1 letter & 1 number" autocomplete="new-password"/>
                    <div class="hint" id="pw-hint">Strength: ‚Äî</div>
                    <div class="error" id="err-password">Password too weak.</div>
                  </div>
                  <div id="pw2Row">
                    <label for="ca-password2">Confirm Password</label>
                    <input id="ca-password2" type="password" placeholder="Re-enter password" autocomplete="new-password"/>
                    <div class="error" id="err-password2">Passwords don‚Äôt match.</div>
                  </div>
                </div>

                <div class="actions">
                  <button class="btn ghost" id="ca-cancel-1">Cancel</button>
                  <button class="btn primary" id="ca-next-1">Next</button>
                </div>
                <p id="createStatus1" class="status"></p>
              </section>

              <!-- Step 2: Identity & Region -->
              <section class="ca-step" data-step="2">
                <h2 class="title">Identity & Region</h2>
                <div class="grid cols-3">
                  <div>
                    <label for="ca-country">Country</label>
                    <select id="ca-country" class="pill-select">
                      <option value="">Select country</option>
                      <option>United States</option><option>Canada</option><option>United Kingdom</option><option>Australia</option><option>Other</option>
                    </select>
                  </div>
                  <div>
                    <label for="ca-state">State / Province</label>
                    <input id="ca-state" type="text" placeholder="State / Province"/>
                  </div>
                  <div>
                    <label for="ca-city">City</label>
                    <input id="ca-city" type="text" placeholder="City"/>
                  </div>

                  <div class="pill-col">
                    <label for="ca-dob-month">Birth Month</label>
                    <select id="ca-dob-month" class="pill-select"></select>
                  </div>
                  <div class="pill-col">
                    <label for="ca-dob-day">Birth Day</label>
                    <select id="ca-dob-day" class="pill-select"></select>
                  </div>
                  <div class="pill-col">
                    <label for="ca-dob-year">Birth Year</label>
                    <select id="ca-dob-year" class="pill-select"></select>
                  </div>
                  <div class="hint" style="grid-column:1/-1">Select Month ‚Ä¢ Day ‚Ä¢ Year</div>
                  <div class="error" id="err-dob" style="grid-column:1/-1">You must be 13+ to join.</div>

                  <div>
                    <label for="ca-zodiac">Chinese Zodiac</label>
                    <select id="ca-zodiac" class="pill-select">
                      <option value="">Auto (from year)</option>
                      <option>Rat</option><option>Ox</option><option>Tiger</option><option>Rabbit</option>
                      <option>Dragon</option><option>Snake</option><option>Horse</option><option>Goat</option>
                      <option>Monkey</option><option>Rooster</option><option>Dog</option><option>Pig</option>
                    </select>
                    <div class="hint">Auto-fills from the selected year. You can override if you want.</div>
                  </div>

                  <div>
                    <label for="ca-lang">Languages</label>
                    <select id="ca-lang" multiple>
                      <option>English</option><option>Spanish</option><option>French</option><option>Arabic</option><option>Hindi</option><option>Chinese</option><option>Other</option>
                    </select>
                    <div class="hint">Hold Ctrl/Cmd to select multiple</div>
                  </div>
                  <div>
                    <label for="ca-ethnicity">Ethnicity (optional)</label>
                    <select id="ca-ethnicity" class="pill-select">
                      <option value="">Prefer not to say</option>
                      <option>African / African American</option><option>Asian</option><option>Hispanic / Latino</option><option>Middle Eastern / North African</option>
                      <option>Native / Indigenous</option><option>Pacific Islander</option><option>White</option><option>Other / Mixed</option>
                    </select>
                  </div>
                  <div>
                    <label for="ca-timezone">Timezone</label>
                    <select id="ca-timezone" class="pill-select">
                      <option value="">Auto-detect</option>
                      <option>America/New_York</option><option>America/Chicago</option><option>America/Denver</option><option>America/Los_Angeles</option><option>UTC</option>
                    </select>
                  </div>
                </div>

                <div class="actions">
                  <button class="btn ghost" id="ca-back-2">Back</button>
                  <button class="btn primary" id="ca-next-2">Next</button>
                </div>
                <p id="createStatus2" class="status"></p>
              </section>

              <!-- Step 3: Education & Community -->
              <section class="ca-step" data-step="3">
                <h2 class="title">Education & Community</h2>
                <div class="grid cols-2">
                  <div>
                    <label for="ca-hs">High School</label>
                    <input id="ca-hs" type="text" placeholder="Type your high school"/>
                  </div>
                  <div>
                    <label for="ca-college">College / University</label>
                    <input id="ca-college" type="text" placeholder="Type your college"/>
                  </div>
                  <div>
                    <label for="ca-role">Role (optional)</label>
                    <select id="ca-role" class="pill-select">
                      <option value="">Select role</option>
                      <option>Student</option><option>Creator</option><option>Athlete</option><option>Musician</option><option>Entrepreneur</option><option>Other</option>
                    </select>
                  </div>
                </div>
                <div class="actions">
                  <button class="btn ghost" id="ca-back-3">Back</button>
                  <button class="btn primary" id="ca-next-3">Next</button>
                </div>
                <p id="createStatus3" class="status"></p>
              </section>

              <!-- Step 4: Battle Setup -->
              <section class="ca-step" data-step="4">
                <h2 class="title">Battle Setup</h2>
                <div class="grid">
                  <div class="avatar-upload">
                    <div class="avatar" id="avatarPreview"><img id="avatarImg" alt="" style="display:none"/></div>
                    <div>
                      <label for="ca-avatar">Profile Photo</label>
                      <input id="ca-avatar" type="file" accept="image/*" class="file-btn"/>
                      <div class="hint">Square images look best</div>
                    </div>
                  </div>

                  <div>
                    <label>Preferred Categories</label>
                    <div class="chipset" id="catChips">
                      <div class="chip">Rap</div><div class="chip">Dance</div><div class="chip">Gaming</div>
                      <div class="chip">Art</div><div class="chip">Sports</div><div class="chip">Comedy</div>
                    </div>
                  </div>

                  <div>
                    <label><input type="checkbox" id="ca-terms"/> I agree to the Terms</label>
                    <div class="hint">You must accept Terms & Privacy to continue</div>
                  </div>
                  <div>
                    <label><input type="checkbox" id="ca-privacy"/> I agree to the Privacy Policy</label>
                  </div>

                  <!-- Social providers (inline ‚Äì Instagram/TikTok removed) -->
                  <div>
                    <label>Or sign up with</label>
                    <div class="providers-inline">
                      <a href="#" class="provider-inline" id="prov-google">Google</a>
                      <a href="#" class="provider-inline" id="prov-facebook">Facebook</a>
                      <a href="#" class="provider-inline" id="prov-twitter">Twitter</a>
                    </div>
                    <div class="hint">If you use social signup, we‚Äôll only ask for anything missing.</div>
                  </div>
                </div>

                <div class="actions">
                  <button class="btn ghost" id="ca-back-4">Back</button>
                  <button class="btn primary" id="ca-submit">Create Account</button>
                </div>
                <p id="createStatus4" class="status"></p>
              </section>

              <div class="foot" style="text-align:center; margin-top:14px; font-size:12px; color:#9aa3ad">
                By creating an account you agree to our <a href="#" style="color:#cfd6dd; text-decoration:none">Terms</a> & <a href="#" style="color:#cfd6dd; text-decoration:none">Privacy</a>.
              </div>
            </div>
          </div>

          <div class="ca-success" id="success">
            <div class="box">
              <h3>Account Created</h3>
              <p>Welcome to BattleBillions ‚Äî redirecting to your home...</p>
            </div>
          </div>
        </section>

        <footer class="foot">¬© <span id="year"></span> BattleBillions</footer>
      </div>
    </div>

    <!-- ===== FRAME ROUTE (SPA pages) ===== -->
    <div id="route-frame" class="route-frame">
      <div class="frame-wrap">
        <iframe id="frameA" class="route-iframe visible"  title="BattleBillions View A" allow="autoplay; clipboard-read; clipboard-write"></iframe>
        <iframe id="frameB" class="route-iframe"          title="BattleBillions View B" allow="autoplay; clipboard-read; clipboard-write"></iframe>
      </div>
    </div>
  </main>

  <!-- ===== ROUTER & UI (no Firebase here) ===== -->
  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    // Show/Hide password (login)
    (function(){
      const pw = document.getElementById("password");
      const btn = document.getElementById("togglePw");
      btn.addEventListener("click", ()=>{
        const to = pw.type === "password" ? "text" : "password";
        pw.type = to; btn.setAttribute("aria-label", to==="password" ? "Show password" : "Hide password");
      });
    })();

    // Title parallax
    (function(){
      const wrap = document.getElementById("titleWrap");
      const el   = document.getElementById("title3d");
      if(!wrap || !el) return;
      let rect = null;
      const updateRect = ()=>{ rect = wrap.getBoundingClientRect(); };
      updateRect(); addEventListener("resize", updateRect, {passive:true});
      wrap.addEventListener("mousemove", (ev)=>{
        if(!rect) return;
        const x = (ev.clientX - rect.left)/rect.width - 0.5;
        const y = (ev.clientY - rect.top )/rect.height - 0.5;
        el.style.transform = `rotateY(${x*10}deg) rotateX(${-y*8}deg) translateZ(0)`;
      });
      wrap.addEventListener("mouseleave", ()=>{ el.style.transform = "rotateY(0deg) rotateX(0deg)"; });
    })();

    /* ===== Hash Router ===== */
    const routes = {
      "/auth/login":  { type:"auth", sub:"login" },
      "/auth/create": { type:"auth", sub:"create" },
      "/home":        { type:"frame", src:"home.html" },
      "/discover":    { type:"frame", src:"discover.html" },
      "/opponent":    { type:"frame", src:"opponent.html" },
      "/battle":      { type:"frame", src:"live.html" },
      "/leaderboard": { type:"frame", src:"leaderboard.html" },
      "/profile":     { type:"frame", src:"profile.html" }
    };

    const authContainer = document.getElementById("route-auth");
    const loginView     = document.getElementById("view-auth");
    const createView    = document.getElementById("view-create");
    const frameView     = document.getElementById("route-frame");
    const appShell      = document.querySelector(".app-shell");
    const statusEl      = document.getElementById("status");

    // Iframes (double buffer to avoid flash)
    const frameA = document.getElementById("frameA");
    const frameB = document.getElementById("frameB");
    let visible = frameA, hidden = frameB;

    function showAuth(sub){
      appShell.classList.remove("frame-active");
      frameView.classList.remove("route-active");
      authContainer.classList.add("route-active");
      loginView.classList.toggle("active", sub==="login");
      createView.classList.toggle("active", sub==="create");
      if(sub==="create"){ initCreateWizardUI(); }
    }
    function showFrame(src){
      appShell.classList.add("frame-active");
      authContainer.classList.remove("route-active");
      frameView.classList.add("route-active");
      const abs = new URL(src, location.href).href;
      if (visible.src === abs) return;
      hidden.removeAttribute("src");
      hidden.classList.remove("visible");
      hidden.addEventListener("load", ()=>{
        visible.classList.remove("visible");
        hidden.classList.add("visible");
        [visible,hidden] = [hidden,visible];
        hidden.removeAttribute("src");
        hidden.classList.remove("visible");
      }, {once:true});
      hidden.src = src;
    }
    function parseHash(){
      const raw  = location.hash || "#/auth/login";
      const [path, query] = raw.slice(1).split("?");
      const parts = path.split("/").filter(Boolean);
      if (parts[0]==="auth" && (parts[1]==="login" || parts[1]==="create")){
        return { base:`/auth/${parts[1]}`, query:new URLSearchParams(query||"") };
      }
      const base = `/${parts[0]||"auth"}`;
      if (base==="/auth") return { base:"/auth/login", query:new URLSearchParams(query||"") };
      return { base, query:new URLSearchParams(query||"") };
    }
    function navigate(){
      const { base, query } = parseHash();
      const route = routes[base] || routes["/auth/login"];
      if (route.type==="auth"){
        window.__completionMode = (base==="/auth/create" && (query && query.get("mode")==="complete"));
        showAuth(route.sub);
        return;
      }
      if (route.type==="frame"){ showFrame(route.src); return; }
      showAuth("login");
    }
    window.addEventListener("hashchange", navigate);
    if(!location.hash) location.hash="/auth/login";
    navigate();

    // Dummy email login (non-blocking; Firebase handles real one in module)
    document.getElementById("authForm").addEventListener("submit",(e)=>{ e.preventDefault(); location.hash="/home"; });
    document.getElementById("modeBtn").addEventListener("click",()=>{ location.hash="/auth/create"; });

    /* ===== Create wizard (UI only) ===== */
    let caState = { step:1 };
    function initCreateWizardUI(){
      const steps = Array.from(document.querySelectorAll('.ca-step'));
      const dots  = Array.from(document.querySelectorAll('[data-stepdot]'));
      const barFill = document.getElementById('barFill');
      const get = id => document.getElementById(id);

      const f = {
        handle:get('ca-handle'), invite:get('ca-invite'),
        email:get('ca-email'), pw:get('ca-password'), pw2:get('ca-password2'),
        m:get('ca-dob-month'), d:get('ca-dob-day'), y:get('ca-dob-year'),
        zodiac:get('ca-zodiac'), tz:get('ca-timezone'),
        terms:get('ca-terms'), privacy:get('ca-privacy')
      };
      const err = { handle:get('err-handle'), email:get('err-email'), pw:get('err-password'), pw2:get('err-password2'), dob:get('err-dob') };
      const reHandle=/^[a-zA-Z0-9_]{3,20}$/; const reEmail=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      // Disable email/pw rows in completion mode
      const completionMode = !!window.__completionMode;
      ['emailRow','pwRow','pw2Row'].forEach(id=>{ const row=get(id); if(row){ row.style.display = completionMode ? 'none' : ''; }});

      // Months / Years
      const months=['January','February','March','April','May','June','July','August','September','October','November','December'];
      f.m.innerHTML = '<option value="">Month</option>' + months.map((m,i)=>`<option value="${i+1}">${m}</option>`).join('');
      const now=new Date(), startYear=now.getFullYear()-100, endYear=now.getFullYear();
      let yhtml='<option value="">Year</option>'; for(let y=endYear; y>=startYear; y--){ yhtml+=`<option value="${y}">${y}</option>`; } f.y.innerHTML=yhtml;
      function daysInMonth(m,y){ if(!m||!y) return 31; return new Date(y,m,0).getDate(); }
      function refreshDays(){ const m=parseInt(f.m.value||'0',10), y=parseInt(f.y.value||'0',10), max=daysInMonth(m,y); const cur=parseInt(f.d.value||'0',10); let html='<option value="">Day</option>'; for(let i=1;i<=max;i++){ html+=`<option value="${i}">${i}</option>`;} f.d.innerHTML=html; if(cur&&cur<=max) f.d.value=String(cur); }
      f.m.addEventListener('change', refreshDays); f.y.addEventListener('change', refreshDays); refreshDays();

      // Chinese zodiac from year (simple)
      const zodiacNames=['Rat','Ox','Tiger','Rabbit','Dragon','Snake','Horse','Goat','Monkey','Rooster','Dog','Pig'];
      function chineseZodiacByYear(year){ const idx=((year-2008)%12+12)%12; return zodiacNames[idx]; }
      f.y.addEventListener('change', ()=>{ const y=parseInt(f.y.value,10); if(y && !f.zodiac.dataset.userOverride){ f.zodiac.value=chineseZodiacByYear(y); } });
      f.zodiac.addEventListener('change', ()=>{ f.zodiac.dataset.userOverride='1'; });

      // Password strength text
      const pwHint = document.getElementById('pw-hint');
      f.pw && f.pw.addEventListener('input', ()=>{ const s=f.pw.value; let score=0; if(s.length>=8)score++; if(/[a-zA-Z]/.test(s))score++; if(/[0-9]/.test(s))score++; pwHint.textContent='Strength: '+(['‚Äî','Weak','OK','Strong'][score]); });

      // Step helpers
      function showStep(n){
        caState.step=n;
        steps.forEach(s=>s.classList.toggle('active', Number(s.dataset.step)===n));
        dots.forEach((d,i)=> d.classList.toggle('active', i < n));
        const pct=((n-1)/(steps.length-1))*100; barFill.style.width=pct+'%';
      }
      function ageFromParts(y,m,d){ if(!y||!m||!d) return 0; const t=new Date(), dob=new Date(y,m-1,d); let a=t.getFullYear()-dob.getFullYear(); const mm=t.getMonth()-dob.getMonth(); if(mm<0||(mm===0&&t.getDate()<dob.getDate())) a--; return a; }

      // Buttons
      get('ca-cancel-1').onclick=()=>{ location.hash='/auth/login'; };
      get('ca-next-1').onclick=()=>{
        let ok=true;
        if(!reHandle.test((f.handle.value||'').trim())){ err.handle.style.display='block'; ok=false; } else err.handle.style.display='none';
        if(!completionMode){
          if(!reEmail.test((f.email.value||'').trim())){ err.email.style.display='block'; ok=false; } else err.email.style.display='none';
          const pw=f.pw.value||'', pw2=f.pw2.value||''; const pwOk=pw.length>=8 && /[a-zA-Z]/.test(pw) && /[0-9]/.test(pw);
          if(!pwOk){ err.pw.style.display='block'; ok=false; } else err.pw.style.display='none';
          if(pw2!==pw){ err.pw2.style.display='block'; ok=false; } else err.pw2.style.display='none';
        }
        if(ok) showStep(2);
      };
      get('ca-back-2').onclick=()=> showStep(1);
      get('ca-next-2').onclick=()=>{
        const y=parseInt(f.y.value,10), m=parseInt(f.m.value,10), d=parseInt(f.d.value,10);
        const a=ageFromParts(y,m,d);
        if(a<13 || !y || !m || !d){ err.dob.style.display='block'; return; } else err.dob.style.display='none';
        if(!f.tz.value){ try{ f.tz.value=Intl.DateTimeFormat().resolvedOptions().timeZone||''; }catch{} }
        showStep(3);
      };
      get('ca-back-3').onclick=()=> showStep(2);
      get('ca-next-3').onclick=()=> showStep(4);
      get('ca-back-4').onclick=()=> showStep(3);

      // Avatar preview
      document.getElementById('ca-avatar').addEventListener('change', (e)=>{
        const file=e.target.files?.[0]; if(!file) return;
        const img=document.getElementById('avatarImg'); const reader=new FileReader();
        reader.onload=ev=>{ img.src=ev.target.result; img.style.display='block'; }; reader.readAsDataURL(file);
      });

      // Category chips
      document.getElementById('catChips').addEventListener('click',(e)=>{ const c=e.target.closest('.chip'); if(!c) return; c.classList.toggle('active'); });

      // Initialize time zone
      try{ f.tz.value=Intl.DateTimeFormat().resolvedOptions().timeZone||''; }catch{}

      // Expose for module to read values on submit
      window.__CAGetValues = ()=>({
        handle:(f.handle.value||'').trim(),
        invite:(f.invite.value||'').trim(),
        email:(f.email?.value||'').trim(),
        pw:(f.pw?.value||''),
        dob:{
          y:parseInt(f.y.value||'0',10),
          m:parseInt(f.m.value||'0',10),
          d:parseInt(f.d.value||'0',10)
        },
        country:document.getElementById('ca-country').value||'',
        state:document.getElementById('ca-state').value||'',
        city:document.getElementById('ca-city').value||'',
        zodiac:f.zodiac.value||'',
        languages:[...document.getElementById('ca-lang').selectedOptions].map(o=>o.value),
        ethnicity:document.getElementById('ca-ethnicity').value||'',
        tz:f.tz.value||'',
        hs:document.getElementById('ca-hs').value||'',
        college:document.getElementById('ca-college').value||'',
        role:document.getElementById('ca-role').value||'',
        categories:[...document.querySelectorAll('#catChips .chip.active')].map(c=>c.textContent.trim()),
        terms:!!f.terms.checked,
        privacy:!!f.privacy.checked
      });

      // Social inline (Step 4)
      document.getElementById('prov-google').onclick=(e)=>{ e.preventDefault(); document.getElementById('googleBtn').click(); };
      document.getElementById('prov-facebook').onclick=(e)=>{ e.preventDefault(); document.getElementById('facebookBtn').click(); };
      document.getElementById('prov-twitter').onclick=(e)=>{ e.preventDefault(); document.getElementById('twitterBtn').click(); };

      // Submit (actual save is in Firebase module)
      document.getElementById('ca-submit').onclick=()=>{ window.__CASubmit && window.__CASubmit(); };

      // Start at correct step (completionMode skips email/pw)
      showStep(completionMode ? 2 : 1);
    }
  </script>

  <!-- ===== FIREBASE + SOCIAL AUTH + SAVE (module) ===== -->
  <script type="module">
    // Use your firebase.js if present
    let local = {};
    try{ local = await import("./firebase.js"); }catch{}
    const {
      auth, db,
      googleProvider:GP, facebookProvider:FP, twitterProvider:TP,
      signInWithPopup:SWP, signInWithRedirect:SWR, getRedirectResult:GRR,
      onAuthStateChanged:OASC, signInWithEmailAndPassword:SWE,
      createUserWithEmailAndPassword:CUW,
      doc:DOC, getDoc:GDC, setDoc:SDC, serverTimestamp:SVT, updateDoc:UPD
    } = local;

    // Fallbacks to CDN if some pieces missing (still using your initialized auth/db)
    let signInWithPopup=SWP, signInWithRedirect=SWR, getRedirectResult=GRR, onAuthStateChanged=OASC, signInWithEmailAndPassword=SWE, createUserWithEmailAndPassword=CUW;
    let GoogleAuthProvider = local.GoogleAuthProvider, FacebookAuthProvider=local.FacebookAuthProvider, TwitterAuthProvider=local.TwitterAuthProvider;
    let doc=DOC, getDoc=GDC, setDoc=SDC, serverTimestamp=SVT, updateDoc=UPD;

    if(!(signInWithPopup && signInWithRedirect && getRedirectResult && onAuthStateChanged)){
      const a = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
      signInWithPopup = signInWithPopup || a.signInWithPopup;
      signInWithRedirect = signInWithRedirect || a.signInWithRedirect;
      getRedirectResult = getRedirectResult || a.getRedirectResult;
      onAuthStateChanged = onAuthStateChanged || a.onAuthStateChanged;
      signInWithEmailAndPassword = signInWithEmailAndPassword || a.signInWithEmailAndPassword;
      createUserWithEmailAndPassword = createUserWithEmailAndPassword || a.createUserWithEmailAndPassword;
      GoogleAuthProvider = GoogleAuthProvider || a.GoogleAuthProvider;
      FacebookAuthProvider = FacebookAuthProvider || a.FacebookAuthProvider;
      TwitterAuthProvider = TwitterAuthProvider || a.TwitterAuthProvider;
    }
    if(!(doc && getDoc && setDoc && serverTimestamp)){
      const f = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
      doc=doc||f.doc; getDoc=getDoc||f.getDoc; setDoc=setDoc||f.setDoc; serverTimestamp=serverTimestamp||f.serverTimestamp; updateDoc=updateDoc||f.updateDoc;
    }

    // Build providers if not exported
    const googleProvider   = GP || new GoogleAuthProvider();
    const facebookProvider = FP || new FacebookAuthProvider();
    const twitterProvider  = TP || new TwitterAuthProvider();

    const statusEl = document.getElementById("status");

    // Ensure user doc and check completeness
    async function ensureUserDoc(user){
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref, { email:user.email||"", avatarURL:user.photoURL||"", createdAt:serverTimestamp(),
          username:null, // required
          // profile fields default null
          country:null,state:null,city:null,tz:null,
          dob:null, age:null, chineseZodiac:null, languages:[], ethnicity:null,
          education:{ hs:null, college:null, role:null },
          categories:[]
        });
        return {existed:false, data:null};
      }
      return {existed:true, data:snap.data()};
    }
    const needsCompletion = (d)=>!(d && d.username && d.dob && d.age);

    // Social sign-in (popup -> redirect fallback)
    async function socialSignIn(provider){
      statusEl.textContent="";
      try{
        await signInWithPopup(auth, provider);
      }catch(err){
        // Popup blocked or environment limitation -> redirect
        if(err && (err.code==="auth/popup-blocked" || err.code==="auth/operation-not-supported-in-this-environment")){
          try{ await signInWithRedirect(auth, provider); }catch(e2){ statusEl.textContent=e2?.message||"Social sign-in failed."; }
        }else{
          statusEl.textContent = err?.message || "Social sign-in failed.";
        }
      }
    }
    // Handle redirect completes
    getRedirectResult(auth).then(async (res)=>{
      if(!res) return;
      const user = res.user;
      const { data } = await ensureUserDoc(user);
      if (needsCompletion(data)) location.hash="/auth/create?mode=complete"; else location.hash="/home";
    }).catch(err=>{ if(err?.message) statusEl.textContent=err.message; });

    // Wire buttons (login + step4 inline)
    document.getElementById("googleBtn")?.addEventListener("click", ()=>socialSignIn(googleProvider));
    document.getElementById("facebookBtn")?.addEventListener("click", ()=>socialSignIn(facebookProvider));
    document.getElementById("twitterBtn")?.addEventListener("click", ()=>socialSignIn(twitterProvider));

    // Email login (optional; SPA still routes to /home if you want placebo)
    document.getElementById("authForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const email=(document.getElementById("email").value||"").trim();
      const pw=document.getElementById("password").value||"";
      try{
        await signInWithEmailAndPassword(auth, email, pw);
        // onAuthStateChanged will route
      }catch(err){
        statusEl.textContent = err?.message || "Sign-in failed.";
      }
    });

    // Auth state -> route
    onAuthStateChanged(auth, async (u)=>{
      if(!u) return;
      if(location.hash.startsWith("#/auth")){
        const { data } = await ensureUserDoc(u);
        location.hash = needsCompletion(data) ? "/auth/create?mode=complete" : "/home";
      }
    });

    // Create account submit (handles both brand-new and completion mode)
    window.__CASubmit = async function(){
      const cs4 = document.getElementById("createStatus4");
      cs4.textContent="";
      const v = window.__CAGetValues ? window.__CAGetValues() : null;
      if(!v){ cs4.textContent="Form not ready."; return; }
      if(!(v.terms && v.privacy)){ cs4.textContent="Please accept Terms and Privacy."; return; }

      // Validate basics
      const uname = (v.handle||"").trim().toLowerCase();
      if(!/^[a-z0-9_]{3,20}$/.test(uname)){ cs4.textContent="Invalid username."; return; }
      // Validate DOB
      const {y,m,d}=v.dob; if(!(y&&m&&d)){ cs4.textContent="Select your full birth date."; return; }
      const dobISO = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const age = (function(){ const t=new Date(); const dd=new Date(y,m-1,d); let a=t.getFullYear()-dd.getFullYear(); const mm=t.getMonth()-dd.getMonth(); if(mm<0||(mm===0&&t.getDate()<dd.getDate())) a--; return a; })();
      if(age<13){ cs4.textContent="You must be at least 13."; return; }

      try{
        let user = auth.currentUser;

        if(!window.__completionMode){
          // Creating a brand-new account
          if(!v.email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v.email)){ cs4.textContent="Valid email required."; return; }
          if(!(v.pw && v.pw.length>=8 && /[A-Za-z]/.test(v.pw) && /[0-9]/.test(v.pw))){ cs4.textContent="Password too weak."; return; }
          const cred = await createUserWithEmailAndPassword(auth, v.email, v.pw);
          user = cred.user;
          // Create doc
          const ref = doc(db, "users", user.uid);
          await setDoc(ref, {
            email: v.email, avatarURL:user.photoURL||"", createdAt:serverTimestamp(),
            username: uname,
            country:v.country||"", state:v.state||"", city:v.city||"", tz:v.tz||"",
            dob: dobISO, age, chineseZodiac: v.zodiac||null,
            languages: v.languages||[], ethnicity: v.ethnicity||"",
            education:{ hs:v.hs||"", college:v.college||"", role:v.role||"" },
            categories: v.categories||[]
          }, { merge:true });
        }else{
          // Completing profile after social sign-in
          if(!user){ cs4.textContent="Please sign in again to finish."; return; }
          const ref = doc(db, "users", user.uid);
          await setDoc(ref, {
            username: uname,
            country:v.country||"", state:v.state||"", city:v.city||"", tz:v.tz||"",
            dob: dobISO, age, chineseZodiac: v.zodiac||null,
            languages: v.languages||[], ethnicity: v.ethnicity||"",
            education:{ hs:v.hs||"", college:v.college||"", role:v.role||"" },
            categories: v.categories||[]
          }, { merge:true });
        }

        // Success overlay then route
        const box = document.getElementById('success'); box.style.display='flex';
        setTimeout(()=>{ location.hash="/home"; }, 1000);
      }catch(err){
        cs4.textContent = err?.message || "Could not create your account.";
      }
    };
  </script>

  <!-- ===== Three.js Background ===== -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script>
  (function(){
    const reduced = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
    const DPR_LIMIT = 1.75, MAX_EXPLOSIONS = reduced ? 6 : 12, BLAST_INTERVAL = reduced ? 1700 : 1200, START_WITH_BLAST = true;
    const canvas = document.getElementById('bg3d');
    try{ const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl'); if(!gl) throw 0; }catch(e){ return; }
    const renderer = new THREE.WebGLRenderer({ canvas, antialias:false, alpha:true, powerPreference:'high-performance' });
    renderer.setClearColor(0x000000, 0);
    const scene = new THREE.Scene(); scene.fog = new THREE.FogExp2(0x000000, reduced ? 0.0008 : 0.0012);
    let width = window.innerWidth, height = window.innerHeight;
    renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, DPR_LIMIT)); renderer.setSize(width, height, false);
    const camera = new THREE.PerspectiveCamera(55, width/height, 0.1, 3000); camera.position.set(0, 0, 140);
    const hemi = new THREE.HemisphereLight(0xaaaaaa, 0x0a0a0a, 0.8);
    const dir  = new THREE.DirectionalLight(0xffe7a4, 0.7); dir.position.set(60, 80, 120); scene.add(hemi, dir);
    const particleTex = (function(){ const size=128,c=document.createElement('canvas'); c.width=c.height=size; const g=c.getContext('2d'); const grad=g.createRadialGradient(size/2,size/2,0,size/2,size/2,size/2); grad.addColorStop(0,'rgba(255,255,255,0.95)'); grad.addColorStop(0.35,'rgba(255,255,255,0.35)'); grad.addColorStop(1,'rgba(255,255,255,0.0)'); g.fillStyle=grad; g.fillRect(0,0,size,size); const tex=new THREE.CanvasTexture(c); tex.minFilter=THREE.LinearFilter; tex.magFilter=THREE.LinearFilter; tex.anisotropy=1; return tex;})();
    const baseMat = new THREE.PointsMaterial({ size:(reduced?16:20), map:particleTex, transparent:true, depthWrite:false, blending:THREE.AdditiveBlending, vertexColors:true, sizeAttenuation:true });
    const ringMatStrong = new THREE.MeshBasicMaterial({ color:0xffd700, transparent:true, opacity:0.9, blending:THREE.AdditiveBlending, side:THREE.DoubleSide });
    const ringMatSoft   = new THREE.MeshBasicMaterial({ color:0xffe18a, transparent:true, opacity:0.6, blending:THREE.AdditiveBlending, side:THREE.DoubleSide });
    const pool=[]; function getPoints(count){ for(let i=pool.length-1;i>=0;i--){ const p=pool[i]; const existing=p.geometry.getAttribute('position').count; if(existing>=count){ pool.splice(i,1); p.visible=true; return p; } } const g=new THREE.BufferGeometry(); const positions=new Float32Array(count*3); const colors=new Float32Array(count*3); const sizes=new Float32Array(count); g.setAttribute('position', new THREE.BufferAttribute(positions,3)); g.setAttribute('color', new THREE.BufferAttribute(colors,3)); g.setAttribute('size', new THREE.BufferAttribute(sizes,1)); const m=baseMat.clone(); const points=new THREE.Points(g,m); points.frustumCulled=false; return points; }
    function releasePoints(points){ points.visible=false; pool.push(points); }
    class Explosion{ constructor(){ const x=(Math.random()-0.5)*140, y=(Math.random()-0.5)*90, z=Math.random()*80-60; this.center=new THREE.Vector3(x,y,z); this.life=reduced?1.5:1.9; this.t=0; this.count=(Math.random()*50+(reduced?75:120))|0; this.points=getPoints(this.count); this.points.position.copy(this.center); const g=this.points.geometry, pos=g.getAttribute('position').array, col=g.getAttribute('color').array, siz=g.getAttribute('size').array; this.vel=new Float32Array(this.count*3); for(let i=0;i<this.count;i++){ const dirv=new THREE.Vector3().randomDirection(); const speed=Math.random()*22+12; this.vel[i*3+0]=dirv.x*speed; this.vel[i*3+1]=dirv.y*speed; this.vel[i*3+2]=dirv.z*speed; pos[i*3+0]=dirv.x*1.6; pos[i*3+1]=dirv.y*1.6; pos[i*3+2]=dirv.z*1.6; col[i*3+0]=1; col[i*3+1]=1; col[i*3+2]=1; siz[i]=Math.random()*6+8; } g.getAttribute('position').needsUpdate=true; g.getAttribute('color').needsUpdate=true; g.getAttribute('size').needsUpdate=true; scene.add(this.points); const ringGeo=new THREE.RingGeometry(5,6.6,64); this.ring1=new THREE.Mesh(ringGeo, ringMatStrong.clone()); this.ring2=new THREE.Mesh(ringGeo, ringMatSoft.clone()); this.r1=5; this.r2=5; this.ring1.position.copy(this.center); this.ring2.position.copy(this.center); scene.add(this.ring1,this.ring2); this.shake=0.45; }
      update(dt){ this.t+=dt; const f=this.t/this.life; const g=this.points.geometry, pos=g.getAttribute('position').array, col=g.getAttribute('color').array, siz=g.getAttribute('size').array; const drag=1-Math.min(0.05*dt*60,0.05); for(let i=0;i<this.count;i++){ const ix=i*3; pos[ix]+=this.vel[ix]*dt; pos[ix+1]+=this.vel[ix+1]*dt; pos[ix+2]+=this.vel[ix+2]*dt; this.vel[ix]*=drag; this.vel[ix+1]*=drag; this.vel[ix+2]*=drag; const toGold = (f-0.25)/0.3; const t=Math.max(0,Math.min(1,toGold)); col[ix]=1; col[ix+1]=1-0.28*t; col[ix+2]=1-0.72*t; siz[i]*=(1-dt*0.1); siz[i]=Math.max(7,siz[i]); } g.getAttribute('position').needsUpdate=true; g.getAttribute('color').needsUpdate=true; g.getAttribute('size').needsUpdate=true; this.r1+=100*dt; this.r2+=125*dt; this.ring1.scale.setScalar(this.r1/5); this.ring2.scale.setScalar(this.r2/5); this.ring1.material.opacity=Math.max(0,0.95-f*1.25); this.ring2.material.opacity=Math.max(0,0.65-f*1.3); this.ring1.lookAt(camera.position); this.ring2.lookAt(camera.position); if(this.shake>0){ const s=this.shake*(1-f); camera.position.x+=(Math.random()-0.5)*s; camera.position.y+=(Math.random()-0.5)*s; } return this.t<this.life; }
      dispose(){ scene.remove(this.points); releasePoints(this.points); scene.remove(this.ring1); scene.remove(this.ring2); }
    }
    const ambient=(function(){ const COUNT=reduced?400:800; const g=new THREE.BufferGeometry(); const positions=new Float32Array(COUNT*3); const colors=new Float32Array(COUNT*3); for(let i=0;i<COUNT;i++){ positions[i*3]=(Math.random()-0.5)*440; positions[i*3+1]=(Math.random()-0.5)*280; positions[i*3+2]=Math.random()*240-180; const t=Math.random()*0.5+0.35; colors[i*3]=t; colors[i*3+1]=t*0.9; colors[i*3+2]=t*0.85; } g.setAttribute('position',new THREE.BufferAttribute(positions,3)); g.setAttribute('color',new THREE.BufferAttribute(colors,3)); const m=new THREE.PointsMaterial({ size:reduced?2.2:3.2, map:particleTex, transparent:true, depthWrite:false, vertexColors:true, blending:THREE.AdditiveBlending }); const p=new THREE.Points(g,m); p.frustumCulled=false; p.userData={t:0}; return p; })();
    scene.add(ambient);
    function resize(){ width=window.innerWidth; height=window.innerHeight; renderer.setPixelRatio(Math.min(window.devicePixelRatio||1,DPR_LIMIT)); renderer.setSize(width,height,false); camera.aspect=width/height; camera.updateProjectionMatrix(); }
    window.addEventListener('resize', resize, { passive:true });
    const explosions=[]; let prev=performance.now(), lastBlast=prev; if(START_WITH_BLAST) explosions.push(new Explosion());
    function loop(now){ const dt=Math.min(0.05,(now-prev)/1000); prev=now; ambient.userData.t+=dt*0.2;const apos=ambient.geometry.getAttribute('position').array;
    for(let i=0;i<apos.length/3;i++){
      apos[i*3+1]+=Math.sin(ambient.userData.t+i*0.15)*0.002;
    }
    ambient.geometry.getAttribute('position').needsUpdate=true;

    // Update explosions
    for(let i=explosions.length-1;i>=0;i--){
      if(!explosions[i].update(dt)){
        explosions[i].dispose();
        explosions.splice(i,1);
      }
    }

    // Spawn new explosions
    if(now-lastBlast>BLAST_INTERVAL && explosions.length<MAX_EXPLOSIONS){
      explosions.push(new Explosion());
      lastBlast=now;
    }

    renderer.render(scene,camera);
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
})();
  </script>
</body>
</html>
