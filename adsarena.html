<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Ad Arena — Camera + Animated BG</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&family=Orbitron:wght@700&display=swap" rel="stylesheet"/>
<style>
  :root{
    --vh:100svh;
    --bg:#07080c; --ink:#f6f7fb; --muted:#a7adbb; --bd:#ffffff22;
    --accent:#4cf0ff; --accent2:#ff2e6f; --gold:#ffd54a;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  svg{display:inline-block;vertical-align:middle}

  .topbar{
    position:sticky;top:0;z-index:40;display:flex;align-items:center;gap:.6rem;padding:.5rem .7rem;
    background:linear-gradient(180deg,rgba(9,10,14,.96),rgba(9,10,14,.88));border-bottom:1px solid var(--bd);backdrop-filter:blur(8px)
  }
  .logo{font-family:Orbitron,Inter,sans-serif;font-weight:700;letter-spacing:.04em}
  .spacer{flex:1}
  .btn{border:1px solid var(--bd);background:#151827;color:var(--ink);border-radius:12px;padding:.46rem .72rem;font-weight:800}
  .btn.gold{background:linear-gradient(180deg,#ffe88a,#ffc400);border:none;color:#141414}

  /* ===== Live Surface ===== */
  .live{height:var(--vh);position:relative;overflow:hidden}

  /* Animated background stack */
  .bgHue{
    position:absolute;inset:-10% -10% 0 -10%;z-index:0;filter:blur(0.3px);
    background:
      radial-gradient(1200px 520px at 50% -220px, rgba(255,255,255,.06), transparent 60%),
      radial-gradient(1000px 460px at 50% 115%, rgba(76,240,255,.08), transparent 60%),
      linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.75));
    animation:hue 30s linear infinite alternate;
  }
  @keyframes hue{from{filter:hue-rotate(0deg)}to{filter:hue-rotate(18deg)}}

  /* stars canvas sits on top of bgHue so it doesn’t hue-rotate */
  #bgStars{position:absolute;inset:-5% -5% 0 -5%;z-index:0}

  .scanlines{position:absolute;inset:0;z-index:0;mix-blend-mode:soft-light;opacity:.18;
    background:repeating-linear-gradient(0deg,rgba(255,255,255,.05) 0 1px,transparent 1px 3px)}

  .arcs{position:absolute;left:50%;top:52%;width:82vw;max-width:920px;transform:translateX(-50%);z-index:0;opacity:.65}
  .arcs path{fill:none;stroke:url(#arcGrad);stroke-width:3;stroke-linecap:round;stroke-dasharray:320;stroke-dashoffset:320;animation:draw 7s ease-in-out infinite}
  .arcs path:nth-child(2){animation-delay:.8s;opacity:.8}
  .arcs path:nth-child(3){animation-delay:1.6s;opacity:.55}
  @keyframes draw{50%{stroke-dashoffset:0}100%{stroke-dashoffset:-320}}

  /* Two vertical panels that read as ONE screen */
  .panes{position:absolute;inset:0;display:grid;grid-template-columns:1fr 1fr;gap:0;z-index:1}
  .pane{position:relative;overflow:hidden;background:#000}
  .pane video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:contrast(1.08) saturate(1.05) brightness(1.02)}
  .left video{mask-image:linear-gradient(to right, black 0 86%, transparent 100%);-webkit-mask-image:linear-gradient(to right, black 0 86%, transparent 100%)}
  .right video{mask-image:linear-gradient(to left, black 0 86%, transparent 100%);-webkit-mask-image:linear-gradient(to left, black 0 86%, transparent 100%)}
  .panes:after{content:"";position:absolute;left:50%;top:0;bottom:0;width:3px;transform:translateX(-1.5px);
    background:linear-gradient(180deg,transparent,#ffffff1f 20%,#88f0ff33 50%,transparent 80%);filter:blur(.5px);opacity:.7}

  /* Center Start button */
  .startWrap{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:4;display:grid;place-items:center;pointer-events:auto}
  .start{
    display:inline-flex;gap:.6rem;align-items:center;border:1px solid var(--bd);
    background:linear-gradient(180deg,#ffe88a,#ffc400);color:#141414;border-radius:16px;
    padding:.72rem 1.1rem;font-weight:900;letter-spacing:.02em;box-shadow:0 16px 50px rgba(255,196,0,.35), inset 0 0 24px rgba(255,255,255,.3);
    transition:transform .08s ease, opacity .35s ease, filter .35s ease
  }
  .start:active{transform:scale(.98)}
  .startWrap.fade{opacity:0;filter:blur(2px);pointer-events:none}

  /* HUD */
  .hud{position:absolute;left:0;right:0;bottom:calc(10px + env(safe-area-inset-bottom));z-index:3;display:flex;justify-content:center;gap:.6rem}
  .chip{display:inline-flex;align-items:center;gap:.45rem;background:rgba(255,255,255,.08);border:1px solid var(--bd);border-radius:10px;padding:.34rem .6rem;font-weight:800}

  /* Control dock */
  .dock{position:absolute;left:0;right:0;bottom:0;z-index:5;transform:translateY(110%);transition:transform .25s ease;
    padding:.6rem .7rem calc(.7rem + env(safe-area-inset-bottom));background:linear-gradient(180deg,transparent 0%, rgba(8,8,10,.75) 22%, rgba(8,8,10,.96) 70%);border-top:1px solid var(--bd)}
  .dock.open{transform:translateY(0)}
  .row{display:flex;flex-wrap:wrap;gap:.55rem;align-items:center;justify-content:center}
  .sel{display:inline-flex;align-items:center;gap:.4rem;border:1px solid var(--bd);background:#ffffff12;border-radius:999px;padding:.38rem .6rem;font-weight:800}
  .sel select{appearance:none;background:transparent;border:0;color:var(--ink);font-weight:800;outline:none}
  .btn.small{padding:.42rem .6rem;border-radius:10px}
</style>
</head>
<body>
  <header class="topbar">
    <div class="logo">AD ARENA</div>
    <div class="spacer"></div>
    <button class="btn" id="openComposer">Edit Ad</button>
    <button class="btn gold" id="toggleDockBtn">Controls</button>
  </header>

  <section class="live" id="live">
    <!-- Animated background stack -->
    <div class="bgHue"></div>
    <canvas id="bgStars" width="800" height="600"></canvas>
    <div class="scanlines"></div>
    <svg class="arcs" viewBox="0 0 800 300" preserveAspectRatio="none" aria-hidden="true">
      <defs>
        <linearGradient id="arcGrad" x1="0" y1="0" x2="1" y2="0">
          <stop offset="0" stop-color="#4cf0ff"/><stop offset="1" stop-color="#ff2e6f"/>
        </linearGradient>
      </defs>
      <path d="M20 240 Q 400 40 780 240"/>
      <path d="M80 260 Q 400 70 720 260"/>
      <path d="M160 280 Q 400 110 640 280"/>
    </svg>

    <!-- Two “one-screen” panels -->
    <div class="panes">
      <article class="pane left"><video id="vidA" playsinline muted></video></article>
      <article class="pane right"><video id="vidB" playsinline muted></video></article>
    </div>

    <!-- Start -->
    <div class="startWrap" id="startWrap">
      <button class="start" id="startBattle">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M8 5v14l11-7z" stroke-width="2"/></svg>
        Start Battle
      </button>
    </div>

    <!-- HUD -->
    <div class="hud">
      <div class="chip"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="9" stroke-width="2"/><path d="M12 7v5l3 2" stroke-width="2"/></svg><span id="timer">00:30</span></div>
      <div class="chip">A <b id="scoreA">0</b></div>
      <div class="chip">B <b id="scoreB">0</b></div>
    </div>

    <!-- Dock -->
    <div class="dock" id="dock">
      <div class="row">
        <div class="sel"><span>Rounds</span>
          <select id="roundsSel"><option>1</option><option selected>3</option><option>5</option></select>
        </div>
        <div class="sel"><span>Turn</span>
          <select id="turnSel"><option>15</option><option selected>30</option><option>45</option><option>60</option></select>
        </div>
        <!-- Camera controls -->
        <button class="btn small" id="camA">Camera A</button>
        <button class="btn small" id="camB">Camera B</button>
        <button class="btn small" id="flipCam">Flip Cam</button>
        <button class="btn small" id="stopCam">Stop Cam</button>
        <a class="btn small" id="ctaA" href="#" target="_blank" rel="noopener">CTA A</a>
        <a class="btn small" id="ctaB" href="#" target="_blank" rel="noopener">CTA B</a>
      </div>
    </div>
  </section>

  <!-- Composer (same as before but trimmed for brevity) -->
  <div class="modal" id="composer">
    <div class="sheet">
      <header>
        <button class="btn" id="closeComposer">Close</button>
        <div style="font-weight:800;margin-left:.5rem">Edit Ad</div>
        <div class="spacer"></div>
        <button class="btn gold" id="applyAd">Apply</button>
      </header>
      <div class="form">
        <div class="field"><label>Video A</label><input id="videoA" type="file" accept="video/*" capture="user"/></div>
        <div class="field"><label>Video B</label><input id="videoB" type="file" accept="video/*" capture="user"/></div>
        <div class="field"><label>Music A</label><input id="audioA" type="file" accept="audio/*"/></div>
        <div class="field"><label>Music B</label><input id="audioB" type="file" accept="audio/*"/></div>
        <div class="field"><label>Trim Start</label><input id="trimStart" type="number" min="0" value="0"/></div>
        <div class="field"><label>Trim End</label><input id="trimEnd" type="number" min="1" value="30"/></div>
        <div class="field"><label>Speed</label>
          <select id="speedSel"><option>0.5x</option><option selected>1x</option><option>1.5x</option><option>2x</option></select>
        </div>
        <div class="field"><label>Music Offset</label><input id="musicOffset" type="number" min="0" value="0"/></div>
        <div class="field"><label>Video Vol</label><input id="volVideo" type="range" min="0" max="1" step="0.05" value="1"/></div>
        <div class="field"><label>Music Vol</label><input id="volMusic" type="range" min="0" max="1" step="0.05" value="0.9"/></div>
        <div class="field"><label>CTA A</label><input id="ctaLinkA" placeholder="https://brand-a.com"/></div>
        <div class="field"><label>CTA B</label><input id="ctaLinkB" placeholder="https://brand-b.com"/></div>
      </div>
    </div>
  </div>

<script>
  const $ = s => document.querySelector(s);

  /* Real mobile viewport */
  function setVH(){ const vv=window.visualViewport; document.documentElement.style.setProperty('--vh', Math.round(vv?.height||innerHeight)+'px'); }
  ['load','resize','orientationchange','scroll'].forEach(e=>addEventListener(e,setVH,{passive:true})); setVH();

  /* ===== Animated stars background (Canvas) ===== */
  const canvas = document.getElementById('bgStars');
  const ctx = canvas.getContext('2d');
  function resizeCanvas(){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    canvas.width = Math.floor(innerWidth * dpr);
    canvas.height = Math.floor((document.documentElement.style.getPropertyValue('--vh').replace('px','')|0) * dpr);
    canvas.style.width = innerWidth + 'px';
    canvas.style.height = (document.documentElement.style.getPropertyValue('--vh').replace('px','')|0) + 'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  resizeCanvas(); addEventListener('resize', resizeCanvas);

  const stars = Array.from({length: 120}).map(()=>({
    x: Math.random()*innerWidth,
    y: Math.random()*innerHeight,
    r: Math.random()*1.5 + 0.3,
    s: Math.random()*0.3 + 0.05
  }));
  function drawStars(){
    ctx.clearRect(0,0,innerWidth,innerHeight);
    ctx.globalCompositeOperation='lighter';
    for(const st of stars){
      ctx.beginPath();
      ctx.arc(st.x, st.y, st.r, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(200,220,255,0.35)';
      ctx.fill();
      st.y -= st.s; if(st.y < -2){ st.y = innerHeight+2; st.x = Math.random()*innerWidth; }
    }
    requestAnimationFrame(drawStars);
  }
  drawStars();

  /* ===== Dock & Composer ===== */
  const dock=$('#dock'), toggleDockBtn=$('#toggleDockBtn'); toggleDockBtn.addEventListener('click',()=> dock.classList.toggle('open'));
  const composer=$('#composer'), openComposer=$('#openComposer'), closeComposer=$('#closeComposer'), applyAd=$('#applyAd');
  openComposer.addEventListener('click',()=> composer.classList.add('open'));
  closeComposer.addEventListener('click',()=> composer.classList.remove('open'));

  const vidA=$('#vidA'), vidB=$('#vidB');
  const audA=new Audio(), audB=new Audio();
  const state={
    A:{loaded:false,videoURL:null,audioURL:null,trimStart:0,trimEnd:30,speed:1,musicOffset:0,volVideo:1,volMusic:0.9,cta:'#'},
    B:{loaded:false,videoURL:null,audioURL:null,trimStart:0,trimEnd:30,speed:1,musicOffset:0,volVideo:1,volMusic:0.9,cta:'#'}
  };

  applyAd.addEventListener('click',()=>{
    const vA=$('#videoA').files?.[0], vB=$('#videoB').files?.[0], aA=$('#audioA').files?.[0], aB=$('#audioB').files?.[0];
    if(vA){ state.A.videoURL=URL.createObjectURL(vA); vidA.src=state.A.videoURL; }
    if(vB){ state.B.videoURL=URL.createObjectURL(vB); vidB.src=state.B.videoURL; }
    if(aA){ state.A.audioURL=URL.createObjectURL(aA); audA.src=state.A.audioURL; }
    if(aB){ state.B.audioURL=URL.createObjectURL(aB); audB.src=state.B.audioURL; }
    state.A.trimStart=+$('#trimStart').value||0; state.A.trimEnd=+$('#trimEnd').value||30;
    state.B.trimStart=state.A.trimStart; state.B.trimEnd=state.A.trimEnd;
    state.A.speed=parseFloat($('#speedSel').value)||1; state.B.speed=state.A.speed;
    state.A.musicOffset=+$('#musicOffset').value||0; state.B.musicOffset=state.A.musicOffset;
    state.A.volVideo=+$('#volVideo').value; state.B.volVideo=state.A.volVideo;
    state.A.volMusic=+$('#volMusic').value; state.B.volMusic=state.A.volMusic;
    state.A.cta=$('#ctaLinkA').value||'#'; state.B.cta=$('#ctaLinkB').value||'#';
    $('#ctaA').href=state.A.cta; $('#ctaB').href=state.B.cta;
    [vidA,vidB].forEach((v,i)=>{ const s=i?state.B:state.A; v.muted=(s.volVideo===0); v.loop=true; v.playbackRate=s.speed; v.play().catch(()=>{}); });
    state.A.loaded=!!state.A.videoURL; state.B.loaded=!!state.B.videoURL;
    composer.classList.remove('open');
  });

  /* ===== Start + Battle engine ===== */
  const startWrap=$('#startWrap'), startBtn=$('#startBattle');
  const roundsSel=$('#roundsSel'), turnSel=$('#turnSel'), timerEl=$('#timer'), scoreA=$('#scoreA'), scoreB=$('#scoreB');
  let ticker=null, tLeft=30, roundNow=1, roundsTotal=3, current='A', aVotes=0, bVotes=0;

  function mmss(s){const m=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(Math.floor(s%60)).padStart(2,'0'); return `${m}:${ss}`;}
  function playPane(p){
    const s=state[p]; if(!s.loaded && !streams[p]) return;  // allow camera even without file
    const v=(p==='A'?vidA:vidB), a=(p==='A'?audA:audB);
    if(s.loaded){ v.currentTime=s.trimStart||0; v.playbackRate=s.speed||1; v.loop=true; v.play().catch(()=>{}); }
    if(s.audioURL){ a.currentTime=s.musicOffset||0; a.volume=s.volMusic??0.9; a.loop=true; a.play().catch(()=>{}); }
  }
  function pausePane(p){ const v=(p==='A'?vidA:vidB), a=(p==='A'?audA:audB); try{v.pause();}catch{} try{a.pause();}catch{} }

  function start(){
    roundsTotal=+roundsSel.value||3; tLeft=+turnSel.value||30; roundNow=1; current='A';
    aVotes=0; bVotes=0; scoreA.textContent=aVotes; scoreB.textContent=bVotes; timerEl.textContent=mmss(tLeft);
    clearInterval(ticker); ticker=setInterval(tick,1000);
    startWrap.classList.add('fade');
    playPane('A'); pausePane('B');
  }
  function tick(){ tLeft--; timerEl.textContent=mmss(tLeft); if(tLeft<=0) swapTurn(); }
  function swapTurn(){
    if(current==='A'){ current='B'; tLeft=+turnSel.value||30; playPane('B'); pausePane('A'); }
    else{ if(roundNow<roundsTotal){ roundNow++; current='A'; tLeft=+turnSel.value||30; playPane('A'); pausePane('B'); }
          else{ clearInterval(ticker); startWrap.classList.remove('fade'); } }
  }
  startBtn.addEventListener('click', start);

  vidA.addEventListener('click',()=>{ if(ticker && current==='A'){ aVotes++; scoreA.textContent=aVotes; }});
  vidB.addEventListener('click',()=>{ if(ticker && current==='B'){ bVotes++; scoreB.textContent=bVotes; }});

  /* ===== Camera preview controls ===== */
  const camA=$('#camA'), camB=$('#camB'), flipCam=$('#flipCam'), stopCam=$('#stopCam');
  let facing = 'user'; // 'user' = front, 'environment' = rear
  const streams = {A:null, B:null};

  async function startCamera(which){
    try{
      // request camera
      const stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode: { ideal: facing } }, audio:false
      });
      const vid = which==='A' ? vidA : vidB;
      // stop existing on that side first
      if(streams[which]) streams[which].getTracks().forEach(t=>t.stop());
      streams[which] = stream;
      vid.srcObject = stream;
      vid.muted = true; // required for autoplay on mobile
      await vid.play().catch(()=>{});
      // mark as "loaded" so battle engine can run without uploaded file
      state[which].loaded = true;
    }catch(err){
      alert('Camera error: ' + (err?.message || err));
    }
  }
  function stopAllCams(){
    ['A','B'].forEach(k=>{
      if(streams[k]){ streams[k].getTracks().forEach(t=>t.stop()); streams[k]=null; }
      const v = k==='A'?vidA:vidB;
      if(v.srcObject){ v.pause(); v.srcObject=null; }
      // if you had a file video loaded, it stays (we only stop camera)
    });
  }

  camA.addEventListener('click',()=>startCamera('A'));
  camB.addEventListener('click',()=>startCamera('B'));
  flipCam.addEventListener('click',async ()=>{
    facing = (facing==='user') ? 'environment' : 'user';
    // if a stream is active, restart it with new facing for both sides using camera
    if(streams.A) startCamera('A');
    if(streams.B) startCamera('B');
  });
  stopCam.addEventListener('click', stopAllCams);

  // Clean up on page hide
  addEventListener('visibilitychange',()=>{ if(document.hidden) stopAllCams(); });
</script>
</body>
</html>
