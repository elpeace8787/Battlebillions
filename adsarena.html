<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>3ATTLE33ILLIONS — Ad Arena</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&family=Orbitron:wght@600;800&display=swap" rel="stylesheet"/>
<style>
  :root{
    --bg:#0b0b0c; --ink:#f5f7fb; --muted:#a6abb6; --gold:#ffd700;
    --ok:#35d49a; --danger:#ff5d5d; --glass:rgba(255,255,255,.06);
    --ring:0 0 0 3px rgba(255,255,255,.14); --dim:rgba(0,0,0,.55);
    --bd:#ffffff18;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow:hidden}
  .safe{padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)}

  /* ===== App Frame (no overlap) ===== */
  .app{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr}
  .topbar{
    position:relative;z-index:10;display:flex;gap:.75rem;align-items:center;
    padding:.6rem .8rem;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
    border-bottom:1px solid var(--bd); backdrop-filter:blur(10px)
  }
  .logoWord{font-family:Orbitron,Inter,sans-serif;font-weight:800;letter-spacing:.5px}
  .pill{display:inline-flex;align-items:center;gap:.5rem;border:1px solid var(--bd);background:var(--glass);border-radius:999px;padding:.45rem .7rem}
  .pill select,.pill input{appearance:none;background:transparent;border:none;color:var(--ink);font-weight:700;outline:none}
  .spacer{flex:1}
  .btn{border:1px solid var(--bd);background:#ffffff12;color:var(--ink);border-radius:12px;padding:.55rem .9rem;font-weight:800}
  .btn.gold{background:linear-gradient(180deg,#ffe88a,#ffc400);border:none;color:#121212}

  /* ===== Arena (strict, no scroll, no overlap) ===== */
  .arena{position:relative;inset:0;display:grid;grid-template-columns:1fr 1fr}
  .pane{position:relative;isolation:isolate;background:#000}
  video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000}
  .shade{position:absolute;inset:0;background:transparent;transition:background .25s ease;z-index:2}
  .pane.dim .shade{background:var(--dim)}

  /* HUD per pane */
  .hud{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:space-between;z-index:3;pointer-events:none}
  .hud .toprow{display:flex;justify-content:space-between;align-items:center;padding:.6rem .75rem}
  .iconbtn{pointer-events:auto;display:grid;place-items:center;width:40px;height:40px;border-radius:999px;background:var(--glass);border:1px solid var(--bd)}
  .iconbtn svg{width:18px;height:18px}
  .center-top{position:absolute;left:50%;transform:translateX(-50%);top:.6rem;display:flex;gap:.5rem;align-items:center}
  .chip{pointer-events:auto;display:inline-flex;align-items:center;gap:.5rem;background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--bd);border-radius:999px;padding:.45rem .8rem;font-weight:800}
  .rounds{font-family:Orbitron,Inter,sans-serif;letter-spacing:.5px}
  .timer{font-family:Orbitron,Inter,sans-serif;min-width:86px;text-align:center}

  .votes{position:absolute;top:3.0rem;right:.8rem;background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--bd);padding:.3rem .6rem;border-radius:999px;font-weight:800;z-index:3}

  /* Brand footer block */
  .brand{pointer-events:auto;position:absolute;left:.8rem;right:.8rem;bottom:.8rem;display:flex;align-items:center;gap:.75rem;background:var(--glass);border:1px solid var(--bd);backdrop-filter:blur(10px);border-radius:18px;padding:.55rem .7rem}
  .logo{width:44px;height:44px;border-radius:50%;overflow:hidden;border:1px solid #ffffff22;flex:0 0 auto;background:#111;display:grid;place-items:center}
  .logo input{display:none}
  .meta{min-width:0;display:flex;flex-direction:column}
  .name{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .tag{font-size:.78rem;color:var(--muted)}
  .ctas{margin-left:auto;display:flex;gap:.5rem;flex-wrap:wrap}
  .btn-cta{pointer-events:auto;border:1px solid var(--bd);border-radius:12px;padding:.45rem .7rem;background:#ffffff10;color:var(--ink);font-weight:800}
  .btn-cta.gold{background:linear-gradient(180deg,#ffe88a,#ffc400);border:none;color:#121212}

  /* Setup row (kept above footer, organized) */
  .setup{position:absolute;left:.8rem;right:.8rem;bottom:calc(4.8rem + 10px);display:flex;gap:.6rem;align-items:center;flex-wrap:wrap;z-index:4}
  .field{pointer-events:auto;display:flex;align-items:center;gap:.45rem;background:var(--glass);border:1px solid var(--bd);border-radius:14px;padding:.45rem .6rem}
  .field label{font-size:.85rem;color:var(--muted)}
  .field input[type="file"], .field input[type="number"], .field input[type="url"], .field input[type="text"]{color:var(--ink);max-width:38vw;background:transparent;border:none;font-weight:700;outline:none}

  /* Music meter appears only after audio chosen */
  .meter{pointer-events:none;position:absolute;left:50%;transform:translateX(-50%);bottom:calc(4.8rem + 52px);width:68%;height:28px;border-radius:12px;overflow:hidden;display:none;z-index:4;border:1px solid var(--bd);background:#0c0c0e}
  canvas.eq{width:100%;height:100%}

  /* Tap zones for voting (no visible buttons) */
  .tapzone{position:absolute;inset:0;z-index:1}
  .tapzone.left{right:50%}
  .tapzone.right{left:50%}
  .hint{position:absolute;bottom:50%;left:50%;transform:translate(-50%,50%);background:var(--glass);border:1px solid var(--bd);backdrop-filter:blur(10px);padding:.4rem .65rem;border-radius:10px;font-size:.85rem;z-index:2;opacity:.85}

  /* Start control bar (fixed, centered) */
  .startbar{position:absolute;left:50%;transform:translateX(-50%);bottom:calc(env(safe-area-inset-bottom) + .8rem);z-index:20;display:flex;gap:.6rem;align-items:center;background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--bd);border-radius:999px;padding:.5rem .6rem}
  .startbar select,.startbar input[type="number"]{appearance:none;background:#ffffff10;border:1px solid var(--bd);border-radius:999px;color:var(--ink);padding:.45rem .7rem;font-weight:800;width:84px;text-align:center}

  /* Hide-on-start collection */
  .hide-on-start{transition:opacity .2s ease}
  .hidden{opacity:0;pointer-events:none}

  /* ===== Matchmaking Lobby (slide-in) ===== */
  .lobby{
    position:fixed;top:0;right:0;height:100%;width:min(420px,92vw);background:rgba(18,18,20,.96);
    border-left:1px solid var(--bd);backdrop-filter:blur(12px);z-index:30;transform:translateX(100%);
    transition:transform .25s ease
  }
  .lobby.open{transform:translateX(0)}
  .lobby header{display:flex;align-items:center;gap:.6rem;padding:.8rem;border-bottom:1px solid var(--bd)}
  .lobby .filters{display:flex;flex-wrap:wrap;gap:.5rem;padding:.7rem .8rem;border-bottom:1px solid var(--bd)}
  .lobby .filters .pill{padding:.4rem .6rem}
  .lobby .list{position:absolute;top:130px;bottom:84px;left:0;right:0;overflow:auto;padding:.6rem .8rem}
  .card{border:1px solid var(--bd);background:var(--glass);border-radius:14px;padding:.6rem .7rem;display:flex;gap:.6rem;align-items:center}
  .card + .card{margin-top:.6rem}
  .card .brandTag{font-size:.78rem;color:var(--muted)}
  .card .grow{flex:1}
  .lobby footer{position:absolute;left:0;right:0;bottom:0;padding:.7rem .8rem;border-top:1px solid var(--bd);display:flex;gap:.6rem}
  .search{flex:1;border:1px solid var(--bd);background:#ffffff10;color:var(--ink);border-radius:10px;padding:.55rem .6rem;font-weight:700;outline:none}

  @media (max-width: 860px){
    .name{font-size:.95rem}
    .votes{top:2.7rem}
    .startbar select{width:74px}
  }
</style>
</head>
<body>
<div class="app safe" id="app">
  <!-- ===== TOP BAR: categories + matchmaking ===== -->
  <div class="topbar hide-on-start" id="topBar">
    <div class="logoWord">AD ARENA</div>

    <!-- Primary Ad Category (locks at start) -->
    <div class="pill" title="Ad Category">
      <span style="opacity:.8">Category</span>
      <select id="adCategory">
        <option selected>Fashion</option><option>Food & Beverage</option><option>Tech</option>
        <option>Gaming</option><option>Beauty</option><option>Auto</option><option>Finance</option>
        <option>Fitness</option><option>Music</option><option>Travel</option><option>Education</option>
        <option>Entertainment</option><option>Sports</option><option>Health</option><option>Nonprofit</option><option>Apps</option>
      </select>
    </div>

    <!-- Optional Subcategory -->
    <div class="pill" title="Subcategory">
      <span style="opacity:.8">Sub</span>
      <input id="adSub" placeholder="e.g., Sneakers, Energy Drinks" />
    </div>

    <div class="spacer"></div>

    <!-- Find Opponent opens the Lobby -->
    <button class="btn" id="openLobbyBtn">Find Opponent</button>
    <!-- Create Challenge quick-post -->
    <button class="btn gold" id="postChallengeBtn">Create Challenge</button>
  </div>

  <!-- ===== ARENA: two constant panels, no scrolling ===== -->
  <div class="arena" id="arena">
    <!-- LEFT -->
    <section class="pane" id="paneL" data-side="left">
      <video id="videoL" playsinline muted></video>
      <div class="shade"></div>
      <div class="hud">
        <div class="toprow">
          <button class="iconbtn" id="exitBtn" title="Exit">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" stroke-linecap="round" d="M6 6l12 12M18 6L6 18"/></svg>
          </button>
          <div class="center-top">
            <div class="chip rounds" id="roundsChip">R1 / 3</div>
            <div class="chip timer" id="timerChip">00:30</div>
          </div>
          <button class="iconbtn" id="flagBtn" title="Flag">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" stroke-linecap="round" d="M4 4v16M4 4h11l-1.5 3H20l-2 4 2 4h-4l-1.5-3H4"/></svg>
          </button>
        </div>

        <div class="votes" id="votesL">0</div>
        <div class="hint hide-on-start" id="hint">Tap left/right to vote during battle</div>

        <!-- Setup row (organized) -->
        <div class="setup hide-on-start" id="setupL">
          <div class="field"><label for="videoInputL">Ad Video</label><input id="videoInputL" type="file" accept="video/*"></div>
          <div class="field"><label for="audioInputL">Audio</label><input id="audioInputL" type="file" accept="audio/*"></div>
          <div class="field"><label for="startL">Start at</label><input id="startL" type="number" min="0" value="0" step="1"><span style="color:var(--muted)">sec</span></div>
          <div class="field"><label for="linkL">CTA Link</label><input id="linkL" type="url" placeholder="https://brand-a.com"></div>
        </div>

        <div class="meter" id="meterL"><canvas class="eq" id="eqL"></canvas></div>

        <!-- Brand footer -->
        <div class="brand hide-on-start" id="brandL">
          <label class="logo" title="Upload logo">
            <input type="file" id="logoInputL" accept="image/*">
            <img id="logoImgL" alt="" style="max-width:100%;max-height:100%;display:none"/>
            <svg id="logoPhL" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="12" cy="8" r="4" stroke-width="2"></circle>
              <path d="M4 20c1.8-3.5 5-5 8-5s6.2 1.5 8 5" stroke-width="2"/>
            </svg>
          </label>
          <div class="meta">
            <input type="text" id="brandNameL" placeholder="Brand A Name" style="background:transparent;border:none;color:var(--ink);font-weight:800;outline:none"/>
            <div class="tag">Verified Ad Arena</div>
          </div>
          <div class="ctas">
            <a class="btn-cta" id="ctaFollowL" href="#" target="_blank" rel="noopener">Follow</a>
            <a class="btn-cta gold" id="ctaShopL" href="#" target="_blank" rel="noopener">Shop</a>
            <a class="btn-cta" id="ctaMoreL" href="#" target="_blank" rel="noopener">Learn&nbsp;More</a>
          </div>
        </div>
      </div>
      <div class="tapzone left" id="tapL" aria-hidden="true"></div>
    </section>

    <!-- RIGHT -->
    <section class="pane" id="paneR" data-side="right">
      <video id="videoR" playsinline muted></video>
      <div class="shade"></div>
      <div class="hud">
        <div class="toprow" aria-hidden="true"></div>
        <div class="votes" id="votesR">0</div>

        <div class="setup hide-on-start" id="setupR">
          <div class="field"><label for="videoInputR">Ad Video</label><input id="videoInputR" type="file" accept="video/*"></div>
          <div class="field"><label for="audioInputR">Audio</label><input id="audioInputR" type="file" accept="audio/*"></div>
          <div class="field"><label for="startR">Start at</label><input id="startR" type="number" min="0" value="0" step="1"><span style="color:var(--muted)">sec</span></div>
          <div class="field"><label for="linkR">CTA Link</label><input id="linkR" type="url" placeholder="https://brand-b.com"></div>
        </div>

        <div class="meter" id="meterR"><canvas class="eq" id="eqR"></canvas></div>

        <div class="brand hide-on-start" id="brandR">
          <label class="logo" title="Upload logo">
            <input type="file" id="logoInputR" accept="image/*">
            <img id="logoImgR" alt="" style="max-width:100%;max-height:100%;display:none"/>
            <svg id="logoPhR" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="12" cy="8" r="4" stroke-width="2"></circle>
              <path d="M4 20c1.8-3.5 5-5 8-5s6.2 1.5 8 5" stroke-width="2"/>
            </svg>
          </label>
          <div class="meta">
            <input type="text" id="brandNameR" placeholder="Brand B Name" style="background:transparent;border:none;color:var(--ink);font-weight:800;outline:none"/>
            <div class="tag">Verified Ad Arena</div>
          </div>
          <div class="ctas">
            <a class="btn-cta" id="ctaFollowR" href="#" target="_blank" rel="noopener">Follow</a>
            <a class="btn-cta gold" id="ctaShopR" href="#" target="_blank" rel="noopener">Shop</a>
            <a class="btn-cta" id="ctaMoreR" href="#" target="_blank" rel="noopener">Learn&nbsp;More</a>
          </div>
        </div>
      </div>
      <div class="tapzone right" id="tapR" aria-hidden="true"></div>
    </section>

    <!-- Start controls -->
    <div class="startbar hide-on-start" id="startBar">
      <span style="font-weight:800;letter-spacing:.4px">Rounds</span>
      <select id="roundsSel"><option>1</option><option selected>3</option><option>5</option></select>
      <span style="font-weight:800;letter-spacing:.4px">Turn</span>
      <select id="turnLen"><option>15</option><option selected>30</option><option>45</option><option>60</option></select>
      <button class="btn gold" id="startBtn">Start Battle</button>
    </div>
  </div>
</div>

<!-- ===== MATCHMAKING LOBBY ===== -->
<aside class="lobby" id="lobby">
  <header>
    <button class="iconbtn" id="closeLobby" title="Close"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" stroke-linecap="round" d="M6 6l12 12M18 6L6 18"/></svg></button>
    <div style="font-weight:800;letter-spacing:.4px">Find Opponent</div>
  </header>

  <div class="filters">
    <div class="pill">
      <span style="opacity:.8">Category</span>
      <select id="filterCategory">
        <option>All</option><option>Fashion</option><option>Food & Beverage</option><option>Tech</option><option>Gaming</option>
        <option>Beauty</option><option>Auto</option><option>Finance</option><option>Fitness</option><option>Music</option>
        <option>Travel</option><option>Education</option><option>Entertainment</option><option>Sports</option><option>Health</option><option>Nonprofit</option><option>Apps</option>
      </select>
    </div>
    <div class="pill">
      <span style="opacity:.8">Rounds</span>
      <select id="filterRounds"><option>Any</option><option>1</option><option selected>3</option><option>5</option></select>
    </div>
    <div class="pill">
      <span style="opacity:.8">Turn</span>
      <select id="filterTurn"><option>Any</option><option>15</option><option selected>30</option><option>45</option><option>60</option></select>
    </div>
  </div>

  <div class="list" id="challengeList"></div>

  <footer>
    <input class="search" id="searchBrand" placeholder="Search brands or tags…"/>
    <button class="btn" id="refreshLobby">Refresh</button>
  </footer>
</aside>

<!-- hidden audio elements -->
<audio id="audioL" preload="auto" crossorigin="anonymous"></audio>
<audio id="audioR" preload="auto" crossorigin="anonymous"></audio>

<script>
  /* ===== Helpers ===== */
  const $ = (s) => document.querySelector(s);

  // Elements
  const L = { pane:$('#paneL'), video:$('#videoL'), logoIn:$('#logoInputL'), logoImg:$('#logoImgL'), logoPh:$('#logoPhL'),
              vidIn:$('#videoInputL'), audIn:$('#audioInputL'), startAt:$('#startL'), linkIn:$('#linkL'),
              brandName:$('#brandNameL'), ctaShop:$('#ctaShopL'), ctaFollow:$('#ctaFollowL'), ctaMore:$('#ctaMoreL'),
              meter:$('#meterL'), eq:$('#eqL'), audio:$('#audioL'), votes:$('#votesL'), tap:$('#tapL') };
  const R = { pane:$('#paneR'), video:$('#videoR'), logoIn:$('#logoInputR'), logoImg:$('#logoImgR'), logoPh:$('#logoPhR'),
              vidIn:$('#videoInputR'), audIn:$('#audioInputR'), startAt:$('#startR'), linkIn:$('#linkR'),
              brandName:$('#brandNameR'), ctaShop:$('#ctaShopR'), ctaFollow:$('#ctaFollowR'), ctaMore:$('#ctaMoreR'),
              meter:$('#meterR'), eq:$('#eqR'), audio:$('#audioR'), votes:$('#votesR'), tap:$('#tapR') };

  const topBar = $('#topBar');
  const adCategory = $('#adCategory'); const adSub = $('#adSub');
  const startBar = $('#startBar'); const startBtn = $('#startBtn');
  const roundsSel = $('#roundsSel'); const turnLenSel = $('#turnLen');
  const roundsChip = $('#roundsChip'); const timerChip = $('#timerChip');
  const exitBtn = $('#exitBtn'); const flagBtn = $('#flagBtn'); const hint = $('#hint');

  // Lobby
  const lobby = $('#lobby'); const openLobbyBtn = $('#openLobbyBtn'); const closeLobby = $('#closeLobby');
  const postChallengeBtn = $('#postChallengeBtn'); const challengeList = $('#challengeList');
  const filterCategory = $('#filterCategory'); const filterRounds = $('#filterRounds'); const filterTurn = $('#filterTurn');
  const searchBrand = $('#searchBrand'); const refreshLobby = $('#refreshLobby');

  /* ===== Layout fixes (no overlaps) =====
     - We split app into topbar (row 0) + arena (row 1)
     - All pane UI is positioned inside pane, with explicit bottoms.
     - No absolute elements from topbar intrude into arena. */

  /* ===== Navigation ===== */
  exitBtn.addEventListener('click', ()=>{ window.location.href='home.html'; });

  flagBtn.addEventListener('click', ()=>{
    const side = currentSide==='left' ? (L.brandName.value||'Brand A') : (R.brandName.value||'Brand B');
    alert('Flag submitted for: ' + side);
  });

  /* ===== File loaders ===== */
  function loadFileTo(el, file){
    const url = URL.createObjectURL(file);
    el.src = url; return url;
  }

  [L,R].forEach(S=>{
    S.logoIn.addEventListener('change', e=>{
      const f=e.target.files?.[0]; if(!f) return;
      S.logoImg.src = URL.createObjectURL(f);
      S.logoImg.style.display='block'; S.logoPh.style.display='none';
    });
    S.vidIn.addEventListener('change', e=>{
      const f=e.target.files?.[0]; if(!f) return;
      loadFileTo(S.video, f); S.video.loop=true; S.video.muted=true;
      S.video.play().catch(()=>{});
    });
  });

  /* ===== Music Meter (IG style) ===== */
  class Meter {
    constructor(audioEl, canvas){
      this.audioEl=audioEl; this.canvas=canvas; this.ctx2d=canvas.getContext('2d');
      this.ac=null; this.src=null; this.an=null; this.data=null; this.raf=null;
    }
    async init(){
      if(this.ac) return;
      this.ac = new (window.AudioContext||window.webkitAudioContext)();
      this.src = this.ac.createMediaElementSource(this.audioEl);
      this.an  = this.ac.createAnalyser(); this.an.fftSize=256;
      this.src.connect(this.an); this.an.connect(this.ac.destination);
      this.data = new Uint8Array(this.an.frequencyBinCount);
    }
    draw(){
      const {width,height}=this.canvas; this.ctx2d.clearRect(0,0,width,height);
      this.an.getByteFrequencyData(this.data);
      const bars=32, step=Math.floor(this.data.length/bars), barW=width/bars;
      for(let i=0;i<bars;i++){
        const v=this.data[i*step]/255; const h=Math.max(2, v*height);
        const x=i*barW, y=height-h; this.ctx2d.fillStyle='rgba(255,255,255,.85)';
        this.ctx2d.fillRect(x+2,y,barW-4,h);
      }
      this.raf=requestAnimationFrame(()=>this.draw());
    }
    start(){ cancelAnimationFrame(this.raf); this.draw(); }
    stop(){ cancelAnimationFrame(this.raf); this.ctx2d.clearRect(0,0,this.canvas.width,this.canvas.height); }
  }
  const meterL = new Meter($('#audioL'), $('#eqL'));
  const meterR = new Meter($('#audioR'), $('#eqR'));

  function fitCanvasHiDPI(cnv){
    const dpr=Math.max(1,window.devicePixelRatio||1);
    const rect=cnv.getBoundingClientRect();
    cnv.width=Math.round(rect.width*dpr); cnv.height=Math.round(rect.height*dpr);
    const ctx=cnv.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  [$('#eqL'),$('#eqR')].forEach(c=>fitCanvasHiDPI(c));
  window.addEventListener('resize', ()=>[$('#eqL'),$('#eqR')].forEach(c=>fitCanvasHiDPI(c)));

  [[L,meterL],[R,meterR]].forEach(([S,M])=>{
    S.audIn.addEventListener('change', async e=>{
      const f=e.target.files?.[0]; if(!f) return;
      await M.init(); loadFileTo(S.audio,f); S.meter.style.display='block';
    });
  });

  // Bind CTAs to link inputs
  L.linkIn.addEventListener('input', ()=>{ L.ctaShop.href=L.linkIn.value||'#'; L.ctaMore.href=L.linkIn.value||'#'; });
  R.linkIn.addEventListener('input', ()=>{ R.ctaShop.href=R.linkIn.value||'#'; R.ctaMore.href=R.linkIn.value||'#'; });

  /* ===== Battle flow ===== */
  let roundsTotal=3, roundNow=1, turnSeconds=30, turnTimeLeft=30, currentSide='left', ticker=null;
  R.pane.classList.add('dim'); // default left starts

  function mmss(s){ const m=Math.floor(s/60).toString().padStart(2,'0'); const ss=Math.floor(s%60).toString().padStart(2,'0'); return `${m}:${ss}`; }

  function updateUIForTurn(){
    roundsChip.textContent=`R${roundNow} / ${roundsTotal}`;
    timerChip.textContent=mmss(turnTimeLeft);
    if(currentSide==='left'){
      L.pane.classList.remove('dim'); R.pane.classList.add('dim');
      L.video.muted=false; R.video.muted=true;
      if(L.video.src) L.video.play().catch(()=>{}); if(R.video.src) R.video.play().catch(()=>{});
      if(L.audio.src){ L.audio.muted=false; if(L.startAt.value) L.audio.currentTime=+L.startAt.value; L.audio.play().catch(()=>{}); meterL.start(); }
      if(R.audio.src){ R.audio.pause(); meterR.stop(); }
    } else {
      R.pane.classList.remove('dim'); L.pane.classList.add('dim');
      R.video.muted=false; L.video.muted=true;
      if(L.video.src) L.video.play().catch(()=>{}); if(R.video.src) R.video.play().catch(()=>{});
      if(R.audio.src){ R.audio.muted=false; if(R.startAt.value) R.audio.currentTime=+R.startAt.value; R.audio.play().catch(()=>{}); meterR.start(); }
      if(L.audio.src){ L.audio.pause(); meterL.stop(); }
    }
  }

  function swapTurnOrRound(){
    if(currentSide==='left'){ currentSide='right'; turnTimeLeft=turnSeconds; updateUIForTurn(); }
    else{
      if(roundNow<roundsTotal){ roundNow+=1; currentSide='left'; turnTimeLeft=turnSeconds; updateUIForTurn(); }
      else{ endBattle(); }
    }
  }

  function tick(){ turnTimeLeft-=1; timerChip.textContent=mmss(turnTimeLeft); if(turnTimeLeft<=0) swapTurnOrRound(); }

  function hideNonEssential(hide=true){
    document.querySelectorAll('.hide-on-start').forEach(el=>el.classList.toggle('hidden', hide));
    // Lock top categories once battle begins
    adCategory.disabled = hide; adSub.disabled = hide;
  }

  function startBattle(){
    roundsTotal=parseInt(roundsSel.value,10);
    turnSeconds=parseInt(turnLenSel.value,10);
    turnTimeLeft=turnSeconds; roundNow=1; currentSide='left';
    hideNonEssential(true); hint.classList.remove('hidden');
    updateUIForTurn(); clearInterval(ticker); ticker=setInterval(tick,1000);
    [L.video,R.video].forEach(v=>{ if(v.src) v.play().catch(()=>{}); });
  }

  function endBattle(){
    clearInterval(ticker); ticker=null;
    meterL.stop(); meterR.stop(); L.audio.pause(); R.audio.pause();
    hideNonEssential(false);
  }

  startBtn.addEventListener('click', startBattle);

  // tap-to-vote
  let votesL=0, votesR=0;
  function registerVote(side){
    if(!ticker) return;
    if(side==='left'){ votesL++; L.votes.textContent=votesL; }
    else { votesR++; R.votes.textContent=votesR; }
    hint.classList.add('hidden');
    const pane = side==='left'? L.pane : R.pane;
    pane.style.outline='2px solid ' + (side==='left'?'#7dd3fc':'#c4b5fd');
    setTimeout(()=>pane.style.outline='',120);
  }
  L.tap.addEventListener('click', ()=>registerVote('left'));
  R.tap.addEventListener('click', ()=>registerVote('right'));
  window.addEventListener('keydown',(e)=>{ if(e.key==='ArrowLeft')registerVote('left'); if(e.key==='ArrowRight')registerVote('right'); if(e.key==='Escape')exitBtn.click(); });

  // Allow meter resume on first user gesture (mobile)
  document.addEventListener('click', async ()=>{ try{ await meterL.ac?.resume(); await meterR.ac?.resume(); }catch{} }, {once:true});

  /* ===== MATCHMAKING LOBBY (Find other companies) =====
     Simple in-memory listings to demo flow.
     Hook to Firestore later: collection "adChallenges" with fields:
     { brand, category, sub, rounds, turn, tags, link, createdAt, status } */

  const demoListings = [
    {brand:'Volt Sneakers', category:'Fashion', sub:'Sneakers', rounds:3, turn:30, tags:['street','drops'], link:'https://voltsneakers.example'},
    {brand:'Pulse Energy', category:'Food & Beverage', sub:'Energy Drinks', rounds:3, turn:30, tags:['esports','new'], link:'https://pulse.example'},
    {brand:'Nebula Phones', category:'Tech', sub:'Smartphones', rounds:5, turn:45, tags:['camera','5G'], link:'https://nebula.example'},
    {brand:'Glow Cosmetics', category:'Beauty', sub:'Lip', rounds:1, turn:30, tags:['vegan'], link:'https://glow.example'},
    {brand:'Apex Motors', category:'Auto', sub:'EV', rounds:3, turn:60, tags:['ev','lux'], link:'https://apex.example'},
    {brand:'SkyFit', category:'Fitness', sub:'Wearables', rounds:3, turn:15, tags:['coach'], link:'https://skyfit.example'},
  ];

  let listings = [...demoListings];

  function renderListings(){
    const cat = filterCategory.value;
    const rr = filterRounds.value;
    const tt = filterTurn.value;
    const q  = searchBrand.value.trim().toLowerCase();

    challengeList.innerHTML='';
    const filtered = listings.filter(it=>{
      if(cat!=='All' && it.category!==cat) return false;
      if(rr!=='Any' && String(it.rounds)!==rr) return false;
      if(tt!=='Any' && String(it.turn)!==tt) return false;
      if(q && !(it.brand.toLowerCase().includes(q) || it.tags.join(' ').toLowerCase().includes(q))) return false;
      return true;
    });

    if(!filtered.length){
      const empty=document.createElement('div');
      empty.style.opacity='.7'; empty.style.padding='.8rem';
      empty.textContent='No open challenges. Create one!';
      challengeList.appendChild(empty); return;
    }

    filtered.forEach(it=>{
      const card=document.createElement('div'); card.className='card';
      card.innerHTML = `
        <div class="logo" style="width:36px;height:36px;border-radius:10px;background:#111"></div>
        <div class="grow">
          <div style="font-weight:800">${it.brand}</div>
          <div class="brandTag">${it.category}${it.sub?(' • '+it.sub):''} • ${it.rounds}R • ${it.turn}s • #${it.tags.join(' #')}</div>
        </div>
        <a class="btn" href="${it.link}" target="_blank" rel="noopener">Site</a>
        <button class="btn gold">Challenge</button>
      `;
      const btn = card.querySelector('.btn.gold');
      btn.addEventListener('click', ()=>{
        // preload arena from listing
        adCategory.value = it.category;
        adSub.value = it.sub || '';
        roundsSel.value = String(it.rounds);
        turnLenSel.value = String(it.turn);
        closeLobby.click();
      });
      challengeList.appendChild(card);
    });
  }

  function openLobby(){ lobby.classList.add('open'); renderListings(); }
  function closeLobbyFn(){ lobby.classList.remove('open'); }
  openLobbyBtn.addEventListener('click', openLobby);
  closeLobby.addEventListener('click', closeLobbyFn);
  refreshLobby.addEventListener('click', renderListings);
  [filterCategory,filterRounds,filterTurn].forEach(el=>el.addEventListener('change', renderListings));
  searchBrand.addEventListener('input', renderListings);

  // Quick create challenge using current topbar selections
  postChallengeBtn.addEventListener('click', ()=>{
    const brand = (L.brandName.value || 'Unnamed Brand');
    const cat = adCategory.value;
    const sub = adSub.value.trim();
    const rounds = parseInt(roundsSel.value,10);
    const turn   = parseInt(turnLenSel.value,10);
    const link   = (L.linkIn.value || '#');
    const tags   = sub ? sub.toLowerCase().split(/\s+|,/) : [];
    listings.unshift({brand, category:cat, sub, rounds, turn, tags, link});
    openLobby(); // show at top
  });

  // UX: open lobby if user taps Find Opponent before setting anything
  // already handled by openLobbyBtn

  // Keep everything visible and organized BEFORE start
  hideNonEssential(false);
</script>
</body>
</html>
