<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Ad Arena — Vertical Battle Reels</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&family=Orbitron:wght@600;800&display=swap" rel="stylesheet"/>
<style>
  :root{
    --bg:#0b0b0c; --ink:#f5f7fb; --muted:#a6abb6; --gold:#ffd700;
    --glass:rgba(255,255,255,.06); --bd:#ffffff26; --dim:rgba(0,0,0,.55);
    /* These are measured by JS to lock the layout to the phone viewport */
    --topH:56px; --botH:56px; --stackH:calc(100vh - var(--topH) - var(--botH));
    --paneH:calc(var(--stackH)/2);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow:hidden}
  .safe{padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)}
  .app{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr auto}

  /* Top bar */
  .topbar{position:relative;z-index:30;display:flex;gap:.6rem;align-items:center;padding:.6rem .8rem;
    background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border-bottom:1px solid var(--bd);backdrop-filter:blur(10px)}
  .logoWord{font-family:Orbitron,Inter,sans-serif;font-weight:800;letter-spacing:.5px}
  .pill{display:inline-flex;align-items:center;gap:.4rem;border:1px solid var(--bd);background:var(--glass);border-radius:999px;padding:.38rem .6rem}
  .pill select,.pill input{appearance:none;background:transparent;border:none;color:var(--ink);font-weight:700;outline:none;min-width:0}
  .spacer{flex:1}
  .btn{border:1px solid var(--bd);background:#ffffff14;color:var(--ink);border-radius:12px;padding:.46rem .72rem;font-weight:800}
  .btn.gold{background:linear-gradient(180deg,#ffe88a,#ffc400);border:none;color:#121212}

  /* Vertical arena stack */
  .stack{position:relative;height:var(--stackH);display:flex;flex-direction:column;gap:0;overflow:hidden}
  .pane{position:relative;height:var(--paneH);min-height:var(--paneH);max-height:var(--paneH);background:#000}
  .stage{position:absolute;inset:0;display:grid;place-items:center}
  /* phone-like vertical video mask 9:16 */
  .phone{position:relative;width:min(100%,56vh);height:100%;max-height:100%;display:grid;place-items:center}
  .frame{position:relative;aspect-ratio:9/16;height:96%;max-height:96%;width:auto;border-radius:18px;overflow:hidden;border:1px solid #ffffff20;background:#000}
  video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000}
  .shade{position:absolute;inset:0;background:transparent;transition:background .25s ease;z-index:2}
  .pane.dim .shade{background:var(--dim)}

  /* HUD */
  .hud{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:space-between;z-index:3;pointer-events:none}
  .toprow{display:flex;justify-content:space-between;align-items:center;padding:.5rem .6rem}
  .center-top{position:absolute;left:50%;transform:translateX(-50%);top:.5rem;display:flex;gap:.4rem;align-items:center}
  .chip{pointer-events:auto;display:inline-flex;align-items:center;gap:.4rem;background:var(--glass);border:1px solid var(--bd);border-radius:999px;padding:.34rem .6rem;font-weight:800}
  .rounds,.timer{font-family:Orbitron,Inter,sans-serif;letter-spacing:.5px}
  .timer{min-width:86px;text-align:center}
  .iconbtn{pointer-events:auto;display:grid;place-items:center;width:38px;height:38px;border-radius:999px;background:var(--glass);border:1px solid var(--bd)}
  .iconbtn svg{width:18px;height:18px}
  .votes{position:absolute;top:2.6rem;right:.6rem;background:var(--glass);border:1px solid var(--bd);padding:.26rem .5rem;border-radius:999px;font-weight:800;z-index:3}

  /* Composer / brand controls inside pane (never overflow) */
  .inline-controls{position:absolute;left:50%;transform:translateX(-50%);bottom:.7rem;display:flex;gap:.5rem;z-index:5}
  .minibtn{pointer-events:auto;border:1px solid var(--bd);background:#ffffff12;color:var(--ink);border-radius:12px;padding:.4rem .6rem;font-weight:800}
  .minibtn.gold{background:linear-gradient(180deg,#ffe88a,#ffc400);border:none;color:#121212}
  .hint{position:absolute;bottom:50%;left:50%;transform:translate(-50%,50%);background:var(--glass);border:1px solid var(--bd);
    padding:.32rem .54rem;border-radius:10px;font-size:.82rem;z-index:2;opacity:.85}

  /* Bottom nav */
  .bottomnav{position:relative;z-index:30;display:flex;align-items:center;justify-content:space-around;
    height:calc(56px + env(safe-area-inset-bottom));padding-bottom:env(safe-area-inset-bottom);
    border-top:1px solid var(--bd);background:rgba(16,16,18,.98);backdrop-filter:blur(10px)}
  .navbtn{display:flex;flex-direction:column;align-items:center;gap:.2rem;text-decoration:none;color:var(--ink);opacity:.9}
  .navbtn svg{width:22px;height:22px}
  .navbtn.active{opacity:1}
  .navlbl{font-size:.7rem}

  /* Modal base */
  .modal{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.5);z-index:60}
  .modal.open{display:flex}
  .sheet{width:min(960px,96vw);max-height:86vh;overflow:auto;background:rgba(20,20,22,.98);
    border:1px solid var(--bd);border-radius:16px 16px 0 0;padding:1rem;backdrop-filter:blur(12px)}
  .sheet header{display:flex;align-items:center;gap:.6rem;margin-bottom:.6rem}
  .pill.small{padding:.3rem .5rem;border-radius:10px}
  .row{display:flex;gap:.6rem;flex-wrap:wrap}
  .grid{display:grid;gap:.6rem}
  .grid.cols2{grid-template-columns:1fr 1fr}
  .field{display:flex;align-items:center;gap:.42rem;background:var(--glass);border:1px solid var(--bd);border-radius:12px;padding:.44rem .6rem}
  .field label{font-size:.86rem;color:var(--muted)}
  .field input[type="file"], .field input[type="number"], .field input[type="url"], .field input[type="text"], .field input[type="range"]{background:transparent;border:none;color:var(--ink);font-weight:700;outline:none}
  .field input[type="range"]{width:160px}
  .ghost{opacity:.7}

  /* Reel preview inside composer (9:16) */
  .reel-preview{display:grid;grid-template-columns:minmax(0,1fr) 300px;gap:.8rem}
  .reel-phone{position:relative;aspect-ratio:9/16;border-radius:16px;border:1px solid #ffffff22;overflow:hidden;background:#000}
  .reel-phone video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  .reel-phone canvas{position:absolute;inset:auto 8px 8px 8px;height:44px;border-radius:8px;background:#0c0c0e;border:1px solid var(--bd)}
  .reel-sidebar{display:grid;align-content:start;gap:.6rem}

  @media (max-width: 900px){
    .reel-preview{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="app safe">
  <!-- Top bar -->
  <div class="topbar" id="topBar">
    <div class="logoWord">AD ARENA</div>
    <div class="pill"><span class="ghost">Category</span>
      <select id="adCategory">
        <option selected>Fashion</option><option>Food & Beverage</option><option>Tech</option>
        <option>Gaming</option><option>Beauty</option><option>Auto</option><option>Finance</option>
        <option>Fitness</option><option>Music</option><option>Travel</option><option>Education</option>
        <option>Entertainment</option><option>Sports</option><option>Health</option><option>Nonprofit</option><option>Apps</option>
      </select>
    </div>
    <div class="pill"><span class="ghost">Sub</span><input id="adSub" placeholder="Sneakers, Energy Drinks…"/></div>
    <div class="spacer"></div>
    <button class="btn" id="findBtn">Find Opponent</button>
    <button class="btn gold" id="createBtn">Create Battle</button>
  </div>

  <!-- Vertical stack: TOP = Brand A, BOTTOM = Brand B -->
  <div class="stack" id="stack">
    <!-- Pane A -->
    <section class="pane" id="paneA">
      <div class="stage">
        <div class="phone"><div class="frame"><video id="vidA" playsinline muted></video></div></div>
      </div>
      <div class="shade"></div>
      <div class="hud">
        <div class="toprow">
          <button class="iconbtn" id="exitBtn" title="Exit">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" d="M6 6l12 12M18 6L6 18"/></svg>
          </button>
          <div class="center-top">
            <div class="chip rounds" id="roundsChip">R1 / 3</div>
            <div class="chip timer" id="timerChip">00:30</div>
          </div>
          <button class="iconbtn" id="flagBtn" title="Flag">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" d="M4 4v16M4 4h11l-1.5 3H20l-2 4 2 4h-4l-1.5-3H4"/></svg>
          </button>
        </div>
        <div class="votes" id="votesA">0</div>
        <div class="hint hide-on-start" id="hint">Tap a pane to vote during battle</div>
      </div>
      <div class="inline-controls hide-on-start">
        <button class="minibtn" id="composeA">Edit Reel</button>
        <a class="minibtn" id="ctaA" href="#" target="_blank" rel="noopener">CTA</a>
      </div>
      <div class="tapzone" id="tapA" style="position:absolute;inset:0;z-index:1"></div>
    </section>

    <!-- Pane B -->
    <section class="pane" id="paneB">
      <div class="stage">
        <div class="phone"><div class="frame"><video id="vidB" playsinline muted></video></div></div>
      </div>
      <div class="shade"></div>
      <div class="hud">
        <div class="toprow" aria-hidden="true"></div>
        <div class="votes" id="votesB">0</div>
      </div>
      <div class="inline-controls hide-on-start">
        <button class="minibtn" id="composeB">Edit Reel</button>
        <a class="minibtn" id="ctaB" href="#" target="_blank" rel="noopener">CTA</a>
      </div>
      <div class="tapzone" id="tapB" style="position:absolute;inset:0;z-index:1"></div>
    </section>

    <!-- Start controls (center) -->
    <div class="chip hide-on-start" id="startBar" style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);display:flex;gap:.5rem;align-items:center">
      <span style="font-weight:800">Rounds</span>
      <select id="roundsSel"><option>1</option><option selected>3</option><option>5</option></select>
      <span style="font-weight:800">Turn</span>
      <select id="turnSel"><option>15</option><option selected>30</option><option>45</option><option>60</option></select>
      <button class="minibtn gold" id="startBtn">Start</button>
    </div>
  </div>

  <!-- Bottom nav -->
  <nav class="bottomnav" id="bottomNav">
    <a class="navbtn" href="#"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" d="M3 11l9-8 9 8v9"/></svg><span class="navlbl">Home</span></a>
    <a class="navbtn" href="#"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="11" cy="11" r="7" stroke-width="2"/><path d="M21 21l-4.3-4.3" stroke-width="2"/></svg><span class="navlbl">Discover</span></a>
    <a class="navbtn active" href="#"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="5" y="4" width="14" height="7" rx="1.5" stroke-width="2"/><rect x="5" y="13" width="14" height="7" rx="1.5" stroke-width="2"/></svg><span class="navlbl">Ad Arena</span></a>
    <a class="navbtn" href="#"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><path stroke-width="2" d="M7 10l5 5 5-5"/></svg><span class="navlbl">Inbox</span></a>
    <a class="navbtn" href="#"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="7" r="4" stroke-width="2"/><path stroke-width="2" d="M5.5 21a6.5 6.5 0 0 1 13 0"/></svg><span class="navlbl">Profile</span></a>
  </nav>
</div>

<!-- =================== REEL COMPOSER (Reusable for A or B) =================== -->
<div class="modal" id="composer">
  <div class="sheet">
    <header>
      <button class="btn" id="closeComposer">Close</button>
      <div style="font-weight:800;margin-left:.4rem">Reel Composer</div>
      <div class="spacer"></div>
      <button class="btn gold" id="applyReel">Apply to Pane</button>
    </header>

    <div class="reel-preview">
      <div class="reel-phone">
        <video id="reelVideo" playsinline muted loop></video>
        <canvas id="eqCanvas"></canvas>
      </div>

      <div class="reel-sidebar">
        <div class="row">
          <div class="pill small"><span class="ghost">Aspect</span>
            <select id="aspectSel">
              <option value="9:16" selected>9:16</option>
              <option value="4:5">4:5</option>
              <option value="1:1">1:1</option>
            </select>
          </div>
          <div class="pill small"><span class="ghost">Loop</span>
            <select id="loopSel"><option>On</option><option>Off</option></select>
          </div>
          <div class="pill small"><span class="ghost">Speed</span>
            <select id="speedSel"><option>0.5x</option><option selected>1x</option><option>1.5x</option><option>2x</option></select>
          </div>
        </div>

        <div class="grid cols2">
          <div class="field full"><label>Video</label><input id="reelVideoFile" type="file" accept="video/*" capture="user"/></div>
          <div class="field full"><label>Music</label><input id="reelAudioFile" type="file" accept="audio/*"/></div>
        </div>

        <div class="field"><label>Music Offset</label><input id="musicOffset" type="number" min="0" value="0"/><span class="ghost">sec</span></div>

        <div class="row">
          <div class="field"><label>Trim Start</label><input id="trimStart" type="number" min="0" value="0"/></div>
          <div class="field"><label>Trim End</label><input id="trimEnd" type="number" min="1" value="30"/></div>
        </div>

        <div class="row">
          <div class="field"><label>Video Vol</label><input id="volVideo" type="range" min="0" max="1" step="0.05" value="1"/></div>
          <div class="field"><label>Music Vol</label><input id="volMusic" type="range" min="0" max="1" step="0.05" value="0.9"/></div>
        </div>

        <div class="grid">
          <div class="field full"><label>CTA Link</label><input id="reelCTA" placeholder="https://your-landingpage.com"/></div>
          <div class="field full"><label>Cover Frame (sec)</label><input id="coverSec" type="number" min="0" value="0"/></div>
        </div>

        <div class="row" style="justify-content:flex-end">
          <button class="btn" id="previewBtn">Preview Range</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Hidden audio for panes -->
<audio id="audA" preload="auto" crossorigin="anonymous"></audio>
<audio id="audB" preload="auto" crossorigin="anonymous"></audio>

<script>
  const $ = (s)=>document.querySelector(s);

  /* ——— Viewport locking (no overflow) ——— */
  const topBar = $('#topBar'), bottomNav = $('#bottomNav');
  function lockHeights(){
    const t = Math.round(topBar.getBoundingClientRect().height);
    const b = Math.round(bottomNav.getBoundingClientRect().height);
    document.documentElement.style.setProperty('--topH', t+'px');
    document.documentElement.style.setProperty('--botH', b+'px');
    const stackH = window.innerHeight - t - b;
    document.documentElement.style.setProperty('--stackH', stackH+'px');
    document.documentElement.style.setProperty('--paneH', (stackH/2)+'px');
  }
  addEventListener('load', lockHeights);
  addEventListener('resize', lockHeights);
  addEventListener('orientationchange', lockHeights);

  /* ——— Elements ——— */
  const vidA = $('#vidA'), vidB = $('#vidB');
  const audA = $('#audA'), audB = $('#audB');
  const votesA = $('#votesA'), votesB = $('#votesB');
  const hint = $('#hint');
  const roundsChip = $('#roundsChip'), timerChip = $('#timerChip');
  const roundsSel = $('#roundsSel'), turnSel = $('#turnSel');
  const startBtn = $('#startBtn');
  const startBar = $('#startBar');
  const exitBtn = $('#exitBtn'), flagBtn = $('#flagBtn');

  // Pane dimming (top starts)
  $('#paneB').classList.add('dim');

  /* ——— Composer state ——— */
  const composer = $('#composer');
  const closeComposer = $('#closeComposer');
  const applyReel = $('#applyReel');
  const previewBtn = $('#previewBtn');
  const reelVideo = $('#reelVideo');
  const reelVideoFile = $('#reelVideoFile');
  const reelAudioFile = $('#reelAudioFile');
  const eqCanvas = $('#eqCanvas');
  const musicOffset = $('#musicOffset');
  const trimStart = $('#trimStart');
  const trimEnd = $('#trimEnd');
  const volVideo = $('#volVideo'), volMusic = $('#volMusic');
  const aspectSel = $('#aspectSel'), loopSel = $('#loopSel'), speedSel = $('#speedSel');
  const reelCTA = $('#reelCTA');
  const coverSec = $('#coverSec');

  // Which pane are we editing?
  let activePane = 'A';

  $('#composeA').addEventListener('click', ()=>openComposer('A'));
  $('#composeB').addEventListener('click', ()=>openComposer('B'));

  function openComposer(pane){
    activePane = pane;
    composer.classList.add('open');
    // seed current settings per pane (if any)
    const s = state[pane];
    if(s.loaded){
      trimStart.value = s.trimStart ?? 0;
      trimEnd.value = s.trimEnd ?? Math.ceil((s.duration||30));
      musicOffset.value = s.musicOffset ?? 0;
      volVideo.value = s.volVideo ?? 1;
      volMusic.value = s.volMusic ?? 0.9;
      loopSel.value = s.loop ? 'On' : 'Off';
      speedSel.value = (s.speed||1)+'x';
      aspectSel.value = s.aspect || '9:16';
      reelCTA.value = s.cta || '';
      coverSec.value = s.coverSec ?? 0;
      if(s.videoURL){ reelVideo.src = s.videoURL; }
      reelVideo.muted = true;
      reelVideo.loop = loopSel.value==='On';
      reelVideo.play().catch(()=>{});
      setAspectOn(reelVideo, aspectSel.value);
    } else {
      // reset
      [trimStart.value, musicOffset.value, coverSec.value] = [0,0,0];
      trimEnd.value = 30;
      volVideo.value = 1; volMusic.value = 0.9;
      loopSel.value = 'On'; speedSel.value = '1x'; aspectSel.value='9:16'; reelCTA.value='';
      reelVideo.removeAttribute('src'); reelVideo.load();
    }
  }
  closeComposer.addEventListener('click', ()=>composer.classList.remove('open'));

  reelVideoFile.addEventListener('change', e=>{
    const f = e.target.files?.[0]; if(!f) return;
    const url = URL.createObjectURL(f);
    reelVideo.src = url; reelVideo.play().catch(()=>{});
    setTimeout(()=>{ trimEnd.value = Math.ceil(reelVideo.duration||30) }, 300);
  });

  reelAudioFile.addEventListener('change', e=>{
    const f = e.target.files?.[0]; if(!f) return;
    // store as pane state later on apply
  });

  aspectSel.addEventListener('change', ()=> setAspectOn(reelVideo, aspectSel.value));
  function setAspectOn(videoEl, val){
    const phone = videoEl.closest('.reel-phone');
    if(!phone) return;
    // enforce mask via CSS aspect ratio on container
    phone.style.aspectRatio = (val==='4:5') ? '4/5' : (val==='1:1' ? '1/1' : '9/16');
  }
  loopSel.addEventListener('change', ()=> reelVideo.loop = (loopSel.value==='On'));
  speedSel.addEventListener('change', ()=>{
    const s = parseFloat(speedSel.value.replace('x',''))||1;
    reelVideo.playbackRate = s;
  });

  // simple analyser bar (music appears after audio attach on apply)
  const eqCtx = eqCanvas.getContext('2d');
  function drawEQ(level=0){
    const w = eqCanvas.clientWidth || 280;
    const h = 44;
    const dpr = window.devicePixelRatio||1;
    eqCanvas.width = Math.round(w*dpr); eqCanvas.height = Math.round(h*dpr);
    eqCtx.setTransform(dpr,0,0,dpr,0,0);
    eqCtx.clearRect(0,0,w,h);
    const bars = 28, bw = w/bars;
    for(let i=0;i<bars;i++){
      const v = Math.abs(Math.sin((i+level)*0.6))*0.9+0.1;
      const barH = v*h;
      eqCtx.fillStyle = 'rgba(255,255,255,.9)';
      eqCtx.fillRect(i*bw+2, h-barH, bw-4, barH);
    }
  }
  drawEQ();

  previewBtn.addEventListener('click', ()=>{
    const start = +trimStart.value||0;
    const end = +trimEnd.value||start+5;
    reelVideo.currentTime = start;
    reelVideo.playbackRate = parseFloat(speedSel.value.replace('x',''))||1;
    reelVideo.play().catch(()=>{});
    clearTimeout(previewBtn._t);
    previewBtn._t = setTimeout(()=>{ reelVideo.pause(); }, Math.max(0,(end-start)*1000/ reelVideo.playbackRate));
  });

  // Save composer settings into pane state and load into main panes
  applyReel.addEventListener('click', async ()=>{
    const pane = activePane;
    const vid = pane==='A'?vidA:vidB;
    const aud = pane==='A'?audA:audB;
    const s = state[pane];

    // Video
    if(reelVideo.src){ s.videoURL = reelVideo.src; vid.src = s.videoURL; }
    s.aspect = aspectSel.value;
    s.loop = (loopSel.value==='On');
    s.speed = parseFloat(speedSel.value.replace('x',''))||1;

    // Trim
    s.trimStart = +trimStart.value||0;
    s.trimEnd = +trimEnd.value||Math.ceil(vid.duration||30);
    s.coverSec = +coverSec.value||0;

    // Music
    s.musicOffset = +musicOffset.value||0;
    s.volVideo = +volVideo.value;
    s.volMusic = +volMusic.value;

    // If a new audio file was picked, store it
    const newAudio = reelAudioFile.files?.[0];
    if(newAudio){ s.audioURL = URL.createObjectURL(newAudio); }

    // CTA
    s.cta = reelCTA.value||'#';
    (pane==='A'?$('#ctaA'):$('#ctaB')).href = s.cta;

    // Apply immediate playback defaults (muted in preview panes)
    vid.muted = true;
    vid.loop = true;
    vid.playbackRate = s.speed;
    try{ await vid.play(); }catch{}

    s.loaded = true;
    composer.classList.remove('open');
  });

  /* ——— Minimal battle engine (vertical) ——— */
  let roundsTotal = 3, roundNow = 1, turnSecs = 30, tLeft = 30, current = 'A', ticker=null;
  function mmss(s){ const m=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(Math.floor(s%60)).padStart(2,'0'); return `${m}:${ss}`; }
  function setEssentials(show){
    document.querySelectorAll('.hide-on-start').forEach(el=>el.classList.toggle('hidden', !show));
  }
  function startBattle(){
    roundsTotal = +roundsSel.value||3;
    turnSecs = +turnSel.value||30;
    tLeft = turnSecs; roundNow=1; current='A';
    setEssentials(false); hint.classList.remove('hidden');
    updateTurn(); clearInterval(ticker); ticker=setInterval(tick,1000);
  }
  function endBattle(){
    clearInterval(ticker); ticker=null;
    try{ audA.pause(); audB.pause(); }catch{}
    setEssentials(true);
  }
  function tick(){ tLeft--; timerChip.textContent = mmss(tLeft); if(tLeft<=0) swapTurn(); }
  startBtn.addEventListener('click', startBattle);
  exitBtn.addEventListener('click', ()=>location.href='home.html');
  flagBtn.addEventListener('click', ()=>alert('Flag submitted'));

  function swapTurn(){
    if(current==='A'){ current='B'; tLeft=turnSecs; updateTurn(); }
    else{ // completed both turns in round
      if(roundNow<roundsTotal){ roundNow++; current='A'; tLeft=turnSecs; updateTurn(); }
      else{ endBattle(); }
    }
  }

  function updateTurn(){
    roundsChip.textContent = `R${roundNow} / ${roundsTotal}`;
    timerChip.textContent = mmss(tLeft);
    const top = $('#paneA'), bottom = $('#paneB');
    if(current==='A'){
      top.classList.remove('dim'); bottom.classList.add('dim');
      playPane('A'); pausePane('B');
    } else {
      bottom.classList.remove('dim'); top.classList.add('dim');
      playPane('B'); pausePane('A');
    }
  }

  function playPane(p){
    const s = state[p];
    const v = (p==='A'?vidA:vidB);
    const a = (p==='A'?audA:audB);
    if(!s.loaded) return;

    // Video trim boundaries
    const st = s.trimStart||0;
    v.currentTime = st;
    v.muted = (s.volVideo===0);
    v.playbackRate = s.speed||1;
    v.loop = false;

    v.onended = null;
    v.ontimeupdate = ()=>{
      if(v.currentTime >= (s.trimEnd||v.duration||30)){
        // stop this turn at end of trimmed segment
        v.pause();
      }
    };
    v.play().catch(()=>{});

    // Audio (music)
    if(s.audioURL){
      a.src = s.audioURL;
      a.currentTime = s.musicOffset||0;
      a.volume = s.volMusic ?? 0.9;
      a.play().catch(()=>{});
    }
  }
  function pausePane(p){
    const v = (p==='A'?vidA:vidB);
    const a = (p==='A'?audA:audB);
    try{ v.pause(); }catch{}
    try{ a.pause(); }catch{}
  }

  // Voting
  let aVotes=0, bVotes=0;
  $('#tapA').addEventListener('click', ()=>{ if(ticker){ aVotes++; votesA.textContent=aVotes; hint.classList.add('hidden'); flash('#paneA'); }});
  $('#tapB').addEventListener('click', ()=>{ if(ticker){ bVotes++; votesB.textContent=bVotes; hint.classList.add('hidden'); flash('#paneB'); }});
  addEventListener('keydown',(e)=>{ if(e.key==='ArrowUp')$('#tapA').click(); if(e.key==='ArrowDown')$('#tapB').click(); });

  function flash(sel){ const el=$(sel); el.style.outline='2px solid #7dd3fc'; setTimeout(()=>el.style.outline='',120); }

  // Pane state
  const state = {
    A: { loaded:false, videoURL:null, audioURL:null, trimStart:0, trimEnd:30, musicOffset:0, volVideo:1, volMusic:0.9, aspect:'9:16', speed:1, loop:true, cta:'#', coverSec:0 },
    B: { loaded:false, videoURL:null, audioURL:null, trimStart:0, trimEnd:30, musicOffset:0, volVideo:1, volMusic:0.9, aspect:'9:16', speed:1, loop:true, cta:'#', coverSec:0 }
  };

  // Find/Create (stubs for now)
  $('#findBtn').addEventListener('click', ()=>alert('Open matchmaking lobby (wire to backend)'));
  $('#createBtn').addEventListener('click', ()=>openComposer('A'));

  // EQ animation placeholder
  let eqT=0; setInterval(()=>{ drawEQ(eqT+=0.3); }, 120);

  // Ensure initial UI shows setup controls
  function init(){ setEssentials(true); lockHeights(); }
  init();
</script>
</body>
</html>
