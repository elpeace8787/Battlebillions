<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Ad Arena — Street Fight Load</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&family=Orbitron:wght@700&display=swap" rel="stylesheet"/>
<style>
  :root{
    --bg:#07080b; --ink:#f5f7fb; --muted:#a4a9b6; --bd:#ffffff22; --glass:rgba(255,255,255,.07);
    --vh:100svh; --accent:#ff275b; --accent2:#4cf0ff; --gold:#ffd54a; --green:#63ffa6; --red:#ff5d5d;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  svg{display:inline-block;vertical-align:middle}

  /* ===== Topbar ===== */
  .topbar{position:sticky;top:0;z-index:40;display:flex;align-items:center;gap:.6rem;padding:.6rem .8rem;
    background:linear-gradient(180deg,rgba(9,10,14,.98),rgba(9,10,14,.9));border-bottom:1px solid var(--bd);backdrop-filter:blur(8px)}
  .logo{font-family:Orbitron,Inter,sans-serif;font-weight:700;letter-spacing:.4px}
  .spacer{flex:1}
  .btn{border:1px solid var(--bd);background:#12131a;color:var(--ink);border-radius:12px;padding:.5rem .8rem;font-weight:800}
  .btn.ghost{background:var(--glass)}
  .btn.gold{background:linear-gradient(180deg,#ffe88a,#ffc400);border:none;color:#121212}
  .chip{display:inline-flex;align-items:center;gap:.45rem;background:var(--glass);border:1px solid var(--bd);border-radius:999px;padding:.34rem .6rem;font-weight:800}
  #chips{display:none;gap:.5rem;margin-left:.5rem}

  /* ===== Live Surface ===== */
  .live{height:var(--vh);position:relative;overflow:hidden}

  /* Mobile: single full-bleed panel with quick switch; Desktop: both panels */
  .stage{position:absolute;inset:0;display:grid;place-items:center;background:#000}
  .frame{position:relative;inset:0;height:100%;width:100%;overflow:hidden}
  .frame video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}

  .stage#stageB{display:none} /* default to A on phones */
  @media(min-width:1024px){ .stage#stageB{display:grid} } /* both on desktop */

  /* Switcher (top) */
  .switcher{position:absolute;top:env(safe-area-inset-top);left:0;right:0;z-index:5;display:flex;justify-content:center;padding:.6rem}
  .seg{display:inline-flex;border:1px solid var(--bd);background:rgba(255,255,255,.08);border-radius:12px;overflow:hidden}
  .seg button{appearance:none;border:0;background:transparent;color:var(--ink);padding:.44rem .8rem;font-weight:800}
  .seg button.active{background:linear-gradient(180deg,#2b2f38,#181b22)}

  /* Bottom HUD (minimal during battle) */
  .hud{position:absolute;left:0;right:0;bottom:calc(10px + env(safe-area-inset-bottom));z-index:5;display:flex;justify-content:space-between;align-items:center;padding:0 .7rem}
  .stat{display:flex;align-items:center;gap:.4rem;background:rgba(255,255,255,.08);border:1px solid var(--bd);border-radius:10px;padding:.34rem .6rem;font-weight:800}
  .fab{display:grid;place-items:center;width:46px;height:46px;border-radius:999px;background:linear-gradient(180deg,#75e0ff,#2dd4bf);border:0;box-shadow:0 8px 30px rgba(45,212,191,.35)}
  .fab svg{width:20px;height:20px;color:#0b0d12}

  /* Slide-up Dock (controls) */
  .dock{position:absolute;left:0;right:0;bottom:0;z-index:6;transform:translateY(110%);transition:transform .25s ease;
    padding:.6rem .7rem calc(.7rem + env(safe-area-inset-bottom));background:linear-gradient(180deg,transparent 0%, rgba(8,8,10,.75) 22%, rgba(8,8,10,.96) 70%);border-top:1px solid var(--bd)}
  .dock.open{transform:translateY(0)}
  .row{display:flex;flex-wrap:wrap;gap:.55rem;align-items:center}
  .dock .chip select{appearance:none;background:transparent;border:0;color:var(--ink);font-weight:800;outline:none}
  .dock .cta{margin-left:auto;display:flex;gap:.5rem}

  /* ===== STREET FIGHT LOAD OVERLAY ===== */
  .load{
    position:absolute;inset:0;z-index:20;display:flex;flex-direction:column;justify-content:space-between;
    pointer-events:auto; /* covers screen before fight */
    background:
      radial-gradient(1200px 500px at 50% -200px, rgba(255,39,91,.12), transparent 60%),
      radial-gradient(1000px 420px at 50% 120%, rgba(76,240,255,.10), transparent 60%),
      linear-gradient(180deg, rgba(0,0,0,.4), rgba(0,0,0,.75));
  }
  .load.hidden{display:none}

  /* scanlines & subtle noise */
  .scanlines::after{
    content:"";position:absolute;inset:0;pointer-events:none;mix-blend-mode:soft-light;opacity:.25;background:
      repeating-linear-gradient(0deg, rgba(255,255,255,.05) 0 1px, transparent 1px 3px);
  }

  /* Nameplates */
  .plates{display:flex;justify-content:space-between;padding:calc(.8rem + env(safe-area-inset-top)) .8rem 0;position:relative}
  .plate{
    display:flex;align-items:center;gap:.6rem;border:1px solid var(--bd);
    background:linear-gradient(180deg,rgba(20,22,28,.9),rgba(14,15,20,.9));border-radius:14px;padding:.5rem .7rem;
    box-shadow:0 10px 40px rgba(0,0,0,.3), inset 0 0 30px rgba(255,255,255,.06)
  }
  .plate .dot{width:10px;height:10px;border-radius:999px}
  .plateA .dot{background:var(--accent2)}
  .plateB .dot{background:var(--accent)}
  .plate strong{font-weight:800;letter-spacing:.4px}

  /* Power bars */
  .bars{display:flex;gap:.8rem;align-items:center;justify-content:center;padding:.6rem .8rem}
  .barWrap{width:min(44%,540px);height:14px;background:#0e1015;border:1px solid var(--bd);border-radius:999px;overflow:hidden;box-shadow:inset 0 0 16px rgba(0,0,0,.5)}
  .bar{height:100%;background:linear-gradient(90deg,var(--green),#23c4ff);width:100%;transform-origin:left;transition:width .25s}
  .bar.red{background:linear-gradient(90deg,#ff7b7b,#ff275b)}

  /* Center VS badge */
  .vsWrap{position:relative;display:grid;place-items:center;padding-top:8vh}
  .vs{
    position:relative;display:grid;place-items:center;width:140px;height:140px;border-radius:999px;
    background:radial-gradient(circle at 50% 50%, #161922 0%, #0b0d14 60%);border:1px solid var(--bd);
    box-shadow:0 8px 40px rgba(255,39,91,.35), inset 0 0 40px rgba(76,240,255,.15);
    animation:pulse 1.8s ease-in-out infinite;
  }
  .vs::before, .vs::after{
    content:"";position:absolute;border-radius:999px;inset:-8px;border:2px dashed rgba(255,255,255,.12);animation:spin 12s linear infinite
  }
  .vs::after{inset:-18px;border-style:solid;border-color:rgba(255,255,255,.06);border-width:1px;animation-direction:reverse}
  .vs span{font-family:Orbitron,Inter,sans-serif;font-weight:700;font-size:42px;letter-spacing:.06em;background:linear-gradient(180deg,#fff,#a5b6ff);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 6px 20px rgba(165,182,255,.25)}
  @keyframes spin{to{transform:rotate(360deg)}}
  @keyframes pulse{0%,100%{box-shadow:0 8px 40px rgba(255,39,91,.35), inset 0 0 40px rgba(76,240,255,.15)}50%{box-shadow:0 12px 60px rgba(255,39,91,.55), inset 0 0 60px rgba(76,240,255,.28)}}

  /* Countdown */
  .count{margin-top:1.1rem;font-family:Orbitron,Inter,sans-serif;font-weight:800;font-size:38px;letter-spacing:.06em;color:#fff;opacity:.9;text-align:center}
  .count small{display:block;font-size:12px;color:var(--muted);margin-top:.2rem}

  /* Action row */
  .actions{display:flex;justify-content:center;gap:.6rem;padding:0 .8rem .9rem}
  .bulge{display:inline-flex;gap:.5rem;align-items:center;border:1px solid var(--bd);background:linear-gradient(180deg,#ffe88a,#ffc400);color:#111;border-radius:14px;padding:.6rem .9rem;font-weight:900;box-shadow:0 12px 40px rgba(255,196,0,.35)}
  .ghost{display:inline-flex;gap:.5rem;align-items:center;border:1px solid var(--bd);background:rgba(255,255,255,.08);border-radius:14px;padding:.6rem .9rem;font-weight:800}

  /* VS separator lightning */
  .bolt{position:absolute;left:50%;top:0;bottom:0;width:2px;background:linear-gradient(180deg,transparent,#ffffff33,transparent);transform:translateX(-1px)}
  .bolt:after{
    content:"";position:absolute;left:-12px;top:35%;width:26px;height:26px;border-radius:50%;
    background:radial-gradient(circle,#ffffff66,#ff3166aa 45%, transparent 65%);filter:blur(2px)
  }

  /* Subtle grunge edges */
  .grunge:before{content:"";position:absolute;inset:-20px;pointer-events:none;background:
    radial-gradient(120px 60px at -40px -40px, rgba(255,255,255,.07), transparent 60%),
    radial-gradient(120px 60px at calc(100% + 40px) calc(100% + 40px), rgba(255,255,255,.06), transparent 60%)}

  /* ===== Chooser / Composer ===== */
  .chooser{position:fixed;inset:0;z-index:60;display:none;flex-direction:column;background:rgba(10,10,12,.98);backdrop-filter:blur(10px)}
  .chooser.open{display:flex}
  .chooser header{display:flex;align-items:center;gap:.6rem;padding:.8rem .9rem;border-bottom:1px solid var(--bd)}
  .chooser .body{flex:1;overflow:auto;padding:1rem;display:grid;gap:1rem}
  .grid{display:grid;gap:.6rem}
  .grid.cols2{grid-template-columns:1fr 1fr}
  .tile{display:flex;align-items:center;gap:.6rem;border:1px solid var(--bd);background:var(--glass);border-radius:14px;padding:.7rem .8rem}
  .tile input{margin:0}
  .pillOpt{display:inline-flex;align-items:center;gap:.45rem;border:1px solid var(--bd);background:#ffffff12;border-radius:999px;padding:.42rem .6rem;cursor:pointer}
  .pillOpt.selected{outline:2px solid #ffffff3a}
  .chooser footer{display:flex;gap:.6rem;justify-content:flex-end;padding:.8rem .9rem;border-top:1px solid var(--bd);background:rgba(16,16,18,.9)}

  .modal{position:fixed;inset:0;z-index:70;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.55)}
  .modal.open{display:flex}
  .sheet{width:100%;max-width:980px;max-height:90svh;overflow:auto;background:rgba(20,20,22,.98);border:1px solid var(--bd);border-radius:16px 16px 0 0;padding:1rem}
  .sheet header{position:sticky;top:0;background:inherit;padding-bottom:.5rem;margin-bottom:.6rem;display:flex;gap:.6rem;align-items:center}
  .field{display:flex;align-items:center;gap:.5rem;border:1px solid var(--bd);background:#ffffff12;border-radius:12px;padding:.55rem .65rem}
  .field input,.field select{border:0;background:transparent;color:var(--ink);font-weight:700;outline:none}
  .form{display:grid;gap:.6rem;grid-template-columns:1fr 1fr}
  @media(max-width:860px){ .form{grid-template-columns:1fr} }
</style>
</head>
<body>
<header class="topbar">
  <div class="logo">AD ARENA</div>
  <div id="chips" class="row">
    <div class="chip" id="chipCat"></div>
    <div class="chip" id="chipSub"></div>
  </div>
  <div class="spacer"></div>
  <button class="btn ghost" id="openChooser" title="Categories">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7" rx="1.5" stroke-width="2"/><rect x="14" y="3" width="7" height="7" rx="1.5" stroke-width="2"/><rect x="3" y="14" width="7" height="7" rx="1.5" stroke-width="2"/><rect x="14" y="14" width="7" height="7" rx="1.5" stroke-width="2"/></svg>
    Categories
  </button>
  <button class="btn gold" id="openComposer" title="Edit Ad">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z" stroke-width="2"/><path d="M14.06 4.94l3.75 3.75" stroke-width="2"/></svg>
    Edit Ad
  </button>
</header>

<section class="live scanlines grunge" id="live">
  <!-- Switcher -->
  <div class="switcher">
    <div class="seg">
      <button id="segA" class="active">Panel A</button>
      <button id="segB">Panel B</button>
    </div>
  </div>

  <!-- Panels -->
  <div class="stage" id="stageA"><div class="frame"><video id="vidA" playsinline muted></video></div></div>
  <div class="stage" id="stageB"><div class="frame"><video id="vidB" playsinline muted></video></div></div>

  <!-- Minimal HUD -->
  <div class="hud">
    <div class="stat">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="9" stroke-width="2"/><path d="M12 7v5l3 2" stroke-width="2"/></svg>
      <span id="timer">00:30</span>
    </div>
    <button class="fab" id="toggleDock" title="Controls">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" d="M21 4H14M10 4H3M10 4v16M14 20V4M3 12h18"/></svg>
    </button>
  </div>

  <!-- Dock controls -->
  <div class="dock" id="dock">
    <div class="row">
      <div class="chip">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M7 7h10M7 12h10M7 17h10" stroke-width="2"/></svg>
        Rounds
        <select id="roundsSel"><option>1</option><option selected>3</option><option>5</option></select>
      </div>
      <div class="chip">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="9" stroke-width="2"/><path d="M12 7v5l3 2" stroke-width="2"/></svg>
        Turn
        <select id="turnSel"><option>15</option><option selected>30</option><option>45</option><option>60</option></select>
      </div>
      <button class="btn gold" id="startBattle">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M8 5v14l11-7z" stroke-width="2"/></svg>
        Start
      </button>
      <div class="spacer"></div>
      <div class="chip">A <strong id="scoreA">0</strong></div>
      <div class="chip">B <strong id="scoreB">0</strong></div>
      <div class="spacer"></div>
      <a class="btn ghost" id="ctaA" href="#" target="_blank" rel="noopener">CTA A</a>
      <a class="btn ghost" id="ctaB" href="#" target="_blank" rel="noopener">CTA B</a>
    </div>
  </div>

  <!-- STREET FIGHT LOAD OVERLAY -->
  <div class="load" id="load">
    <div class="plates">
      <div class="plate plateA">
        <span class="dot"></span>
        <strong id="plateA">Brand A</strong>
      </div>
      <div class="plate plateB">
        <span class="dot"></span>
        <strong id="plateB">Brand B</strong>
      </div>
    </div>

    <div class="bars">
      <div class="barWrap"><div class="bar" id="barA"></div></div>
      <div class="barWrap"><div class="bar red" id="barB"></div></div>
    </div>

    <div class="vsWrap">
      <div class="bolt"></div>
      <div class="vs"><span>VS</span></div>
      <div class="count" id="countTxt">READY?<small>Tap FIGHT when you’re set</small></div>
    </div>

    <div class="actions">
      <button class="bulge" id="fightBtn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M8 5v14l11-7z" stroke-width="2"/></svg>
        FIGHT!
      </button>
      <button class="ghost" id="swapBtn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 7h11l-1.5 3H20l-2 4 2 4h-4l-1.5-3H4" stroke-width="2"/></svg>
        Swap Sides
      </button>
      <button class="ghost" id="previewBtn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke-width="2"/><circle cx="12" cy="12" r="3" stroke-width="2"/></svg>
        Preview A/B
      </button>
    </div>
  </div>
</section>

<!-- CATEGORY → SUBCATEGORY -->
<div class="chooser" id="chooser">
  <header>
    <div class="logo">Choose Category</div>
    <div class="spacer"></div>
    <button class="btn" id="closeChooser">Close</button>
  </header>
  <div class="body">
    <div>
      <div style="font-weight:800;opacity:.9;margin-bottom:.4rem">1) Category</div>
      <div class="grid cols2" id="catGrid"></div>
    </div>
    <div>
      <div style="font-weight:800;opacity:.9;margin-bottom:.4rem">2) Subcategory</div>
      <div id="subGrid" class="grid"></div>
    </div>
  </div>
  <footer>
    <button class="btn" id="clearSel">Clear</button>
    <button class="btn gold" id="confirmSel" disabled>Confirm</button>
  </footer>
</div>

<!-- EDIT AD -->
<div class="modal" id="composer">
  <div class="sheet">
    <header>
      <button class="btn" id="closeComposer">Close</button>
      <div style="font-weight:800;margin-left:.5rem">Edit Ad</div>
      <div class="spacer"></div>
      <button class="btn gold" id="applyAd">Apply</button>
    </header>
    <div class="form">
      <div class="field"><label>Video</label><input id="videoFile" type="file" accept="video/*" capture="user"/></div>
      <div class="field"><label>Music</label><input id="audioFile" type="file" accept="audio/*"/></div>
      <div class="field"><label>Trim Start</label><input id="trimStart" type="number" min="0" value="0"/></div>
      <div class="field"><label>Trim End</label><input id="trimEnd" type="number" min="1" value="30"/></div>
      <div class="field"><label>Speed</label><select id="speedSel"><option>0.5x</option><option selected>1x</option><option>1.5x</option><option>2x</option></select></div>
      <div class="field"><label>Music Offset</label><input id="musicOffset" type="number" min="0" value="0"/></div>
      <div class="field"><label>Video Vol</label><input id="volVideo" type="range" min="0" max="1" step="0.05" value="1"/></div>
      <div class="field"><label>Music Vol</label><input id="volMusic" type="range" min="0" max="1" step="0.05" value="0.9"/></div>
      <div class="field"><label>CTA</label><input id="ctaLink" placeholder="https://your-landingpage.com"/></div>
    </div>
  </div>
</div>

<script>
  const $ = s => document.querySelector(s);

  /* ===== Real mobile viewport ===== */
  function setVH(){ const vv=window.visualViewport; document.documentElement.style.setProperty('--vh', Math.round(vv?.height||window.innerHeight)+'px');}
  ['load','resize','orientationchange','scroll'].forEach(ev=>addEventListener(ev,setVH,{passive:true})); setVH();

  /* ===== Panels & switcher ===== */
  const stageA=$('#stageA'), stageB=$('#stageB'), segA=$('#segA'), segB=$('#segB');
  const vidA=$('#vidA'), vidB=$('#vidB'); let active='A';
  function showPanel(which){ active=which; const isDesk=matchMedia('(min-width:1024px)').matches;
    if(isDesk){ stageA.style.display='grid'; stageB.style.display='grid'; return; }
    if(which==='A'){ stageA.style.display='grid'; stageB.style.display='none'; segA.classList.add('active'); segB.classList.remove('active'); }
    else { stageA.style.display='none'; stageB.style.display='grid'; segB.classList.add('active'); segA.classList.remove('active'); }
  }
  segA.addEventListener('click',()=>showPanel('A'));
  segB.addEventListener('click',()=>showPanel('B'));
  addEventListener('resize',()=>showPanel(active));

  /* ===== Dock ===== */
  const dock=$('#dock'), toggleDock=$('#toggleDock'); toggleDock.addEventListener('click',()=>dock.classList.toggle('open'));

  /* ===== Category chooser ===== */
  const CATEGORY_MAP = {
    "Fashion":["Sneakers","Apparel","Accessories","Luxury","Streetwear","Watches & Jewelry"],
    "Food & Beverage":["Energy Drinks","Snacks","Quick Service","Coffee","Groceries"],
    "Tech":["Smartphones","Laptops","Audio","Smart Home","Apps","AI Tools"],
    "Gaming":["Consoles","PC","Esports","Mobile Games","Peripherals"],
    "Beauty":["Skincare","Makeup","Hair","Fragrance"],
    "Auto":["EV","SUV","Sedan","Charging","Aftermarket"],
    "Finance":["Banking","Investing","Insurance","Fintech","Crypto"],
    "Fitness":["Wearables","Gym","Nutrition","Yoga"],
    "Music":["Streaming","Artists","Instruments"],
    "Travel":["Airlines","Hotels","Experiences","Luggage"],
    "Entertainment":["Streaming","Movies","Events","Tickets"]
  };
  const chooser=$('#chooser'), openChooser=$('#openChooser'), closeChooser=$('#closeChooser'),
        catGrid=$('#catGrid'), subGrid=$('#subGrid'), clearSel=$('#clearSel'), confirmSel=$('#confirmSel'),
        chips=$('#chips'), chipCat=$('#chipCat'), chipSub=$('#chipSub');
  let chosenCat=null, chosenSub=null;

  function renderCats(){ catGrid.innerHTML=''; Object.keys(CATEGORY_MAP).forEach(cat=>{
    const el=document.createElement('label'); el.className='tile';
    el.innerHTML=`<input type="radio" name="cat" value="${cat}"><strong>${cat}</strong>`;
    el.querySelector('input').addEventListener('change',()=>{ chosenCat=cat; chosenSub=null; renderSubs(cat); updateConfirm(); });
    catGrid.appendChild(el);
  });}
  function renderSubs(cat){ subGrid.innerHTML=''; if(!cat) return;
    const row=document.createElement('div'); row.style.display='flex'; row.style.flexWrap='wrap'; row.style.gap='.5rem';
    CATEGORY_MAP[cat].forEach(s=>{ const b=document.createElement('button'); b.type='button'; b.className='pillOpt'; b.textContent=s;
      b.addEventListener('click',()=>{ chosenSub=s; [...row.children].forEach(x=>x.classList.remove('selected')); b.classList.add('selected'); updateConfirm(); });
      row.appendChild(b);
    }); subGrid.appendChild(row);
  }
  function updateConfirm(){ confirmSel.disabled=!(chosenCat && chosenSub); }
  openChooser.addEventListener('click',()=>{ chooser.classList.add('open'); renderCats(); renderSubs(null); updateConfirm(); });
  closeChooser.addEventListener('click',()=> chooser.classList.remove('open'));
  clearSel.addEventListener('click',()=>{ chosenCat=null; chosenSub=null; renderCats(); renderSubs(null); updateConfirm(); });
  confirmSel.addEventListener('click',()=>{ chips.style.display='flex'; chipCat.textContent=chosenCat; chipSub.textContent=chosenSub; chooser.classList.remove('open'); });

  /* ===== Composer (Edit Ad) ===== */
  const composer=$('#composer'), openComposer=$('#openComposer'), closeComposer=$('#closeComposer'), applyAd=$('#applyAd');
  const videoFile=$('#videoFile'), audioFile=$('#audioFile'), trimStart=$('#trimStart'), trimEnd=$('#trimEnd'),
        speedSel=$('#speedSel'), musicOffset=$('#musicOffset'), volVideo=$('#volVideo'), volMusic=$('#volMusic'), ctaLink=$('#ctaLink');
  const audA=new Audio(), audB=new Audio();
  const state={A:{loaded:false}, B:{loaded:false}};
  let activePane='A';

  openComposer.addEventListener('click',()=>{ activePane=active; composer.classList.add('open'); loadComposer(activePane); });
  closeComposer.addEventListener('click',()=>composer.classList.remove('open'));

  function loadComposer(p){ const s=state[p]||{};
    speedSel.value=(s.speed||1)+'x'; trimStart.value=s.trimStart||0; trimEnd.value=s.trimEnd||30;
    musicOffset.value=s.musicOffset||0; volVideo.value=s.volVideo ?? 1; volMusic.value=s.volMusic ?? 0.9; ctaLink.value=s.cta||'';
  }

  applyAd.addEventListener('click',()=>{
    const p=activePane; const s=state[p]=state[p]||{}; const v=(p==='A'?vidA:vidB); const a=(p==='A'?audA:audB);
    if(videoFile.files?.[0]){ s.videoURL=URL.createObjectURL(videoFile.files[0]); v.src=s.videoURL; }
    if(audioFile.files?.[0]){ s.audioURL=URL.createObjectURL(audioFile.files[0]); a.src=s.audioURL; }
    s.trimStart=+trimStart.value||0; s.trimEnd=+trimEnd.value||30; s.speed=parseFloat(speedSel.value)||1;
    s.musicOffset=+musicOffset.value||0; s.volVideo=+volVideo.value; s.volMusic=+volMusic.value; s.cta=ctaLink.value||'#';
    (p==='A'?$('#ctaA'):$('#ctaB')).href=s.cta;
    v.muted=(s.volVideo===0); v.loop=true; v.playbackRate=s.speed; v.play().catch(()=>{});
    s.loaded=true; composer.classList.remove('open'); videoFile.value=''; audioFile.value='';
    // update plates if brand names embedded later
  });

  /* ===== Battle engine & Street Fight Load ===== */
  const roundsSel=$('#roundsSel'), turnSel=$('#turnSel'), startBattle=$('#startBattle');
  const timerEl=$('#timer'), scoreA=$('#scoreA'), scoreB=$('#scoreB');
  let ticker=null, tLeft=30, roundNow=1, roundsTotal=3, current='A', aVotes=0, bVotes=0;

  const loadOverlay=$('#load'), fightBtn=$('#fightBtn'), swapBtn=$('#swapBtn'), previewBtn=$('#previewBtn'),
        barA=$('#barA'), barB=$('#barB'), countTxt=$('#countTxt'), plateA=$('#plateA'), plateB=$('#plateB');

  function mmss(s){const m=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(Math.floor(s%60)).padStart(2,'0'); return `${m}:${ss}`;}

  function playPane(p){
    const s=state[p]; if(!s.loaded) return; const v=(p==='A'?vidA:vidB), a=(p==='A'?audA:audB);
    v.currentTime=s.trimStart||0; v.playbackRate=s.speed||1; v.loop=true; v.play().catch(()=>{});
    if(s.audioURL){ a.currentTime=s.musicOffset||0; a.volume=s.volMusic ?? 0.9; a.loop=true; a.play().catch(()=>{}); }
  }
  function pausePane(p){ const v=(p==='A'?vidA:vidB), a=(p==='A'?audA:audB); try{v.pause();}catch{} try{a.pause();}catch{} }

  function showLoad(){ loadOverlay.classList.remove('hidden'); barA.style.width='100%'; barB.style.width='100%'; countTxt.textContent='READY?'; }
  function hideLoad(){ loadOverlay.classList.add('hidden'); }

  function start(){
    roundsTotal=+roundsSel.value||3; tLeft=+turnSel.value||30; roundNow=1; current='A';
    aVotes=0; bVotes=0; scoreA.textContent=aVotes; scoreB.textContent=bVotes; timerEl.textContent=mmss(tLeft);
    clearInterval(ticker); ticker=setInterval(tick,1000);
    hideLoad(); showPanel('A'); playPane('A'); pausePane('B');
  }
  function tick(){ tLeft--; timerEl.textContent=mmss(tLeft); if(tLeft<=0) swap(); }
  function swap(){
    if(current==='A'){ current='B'; tLeft=+turnSel.value||30; showPanel('B'); playPane('B'); pausePane('A'); }
    else { if(roundNow<roundsTotal){ roundNow++; current='A'; tLeft=+turnSel.value||30; showPanel('A'); playPane('A'); pausePane('B'); } else { clearInterval(ticker); showLoad(); } }
  }

  // Pre-battle: animate bars draining to 70% to simulate hype, then wait for "FIGHT!"
  function hypeBars(){ barA.style.width='70%'; barB.style.width='70%'; }
  setTimeout(hypeBars, 800);

  fightBtn.addEventListener('click',()=>{
    // Quick 3..2..1.. FIGHT text before start
    let n=3; countTxt.textContent=n; const iv=setInterval(()=>{ n--; if(n>0){ countTxt.textContent=n; } else { clearInterval(iv); countTxt.textContent='FIGHT!'; setTimeout(start,260);} },600);
  });
  swapBtn.addEventListener('click',()=>{ const left=plateA.textContent; plateA.textContent=plateB.textContent; plateB.textContent=left; const tmp=state.A; state.A=state.B; state.B=tmp; });
  previewBtn.addEventListener('click',()=>{ showPanel(active==='A'?'B':'A'); active=(active==='A'?'B':'A'); });

  startBattle.addEventListener('click',()=>{ showLoad(); /* user can hit FIGHT or use Start as shortcut: */ fightBtn.click(); });

  // Tap videos to vote
  vidA.addEventListener('click',()=>{ if(ticker && current==='A'){ aVotes++; scoreA.textContent=aVotes; barA.style.width=Math.max(20,100 - aVotes)% + '%'; }});
  vidB.addEventListener('click',()=>{ if(ticker && current==='B'){ bVotes++; scoreB.textContent=bVotes; barB.style.width=Math.max(20,100 - bVotes)% + '%'; }});

  // Boot with load overlay visible
  showLoad();

  /* ===== Accessibility niceties ===== */
  addEventListener('keydown',e=>{
    if(e.key==='1') showPanel('A'); if(e.key==='2') showPanel('B');
    if(e.key.toLowerCase()==='d') dock.classList.toggle('open');
  });
</script>
</body>
</html>
